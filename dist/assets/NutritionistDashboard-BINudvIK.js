import{q as oe,r as p,u as de,b as Q,j as e,C as _,c as k,d as A,w as q,e as C,L as De,X as Le,D as Fe,x as Be,B as O,y as He,z as V,T as he,s as v,E as ue,F as R,G as Ue,a as Ve,t as ge,m as qe,H as Oe}from"./index-DL6VMzkS.js";import{I as ze}from"./input-CMIeflfg.js";import{t as We}from"./mealTranslations-B1KHhmEq.js";import{S as Ge}from"./search-DSoGe5N4.js";import{F as Ye}from"./filter-BP9BoWgp.js";import{U as ne}from"./utensils-Dewe3o1J.js";import{W as ie}from"./weight-BU16ia2P.js";import{f as Ae}from"./formatDistanceToNow-DtmfIdtc.js";import{p as K}from"./pt-BR-faZp8-Xc.js";import{B as fe}from"./badge-CMQ26CgR.js";import{g as Xe,a as Ze,b as Je,c as Ke}from"./patient-queries-DGcE69Ge.js";import{A as Qe}from"./alert-triangle-CBqpK_o8.js";import{S as et,a as D}from"./skeleton-srGBIzGo.js";import{A as be}from"./activity-CnuM4kS2.js";import{M as tt}from"./message-square-DT-jZ4Je.js";import{C as ye}from"./calendar-jIa_pVTS.js";import{B as at}from"./book-open-BHuBuXpH.js";import{F as st}from"./file-text-C4_WSc72.js";import{p as Me}from"./parseISO-DyXfBXdu.js";import{U as we}from"./users-Bz7ifqG6.js";import{T as rt}from"./trending-up-D1f-Js4G.js";import"./constructNow-BKPZXC7W.js";import"./compareAsc-bTrxyzCK.js";import"./endOfMonth-fINJXo8H.js";import"./query-helpers-mbysFH2_.js";const je=oe("Clipboard",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}]]),nt=oe("Gift",[["rect",{x:"3",y:"8",width:"18",height:"4",rx:"1",key:"bkv52"}],["path",{d:"M12 8v13",key:"1c76mn"}],["path",{d:"M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7",key:"6wjy6b"}],["path",{d:"M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5",key:"1ihvrl"}]]),Ne=oe("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z",key:"ymcmye"}]]),it=()=>{const[t,r]=p.useState([]),[c,o]=p.useState(!0),[x,l]=p.useState(""),[i,s]=p.useState("all"),{user:h}=de(),f=Q(),M=d=>{const y=Number.parseFloat(d);return Number.isNaN(y)?d?`${d} kcal`:null:`${y.toFixed(2)} kcal`};p.useEffect(()=>{(async()=>{if(h?.id){o(!0);try{const{data:y}=await v.from("user_profiles").select("id, name").eq("nutritionist_id",h.id).eq("user_type","patient");if(!y||y.length===0){r([]),o(!1);return}const w=y.map(m=>m.id),I=Object.fromEntries(y.map(m=>[m.id,m])),S=[],[E,L]=await Promise.all([v.from("meal_audit_log").select("id, patient_id, action, meal_type, details, created_at").in("patient_id",w).order("created_at",{ascending:!1}).limit(100),v.from("growth_records").select("id, patient_id, weight, created_at").in("patient_id",w).order("created_at",{ascending:!1}).limit(100)]);E.data&&E.data.forEach(m=>{const N=I[m.patient_id];if(N){const B=m.details?.total_calories??0;let a="",u="";m.action==="create"?(a="registrou",u="meal"):m.action==="update"?(a="editou",u="edit"):m.action==="delete"&&(a="deletou",u="delete"),S.push({id:`audit-${m.id}`,type:u,patient_id:m.patient_id,patient_name:N.name,description:a,meal_type:We(m.meal_type),detail:M(B),timestamp:m.created_at})}}),L.data&&L.data.forEach(m=>{const N=I[m.patient_id];N&&S.push({id:`weight-${m.id}`,type:"weight",patient_id:m.patient_id,patient_name:N.name,description:"registrou peso",detail:`${m.weight} kg`,timestamp:m.created_at})}),S.sort((m,N)=>new Date(N.timestamp)-new Date(m.timestamp)),r(S)}catch(y){console.error("Erro ao buscar atualizações:",y),r([])}o(!1)}})()},[h]);const T=d=>{switch(d){case"meal":return e.jsx(ne,{className:"h-5 w-5 text-secondary"});case"weight":return e.jsx(ie,{className:"h-5 w-5 text-primary"});case"edit":return e.jsx(Ne,{className:"h-5 w-5 text-blue-600"});case"delete":return e.jsx(he,{className:"h-5 w-5 text-red-600"});default:return null}},j=t.filter(d=>!(i!=="all"&&d.type!==i||x&&!d.patient_name.toLowerCase().includes(x.toLowerCase())));return c?e.jsxs(_,{className:"bg-card shadow-card-dark rounded-xl overflow-hidden",children:[e.jsxs(k,{children:[e.jsx(A,{className:"font-clash text-lg font-semibold text-primary",children:"Registros Recentes"}),e.jsx(q,{className:"text-muted-foreground",children:"Carregando..."})]}),e.jsx(C,{className:"flex items-center justify-center py-10",children:e.jsx(De,{className:"w-6 h-6 animate-spin text-primary"})})]}):e.jsxs(_,{className:"bg-card shadow-card-dark rounded-xl overflow-hidden",children:[e.jsxs(k,{className:"pb-3",children:[e.jsx(A,{className:"font-clash text-base md:text-lg font-semibold text-primary break-words",children:"Registros Recentes"}),e.jsx(q,{className:"text-muted-foreground text-xs md:text-sm",children:"Últimos registros dos seus pacientes"}),e.jsxs("div",{className:"flex gap-2 mt-3 min-w-0",children:[e.jsxs("div",{className:"relative flex-1 min-w-0",children:[e.jsx(Ge,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ze,{placeholder:"Pesquisar por paciente...",value:x,onChange:d=>l(d.target.value),className:"pl-9 pr-9 min-w-0"}),x&&e.jsx("button",{onClick:()=>l(""),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-muted-foreground hover:text-foreground",children:e.jsx(Le,{className:"h-4 w-4"})})]}),e.jsxs(Fe,{children:[e.jsx(Be,{asChild:!0,children:e.jsx(O,{variant:"outline",size:"icon",children:e.jsx(Ye,{className:"h-4 w-4"})})}),e.jsxs(He,{align:"end",children:[e.jsx(V,{onClick:()=>s("all"),children:e.jsx("span",{className:i==="all"?"font-semibold":"",children:"Todos"})}),e.jsxs(V,{onClick:()=>s("meal"),children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:i==="meal"?"font-semibold":"",children:"Refeições"})]}),e.jsxs(V,{onClick:()=>s("weight"),children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:i==="weight"?"font-semibold":"",children:"Peso"})]}),e.jsxs(V,{onClick:()=>s("edit"),children:[e.jsx(Ne,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:i==="edit"?"font-semibold":"",children:"Edições"})]}),e.jsxs(V,{onClick:()=>s("delete"),children:[e.jsx(he,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:i==="delete"?"font-semibold":"",children:"Exclusões"})]})]})]})]})]}),e.jsx(C,{children:j.length===0?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:x||i!=="all"?"Nenhum registro encontrado com os filtros aplicados":"Nenhum registro recente."})}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-xs text-muted-foreground mb-3",children:[j.length," ",j.length===1?"registro":"registros"]}),e.jsx("div",{className:"space-y-3 max-h-[400px] overflow-y-auto pr-2",children:j.map(d=>e.jsxs("div",{className:"flex items-start gap-3 min-w-0",children:[e.jsx("div",{className:"bg-muted p-2 rounded-full flex-shrink-0",children:T(d.type)}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsxs("p",{className:"text-sm break-words",children:[d.patient_id?e.jsx("button",{type:"button",className:"font-semibold text-primary hover:underline",onClick:()=>f(`/nutritionist/patients/${d.patient_id}/hub`),children:d.patient_name}):e.jsx("span",{className:"font-semibold text-primary",children:d.patient_name})," ",e.jsx("span",{className:"text-foreground",children:d.description}),d.meal_type&&e.jsxs(e.Fragment,{children:[" seu ",e.jsx("span",{className:"font-semibold text-foreground",children:d.meal_type})]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[d.detail&&`${d.detail} • `,Ae(new Date(d.timestamp),{addSuffix:!0,locale:K})]})]})]},d.id))})]})})]})},ve={pending:je,low_adherence:be,birthday:nt,appointment_upcoming:ye,meal:ne,anthropometry:ie,anamnesis:st,meal_plan:at,prescription:je,appointment:ye,message:tt,achievement:be,default:et},ot={pending:"Pendência",low_adherence:"Baixa adesão",birthday:"Aniversário",appointment_upcoming:"Consulta próxima",meal:"Refeição",anthropometry:"Avaliação",anamnesis:"Anamnese",meal_plan:"Plano alimentar",prescription:"Cálculo",appointment:"Consulta",message:"Mensagem",achievement:"Conquista"},_e={pending:{card:"bg-amber-50/60 border-amber-200/60",badge:"bg-amber-50 text-amber-700 border-amber-200",icon:"text-amber-600"},low_adherence:{card:"bg-rose-50/60 border-rose-200/60",badge:"bg-rose-50 text-rose-700 border-rose-200",icon:"text-rose-600"},birthday:{card:"bg-violet-50/60 border-violet-200/60",badge:"bg-violet-50 text-violet-700 border-violet-200",icon:"text-violet-600"},appointment_upcoming:{card:"bg-sky-50/60 border-sky-200/60",badge:"bg-sky-50 text-sky-700 border-sky-200",icon:"text-sky-600"},meal:{card:"bg-orange-50/60 border-orange-200/60",badge:"bg-orange-50 text-orange-700 border-orange-200",icon:"text-orange-600"},anthropometry:{card:"bg-emerald-50/60 border-emerald-200/60",badge:"bg-emerald-50 text-emerald-700 border-emerald-200",icon:"text-emerald-600"},anamnesis:{card:"bg-indigo-50/60 border-indigo-200/60",badge:"bg-indigo-50 text-indigo-700 border-indigo-200",icon:"text-indigo-600"},meal_plan:{card:"bg-cyan-50/60 border-cyan-200/60",badge:"bg-cyan-50 text-cyan-700 border-cyan-200",icon:"text-cyan-600"},prescription:{card:"bg-yellow-50/60 border-yellow-200/60",badge:"bg-yellow-50 text-yellow-700 border-yellow-200",icon:"text-yellow-600"},appointment:{card:"bg-blue-50/60 border-blue-200/60",badge:"bg-blue-50 text-blue-700 border-blue-200",icon:"text-blue-600"},message:{card:"bg-slate-50/60 border-slate-200/60",badge:"bg-slate-50 text-slate-700 border-slate-200",icon:"text-slate-600"},achievement:{card:"bg-amber-50/60 border-amber-200/60",badge:"bg-amber-50 text-amber-700 border-amber-200",icon:"text-amber-600"},default:{card:"bg-muted/40 border-border/70",badge:"bg-muted text-muted-foreground border-border",icon:"text-muted-foreground"}},dt=()=>{const{user:t}=de(),r=Q(),[c,o]=p.useState(!0),[x,l]=p.useState([]);p.useEffect(()=>{(async()=>{if(t?.id){o(!0);try{const h=new Date,[f,M,T,j,d,y]=await Promise.all([Xe(t.id,40),Ze(t.id),Je(t.id),v.from("appointments").select("id, appointment_time, patient_id, patient:appointments_patient_id_fkey(id, name, avatar_url)").eq("nutritionist_id",t.id).gte("appointment_time",h.toISOString()).order("appointment_time",{ascending:!0}).limit(5),v.from("user_profiles").select("id, name, birth_date, avatar_url").eq("nutritionist_id",t.id).eq("is_active",!0),Ke(t.id)]);if(f.error)throw f.error;if(M.error)throw M.error;if(T.error)throw T.error;if(j.error)throw j.error;if(d.error)throw d.error;const w=y?.data||[],I=(f.data||[]).map(a=>{const u=lt(a),$=P("activity",a,w);return{id:`activity-${a.id}`,type:a.type,patientId:a.patient_id,patientName:a.patient_name,patientAvatar:a.patient_avatar||null,title:a.title,description:a.description,timestamp:a.timestamp,ctaLabel:u.label,ctaRoute:u.route,priority:5,priorityScore:$.score,priorityReason:$.reason}}),S=(T.data||[]).flatMap(a=>a.pending_items.map(u=>({id:`pending-${a.patient_id}-${u.type}`,type:"pending",patientId:a.patient_id,patientName:a.patient_name,title:u.label,description:"Cadastro pendente",timestamp:null,ctaLabel:"Resolver",ctaRoute:u.route,priority:1,priorityScore:P("pending",u,w).score,priorityReason:P("pending",u,w).reason}))),E=(M.data||[]).map(a=>({id:`low-adherence-${a.id}`,type:"low_adherence",patientId:a.id,patientName:a.name,title:"Baixa adesão",description:a.days_inactive===null?"Sem registros de refeição":`Sem registros há ${a.days_inactive} dia${a.days_inactive!==1?"s":""}`,timestamp:null,ctaLabel:"Ver diário",ctaRoute:`/nutritionist/patients/${a.id}/food-diary`,priority:4,priorityScore:P("low_adherence",a,w).score,priorityReason:P("low_adherence",a,w).reason})),L=(j.data||[]).map(a=>({id:`appt-${a.id}`,type:"appointment_upcoming",patientId:a.patient_id,patientName:a.patient?.name||"Paciente",patientAvatar:a.patient?.avatar_url||null,title:"Consulta próxima",description:a.appointment_time?R(Me(a.appointment_time),"d 'de' MMMM 'às' HH:mm",{locale:K}):"Consulta agendada",timestamp:a.appointment_time,ctaLabel:"Ver agenda",ctaRoute:"/nutritionist/agenda",priority:2,priorityScore:P("appointment_upcoming",a,w).score,priorityReason:P("appointment_upcoming",a,w).reason})),m=ct(d.data||[]),B=[...S,...L,...m,...E,...I].sort((a,u)=>{const $=Number(a.priorityScore||0),H=Number(u.priorityScore||0);if($!==H)return H-$;if(a.priority!==u.priority)return a.priority-u.priority;const z=a.timestamp?new Date(a.timestamp).getTime():0;return(u.timestamp?new Date(u.timestamp).getTime():0)-z});l(B)}catch(h){console.error("Erro ao carregar feed:",h),l([])}finally{o(!1)}}})()},[t]);const i=s=>{if(!s)return"Pendente";const h=typeof s=="string"?new Date(s):s;return Ue(h)?Ae(h,{addSuffix:!0,locale:K}):"Pendente"};return c?e.jsxs(_,{className:"bg-card shadow-card-dark rounded-xl overflow-hidden",children:[e.jsxs(k,{children:[e.jsx(A,{className:"font-clash text-lg font-semibold text-primary",children:"Feed de Atividades"}),e.jsx(q,{className:"text-muted-foreground",children:"Carregando..."})]}),e.jsx(C,{className:"flex items-center justify-center py-10",children:e.jsx(De,{className:"w-6 h-6 animate-spin text-primary"})})]}):e.jsxs(_,{className:"bg-card shadow-card-dark rounded-xl overflow-hidden",children:[e.jsxs(k,{className:"flex flex-row items-start justify-between gap-2 md:gap-4 pb-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx(A,{className:"font-clash text-base md:text-lg font-semibold text-primary break-words",children:"Feed de Atividades"}),e.jsx(q,{className:"text-muted-foreground text-xs md:text-sm",children:"Tudo o que precisa ver ao iniciar o dia"})]}),e.jsxs(fe,{variant:"outline",className:"text-xs",children:[x.length," eventos"]})]}),e.jsx(C,{children:x.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Qe,{className:"w-12 h-12 text-muted-foreground/50 mx-auto mb-3"}),e.jsx("p",{className:"text-muted-foreground font-medium mb-1",children:"Tudo em dia!"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Não há alertas ou atividades relevantes no momento"})]}):e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"max-h-[520px] overflow-y-auto pr-2 space-y-2",children:x.map(s=>{const h=ve[s.type]||ve.default,f=_e[s.type]||_e.default;return e.jsxs("div",{className:`flex items-start gap-2 md:gap-3 rounded-xl border p-3 md:p-4 shadow-sm hover:shadow-md transition-all min-w-0 ${f.card}`,children:[e.jsxs("div",{className:"mt-0.5 flex items-center gap-2 md:gap-3 shrink-0",children:[e.jsx("div",{className:"h-9 w-9 md:h-10 md:w-10 rounded-full border border-border bg-muted/40 flex items-center justify-center text-xs font-semibold text-muted-foreground",children:s.patientName?s.patientName.substring(0,2).toUpperCase():"HT"}),e.jsx("div",{className:"rounded-full border border-border bg-background p-1.5 md:p-2",children:e.jsx(h,{className:`h-3.5 w-3.5 md:h-4 md:w-4 ${f.icon}`})})]}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-1 sm:gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("p",{className:"text-sm font-semibold text-foreground truncate",children:[s.patientName?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-primary font-semibold",children:s.patientName})," "]}):null,s.title]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5 line-clamp-2",children:s.description}),s.priorityReason?e.jsxs("p",{className:"text-[11px] text-muted-foreground mt-1",children:["Prioridade: ",s.priorityReason]}):null]}),s.type==="pending"&&s.ctaRoute?e.jsxs(O,{size:"sm",className:"h-7 px-2 text-xs",onClick:()=>r(s.ctaRoute),children:[s.ctaLabel||"Resolver",e.jsx(ue,{className:"ml-1 h-3 w-3"})]}):e.jsx("span",{className:"text-xs text-muted-foreground whitespace-nowrap",children:i(s.timestamp)})]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(fe,{variant:"outline",className:`text-xs ${f.badge}`,children:ot[s.type]||"Atividade"}),s.type!=="pending"&&s.ctaRoute?e.jsxs(O,{size:"sm",variant:"outline",className:"h-7 px-2 text-xs hover:border-primary/40",onClick:()=>r(s.ctaRoute),children:[s.ctaLabel||"Ver detalhes",e.jsx(ue,{className:"ml-1 h-3 w-3"})]}):null]})]})]},s.id)})}),e.jsx("div",{className:"pointer-events-none absolute inset-x-0 bottom-0 h-10 bg-gradient-to-t from-background to-transparent"})]})})]})},lt=t=>{if(!t?.patient_id)return{label:"Ver detalhes",route:"/nutritionist/patients"};switch(t.type){case"meal":return{label:"Ver diário",route:`/nutritionist/patients/${t.patient_id}/food-diary`};case"anthropometry":return{label:"Ver avaliação",route:`/nutritionist/patients/${t.patient_id}/anthropometry`};case"anamnesis":return{label:"Ver anamnese",route:`/nutritionist/patients/${t.patient_id}/anamnesis`};case"meal_plan":return{label:"Ver plano",route:`/nutritionist/patients/${t.patient_id}/meal-plan`};case"prescription":return{label:"Ver cálculo",route:`/nutritionist/patients/${t.patient_id}/energy-expenditure`};case"appointment":return{label:"Ver agenda",route:"/nutritionist/agenda"};case"message":return{label:"Abrir chat",route:`/chat/nutritionist/${t.patient_id}`};case"achievement":return{label:"Ver metas",route:`/nutritionist/patients/${t.patient_id}/goals`};default:return{label:"Ver paciente",route:`/nutritionist/patients/${t.patient_id}/hub`}}},ct=t=>{const r=new Date,c=[];return t.forEach(o=>{if(!o.birth_date)return;const x=new Date(o.birth_date);x.setFullYear(r.getFullYear());const l=Math.ceil((x-r)/(1e3*60*60*24));(l===0||l>0&&l<=7)&&c.push({id:`birthday-${o.id}`,type:"birthday",patientId:o.id,patientName:o.name,patientAvatar:o.avatar_url||null,title:l===0?"Aniversário hoje":`Aniversário em ${l} dia${l>1?"s":""}`,description:`Nascimento: ${R(new Date(o.birth_date),"dd/MM")}`,timestamp:null,ctaLabel:"Ver perfil",ctaRoute:`/nutritionist/patients/${o.id}/hub`,priority:3})}),c},P=(t,r,c=[])=>{const o=i=>c.find(s=>s.rule_key===i&&s.is_active!==!1);if(t==="pending"){const i=o("pending_data");return{score:Number(i?.weight||5),reason:"Pendencia de dados essenciais"}}if(t==="low_adherence"){const i=o("low_adherence");return{score:Number(i?.weight||4),reason:"Baixa adesao recente"}}if(t==="appointment_upcoming"){const i=o("appointment_upcoming");return{score:Number(i?.weight||3),reason:"Consulta proxima"}}const l=o({meal:"recent_activity",anthropometry:"recent_activity",anamnesis:"recent_activity",meal_plan:"recent_activity",appointment:"appointment_upcoming",message:"recent_activity",achievement:"recent_activity"}[r?.type]||"recent_activity");return{score:Number(l?.weight||1),reason:"Atividade recente"}};function se(){return e.jsxs(_,{className:"bg-card shadow-card-dark rounded-xl",children:[e.jsx(k,{className:"pb-2",children:e.jsx(D,{className:"h-4 w-32"})}),e.jsxs(C,{children:[e.jsx(D,{className:"h-10 w-20 mb-2"}),e.jsx(D,{className:"h-3 w-40"})]})]})}function ke(){return e.jsxs(_,{className:"bg-card shadow-card-dark rounded-xl",children:[e.jsxs(k,{className:"pb-3",children:[e.jsx(D,{className:"h-5 w-48 mb-2"}),e.jsx(D,{className:"h-4 w-64"})]}),e.jsx(C,{className:"space-y-3",children:[1,2,3].map(t=>e.jsxs("div",{className:"flex items-start gap-3 p-3 rounded-lg border border-border",children:[e.jsx(D,{className:"h-10 w-10 rounded-full flex-shrink-0"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(D,{className:"h-4 w-3/4"}),e.jsx(D,{className:"h-3 w-1/2"})]})]},t))})]})}const mt=(t,r=[])=>{const c=new Date;c.setDate(c.getDate()-(t-1));const o=Array.from({length:t},(l,i)=>{const s=new Date(c);return s.setDate(c.getDate()+i),R(s,"yyyy-MM-dd")}),x={};return r.forEach(l=>{if(!l)return;const i=R(new Date(l),"yyyy-MM-dd");x[i]=(x[i]||0)+1}),o.map(l=>x[l]||0)},re=({data:t=[]})=>{if(!t.length)return null;const r=Math.max(...t,1),c=140,o=44,x=c/Math.max(1,t.length-1),l=t.map((i,s)=>{const h=s*x,f=o-i/r*(o-4);return`${h},${f}`}).join(" ");return e.jsx("div",{className:"pointer-events-none absolute right-2 bottom-2 opacity-35",children:e.jsx("svg",{viewBox:`0 0 ${c} ${o}`,className:"h-11 w-36","aria-hidden":"true",children:e.jsx("polyline",{points:l,fill:"none",stroke:"white",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round"})})})},Ce=t=>t>=5?"bg-secondary/15 text-secondary border-secondary/30":t>=3?"bg-yellow-100 text-yellow-800 border-yellow-300":"bg-primary/15 text-primary border-primary/30",pt=t=>{const c=(new Date(t).getTime()-Date.now())/(1e3*60*60);return c<=2?{label:"Muito próxima",rowClass:"border-red-300/80 bg-red-50/70",badgeClass:"bg-red-100 text-red-700 border-red-200",dotClass:"bg-red-500"}:c<=24?{label:"Hoje",rowClass:"border-orange-300/80 bg-orange-50/70",badgeClass:"bg-orange-100 text-orange-700 border-orange-200",dotClass:"bg-orange-500"}:c<=72?{label:"Em breve",rowClass:"border-amber-300/80 bg-amber-50/70",badgeClass:"bg-amber-100 text-amber-700 border-amber-200",dotClass:"bg-amber-500"}:{label:"Programada",rowClass:"border-emerald-300/80 bg-emerald-50/70",badgeClass:"bg-emerald-100 text-emerald-700 border-emerald-200",dotClass:"bg-emerald-500"}},Se=({appointments:t,totalUpcoming:r,todayAppointments:c})=>{const o=Q(),x=c>0,l=r>0;return e.jsxs(_,{className:"bg-card shadow-card-dark rounded-xl overflow-hidden",children:[e.jsx(k,{className:"pb-2",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 min-w-0",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx(A,{className:"font-clash text-base md:text-lg font-semibold text-primary break-words",children:"Próximas Consultas"}),e.jsx(q,{className:"text-muted-foreground text-xs md:text-sm",children:"Seus próximos agendamentos."})]}),e.jsxs("div",{className:"mt-0.5 flex flex-wrap justify-end gap-1.5",children:[x&&e.jsxs("span",{className:`rounded-full border px-2 py-0.5 text-[10px] font-semibold ${Ce(c)}`,children:["Hoje: ",c]}),l&&e.jsxs("span",{className:`rounded-full border px-2 py-0.5 text-[10px] font-semibold ${Ce(r)}`,children:["Total: ",r]})]})]})}),e.jsx(C,{children:t.length>0?e.jsxs("div",{className:"space-y-4",children:[t.map(i=>{const s=i.patient,h=pt(i.appointment_time);return e.jsxs("div",{className:`rounded-lg border p-2.5 ${h.rowClass}`,children:[e.jsx("div",{className:"mb-2 flex justify-end",children:e.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-[11px] font-medium ${h.badgeClass}`,children:[e.jsx("span",{className:`h-1.5 w-1.5 rounded-full ${h.dotClass}`}),h.label]})}),e.jsxs("div",{className:"flex items-center space-x-3 min-w-0",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-emerald-100 flex-shrink-0 flex items-center justify-center",children:e.jsx("span",{className:"font-semibold text-emerald-700 text-xs",children:(s?.name||"P").substring(0,2).toUpperCase()})}),e.jsxs("div",{className:"min-w-0 flex-1 overflow-hidden",children:[e.jsx("p",{className:"text-sm font-medium text-foreground truncate",children:s?.name||"Paciente (Excluído)"}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:R(Me(i.appointment_time),"d 'de' MMMM 'às' HH:mm",{locale:K})})]})]})]},i.id)}),e.jsx(O,{variant:"outline",size:"sm",className:"w-full mt-2",onClick:()=>o("/nutritionist/agenda"),children:"Ver agenda completa"})]}):e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Nenhuma consulta agendada."})})]})};function Ft(){const{toast:t}=Ve(),{user:r}=de(),c=Q(),[o,x]=p.useState([]),[l,i]=p.useState([]),[s,h]=p.useState(0),[f,M]=p.useState(0),[T,j]=p.useState(0),[d,y]=p.useState("--%"),[w,I]=p.useState(0),[S,E]=p.useState(0),[L,m]=p.useState([]),[N,B]=p.useState([]),[a,u]=p.useState([]),[$,H]=p.useState(!0),[z,ee]=p.useState(!0),le=p.useCallback(async()=>{if(!(!r||!r.id)){H(!0);try{const b=await v.from("user_profiles").select("id, name, created_at").eq("nutritionist_id",r.id).eq("is_active",!0).order("name",{ascending:!0}).then(({data:n,error:g})=>{if(g)throw g;return n||[]}),F=b.map(n=>n.id),W=new Date(Date.now()-1440*60*1e3).toISOString(),U=F.length?await v.from("meals").select("patient_id, created_at").in("patient_id",F).gte("created_at",W).then(({data:n,error:g})=>{if(g)throw g;return n||[]}):[];x(b);const G=b.filter(n=>n.created_at&&new Date(n.created_at)>=new Date(Date.now()-2160*60*60*1e3)).map(n=>n.created_at),Y=mt(90,G),te=Math.max(0,b.length-G.length),X=Y.reduce((n,g,J)=>{const Ee=J===0?te:n[J-1];return n.push(Ee+g),n},[]);m(X);const Te=b.filter(n=>n.created_at&&new Date(n.created_at)>=new Date(Date.now()-720*60*60*1e3)).length;E(Te);const me=U.reduce((n,g)=>(n[g.patient_id]=(n[g.patient_id]||0)+1,n),{}),$e=Object.values(me).filter(n=>n>=1).length,pe=Object.values(me).filter(n=>n>=2).length,Pe=F.length?Math.round(pe/F.length*100):0;j($e),I(pe),y(`${Pe}%`);const xe=Array.from({length:24},(n,g)=>{const J=new Date(Date.now()-(23-g)*60*60*1e3);return R(J,"yyyy-MM-dd HH")}),Z={},ae={};U.forEach(n=>{const g=R(new Date(n.created_at),"yyyy-MM-dd HH");ae[g]=(ae[g]||0)+1,Z[g]||(Z[g]=new Set),Z[g].add(n.patient_id)});const Re=xe.map(n=>Z[n]?.size||0),Ie=xe.map(n=>ae[n]||0);B(Re),u(Ie)}catch(b){console.error("Erro ao carregar estatísticas:",b),t({title:"Erro ao carregar estatísticas",description:ge(b,"Não foi possível carregar as estatísticas."),variant:"destructive"})}finally{H(!1)}}},[r,t]),ce=p.useCallback(async()=>{if(!(!r||!r.id)){ee(!0);try{const b=new Date().toISOString(),{data:F,error:W}=await v.from("appointments").select("id, appointment_time, patient:appointments_patient_id_fkey(id, name, avatar_url)").eq("nutritionist_id",r.id).gte("appointment_time",b).order("appointment_time",{ascending:!0}).limit(3);if(W)throw W;i(F||[]);const U=new Date().toISOString().split("T")[0],[{count:G,error:Y},{count:te,error:X}]=await Promise.all([v.from("appointments").select("*",{count:"exact",head:!0}).eq("nutritionist_id",r.id).gte("appointment_time",b),v.from("appointments").select("*",{count:"exact",head:!0}).eq("nutritionist_id",r.id).gte("appointment_time",`${U}T00:00:00`).lte("appointment_time",`${U}T23:59:59`)]);if(Y)throw Y;if(X)throw X;M(G||0),h(te||0)}catch(b){console.error("Erro ao carregar agendamentos:",b),t({title:"Erro ao carregar agendamentos",description:ge(b,"Não foi possível carregar os agendamentos."),variant:"destructive"})}finally{ee(!1)}}},[r,t]);return p.useEffect(()=>{r?.id&&(le(),ce())},[r?.id,le,ce]),e.jsx("div",{className:"flex flex-col min-h-screen bg-background",children:e.jsxs(qe.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"max-w-7xl mx-auto w-full px-4 md:px-8 pt-4 md:pt-8 min-w-0 overflow-x-hidden",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6 md:mb-8 text-center sm:text-left",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("h2",{className:"text-2xl md:text-3xl font-bold font-heading uppercase tracking-wide text-primary break-words",children:"Dashboard"}),e.jsx("p",{className:"text-neutral-600 text-sm md:text-base mt-0.5",children:"Gerencie seus pacientes, Planos e Análises."})]}),e.jsx("div",{className:"flex gap-2 flex-wrap justify-center sm:justify-end",children:e.jsxs(O,{variant:"secondary",onClick:()=>c("/nutritionist/patients"),children:[e.jsx(we,{className:"h-4 w-4 mr-2"}),"Ver todos os pacientes"]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-8 lg:order-last order-3",children:[e.jsx("div",{className:"hidden lg:block",children:z?e.jsx(ke,{}):e.jsx(Se,{appointments:l,totalUpcoming:f,todayAppointments:s})}),e.jsx(it,{})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-8 lg:order-first order-1",children:[e.jsx("div",{className:"grid gap-4 grid-cols-2 lg:grid-cols-3 mb-6",children:$?e.jsxs(e.Fragment,{children:[e.jsx(se,{}),e.jsx(se,{}),e.jsx("div",{className:"col-span-2 lg:col-span-1",children:e.jsx(se,{})})]}):e.jsxs(e.Fragment,{children:[e.jsxs(_,{className:"relative overflow-hidden bg-primary text-white border-0 shadow-card-dark",children:[e.jsx(re,{data:L}),e.jsxs(k,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(A,{className:"font-heading uppercase text-xs lg:text-sm font-medium text-white/80 tracking-wide leading-tight",children:"Total Pacientes"}),e.jsx(we,{className:"h-5 w-5 lg:h-6 lg:w-6 text-white/80 flex-shrink-0"})]}),e.jsxs(C,{className:"relative",children:[e.jsx("div",{className:"text-3xl lg:text-4xl font-bold text-white",children:o.length}),e.jsx("p",{className:"text-xs text-white/70",children:"Evolução dos últimos 90 dias"})]})]}),e.jsxs(_,{className:"relative overflow-hidden bg-neutral-800 text-white border-0 shadow-card-dark lg:order-3",children:[e.jsx(re,{data:N}),e.jsxs(k,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(A,{className:"font-heading uppercase text-xs lg:text-sm font-medium text-white/80 tracking-wide leading-tight",children:"Pacientes Ativos"}),e.jsx(Oe,{className:"h-5 w-5 lg:h-6 lg:w-6 text-white/80 flex-shrink-0"})]}),e.jsxs(C,{className:"relative",children:[e.jsx("div",{className:"text-3xl lg:text-4xl font-bold text-white",children:T}),e.jsxs("p",{className:"text-xs text-white/70 leading-tight",children:[S," novos nos últimos 30 dias"]})]})]}),e.jsxs(_,{className:"relative overflow-hidden bg-secondary text-white border-0 shadow-card-dark col-span-2 lg:col-span-1 lg:order-2",children:[e.jsx(re,{data:a}),e.jsxs(k,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(A,{className:"font-heading uppercase text-xs lg:text-sm font-medium text-white/80 tracking-wide leading-tight",children:"Adesão 24h"}),e.jsx(rt,{className:"h-5 w-5 lg:h-6 lg:w-6 text-white/80 flex-shrink-0"})]}),e.jsxs(C,{className:"relative",children:[e.jsx("div",{className:"text-3xl lg:text-4xl font-bold text-white",children:d}),e.jsxs("p",{className:"text-xs text-white/70",children:[w,"/",o.length," com 2+ registros"]})]})]})]})}),e.jsx(dt,{})]}),e.jsx("div",{className:"lg:hidden order-2",children:z?e.jsx(ke,{}):e.jsx(Se,{appointments:l,totalUpcoming:f,todayAppointments:s})})]})]})})}export{Ft as default};
