import{q as lt,as as K,r as x,F as m,j as e,J as je,K as ve,M as we,N as _e,I as Me,O as $e,B as j,s as z,u as ct,a as dt,b as mt,at as ut,m as pt,C as ne,e as re,E as xe,ad as ke,c as he,d as ge,w as Ee,X as xt,U as ht,T as gt,A as ft,h as yt,i as jt,k as vt,l as wt,n as _t,o as bt,p as Nt,t as Ct,a3 as Dt,au as St}from"./index-BvWB-6Y-.js";import{i as Mt,a as He,C as Ae,e as Te,s as kt}from"./calendar-rgGv7qqU.js";import{I as J}from"./input-OBodSLFw.js";import{L as M}from"./label-Dds-NHUC.js";import{S as X,a as G,b as Q,c as Y,d as F}from"./select-CHitR1r5.js";import{B as Fe}from"./badge-CCK5Bs0D.js";import{b as Et}from"./pdfUtils-DbTjH_I8.js";import{D as At,T as Tt,C as ze}from"./date-input-NufpG6-F.js";import{S as be}from"./search-DAzfs9rU.js";import{l as Ft,g as zt}from"./financial-queries-Co2vDJmL.js";import{l as P}from"./query-helpers-mbysFH2_.js";import{l as Z}from"./observability-queries-BxbsnaqH.js";import{c as Ve}from"./constructNow-BDnuN8eJ.js";import{P as Pt}from"./plus-BWNKYoo4.js";import{C as fe}from"./chevron-left-FDyjizdT.js";import{C as Ot}from"./calendar-BxLBJTLY.js";import{F as Lt}from"./filter-DzB1LpgZ.js";import{C as It}from"./clock-BDxmKYor.js";import{E as qt}from"./eye-D-rBLbjZ.js";import{P as $t}from"./pen-square-OCV3PTXs.js";import{i as Ht}from"./isTomorrow-BGjt5OZp.js";import{p as b}from"./pt-BR-BMtVLtF7.js";import{i as Pe}from"./isSameDay-CSO39H9U.js";import{i as T}from"./isToday-kGhyZ0TX.js";import{s as Vt}from"./subMonths-eleCAaEd.js";import{a as Rt}from"./addMonths-hOFFPW3g.js";import{e as Wt}from"./endOfMonth-Ca9QmV5D.js";import"./extends-CF3RwP-h.js";import"./jspdf.es.min-B7ZBL3OL.js";import"./jspdf.plugin.autotable-C3NxY6Hi.js";import"./html2canvas.esm-B0tyYwQk.js";import"./popover-BK70NwGK.js";import"./parseISO-DtrTOw4I.js";const Oe=lt("FileDown",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}],["path",{d:"M12 18v-6",key:"17g6i2"}],["path",{d:"m9 15 3 3 3-3",key:"1npd3o"}]]);function Bt(n,h,i){const p=K(n,i),d=K(h,i);return+p==+d}function Le(n){return Mt(n,Ve(n))}function Ie(n,h){return Bt(n,Ve(n),h)}function Ut(n,h){return He(n,-1)}const ye="custom";function Kt({open:n,onOpenChange:h,appointment:i,patients:p=[],services:d=[],nutritionistId:k,preSelectedDate:N,onSave:E}){const[l,y]=x.useState({patient_id:"",appointment_time_date:N?m(N,"yyyy-MM-dd"):m(new Date,"yyyy-MM-dd"),appointment_time_hour:"",duration:60,appointment_type:"first_appointment",status:"scheduled",notes:"",service_id:"",use_custom_price:!1,custom_price:"",custom_description:""}),[o,v]=x.useState(""),[A,C]=x.useState(!1),S=p.filter(s=>s.name.toLowerCase().includes(o.toLowerCase())).slice(0,5),_=[{value:"first_appointment",label:"Primeira Consulta"},{value:"return",label:"Retorno"},{value:"evaluation",label:"Avalia√ß√£o"},{value:"online",label:"Online"},{value:"in_person",label:"Presencial"}],O=[{value:"scheduled",label:"Agendada"},{value:"confirmed",label:"Confirmada"},{value:"completed",label:"Realizada"},{value:"canceled",label:"Cancelada"},{value:"no_show",label:"Faltou"}],L=[{value:30,label:"30 minutos"},{value:45,label:"45 minutos"},{value:60,label:"1 hora"},{value:90,label:"1h 30min"},{value:120,label:"2 horas"}];x.useEffect(()=>{if(i){const s=i.start_time||i.appointment_time;if(y({patient_id:i.patient_id||"",appointment_time_date:s?m(new Date(s),"yyyy-MM-dd"):m(new Date,"yyyy-MM-dd"),appointment_time_hour:s?m(new Date(s),"HH:mm"):"",duration:i.duration||60,appointment_type:i.appointment_type||"first_appointment",status:i.status||"scheduled",notes:i.notes||"",service_id:"",use_custom_price:!1,custom_price:"",custom_description:""}),i.patient_id){const c=p.find(q=>q.id===i.patient_id);c&&v(c.name)}}else y({patient_id:"",appointment_time_date:N?m(N,"yyyy-MM-dd"):m(new Date,"yyyy-MM-dd"),appointment_time_hour:"",duration:60,appointment_type:"first_appointment",status:"scheduled",notes:"",service_id:"",use_custom_price:!1,custom_price:"",custom_description:""}),v("")},[i,n,N,p]);const f=s=>{s===ye?y(c=>({...c,service_id:"",use_custom_price:!0})):(d.find(c=>c.id.toString()===s),y(c=>({...c,service_id:s,use_custom_price:!1,custom_price:"",custom_description:""})))},ie=s=>{if(s.preventDefault(),!l.patient_id||!l.appointment_time_date||!l.appointment_time_hour)return;const[c,q,$]=l.appointment_time_date.split("-").map(Number),[ae,oe]=l.appointment_time_hour.split(":").map(Number),ee=new Date(c,q-1,$,ae,oe),le={...i,patient_id:l.patient_id,appointment_time:ee.toISOString(),notes:l.notes,duration:l.duration,appointment_type:l.appointment_type,status:l.status},H={service_id:l.use_custom_price?null:l.service_id||null,custom_price:l.use_custom_price?l.custom_price:null,custom_description:l.use_custom_price?l.custom_description:null};E(le,H)},D=d.find(s=>s.id.toString()===l.service_id);return e.jsx(je,{open:n,onOpenChange:h,children:e.jsxs(ve,{className:"w-[calc(100vw-2rem)] max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(we,{children:e.jsx(_e,{children:i?"Editar Agendamento":"Novo Agendamento"})}),e.jsxs("form",{onSubmit:ie,className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(M,{htmlFor:"patient_search",children:"Paciente *"}),e.jsxs("div",{className:"relative",children:[e.jsx(be,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(J,{id:"patient_search",type:"text",placeholder:"Buscar paciente pelo nome...",value:o,onChange:s=>{v(s.target.value),C(!0),s.target.value||y(c=>({...c,patient_id:""}))},onFocus:()=>C(!0),className:"pl-9",required:!l.patient_id})]}),A&&o&&S.length>0&&e.jsx("div",{className:"absolute z-50 w-full mt-1 bg-popover border rounded-md shadow-lg max-h-60 overflow-auto",children:S.map(s=>e.jsx("button",{type:"button",className:"w-full text-left px-3 py-2 hover:bg-accent hover:text-accent-foreground text-sm",onClick:()=>{y(c=>({...c,patient_id:s.id})),v(s.name),C(!1)},children:s.name},s.id))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(M,{htmlFor:"date",children:"Data *"}),e.jsx(At,{id:"date",required:!0,value:l.appointment_time_date,onChange:s=>y(c=>({...c,appointment_time_date:s}))})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"time",children:"Hora *"}),e.jsx(Tt,{id:"time",required:!0,value:l.appointment_time_hour,onChange:s=>y(c=>({...c,appointment_time_hour:s}))})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(M,{htmlFor:"duration",children:"Dura√ß√£o *"}),e.jsxs(X,{required:!0,value:String(l.duration),onValueChange:s=>y(c=>({...c,duration:Number(s)})),children:[e.jsx(G,{children:e.jsx(Q,{})}),e.jsx(Y,{children:L.map(s=>e.jsx(F,{value:String(s.value),children:s.label},s.value))})]})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"appointment_type",children:"Tipo *"}),e.jsxs(X,{required:!0,value:l.appointment_type,onValueChange:s=>y(c=>({...c,appointment_type:s})),children:[e.jsx(G,{children:e.jsx(Q,{})}),e.jsx(Y,{children:_.map(s=>e.jsx(F,{value:s.value,children:s.label},s.value))})]})]})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"status",children:"Status *"}),e.jsxs(X,{required:!0,value:l.status,onValueChange:s=>y(c=>({...c,status:s})),children:[e.jsx(G,{children:e.jsx(Q,{})}),e.jsx(Y,{children:O.map(s=>e.jsx(F,{value:s.value,children:s.label},s.value))})]})]}),!i&&e.jsxs("div",{className:"border-t pt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx(M,{className:"text-base font-semibold",children:"Informa√ß√µes Financeiras"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Selecione um servi√ßo padr√£o ou defina um valor personalizado"})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"service",children:"Servi√ßo"}),e.jsxs(X,{value:l.use_custom_price?ye:l.service_id||"",onValueChange:f,children:[e.jsx(G,{children:e.jsx(Q,{placeholder:"Selecione um servi√ßo ou valor personalizado"})}),e.jsxs(Y,{children:[d.map(s=>e.jsxs(F,{value:s.id.toString(),children:[s.name," - ",Me(s.price)]},s.id)),e.jsx(F,{value:ye,children:"üí∞ Valor Personalizado / Outro"})]})]})]}),l.use_custom_price?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx(M,{htmlFor:"custom_price",children:"Valor Personalizado (R$) *"}),e.jsx(J,{id:"custom_price",type:"number",step:"0.01",min:"0",required:l.use_custom_price,value:l.custom_price,onChange:s=>y(c=>({...c,custom_price:s.target.value})),placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"custom_description",children:"Descri√ß√£o do Servi√ßo"}),e.jsx(J,{id:"custom_description",value:l.custom_description,onChange:s=>y(c=>({...c,custom_description:s.target.value})),placeholder:"Ex: Consulta especializada"})]})]}):D?e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Valor do servi√ßo:"}),e.jsx("p",{className:"text-lg font-semibold text-primary",children:Me(D.price)})]}):null]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"notes",children:"Observa√ß√µes"}),e.jsx(J,{id:"notes",value:l.notes,onChange:s=>y(c=>({...c,notes:s.target.value})),placeholder:"Informa√ß√µes adicionais (opcional)"})]}),e.jsxs($e,{children:[e.jsx(j,{type:"button",variant:"outline",onClick:()=>h(!1),children:"Cancelar"}),e.jsx(j,{type:"submit",children:i?"Atualizar":"Salvar"})]})]})]})})}const Re=async(n,h=!1)=>{try{const{data:i,error:p}=await z.rpc("sync_appointment_notification_schedule",{p_appointment_id:n,p_force_reschedule:h});if(p)throw p;return{data:i,error:null}}catch(i){return P("Erro ao sincronizar notifica√ß√µes da consulta",i),{data:null,error:i}}},Jt=async({appointmentId:n,nextStatus:h,reason:i=null})=>{try{const{data:p,error:d}=await z.rpc("transition_appointment_status",{p_appointment_id:n,p_next_status:h,p_reason:i});if(d)throw d;return{data:p,error:null}}catch(p){return P("Erro ao transicionar status da consulta",p),{data:null,error:p}}},Xt="scheduled",Gt={awaiting_confirmation:"scheduled",cancelled:"canceled",no_show:"canceled"},We=n=>!n||typeof n!="string"?Xt:Gt[n]||n,qe=n=>{if(!n)return null;const h=new Date(n);return Number.isNaN(h.getTime())?null:h.toISOString()},Be=(n={})=>{const h=n.start_time||n.appointment_time,i=Number(n.duration||60),p=qe(h),d=p?new Date(new Date(p).getTime()+i*6e4).toISOString():null,k=qe(n.end_time)||d;return{nutritionist_id:n.nutritionist_id,patient_id:n.patient_id||null,title:n.title||n.appointment_type||"Consulta",start_time:p,end_time:k,notes:n.notes||null,status:We(n.status)}},Qt=n=>["completed","canceled","no_show"].includes(n);async function Yt(n,h){const i=Date.now(),{nutritionist_id:p,patient_id:d,appointment_time:k}=n,{service_id:N,custom_price:E,custom_description:l}=h,y=Be(n),{data:o,error:v}=await z.from("appointments").insert(y).select().single();if(v)throw P("Error creating appointment",v),await Z({module:"agenda",operation:"create_appointment_with_finance",eventType:"error",latencyMs:Date.now()-i,nutritionistId:p||null,patientId:d||null,errorMessage:v?.message||String(v)}),v;const A=await Re(o.id,!0);A.error&&P("Erro ao sincronizar notifica√ß√µes da consulta ap√≥s cria√ß√£o",A.error);const{data:C}=await z.from("user_profiles").select("name").eq("id",d).single(),S=C?.name||"Paciente";let _=0,O="";if(N){const{data:f}=await z.from("services").select("name, price, category").eq("id",N).single();f&&(_=parseFloat(f.price),O=`Agendamento: ${S} - ${f.name}`)}else E&&(_=parseFloat(E),O=l?`Agendamento: ${S} - ${l}`:`Agendamento: ${S}`);let L=null;if(_>0&&O)try{const f=new Date(y.start_time||k);L=await Ft({nutritionist_id:p,patient_id:d,type:"income",category:N?"consulta":"outros",description:O,amount:_,transaction_date:m(f,"yyyy-MM-dd"),status:"pending",due_date:m(f,"yyyy-MM-dd")})}catch(f){P("Error creating financial transaction",f)}return await Z({module:"agenda",operation:"create_appointment_with_finance",eventType:"success",latencyMs:Date.now()-i,nutritionistId:p||null,patientId:d||null,metadata:{has_financial_transaction:!!L}}),{appointment:o,transaction:L}}async function Zt(n,h){const i=Date.now(),p=h?.nutritionist_id||null,d=h?.patient_id||null,k=We(h?.status),{data:N,error:E}=await z.from("appointments").select("status").eq("id",n).single();if(E)throw P("Error loading current appointment status",E),await Z({module:"agenda",operation:"update_appointment",eventType:"error",latencyMs:Date.now()-i,nutritionistId:p,patientId:d,errorMessage:E?.message||String(E)}),E;const l=Be({...h,status:N?.status||k}),{status:y,...o}=l,{data:v,error:A}=await z.from("appointments").update(o).eq("id",n).select().single();if(A)throw P("Error updating appointment",A),await Z({module:"agenda",operation:"update_appointment",eventType:"error",latencyMs:Date.now()-i,nutritionistId:p,patientId:d,errorMessage:A?.message||String(A)}),A;if(k&&k!==N?.status){const _=await Jt({appointmentId:n,nextStatus:k,reason:h?.cancellation_reason||null});if(_.error)throw _.error}else if(!Qt(N?.status)){const _=await Re(n,!0);_.error&&P("Erro ao sincronizar notifica√ß√µes da consulta ap√≥s atualiza√ß√£o",_.error)}const{data:C,error:S}=await z.from("appointments").select("*").eq("id",n).single();if(S)throw P("Error fetching refreshed appointment",S),await Z({module:"agenda",operation:"update_appointment",eventType:"error",latencyMs:Date.now()-i,nutritionistId:p,patientId:d,errorMessage:S?.message||String(S)}),S;return await Z({module:"agenda",operation:"update_appointment",eventType:"success",latencyMs:Date.now()-i,nutritionistId:C?.nutritionist_id||p,patientId:C?.patient_id||d,metadata:{status:C?.status||k||null}}),C}function za(){const{user:n,signOut:h}=ct(),{toast:i}=dt(),p=mt(),[d,k]=x.useState([]),[N,E]=x.useState([]),[l,y]=x.useState([]),[o,v]=x.useState(null),[A,C]=x.useState(!1),[S,_]=x.useState(null),[O,L]=x.useState(!0),[f,ie]=x.useState("all"),[D,s]=x.useState(""),[c,q]=x.useState(!1),[$,ae]=x.useState(null),[oe,ee]=x.useState(!1),[le,H]=x.useState(!1),[te,Ue]=x.useState("week"),[V,ce]=x.useState(K(new Date,{locale:b})),[R,de]=x.useState(new Date),Ne=x.useCallback(t=>{const a=t?.start_time||t?.appointment_time||null,r=a?new Date(a):null,u=t?.end_time?new Date(t.end_time):null,g=r&&u?Math.max(1,Math.round((u.getTime()-r.getTime())/6e4)):null;return{...t,appointment_time:a,duration:Number(t?.duration||g||60)}},[]),se=x.useCallback(async()=>{if(!n)return;L(!0);const{data:t,error:a}=await z.from("appointments").select("*, patient:user_profiles!appointments_patient_id_fkey(name, id)").eq("nutritionist_id",n.id).limit(1e3);a?i({title:"Erro",description:a.message,variant:"destructive"}):k((t||[]).map(Ne));const{data:r,error:u}=await z.from("user_profiles").select("id, name").eq("nutritionist_id",n.id).limit(500);u?i({title:"Erro",description:"N√£o foi poss√≠vel carregar os pacientes.",variant:"destructive"}):E(r||[]);try{const g=await zt(n.id);y(g||[])}catch(g){console.error("Error loading services:",g),y([])}L(!1)},[n,i,Ne]);x.useEffect(()=>{se()},[se]);const Ke=async(t,a)=>{const{patient_id:r,appointment_time:u,notes:g,duration:w,appointment_type:B,status:U}=t,Se=new Date(u),ot=new Date(Se.getTime()+w*6e4);if(d.some(I=>{if(t.id&&I.id===t.id)return!1;const ue=new Date(I.appointment_time),pe=new Date(ue.getTime()+(I.duration||60)*6e4);return Se<pe&&ot>ue})){i({title:"Conflito de Hor√°rio",description:"J√° existe um agendamento neste hor√°rio. Por favor, escolha outro hor√°rio.",variant:"destructive"});return}try{if(t.id)await Zt(t.id,{patient_id:r,appointment_time:u,notes:g,duration:w||60,appointment_type:B||"first_appointment",status:U||"scheduled"}),i({title:"Sucesso!",description:"Agendamento atualizado com sucesso."});else{const I={nutritionist_id:n.id,patient_id:r,appointment_time:u,notes:g,duration:w||60,appointment_type:B||"first_appointment",status:U||"scheduled"},{appointment:ue,transaction:pe}=await Yt(I,a);i(pe?{title:"Sucesso!",description:"Agendamento criado e registro financeiro gerado automaticamente."}:{title:"Sucesso!",description:"Agendamento criado com sucesso."})}C(!1),_(null),se()}catch(I){console.error("Error saving appointment:",I),i({title:"Erro",description:Ct(I,"N√£o foi poss√≠vel salvar o agendamento."),variant:"destructive"})}},Je=t=>{ae(t),q(!0)},Xe=async()=>{if(!$)return;const{error:t}=await z.from("appointments").delete().eq("id",$.id);t?i({title:"Erro",description:"N√£o foi poss√≠vel deletar o agendamento.",variant:"destructive"}):(i({title:"Sucesso!",description:"Agendamento deletado com sucesso."}),se()),q(!1),ae(null)},Ce=x.useMemo(()=>{const t=new Date;let a=[...d].sort((r,u)=>new Date(r.appointment_time)-new Date(u.appointment_time));if(o)a=a.filter(r=>Pe(new Date(r.appointment_time),o));else switch(f){case"today":a=a.filter(r=>T(new Date(r.appointment_time)));break;case"week":a=a.filter(r=>Ie(new Date(r.appointment_time),{locale:b}));break;case"month":a=a.filter(r=>Le(new Date(r.appointment_time)));break;default:a=a.filter(r=>new Date(r.appointment_time)>=ut(t))}if(D.trim()){const r=D.toLowerCase();a=a.filter(u=>u.patient?.name?.toLowerCase().includes(r))}return a},[d,f,o,D]),De=x.useMemo(()=>{const t={};return Ce.forEach(a=>{const r=m(new Date(a.appointment_time),"yyyy-MM-dd");t[r]||(t[r]=[]),t[r].push(a)}),t},[Ce]),W=x.useMemo(()=>{const t={};return d.forEach(a=>{const r=m(new Date(a.appointment_time),"yyyy-MM-dd");t[r]=(t[r]||0)+1}),t},[d]),Ge=t=>{const a={scheduled:{label:"Agendada",variant:"outline",color:"text-blue-600 bg-blue-50"},confirmed:{label:"Confirmada",variant:"default",color:"text-green-600 bg-green-50"},awaiting_confirmation:{label:"Aguardando",variant:"secondary",color:"text-yellow-600 bg-yellow-50"},completed:{label:"Realizada",variant:"secondary",color:"text-gray-600 bg-gray-100"},canceled:{label:"Cancelada",variant:"destructive",color:"text-red-600 bg-red-50"},cancelled:{label:"Cancelada",variant:"destructive",color:"text-red-600 bg-red-50"},no_show:{label:"Faltou",variant:"destructive",color:"text-orange-600 bg-orange-50"}};return a[t]||a.scheduled},Qe=t=>{const a={first_appointment:{label:"Primeira Consulta"},return:{label:"Retorno"},evaluation:{label:"Avalia√ß√£o"},online:{label:"Online"},in_person:{label:"Presencial"}};return a[t]||a.first_appointment},Ye=(t,a)=>{const r=new Date(new Date(t).getTime()+(a||60)*6e4);return m(r,"HH:mm")},Ze=t=>{const[a,r,u]=t.split("-").map(Number),g=new Date(a,r-1,u),w=m(g,"EEEE",{locale:b}),B=w.charAt(0).toUpperCase()+w.slice(1),U=m(g,"dd 'de' MMMM",{locale:b});return T(g)?`Hoje ‚Ä¢ ${B}, ${U}`:Ht(g)?`Amanh√£ ‚Ä¢ ${B}, ${U}`:`${B}, ${U}`},et=()=>{v(Dt(o||new Date,1))},tt=()=>{v(St(o||new Date,1))},at=()=>{v(new Date)},st=()=>{v(null)},nt=t=>{o&&Pe(t,o)?v(null):v(t)},rt=t=>{v(t),ee(!1)},me=t=>t>=5?"text-secondary font-bold":t>=3?"text-yellow-600 font-bold":t>=1?"text-primary font-bold":"text-muted-foreground font-bold",it=async()=>{try{let t="",a=[],r,u;if(te==="week"?(r=K(V,{locale:b}),u=Te(V,{locale:b}),t=`Semana de ${m(r,"dd/MM")} a ${m(u,"dd/MM/yyyy")}`,a=d.filter(g=>{const w=new Date(g.appointment_time);return w>=r&&w<=u}).sort((g,w)=>new Date(g.appointment_time)-new Date(w.appointment_time))):(r=kt(R),u=Wt(R),t=m(R,"MMMM 'de' yyyy",{locale:b}),t=t.charAt(0).toUpperCase()+t.slice(1),a=d.filter(g=>{const w=new Date(g.appointment_time);return w>=r&&w<=u}).sort((g,w)=>new Date(g.appointment_time)-new Date(w.appointment_time))),a.length===0){i({title:"Sem agendamentos",description:`N√£o h√° agendamentos para ${t.toLowerCase()}.`,variant:"default"});return}await Et(a,te,t,n?.profile?.name||n?.email?.split("@")[0]||null),i({title:"PDF gerado!",description:`Agenda exportada com sucesso (${a.length} consultas).`}),H(!1)}catch(t){console.error("Erro ao exportar PDF:",t),i({title:"Erro ao exportar",description:"N√£o foi poss√≠vel gerar o PDF. Tente novamente.",variant:"destructive"})}};return e.jsx("div",{className:"min-h-screen bg-background overflow-x-hidden",children:e.jsxs(pt.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"max-w-7xl mx-auto w-full px-4 md:px-8 pt-4 md:pt-8 min-w-0 overflow-x-hidden",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6 md:mb-8 text-center sm:text-left",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("h2",{className:"text-2xl md:text-3xl font-bold font-heading uppercase tracking-wide text-primary break-words",children:"Agenda de Consultas"}),e.jsx("p",{className:"text-neutral-600 mt-1 text-sm md:text-base",children:"Visualize e gerencie todos os seus agendamentos."})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap justify-center sm:justify-end",children:[e.jsxs(j,{variant:"outline",onClick:()=>H(!0),className:"border-primary text-primary hover:bg-primary hover:text-white",children:[e.jsx(Oe,{className:"w-4 h-4 mr-2"})," Exportar PDF"]}),e.jsxs(j,{onClick:()=>{_(null),C(!0)},className:"bg-primary hover:bg-primary/90",children:[e.jsx(Pt,{className:"w-4 h-4 mr-2"})," Novo Agendamento"]})]})]}),e.jsx("div",{className:"lg:hidden mb-6",children:e.jsx(ne,{className:"bg-card shadow-card-dark rounded-xl overflow-hidden",children:e.jsxs(re,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx(j,{variant:"outline",size:"icon",onClick:et,className:"h-10 w-10 flex-shrink-0",children:e.jsx(fe,{className:"w-5 h-5"})}),e.jsx("div",{className:"flex-1 text-center",children:o?e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-primary",children:m(o,"dd 'de' MMMM",{locale:b})}),e.jsx("p",{className:"text-xs text-muted-foreground capitalize",children:m(o,"EEEE",{locale:b})})]}):e.jsx("p",{className:"text-sm font-semibold text-muted-foreground",children:"Todos os agendamentos"})}),e.jsx(j,{variant:"outline",size:"icon",onClick:tt,className:"h-10 w-10 flex-shrink-0",children:e.jsx(xe,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[e.jsx(j,{variant:o&&T(o)?"default":"outline",size:"sm",onClick:at,className:"flex-1",children:"Hoje"}),e.jsxs(j,{variant:"outline",size:"sm",onClick:()=>ee(!0),className:"flex-1",children:[e.jsx(Ot,{className:"w-4 h-4 mr-1.5"}),"Calend√°rio"]}),o&&e.jsx(j,{variant:"outline",size:"sm",onClick:st,className:"flex-1",children:"Ver Todos"})]})]})})}),e.jsx(je,{open:oe,onOpenChange:ee,children:e.jsxs(ve,{className:"max-w-sm",children:[e.jsxs(we,{children:[e.jsx(_e,{children:"Selecionar Data"}),e.jsx(ke,{children:"Escolha uma data para ver os agendamentos"})]}),e.jsx("div",{className:"flex justify-center py-4",children:e.jsx(Ae,{mode:"single",selected:o,onSelect:rt,className:"rounded-md border",locale:b,modifiers:{today:t=>T(t),highLoad:t=>(W[m(t,"yyyy-MM-dd")]||0)>=5&&!T(t),mediumLoad:t=>{const a=W[m(t,"yyyy-MM-dd")]||0;return a>=3&&a<5&&!T(t)},lowLoad:t=>{const a=W[m(t,"yyyy-MM-dd")]||0;return a>=1&&a<3&&!T(t)}},modifiersClassNames:{today:"bg-primary text-white font-bold ring-2 ring-primary ring-offset-2 hover:bg-primary",highLoad:"bg-secondary/80 text-white font-bold hover:bg-secondary",mediumLoad:"bg-yellow-400/70 text-yellow-900 font-bold hover:bg-yellow-400",lowLoad:"bg-primary/30 text-primary font-bold hover:bg-primary/40"}})}),e.jsxs("div",{className:"space-y-2 pb-2",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground px-2",children:"Legenda:"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-xs px-2",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-3 h-3 rounded bg-primary/30 flex-shrink-0"}),e.jsx("span",{className:"text-muted-foreground",children:"1-2"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-3 h-3 rounded bg-yellow-400/70 flex-shrink-0"}),e.jsx("span",{className:"text-muted-foreground",children:"3-4"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-3 h-3 rounded bg-secondary/80 flex-shrink-0"}),e.jsx("span",{className:"text-muted-foreground",children:"5+"})]})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-10 gap-6",children:[e.jsx("div",{className:"lg:col-span-7 order-1 min-w-0",children:e.jsxs(ne,{className:"bg-card shadow-card-dark rounded-xl overflow-hidden",children:[e.jsx(he,{className:"pb-3",children:e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{children:[e.jsx(ge,{className:"font-heading text-base lg:text-lg font-semibold text-primary",children:"Agendamentos"}),e.jsxs(Ee,{className:"text-xs lg:text-sm",children:[o&&`Agendamentos de ${m(o,"dd/MM/yyyy")}`,!o&&f==="all"&&"Todos os pr√≥ximos agendamentos",!o&&f==="today"&&"Agendamentos de hoje",!o&&f==="week"&&"Agendamentos desta semana",!o&&f==="month"&&"Agendamentos deste m√™s"]})]}),e.jsxs("div",{className:"hidden lg:flex flex-col sm:flex-row gap-3",children:[e.jsxs(X,{value:f,onValueChange:ie,disabled:!!o,children:[e.jsxs(G,{className:"w-full sm:w-[180px]",children:[e.jsx(Lt,{className:"w-4 h-4 mr-2"}),e.jsx(Q,{})]}),e.jsxs(Y,{children:[e.jsx(F,{value:"all",children:"Todos"}),e.jsx(F,{value:"today",children:"Hoje"}),e.jsx(F,{value:"week",children:"Esta Semana"}),e.jsx(F,{value:"month",children:"Este M√™s"})]})]}),e.jsxs("div",{className:"relative flex-1",children:[e.jsx(be,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(J,{placeholder:"Buscar paciente...",value:D,onChange:t=>s(t.target.value),className:"pl-9"})]}),(D||o)&&e.jsxs(j,{variant:"outline",size:"sm",onClick:()=>{s(""),v(null)},className:"w-full sm:w-auto",children:[e.jsx(xt,{className:"w-4 h-4 mr-2"}),"Limpar Filtros"]})]}),e.jsxs("div",{className:"lg:hidden relative",children:[e.jsx(be,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(J,{placeholder:"Buscar paciente...",value:D,onChange:t=>s(t.target.value),className:"pl-9"})]})]})}),e.jsx(re,{className:"p-3 lg:p-6",children:O?e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx("p",{className:"text-muted-foreground text-sm",children:"Carregando agendamentos..."})}):Object.keys(De).length>0?e.jsx("div",{className:"space-y-4 lg:space-y-6",children:Object.entries(De).map(([t,a])=>e.jsxs("div",{className:"space-y-2 lg:space-y-3",children:[!o&&e.jsxs("div",{className:"flex items-center gap-2 lg:gap-3 pb-2 border-b",children:[e.jsx(ze,{className:"w-4 h-4 lg:w-5 lg:h-5 text-primary flex-shrink-0"}),e.jsx("h3",{className:"font-semibold text-sm lg:text-base text-foreground capitalize truncate",children:Ze(t)}),e.jsx(Fe,{variant:"secondary",className:`ml-auto text-xs whitespace-nowrap border-0 ${a.length>=5?"bg-secondary/80 text-white":a.length>=3?"bg-yellow-400/70 text-yellow-900":"bg-primary/30 text-primary"}`,children:a.length})]}),e.jsx("div",{className:"space-y-2 lg:space-y-3",children:a.map(r=>{const u=Ge(r.status||"scheduled"),g=Qe(r.appointment_type||"first_appointment"),w=Ye(r.appointment_time,r.duration);return e.jsxs("div",{className:"flex items-center gap-2 lg:gap-4 p-2.5 lg:p-4 bg-muted/30 hover:bg-muted/50 rounded-lg border border-border/50 transition-all hover:shadow-md",children:[e.jsxs("div",{className:"flex flex-col items-center justify-center bg-primary/10 px-2 lg:px-3 py-1.5 lg:py-2 rounded-lg min-w-[55px] lg:min-w-[70px] flex-shrink-0",children:[e.jsx(It,{className:"w-3 h-3 lg:w-4 lg:h-4 mb-0.5 lg:mb-1 text-primary"}),e.jsx("span",{className:"text-xs lg:text-sm font-bold text-primary",children:m(new Date(r.appointment_time),"HH:mm")}),e.jsx("span",{className:"text-[10px] lg:text-xs text-muted-foreground",children:w})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1.5 lg:gap-2 mb-0.5",children:[e.jsx(ht,{className:"w-3.5 h-3.5 lg:w-4 lg:h-4 text-muted-foreground flex-shrink-0"}),e.jsx("p",{className:"font-semibold text-sm lg:text-base text-foreground truncate",children:r.patient?.name||"Paciente n√£o identificado"})]}),e.jsxs("div",{className:"flex items-center gap-1.5 flex-wrap",children:[e.jsx(Fe,{className:`text-xs ${u.color} border-0`,children:u.label}),e.jsx("span",{className:"text-xs text-muted-foreground",children:g.label}),r.notes&&e.jsxs("p",{className:"text-xs text-muted-foreground line-clamp-1 hidden lg:block",children:["‚Ä¢ ",r.notes]})]})]}),e.jsxs("div",{className:"flex gap-1 lg:gap-2 flex-shrink-0",children:[e.jsx(j,{variant:"ghost",size:"icon",onClick:()=>p(`/nutritionist/patients/${r.patient_id}/hub`),className:"h-8 w-8 lg:h-9 lg:w-9 hover:bg-blue-50 hover:text-blue-600",title:"Ver detalhes do paciente",children:e.jsx(qt,{className:"w-3.5 h-3.5 lg:w-4 lg:h-4"})}),e.jsx(j,{variant:"ghost",size:"icon",onClick:()=>{_(r),C(!0)},className:"h-8 w-8 lg:h-9 lg:w-9 hover:bg-primary/10 hover:text-primary",title:"Editar agendamento",children:e.jsx($t,{className:"w-3.5 h-3.5 lg:w-4 lg:h-4"})}),e.jsx(j,{variant:"ghost",size:"icon",className:"h-8 w-8 lg:h-9 lg:w-9 text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>Je(r),title:"Excluir agendamento",children:e.jsx(gt,{className:"w-3.5 h-3.5 lg:w-4 lg:h-4"})})]})]},r.id)})})]},t))}):e.jsxs("div",{className:"flex flex-col items-center justify-center py-8 lg:py-12 text-center",children:[e.jsx(ze,{className:"w-12 h-12 lg:w-16 lg:h-16 text-muted-foreground/50 mb-3 lg:mb-4"}),e.jsx("p",{className:"text-muted-foreground font-medium text-sm lg:text-base mb-1 lg:mb-2",children:"Nenhum agendamento encontrado"}),e.jsxs("p",{className:"text-xs lg:text-sm text-muted-foreground",children:[D&&"Nenhum agendamento encontrado para esta busca",!D&&o&&"N√£o h√° consultas agendadas para este dia",!D&&!o&&f==="all"&&"Adicione um novo agendamento para come√ßar",!D&&!o&&f==="today"&&"N√£o h√° consultas agendadas para hoje",!D&&!o&&f==="week"&&"N√£o h√° consultas agendadas para esta semana",!D&&!o&&f==="month"&&"N√£o h√° consultas agendadas para este m√™s"]})]})})]})}),e.jsxs("div",{className:"hidden lg:block lg:col-span-3 order-2 space-y-6",children:[e.jsxs(ne,{className:"bg-card shadow-card-dark rounded-xl",children:[e.jsxs(he,{className:"pb-3",children:[e.jsx(ge,{className:"font-heading text-lg font-semibold text-primary",children:"Calend√°rio"}),e.jsx(Ee,{className:"text-xs",children:"Clique em um dia para filtrar ‚Ä¢ Clique novamente para limpar"})]}),e.jsxs(re,{className:"flex flex-col items-center p-0 pb-3",children:[e.jsx("div",{className:"w-full flex justify-center",children:e.jsx(Ae,{mode:"single",selected:o,onSelect:nt,className:"w-fit",locale:b,modifiers:{today:t=>T(t),highLoad:t=>(W[m(t,"yyyy-MM-dd")]||0)>=5&&!T(t),mediumLoad:t=>{const a=W[m(t,"yyyy-MM-dd")]||0;return a>=3&&a<5&&!T(t)},lowLoad:t=>{const a=W[m(t,"yyyy-MM-dd")]||0;return a>=1&&a<3&&!T(t)}},modifiersClassNames:{today:"bg-primary text-white font-bold ring-2 ring-primary ring-offset-2 hover:bg-primary",highLoad:"bg-secondary/80 text-white font-bold hover:bg-secondary",mediumLoad:"bg-yellow-400/70 text-yellow-900 font-bold hover:bg-yellow-400",lowLoad:"bg-primary/30 text-primary font-bold hover:bg-primary/40"}})}),e.jsxs("div",{className:"w-full px-4 mt-3 border-t pt-3",children:[e.jsx("p",{className:"text-xs font-semibold text-muted-foreground mb-2",children:"Legenda:"}),e.jsxs("div",{className:"flex items-center gap-3 text-xs flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-3 h-3 rounded bg-primary/30 flex-shrink-0"}),e.jsx("span",{className:"text-muted-foreground whitespace-nowrap",children:"1-2"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-3 h-3 rounded bg-yellow-400/70 flex-shrink-0"}),e.jsx("span",{className:"text-muted-foreground whitespace-nowrap",children:"3-4"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-3 h-3 rounded bg-secondary/80 flex-shrink-0"}),e.jsx("span",{className:"text-muted-foreground whitespace-nowrap",children:"5+"})]})]})]})]})]}),e.jsxs(ne,{className:"bg-card shadow-card-dark rounded-xl",children:[e.jsx(he,{className:"pb-3",children:e.jsx(ge,{className:"font-heading text-lg font-semibold text-primary",children:"Resumo"})}),e.jsx(re,{className:"space-y-3",children:(()=>{const t=d.filter(u=>T(new Date(u.appointment_time))).length,a=d.filter(u=>Ie(new Date(u.appointment_time),{locale:b})).length,r=d.filter(u=>Le(new Date(u.appointment_time))).length;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 rounded-lg",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Hoje"}),e.jsx("span",{className:me(t),children:t})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 rounded-lg",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Esta Semana"}),e.jsx("span",{className:me(a),children:a})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 rounded-lg",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Este M√™s"}),e.jsx("span",{className:me(r),children:r})]})]})})()})]})]})]}),e.jsx(je,{open:le,onOpenChange:H,children:e.jsxs(ve,{className:"sm:max-w-md",children:[e.jsxs(we,{children:[e.jsx(_e,{children:"Exportar Agenda em PDF"}),e.jsx(ke,{children:"Selecione o per√≠odo que deseja exportar"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{children:[e.jsx(M,{htmlFor:"period-type",children:"Per√≠odo"}),e.jsxs(X,{value:te,onValueChange:Ue,children:[e.jsx(G,{id:"period-type",children:e.jsx(Q,{})}),e.jsxs(Y,{children:[e.jsx(F,{value:"week",children:"Semana"}),e.jsx(F,{value:"month",children:"M√™s"})]})]})]}),te==="week"&&e.jsxs("div",{children:[e.jsx(M,{children:"Selecionar Semana"}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx(j,{type:"button",variant:"outline",size:"icon",onClick:()=>ce(Ut(V)),children:e.jsx(fe,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex-1 text-center text-sm font-medium",children:[m(K(V,{locale:b}),"dd/MM")," a"," ",m(Te(V,{locale:b}),"dd/MM/yyyy")]}),e.jsx(j,{type:"button",variant:"outline",size:"icon",onClick:()=>ce(He(V,1)),children:e.jsx(xe,{className:"w-4 h-4"})})]}),e.jsx(j,{type:"button",variant:"ghost",size:"sm",onClick:()=>ce(K(new Date,{locale:b})),className:"w-full mt-2 text-xs",children:"Semana Atual"})]}),te==="month"&&e.jsxs("div",{children:[e.jsx(M,{children:"Selecionar M√™s"}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx(j,{type:"button",variant:"outline",size:"icon",onClick:()=>de(Vt(R,1)),children:e.jsx(fe,{className:"w-4 h-4"})}),e.jsx("div",{className:"flex-1 text-center text-sm font-medium capitalize",children:m(R,"MMMM 'de' yyyy",{locale:b})}),e.jsx(j,{type:"button",variant:"outline",size:"icon",onClick:()=>de(Rt(R,1)),children:e.jsx(xe,{className:"w-4 h-4"})})]}),e.jsx(j,{type:"button",variant:"ghost",size:"sm",onClick:()=>de(new Date),className:"w-full mt-2 text-xs",children:"M√™s Atual"})]})]}),e.jsxs($e,{children:[e.jsx(j,{type:"button",variant:"outline",onClick:()=>H(!1),children:"Cancelar"}),e.jsxs(j,{type:"button",onClick:it,className:"bg-primary",children:[e.jsx(Oe,{className:"w-4 h-4 mr-2"}),"Exportar"]})]})]})}),e.jsx(Kt,{open:A,onOpenChange:C,appointment:S,patients:N,services:l,nutritionistId:n?.id,preSelectedDate:o,onSave:Ke}),e.jsx(ft,{open:c,onOpenChange:q,children:e.jsxs(yt,{children:[e.jsxs(jt,{children:[e.jsx(vt,{children:"Confirmar Exclus√£o"}),e.jsxs(wt,{children:["Tem certeza que deseja excluir o agendamento de"," ",e.jsx("strong",{children:$?.patient?.name})," para"," ",e.jsx("strong",{children:$&&m(new Date($.appointment_time),"dd/MM/yyyy '√†s' HH:mm")}),"?",e.jsx("br",{}),e.jsx("br",{}),"Esta a√ß√£o n√£o pode ser desfeita."]})]}),e.jsxs(_t,{children:[e.jsx(bt,{children:"Cancelar"}),e.jsx(Nt,{onClick:Xe,className:"bg-destructive hover:bg-destructive/90",children:"Excluir"})]})]})})]})})}export{za as default};
