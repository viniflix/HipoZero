import{s as o}from"./index-BvWB-6Y-.js";import{f as p}from"./date-C2sroe8F.js";import{l as u}from"./query-helpers-mbysFH2_.js";const m={none:0,low:1,medium:2,high:3},_={risk_level:"none",risk_reason:null,marker_key:null};async function D(t,e=50){try{const{data:r,error:a}=await o.from("lab_results").select("*").eq("patient_id",t).order("test_date",{ascending:!1}).limit(e);return{data:r,error:a}}catch(r){return u("Erro ao buscar exames",r),{data:null,error:r}}}async function N(t){try{const e=new Date;e.setDate(e.getDate()-30);const r=p(e),{data:a,error:n}=await o.from("lab_results").select("*").eq("patient_id",t).gte("test_date",r).order("test_date",{ascending:!1});return{data:a,error:n}}catch(e){return u("Erro ao buscar exames recentes",e),{data:null,error:e}}}async function h(t){try{const{data:e,error:r}=await o.from("lab_results").select("*").eq("id",t).single();return{data:e,error:r}}catch(e){return u("Erro ao buscar exame",e),{data:null,error:e}}}async function F(t){try{let e="pending";t.test_value!==null&&t.test_value!==void 0&&t.test_value!==""&&(e=k(t.test_value,t.reference_min,t.reference_max));const{data:r,error:a}=await o.from("lab_results").insert([{...t,status:e}]).select().single();return{data:r,error:a}}catch(e){return u("Erro ao criar exame",e),{data:null,error:e}}}async function S(t,e){try{const{data:r}=await h(t),a=e.test_value!==void 0?e.test_value:r?.test_value,n=a!=null&&a!=="";n&&(e.test_value!==void 0||e.reference_min!==void 0||e.reference_max!==void 0)&&r?e.status=k(a,e.reference_min!==void 0?e.reference_min:r.reference_min,e.reference_max!==void 0?e.reference_max:r.reference_max):!n&&e.test_value===null&&(e.status="pending");const{data:s,error:c}=await o.from("lab_results").update(e).eq("id",t).select().single();return{data:s,error:c}}catch(r){return u("Erro ao atualizar exame",r),{data:null,error:r}}}async function E(t){try{const{data:e}=await h(t);e?.pdf_url&&await v(e.pdf_url);const{data:r,error:a}=await o.from("lab_results").delete().eq("id",t).select().single();return{data:r,error:a}}catch(e){return u("Erro ao deletar exame",e),{data:null,error:e}}}function k(t,e,r){if(e==null||r==null||t==null||t==="")return"pending";const a=parseFloat(t);return isNaN(a)?"pending":a<e?"low":a>r?"high":"normal"}const d=(t="")=>String(t||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"");async function $(t=null){try{let e=o.from("lab_risk_rules").select("*").eq("is_active",!0);t?e=e.or(`nutritionist_id.is.null,nutritionist_id.eq.${t}`):e=e.is("nutritionist_id",null);const{data:r,error:a}=await e;if(a)throw a;return{data:(r||[]).sort((i,s)=>{const c=i?.nutritionist_id?1:0;return(s?.nutritionist_id?1:0)-c}),error:null}}catch(e){return u("Erro ao buscar regras de risco laboratorial",e),{data:[],error:e}}}function b(t,e=[]){if(!t)return{..._};const r=d(t.marker_key||t.test_name),a=(e||[]).find(l=>d(l.marker_key)===r),n=Number(t?.test_value);if(!Number.isFinite(n))return{..._,marker_key:r};if(a){const l=Number(a?.low_threshold),f=Number(a?.high_threshold),g=Number.isFinite(l),y=Number.isFinite(f);return g&&n<l?{marker_key:r,risk_level:a.risk_low||"medium",risk_reason:`Abaixo do limiar (${l}${a.unit?` ${a.unit}`:""})`}:y&&n>f?{marker_key:r,risk_level:a.risk_high||"high",risk_reason:`Acima do limiar (${f}${a.unit?` ${a.unit}`:""})`}:{marker_key:r,risk_level:"none",risk_reason:"Dentro da faixa esperada"}}const s=Number(t?.reference_min),c=Number(t?.reference_max);return Number.isFinite(s)&&n<s?{marker_key:r,risk_level:"medium",risk_reason:"Abaixo da referência"}:Number.isFinite(c)&&n>c?{marker_key:r,risk_level:"high",risk_reason:"Acima da referência"}:{marker_key:r,risk_level:"none",risk_reason:null}}function q(t=[],e=[]){const r=(t||[]).map(n=>{const i=b(n,e);return{...n,risk_level:i.risk_level,risk_reason:i.risk_reason,marker_key:i.marker_key||d(n?.test_name)}}),a=r.reduce((n,i)=>{const s=m[n]??0;return(m[i.risk_level]??0)>s?i.risk_level:n},"none");return{data:r,summary:{total:r.length,high:r.filter(n=>n.risk_level==="high").length,medium:r.filter(n=>n.risk_level==="medium").length,low:r.filter(n=>n.risk_level==="low").length,highest_risk:a}}}async function R(t,e){try{if(e.type!=="application/pdf")return{url:null,filename:null,error:{message:"Apenas arquivos PDF são permitidos"}};const r=10*1024*1024;if(e.size>r)return{url:null,filename:null,error:{message:"O arquivo deve ter no máximo 10MB"}};const a=Date.now(),n=Math.random().toString(36).substring(7),s=`${t}/${a}_${n}.pdf`,{data:c,error:l}=await o.storage.from("lab-results-pdfs").upload(s,e,{cacheControl:"3600",upsert:!1});if(l)throw l;const{data:f}=await o.storage.from("lab-results-pdfs").createSignedUrl(s,31536e3);return{url:f.signedUrl,filename:e.name,path:s,error:null}}catch(r){return u("Erro ao fazer upload do PDF",r),{url:null,filename:null,error:r}}}async function v(t){try{if(!t)return{success:!1,error:{message:"URL do PDF não fornecida"}};const e=t.split("/lab-results-pdfs/");if(e.length<2)return{success:!1,error:{message:"URL inválida"}};const a=e[1].split("?")[0],{error:n}=await o.storage.from("lab-results-pdfs").remove([a]);if(n)throw n;return{success:!0,error:null}}catch(e){return u("Erro ao deletar PDF",e),{success:!1,error:e}}}export{D as a,$ as b,q as c,k as d,v as e,S as f,N as g,F as h,E as i,R as u};
