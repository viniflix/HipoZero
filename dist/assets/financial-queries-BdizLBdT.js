import{aO as w,s as c,O as l,aN as D,ad as E}from"./index-CzP_nI2M.js";import{s as h}from"./startOfMonth-D7_dMI_Z.js";import{p as S}from"./parseISO-BczzEZ0Y.js";async function b(n,t){if(!t)throw new Error("nutritionistId is required for getFinancialSummary");const e=h(n),a=w(n),{data:r,error:o}=await c.from("financial_transactions").select("type, amount, status").eq("nutritionist_id",t).gte("transaction_date",l(e,"yyyy-MM-dd")).lte("transaction_date",l(a,"yyyy-MM-dd"));if(o)throw console.error("Error fetching financial summary:",o),o;const u=(r||[]).filter(s=>s.type==="income").reduce((s,y)=>s+parseFloat(y.amount||0),0),d=u,i=(r||[]).filter(s=>s.type==="expense").reduce((s,y)=>s+parseFloat(y.amount||0),0),f=(r||[]).filter(s=>s.status==="overdue").reduce((s,y)=>s+parseFloat(y.amount||0),0);return{income:u,netIncome:d,expenses:i,netResult:d-i,overdue:f}}async function T(n,t={},e={},a={}){let r=c.from("financial_transactions").select(`
            *,
            patient:user_profiles!financial_transactions_patient_id_fkey(
                id,
                name
            )
        `,{count:"exact"}).eq("nutritionist_id",n);if(t.type&&(r=r.eq("type",t.type)),t.status&&(r=r.eq("status",t.status)),t.search&&(r=r.ilike("description",`%${t.search}%`)),t.month&&t.year){const s=h(new Date(t.year,t.month-1,1)),y=w(new Date(t.year,t.month-1,1));r=r.gte("transaction_date",l(s,"yyyy-MM-dd")).lte("transaction_date",l(y,"yyyy-MM-dd"))}const o=a.field||"transaction_date",u=a.order||"desc";if(r=r.order(o,{ascending:u==="asc"}),e.page&&e.pageSize){const s=(e.page-1)*e.pageSize,y=s+e.pageSize-1;r=r.range(s,y)}const{data:d,error:i,count:f}=await r;if(i)throw console.error("Error fetching transactions:",i),i;return{data:d||[],total:f||0}}async function k(n){const{id:t,...e}=n;e.status||(e.status=e.isPaid?"paid":"pending"),e.status==="pending"&&!e.due_date&&(e.due_date=e.transaction_date),delete e.isPaid;let a;t?a=c.from("financial_transactions").update(e).eq("id",t).select().single():a=c.from("financial_transactions").insert(e).select().single();const{data:r,error:o}=await a;if(o)throw console.error("Error saving transaction:",o),o;return r}async function P(n){const{error:t}=await c.from("financial_transactions").delete().eq("id",n);if(t)throw console.error("Error deleting transaction:",t),t}async function j(n,t,e="day"){const a=h(t),r=w(t),{data:o,error:u}=await c.from("financial_transactions").select("transaction_date, type, amount").eq("nutritionist_id",n).gte("transaction_date",l(a,"yyyy-MM-dd")).lte("transaction_date",l(r,"yyyy-MM-dd")).order("transaction_date",{ascending:!0});if(u)throw console.error("Error fetching cash flow data:",u),u;const d={};return o.forEach(i=>{const f=new Date(i.transaction_date);let s;if(e==="week"){const y=new Date(f);y.setDate(f.getDate()-f.getDay()),s=l(y,"yyyy-MM-dd")}else s=l(f,"yyyy-MM-dd");d[s]||(d[s]={date:s,income:0,expenses:0}),i.type==="income"?d[s].income+=parseFloat(i.amount||0):d[s].expenses+=parseFloat(i.amount||0)}),Object.values(d).sort((i,f)=>i.date.localeCompare(f.date))}async function C(n,t){const e=h(t),a=w(t),{data:r,error:o}=await c.from("financial_transactions").select("category, amount").eq("nutritionist_id",n).eq("type","expense").gte("transaction_date",l(e,"yyyy-MM-dd")).lte("transaction_date",l(a,"yyyy-MM-dd"));if(o)throw console.error("Error fetching expense distribution:",o),o;const u={};return r.forEach(d=>{const i=d.category||"outros";u[i]||(u[i]=0),u[i]+=parseFloat(d.amount||0)}),Object.entries(u).map(([d,i])=>({name:d.charAt(0).toUpperCase()+d.slice(1).replace("_"," "),value:i}))}async function z(n,t){const e=D(t),a=E(e,30),{data:r,error:o}=await c.from("financial_transactions").select("type, amount").eq("nutritionist_id",n).eq("status","paid");if(o)throw console.error("Error fetching paid transactions for balance:",o),o;let u=0;(r||[]).forEach(p=>{const g=parseFloat(p.amount||0);p.type==="income"?u+=g:u-=g});const{data:d,error:i}=await c.from("financial_transactions").select("type, amount, due_date, transaction_date").eq("nutritionist_id",n).eq("status","pending").gte("due_date",l(e,"yyyy-MM-dd")).lte("due_date",l(a,"yyyy-MM-dd")),{data:f,error:s}=await c.from("financial_transactions").select("type, amount, due_date, transaction_date").eq("nutritionist_id",n).eq("status","pending").is("due_date",null).gte("transaction_date",l(e,"yyyy-MM-dd")).lte("transaction_date",l(a,"yyyy-MM-dd"));if(i||s)throw console.error("Error fetching pending transactions:",i||s),i||s;const y=[...d||[],...f||[]],_={};y.forEach(p=>{const g=p.due_date||p.transaction_date;if(!g)return;const m=l(S(g),"yyyy-MM-dd");_[m]||(_[m]={income:0,expenses:0});const q=parseFloat(p.amount||0);p.type==="income"?_[m].income+=q:_[m].expenses+=q});const v=[];let M=u;for(let p=0;p<=30;p++){const g=E(e,p),m=l(g,"yyyy-MM-dd");_[m]&&(M+=_[m].income,M-=_[m].expenses),v.push({date:m,balance:Math.round(M*100)/100})}return v}async function B(n){const{data:t,error:e}=await c.from("user_profiles").select("id, name").eq("nutritionist_id",n).order("name",{ascending:!0});if(e)throw console.error("Error fetching patients:",e),e;return t||[]}async function A(n){const{data:t,error:e}=await c.from("services").select("*").eq("nutritionist_id",n).order("name",{ascending:!0});if(e)throw console.error("Error fetching services:",e),e;return(t||[]).filter(r=>r.is_active!==!1&&r.active!==!1)}async function K(n){const{id:t,...e}=n;e.updated_at=new Date().toISOString();let a;t?a=c.from("services").update(e).eq("id",t).select().single():a=c.from("services").insert(e).select().single();const{data:r,error:o}=await a;if(o)throw console.error("Error saving service:",o),o;return r}async function W(n){let t={updated_at:new Date().toISOString()};t.is_active=!1;const{error:e}=await c.from("services").update(t).eq("id",n);if(e)if(e.message&&e.message.includes("is_active")){delete t.is_active,t.active=!1;const{error:a}=await c.from("services").update(t).eq("id",n);if(a)throw console.error("Error deleting service:",a),a}else throw console.error("Error deleting service:",e),e}async function I(n){const{data:t,error:e}=await c.from("financial_transactions").insert(n).select();if(e)throw console.error("Error saving multiple transactions:",e),e;return t||[]}async function N(n){const t=l(new Date,"yyyy-MM-dd"),{data:e,error:a}=await c.from("financial_transactions").select(`
            *,
            patient:user_profiles!financial_transactions_patient_id_fkey(
                id,
                name
            )
        `).eq("nutritionist_id",n).eq("type","income").eq("status","pending").lte("transaction_date",t).order("transaction_date",{ascending:!0});if(a)throw console.error("Error fetching pending payments:",a),a;return e||[]}async function R(n,t){const{data:e,error:a}=await c.from("financial_transactions").update({status:t}).eq("id",n).select().single();if(a)throw console.error("Error updating transaction status:",a),a;return e}async function U(n,t){const{data:e,error:a}=await c.from("financial_transactions").update({transaction_date:t,due_date:t}).eq("id",n).select().single();if(a)throw console.error("Error rescheduling transaction:",a),a;return e}export{N as a,P as b,b as c,W as d,T as e,j as f,A as g,C as h,z as i,B as j,I as k,k as l,U as r,K as s,R as u};
