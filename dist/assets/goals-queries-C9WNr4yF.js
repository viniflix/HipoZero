import{s as c}from"./index-BvWB-6Y-.js";import{g as G}from"./date-C2sroe8F.js";import{l as u}from"./query-helpers-mbysFH2_.js";import{t as w}from"./patient-queries-DNM8Wnzg.js";const f=7700,T=1e3,C=200,x=500,N=async(t,a)=>{const{goal_type:e,initial_weight:i,target_weight:l,start_date:o,target_date:g}=t,m=l-i,b=m<0,h=m>0,p=new Date(o).getTime(),v=new Date(g).getTime(),M=Math.ceil((v-p)/(1e3*60*60*24));if(M<=0)return{is_realistic:!1,viability_score:1,viability_notes:"Data alvo deve ser posterior √† data de in√≠cio.",warnings:[{type:"invalid_dates",message:"Data alvo inv√°lida"}],required_daily_deficit:0,daily_calorie_goal:null};const n=m/M*f,{data:q}=await c.from("energy_expenditure_calculations").select("*").eq("patient_id",a).order("created_at",{ascending:!1}).limit(1).maybeSingle(),{data:P}=await c.from("meal_plans").select("*").eq("patient_id",a).eq("is_active",!0).maybeSingle(),y=q?.get||null,_=P?.daily_calories||null,r={is_realistic:!0,viability_score:5,viability_notes:"",warnings:[],required_daily_deficit:Math.round(n),daily_calorie_goal:null,energy_expenditure_id:q?.id||null,meal_plan_id:P?.id||null},s=[],d=[];if(b&&Math.abs(n)>T&&(r.is_realistic=!1,r.viability_score=1,d.push({type:"too_aggressive",message:`D√©ficit de ${Math.abs(Math.round(n))} kcal/dia √© muito agressivo e pode ser prejudicial √† sa√∫de.`}),s.push("‚ö†Ô∏è Meta extremamente agressiva. Recomendamos estender o prazo ou reduzir o objetivo de peso.")),b&&Math.abs(n)<C&&(r.viability_score=Math.min(r.viability_score,3),d.push({type:"too_slow",message:`D√©ficit de apenas ${Math.abs(Math.round(n))} kcal/dia resultar√° em perda muito lenta.`}),s.push("üìä Meta pode ser muito conservadora. Considere reduzir o prazo para resultados mais vis√≠veis.")),h&&n>x&&(r.is_realistic=!1,r.viability_score=1,d.push({type:"gain_too_fast",message:`Super√°vit de ${Math.round(n)} kcal/dia √© excessivo.`}),s.push("‚ö†Ô∏è Ganho de peso muito r√°pido. Pode resultar em ac√∫mulo excessivo de gordura.")),y&&_){const D=y-_,E=y-n;r.daily_calorie_goal=Math.round(E),Math.abs(D-n)>300?(r.viability_score=Math.min(r.viability_score,3),D<n?(d.push({type:"plan_too_high_calories",message:`Plano atual fornece ${Math.round(_)} kcal/dia. Para atingir a meta, deveria fornecer aproximadamente ${Math.round(E)} kcal/dia.`}),s.push("üìã Plano alimentar atual fornece mais calorias que o necess√°rio. Considere ajustar o plano.")):(d.push({type:"plan_too_low_calories",message:`Plano atual fornece ${Math.round(_)} kcal/dia. Est√° abaixo do necess√°rio para a meta (${Math.round(E)} kcal/dia).`}),s.push("üìã Plano alimentar atual fornece menos calorias que o necess√°rio. Meta pode ser atingida mais rapidamente."))):s.push("‚úÖ Plano alimentar atual est√° adequado para atingir a meta no prazo estabelecido."),s.push(`
**Dados nutricionais:**`),s.push(`‚Ä¢ Gasto energ√©tico total: ${Math.round(y)} kcal/dia`),s.push(`‚Ä¢ Plano alimentar atual: ${Math.round(_)} kcal/dia`),s.push(`‚Ä¢ D√©ficit atual: ${Math.round(D)} kcal/dia`),s.push(`‚Ä¢ D√©ficit necess√°rio: ${Math.round(n)} kcal/dia`)}else r.viability_score=Math.min(r.viability_score,3),d.push({type:"missing_data",message:"Faltam dados de gasto energ√©tico ou plano alimentar para valida√ß√£o completa."}),y||s.push("‚ö†Ô∏è Gasto energ√©tico n√£o calculado. Recomendamos calcular antes de criar a meta."),_||s.push("‚ö†Ô∏è Nenhum plano alimentar ativo. Crie um plano adequado √† meta.");return M<7&&(r.viability_score=Math.min(r.viability_score,2),d.push({type:"too_short_deadline",message:"Prazo muito curto. Metas saud√°veis requerem mais tempo."})),M>365&&(r.viability_score=Math.min(r.viability_score,4),d.push({type:"long_deadline",message:"Prazo muito longo. Considere criar metas intermedi√°rias."})),r.viability_notes=s.join(`
`),r.warnings=d,r},R=async(t,a,e)=>{try{const i=await N(t,a),l={patient_id:a,nutritionist_id:e,goal_type:t.goal_type,title:t.title,description:t.description||null,initial_weight:t.initial_weight,target_weight:t.target_weight,current_weight:t.initial_weight,start_date:t.start_date,target_date:t.target_date,...i,status:"active"},{data:o,error:g}=await c.from("patient_goals").insert([l]).select().single();if(g)throw g;return await w({eventName:"goal.created",sourceModule:"goals",patientId:o?.patient_id||a,nutritionistId:o?.nutritionist_id||e||null,payload:{goal_id:o?.id||null,goal_type:o?.goal_type||t.goal_type||null}}),{data:o,error:null}}catch(i){return u("Erro ao criar meta",i),{data:null,error:i}}},j=async(t,a={})=>{try{let e=c.from("patient_goals").select("*").eq("patient_id",t);a.status&&(Array.isArray(a.status)?e=e.in("status",a.status):e=e.eq("status",a.status)),e=e.order("created_at",{ascending:!1}),a.limit&&(e=e.limit(a.limit));const{data:i,error:l}=await e;if(l)throw l;return{data:i,error:null}}catch(e){return u("Erro ao buscar metas",e),{data:null,error:e}}},L=async t=>{try{const{data:a,error:e}=await c.from("patient_goals").select("*").eq("patient_id",t).eq("status","active").order("created_at",{ascending:!1}).limit(1).maybeSingle();if(e)throw e;return{data:a,error:null}}catch(a){return u("Erro ao buscar meta ativa",a),{data:null,error:a}}},k=async t=>{try{const{data:a,error:e}=await c.from("patient_goals").select("*").eq("id",t).single();if(e)throw e;return{data:a,error:null}}catch(a){return u("Erro ao buscar meta",a),{data:null,error:a}}},U=async(t,a)=>{try{const{data:e}=await k(t);if(!e)throw new Error("Meta n√£o encontrada");const i=Number(e.initial_weight),l=Number(e.target_weight),o=Number(a),g=i-l,m=i-o,b=g===0?100:m/g*100,h=Math.max(0,Number(b.toFixed(2))),{data:p,error:v}=await c.from("patient_goals").update({current_weight:a,progress_percentage:h}).eq("id",t).select().single();if(v)throw v;return h>=100&&await $(t),await w({eventName:"goal.progress.updated",sourceModule:"goals",patientId:p?.patient_id||e?.patient_id||null,nutritionistId:p?.nutritionist_id||e?.nutritionist_id||null,payload:{goal_id:p?.id||t,progress_percentage:h,current_weight:Number(a)}}),{data:p,error:null}}catch(e){return u("Erro ao atualizar progresso",e),{data:null,error:e}}},$=async t=>{try{const{data:a,error:e}=await c.from("patient_goals").update({status:"completed",completion_date:G()}).eq("id",t).select().single();if(e)throw e;return await w({eventName:"goal.completed",sourceModule:"goals",patientId:a?.patient_id||null,nutritionistId:a?.nutritionist_id||null,payload:{goal_id:a?.id||t}}),{data:a,error:null}}catch(a){return u("Erro ao completar meta",a),{data:null,error:a}}},V=async(t,a="")=>{try{const{data:e,error:i}=await c.from("patient_goals").update({status:"cancelled",description:a?`${a}`:void 0}).eq("id",t).select().single();if(i)throw i;return await w({eventName:"goal.cancelled",sourceModule:"goals",patientId:e?.patient_id||null,nutritionistId:e?.nutritionist_id||null,payload:{goal_id:e?.id||t,reason:a||null}}),{data:e,error:null}}catch(e){return u("Erro ao cancelar meta",e),{data:null,error:e}}},X=async t=>{try{const{data:a,error:e}=await c.from("patient_goals").update({status:"paused"}).eq("id",t).select().single();if(e)throw e;return await w({eventName:"goal.paused",sourceModule:"goals",patientId:a?.patient_id||null,nutritionistId:a?.nutritionist_id||null,payload:{goal_id:a?.id||t}}),{data:a,error:null}}catch(a){return u("Erro ao pausar meta",a),{data:null,error:a}}},B=t=>{const a=t<0,e=Math.abs(t);return e===0?1:Math.ceil(a?e*f/T:e*f/x)},K=t=>{const a=t<0,e=Math.abs(t);return e===0?1:Math.ceil(a?e*f/500:e*f/300)},O=t=>{const a=new Date,i=new Date(t).getTime()-a.getTime();return Math.ceil(i/(1e3*60*60*24))},H=t=>{if(!t||t.status!=="active")return null;const a=Math.ceil((new Date(t.target_date).getTime()-new Date(t.start_date).getTime())/(1e3*60*60*24)),i=Math.ceil((new Date().getTime()-new Date(t.start_date).getTime())/(1e3*60*60*24))/a*100,o=(t.progress_percentage||0)-i;return o>=10?{status:"ahead",label:"Adiantado",color:"text-green-600"}:o<=-10?{status:"behind",label:"Atrasado",color:"text-red-600"}:{status:"on_track",label:"No prazo",color:"text-blue-600"}};export{O as a,H as b,j as c,K as d,B as e,N as f,L as g,R as h,$ as i,V as j,X as p,U as u};
