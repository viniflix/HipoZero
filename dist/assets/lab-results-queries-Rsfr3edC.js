import{s}from"./index-qjbGaV1R.js";import{f as g}from"./date-C2sroe8F.js";import{l as o}from"./query-helpers-CC2p4I3d.js";async function b(t,e=50){try{const{data:r,error:a}=await s.from("lab_results").select("*").eq("patient_id",t).order("test_date",{ascending:!1}).limit(e);return{data:r,error:a}}catch(r){return o("Erro ao buscar exames",r),{data:null,error:r}}}async function w(t){try{const e=new Date;e.setDate(e.getDate()-30);const r=g(e),{data:a,error:n}=await s.from("lab_results").select("*").eq("patient_id",t).gte("test_date",r).order("test_date",{ascending:!1});return{data:a,error:n}}catch(e){return o("Erro ao buscar exames recentes",e),{data:null,error:e}}}async function c(t){try{const{data:e,error:r}=await s.from("lab_results").select("*").eq("id",t).single();return{data:e,error:r}}catch(e){return o("Erro ao buscar exame",e),{data:null,error:e}}}async function x(t){try{let e="pending";t.test_value!==null&&t.test_value!==void 0&&t.test_value!==""&&(e=f(t.test_value,t.reference_min,t.reference_max));const{data:r,error:a}=await s.from("lab_results").insert([{...t,status:e}]).select().single();return{data:r,error:a}}catch(e){return o("Erro ao criar exame",e),{data:null,error:e}}}async function v(t,e){try{const{data:r}=await c(t),a=e.test_value!==void 0?e.test_value:r?.test_value,n=a!=null&&a!=="";n&&(e.test_value!==void 0||e.reference_min!==void 0||e.reference_max!==void 0)&&r?e.status=f(a,e.reference_min!==void 0?e.reference_min:r.reference_min,e.reference_max!==void 0?e.reference_max:r.reference_max):!n&&e.test_value===null&&(e.status="pending");const{data:l,error:u}=await s.from("lab_results").update(e).eq("id",t).select().single();return{data:l,error:u}}catch(r){return o("Erro ao atualizar exame",r),{data:null,error:r}}}async function D(t){try{const{data:e}=await c(t);e?.pdf_url&&await _(e.pdf_url);const{data:r,error:a}=await s.from("lab_results").delete().eq("id",t).select().single();return{data:r,error:a}}catch(e){return o("Erro ao deletar exame",e),{data:null,error:e}}}function f(t,e,r){if(e==null||r==null||t==null||t==="")return"pending";const a=parseFloat(t);return isNaN(a)?"pending":a<e?"low":a>r?"high":"normal"}async function E(t,e){try{if(e.type!=="application/pdf")return{url:null,filename:null,error:{message:"Apenas arquivos PDF são permitidos"}};const r=10*1024*1024;if(e.size>r)return{url:null,filename:null,error:{message:"O arquivo deve ter no máximo 10MB"}};const a=Date.now(),n=Math.random().toString(36).substring(7),l=`${t}/${a}_${n}.pdf`,{data:u,error:i}=await s.storage.from("lab-results-pdfs").upload(l,e,{cacheControl:"3600",upsert:!1});if(i)throw i;const{data:m}=await s.storage.from("lab-results-pdfs").createSignedUrl(l,31536e3);return{url:m.signedUrl,filename:e.name,path:l,error:null}}catch(r){return o("Erro ao fazer upload do PDF",r),{url:null,filename:null,error:r}}}async function _(t){try{if(!t)return{success:!1,error:{message:"URL do PDF não fornecida"}};const e=t.split("/lab-results-pdfs/");if(e.length<2)return{success:!1,error:{message:"URL inválida"}};const a=e[1].split("?")[0],{error:n}=await s.storage.from("lab-results-pdfs").remove([a]);if(n)throw n;return{success:!0,error:null}}catch(e){return o("Erro ao deletar PDF",e),{success:!1,error:e}}}export{b as a,v as b,f as c,_ as d,x as e,D as f,w as g,E as u};
