import{q as Ne,r as n,u as Le,b as ve,j as e,C as $,c as R,d as q,w as te,e as M,L as Ye,X as tt,D as st,x as at,B as A,y as rt,z as xe,T as ze,s as V,a as Ze,E as Be,F as ne,G as nt,t as pe,m as it,H as ot}from"./index-BvWB-6Y-.js";import{g as dt}from"./observability-queries-BxbsnaqH.js";import{I as lt}from"./input-OBodSLFw.js";import{t as ct}from"./mealTranslations-B1KHhmEq.js";import{S as mt}from"./search-DAzfs9rU.js";import{F as ut}from"./filter-DzB1LpgZ.js";import{U as Me}from"./utensils-CLVAb11L.js";import{W as Pe}from"./weight-CyN5bFNH.js";import{f as Je}from"./formatDistanceToNow-DnOJpndx.js";import{p as je}from"./pt-BR-BMtVLtF7.js";import{B as De}from"./badge-CCK5Bs0D.js";import{g as xt,a as pt,b as ht,c as gt,d as bt,e as ft,f as yt,h as wt,s as jt,r as Nt,i as vt,j as _t,k as kt,l as Ct}from"./patient-queries-DNM8Wnzg.js";import{A as Ee}from"./alert-triangle-D0DKZ4eY.js";import{S as St,a as ee}from"./skeleton-Dirg_Jda.js";import{A as Oe}from"./activity-CbrTkNiD.js";import{M as It}from"./message-square-d4PysXqo.js";import{C as He}from"./calendar-BxLBJTLY.js";import{B as At}from"./book-open-CwyK4bLE.js";import{F as Tt}from"./file-text-CyOxrREb.js";import{p as Qe}from"./parseISO-DtrTOw4I.js";import{U as Ue}from"./users-DlciEtw2.js";import{T as Dt}from"./trending-up-DCN4wKoA.js";import{C as $t}from"./clipboard-list-hPvpDmQd.js";import"./query-helpers-mbysFH2_.js";import"./constructNow-BDnuN8eJ.js";import"./compareAsc-BbDmGHdd.js";import"./endOfMonth-Ca9QmV5D.js";import"./lab-results-queries-B3ZMjFH4.js";import"./date-C2sroe8F.js";const Rt=Ne("CalendarX2",[["path",{d:"M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8",key:"3spt84"}],["line",{x1:"16",x2:"16",y1:"2",y2:"6",key:"m3sa8f"}],["line",{x1:"8",x2:"8",y1:"2",y2:"6",key:"18kwsl"}],["line",{x1:"3",x2:"21",y1:"10",y2:"10",key:"xt86sb"}],["line",{x1:"17",x2:"22",y1:"17",y2:"22",key:"xa9o8b"}],["line",{x1:"17",x2:"22",y1:"22",y2:"17",key:"18nitg"}]]),Ve=Ne("Clipboard",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}]]),Mt=Ne("Gift",[["rect",{x:"3",y:"8",width:"18",height:"4",rx:"1",key:"bkv52"}],["path",{d:"M12 8v13",key:"1c76mn"}],["path",{d:"M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7",key:"6wjy6b"}],["path",{d:"M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5",key:"1ihvrl"}]]),qe=Ne("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z",key:"ymcmye"}]]),Pt=()=>{const[a,r]=n.useState([]),[o,c]=n.useState(!0),[m,i]=n.useState(""),[p,N]=n.useState("all"),{user:k}=Le(),T=ve(),de=u=>{const C=Number.parseFloat(u);return Number.isNaN(C)?u?`${u} kcal`:null:`${C.toFixed(2)} kcal`};n.useEffect(()=>{(async()=>{if(k?.id){c(!0);try{const{data:C}=await V.from("user_profiles").select("id, name").eq("nutritionist_id",k.id).eq("user_type","patient");if(!C||C.length===0){r([]),c(!1);return}const K=C.map(g=>g.id),se=Object.fromEntries(C.map(g=>[g.id,g])),G=[],[ae,X]=await Promise.all([V.from("meal_audit_log").select("id, patient_id, action, meal_type, details, created_at").in("patient_id",K).order("created_at",{ascending:!1}).limit(100),V.from("growth_records").select("id, patient_id, weight, created_at").in("patient_id",K).order("created_at",{ascending:!1}).limit(100)]);ae.data&&ae.data.forEach(g=>{const E=se[g.patient_id];if(E){const O=g.details?.total_calories??0;let Y="",H="";g.action==="create"?(Y="registrou",H="meal"):g.action==="update"?(Y="editou",H="edit"):g.action==="delete"&&(Y="deletou",H="delete"),G.push({id:`audit-${g.id}`,type:H,patient_id:g.patient_id,patient_name:E.name,description:Y,meal_type:ct(g.meal_type),detail:de(O),timestamp:g.created_at})}}),X.data&&X.data.forEach(g=>{const E=se[g.patient_id];E&&G.push({id:`weight-${g.id}`,type:"weight",patient_id:g.patient_id,patient_name:E.name,description:"registrou peso",detail:`${g.weight} kg`,timestamp:g.created_at})}),G.sort((g,E)=>new Date(E.timestamp)-new Date(g.timestamp)),r(G)}catch(C){console.error("Erro ao buscar atualizações:",C),r([])}c(!1)}})()},[k]);const P=u=>{switch(u){case"meal":return e.jsx(Me,{className:"h-5 w-5 text-secondary"});case"weight":return e.jsx(Pe,{className:"h-5 w-5 text-primary"});case"edit":return e.jsx(qe,{className:"h-5 w-5 text-blue-600"});case"delete":return e.jsx(ze,{className:"h-5 w-5 text-red-600"});default:return null}},L=a.filter(u=>!(p!=="all"&&u.type!==p||m&&!u.patient_name.toLowerCase().includes(m.toLowerCase())));return o?e.jsxs($,{className:"bg-card shadow-card-dark rounded-xl overflow-hidden",children:[e.jsxs(R,{children:[e.jsx(q,{className:"font-clash text-lg font-semibold text-primary",children:"Registros Recentes"}),e.jsx(te,{className:"text-muted-foreground",children:"Carregando..."})]}),e.jsx(M,{className:"flex items-center justify-center py-10",children:e.jsx(Ye,{className:"w-6 h-6 animate-spin text-primary"})})]}):e.jsxs($,{className:"bg-card shadow-card-dark rounded-xl overflow-hidden",children:[e.jsxs(R,{className:"pb-3",children:[e.jsx(q,{className:"font-clash text-base md:text-lg font-semibold text-primary break-words",children:"Registros Recentes"}),e.jsx(te,{className:"text-muted-foreground text-xs md:text-sm",children:"Últimos registros dos seus pacientes"}),e.jsxs("div",{className:"flex gap-2 mt-3 min-w-0",children:[e.jsxs("div",{className:"relative flex-1 min-w-0",children:[e.jsx(mt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(lt,{placeholder:"Pesquisar por paciente...",value:m,onChange:u=>i(u.target.value),className:"pl-9 pr-9 min-w-0"}),m&&e.jsx("button",{onClick:()=>i(""),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-muted-foreground hover:text-foreground",children:e.jsx(tt,{className:"h-4 w-4"})})]}),e.jsxs(st,{children:[e.jsx(at,{asChild:!0,children:e.jsx(A,{variant:"outline",size:"icon",children:e.jsx(ut,{className:"h-4 w-4"})})}),e.jsxs(rt,{align:"end",children:[e.jsx(xe,{onClick:()=>N("all"),children:e.jsx("span",{className:p==="all"?"font-semibold":"",children:"Todos"})}),e.jsxs(xe,{onClick:()=>N("meal"),children:[e.jsx(Me,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:p==="meal"?"font-semibold":"",children:"Refeições"})]}),e.jsxs(xe,{onClick:()=>N("weight"),children:[e.jsx(Pe,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:p==="weight"?"font-semibold":"",children:"Peso"})]}),e.jsxs(xe,{onClick:()=>N("edit"),children:[e.jsx(qe,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:p==="edit"?"font-semibold":"",children:"Edições"})]}),e.jsxs(xe,{onClick:()=>N("delete"),children:[e.jsx(ze,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:p==="delete"?"font-semibold":"",children:"Exclusões"})]})]})]})]})]}),e.jsx(M,{children:L.length===0?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:m||p!=="all"?"Nenhum registro encontrado com os filtros aplicados":"Nenhum registro recente."})}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-xs text-muted-foreground mb-3",children:[L.length," ",L.length===1?"registro":"registros"]}),e.jsx("div",{className:"space-y-3 max-h-[400px] overflow-y-auto pr-2",children:L.map(u=>e.jsxs("div",{className:"flex items-start gap-3 min-w-0",children:[e.jsx("div",{className:"bg-muted p-2 rounded-full flex-shrink-0",children:P(u.type)}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsxs("p",{className:"text-sm break-words",children:[u.patient_id?e.jsx("button",{type:"button",className:"font-semibold text-primary hover:underline",onClick:()=>T(`/nutritionist/patients/${u.patient_id}/hub`),children:u.patient_name}):e.jsx("span",{className:"font-semibold text-primary",children:u.patient_name})," ",e.jsx("span",{className:"text-foreground",children:u.description}),u.meal_type&&e.jsxs(e.Fragment,{children:[" seu ",e.jsx("span",{className:"font-semibold text-foreground",children:u.meal_type})]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[u.detail&&`${u.detail} • `,Je(new Date(u.timestamp),{addSuffix:!0,locale:je})]})]})]},u.id))})]})})]})},We={pending:Ve,low_adherence:Oe,birthday:Mt,appointment_upcoming:He,meal:Me,anthropometry:Pe,anamnesis:Tt,meal_plan:At,prescription:Ve,appointment:He,message:It,achievement:Oe,lab_high_risk:Ee,default:St},Lt={pending:"Pendência",low_adherence:"Baixa adesão",birthday:"Aniversário",appointment_upcoming:"Consulta próxima",meal:"Refeição",anthropometry:"Avaliação",anamnesis:"Anamnese",meal_plan:"Plano alimentar",prescription:"Cálculo",appointment:"Consulta",message:"Mensagem",achievement:"Conquista",lab_high_risk:"Risco laboratorial"},Ge={pending:{card:"bg-amber-50/60 border-amber-200/60",badge:"bg-amber-50 text-amber-700 border-amber-200",icon:"text-amber-600"},low_adherence:{card:"bg-rose-50/60 border-rose-200/60",badge:"bg-rose-50 text-rose-700 border-rose-200",icon:"text-rose-600"},birthday:{card:"bg-violet-50/60 border-violet-200/60",badge:"bg-violet-50 text-violet-700 border-violet-200",icon:"text-violet-600"},appointment_upcoming:{card:"bg-sky-50/60 border-sky-200/60",badge:"bg-sky-50 text-sky-700 border-sky-200",icon:"text-sky-600"},meal:{card:"bg-orange-50/60 border-orange-200/60",badge:"bg-orange-50 text-orange-700 border-orange-200",icon:"text-orange-600"},anthropometry:{card:"bg-emerald-50/60 border-emerald-200/60",badge:"bg-emerald-50 text-emerald-700 border-emerald-200",icon:"text-emerald-600"},anamnesis:{card:"bg-indigo-50/60 border-indigo-200/60",badge:"bg-indigo-50 text-indigo-700 border-indigo-200",icon:"text-indigo-600"},meal_plan:{card:"bg-cyan-50/60 border-cyan-200/60",badge:"bg-cyan-50 text-cyan-700 border-cyan-200",icon:"text-cyan-600"},prescription:{card:"bg-yellow-50/60 border-yellow-200/60",badge:"bg-yellow-50 text-yellow-700 border-yellow-200",icon:"text-yellow-600"},appointment:{card:"bg-blue-50/60 border-blue-200/60",badge:"bg-blue-50 text-blue-700 border-blue-200",icon:"text-blue-600"},message:{card:"bg-slate-50/60 border-slate-200/60",badge:"bg-slate-50 text-slate-700 border-slate-200",icon:"text-slate-600"},achievement:{card:"bg-amber-50/60 border-amber-200/60",badge:"bg-amber-50 text-amber-700 border-amber-200",icon:"text-amber-600"},lab_high_risk:{card:"bg-red-50/60 border-red-200/70",badge:"bg-red-50 text-red-700 border-red-200",icon:"text-red-600"},default:{card:"bg-muted/40 border-border/70",badge:"bg-muted text-muted-foreground border-border",icon:"text-muted-foreground"}},Et=()=>{const{user:a}=Le(),r=ve(),{toast:o}=Ze(),[c,m]=n.useState(!0),[i,p]=n.useState([]),[N,k]=n.useState(null),[T,de]=n.useState("all"),[P,L]=n.useState([]),[u,C]=n.useState(!1),[K,se]=n.useState(null),[G,ae]=n.useState(null),[X,g]=n.useState({});n.useEffect(()=>{(async()=>{if(a?.id){m(!0);try{const l=new Date,[h,b,y,j,J,ge,ie]=await Promise.all([xt(a.id,40),pt(a.id),ht(a.id),V.from("appointments").select("id, start_time, patient_id, patient:appointments_patient_id_fkey(id, name, avatar_url)").eq("nutritionist_id",a.id).gte("start_time",l.toISOString()).order("start_time",{ascending:!0}).limit(5),gt(a.id),bt(a.id),ft(a.id)]);if(h.error)throw h.error;if(b.error)throw b.error;if(y.error)throw y.error;if(j.error)throw j.error;if(J.error)throw J.error;if(ie.error)throw ie.error;const ce=J.data||[],me=ce.map(s=>s.id).filter(Boolean),be=new Map(ce.map(s=>[s.id,s.name||"Paciente"]));let ue=[];if(me.length){const s=await yt({nutritionistId:a.id,patientIds:me,daysWindow:120});s.error?console.warn("Não foi possível carregar alertas laboratoriais de alto risco:",s.error):ue=s.data||[]}const fe=ge?.data||[],ye=(h.data||[]).map(s=>{const w=Ft(s);return{id:`activity-${s.id}`,type:s.type,patientId:s.patient_id,patientName:s.patient_name,patientAvatar:s.patient_avatar||null,title:s.title,description:s.description,timestamp:s.timestamp,ctaLabel:w.label,ctaRoute:w.route,priority:5,sourceType:"activity",sourceId:`activity-${s.id}`}}),d=(y.data||[]).flatMap(s=>s.pending_items.map(w=>({id:`pending-${s.patient_id}-${w.type}`,type:"pending",patientId:s.patient_id,patientName:s.patient_name,title:w.label,description:"Cadastro pendente",timestamp:null,ctaLabel:"Resolver",ctaRoute:w.route,pendingType:w.type,priority:1,sourceType:"pending",sourceId:`pending-${s.patient_id}-${w.type}`}))),S=(b.data||[]).map(s=>({id:`low-adherence-${s.id}`,type:"low_adherence",patientId:s.id,patientName:s.name,title:"Baixa adesão",description:s.days_inactive===null?"Sem registros de refeição":`Sem registros há ${s.days_inactive} dia${s.days_inactive!==1?"s":""}`,daysInactive:s.days_inactive,timestamp:null,ctaLabel:"Ver diário",ctaRoute:`/nutritionist/patients/${s.id}/food-diary`,priority:4,sourceType:"low_adherence",sourceId:`low-adherence-${s.id}`})),U=(j.data||[]).map(s=>({id:`appt-${s.id}`,type:"appointment_upcoming",patientId:s.patient_id,patientName:s.patient?.name||"Paciente",patientAvatar:s.patient?.avatar_url||null,title:"Consulta próxima",description:s.start_time?ne(Qe(s.start_time),"d 'de' MMMM 'às' HH:mm",{locale:je}):"Consulta agendada",timestamp:s.start_time,ctaLabel:"Ver agenda",ctaRoute:"/nutritionist/agenda",priority:2,sourceType:"appointment_upcoming",sourceId:`appt-${s.id}`})),D=zt(J.data||[]).map(s=>({...s,sourceType:"birthday",sourceId:s.id})),I=(ue||[]).map(s=>({id:`lab-risk-${s.patient_id}-${s.marker_key}`,type:"lab_high_risk",patientId:s.patient_id,patientName:be.get(s.patient_id)||"Paciente",title:"Exame com risco alto",description:`${s.test_name||"Marcador"}: ${s.test_value??"--"} ${s.test_unit||""}`.trim(),timestamp:s.test_date||s.created_at||null,ctaLabel:"Ver exames",ctaRoute:`/nutritionist/patients/${s.patient_id}/lab-results`,priority:1,sourceType:"lab_high_risk",sourceId:`${s.patient_id}-${s.marker_key}`,riskReason:s.risk_reason})),F=[...d,...U,...D,...S,...I,...ye],z=wt(F,fe),B=await jt(a.id,z,ie?.data||[]);B.error&&console.warn("Não foi possível sincronizar snapshot do feed:",B.error);const W=new Map([...ie?.data||[],...B?.data||[]].map(s=>[`${s.source_type}:${s.source_id}`,s])),Q=z.map(s=>{const w=`${s.sourceType}:${s.sourceId}`,v=W.get(w);return{...s,persistedStatus:v?.status||"open",firstSeenAt:v?.first_seen_at||v?.created_at||s.timestamp||null,snoozeUntil:v?.snooze_until||null}}).filter(s=>{const w=`${s.sourceType}:${s.sourceId}`,v=W.get(w);return v?v.status==="resolved"?!1:v.status==="snoozed"?v.snooze_until?new Date(v.snooze_until).getTime()<=Date.now():!1:!0:!0}).sort((s,w)=>{const v=Number(s.priorityScore||0),oe=Number(w.priorityScore||0);if(v!==oe)return oe-v;if(s.priority!==w.priority)return s.priority-w.priority;const Te=s.timestamp?new Date(s.timestamp).getTime():0;return(w.timestamp?new Date(w.timestamp).getTime():0)-Te});p(Q)}catch(l){console.error("Erro ao carregar feed:",l),p([])}finally{m(!1)}}})()},[a]);const E=t=>{if(!t)return"Pendente";const l=typeof t=="string"?new Date(t):t;return nt(l)?Je(l,{addSuffix:!0,locale:je}):"Pendente"},O=n.useMemo(()=>T==="high"?i.filter(t=>Number(t.priorityScore||0)>=4):T==="pending"?i.filter(t=>t.type==="pending"):T==="adherence"?i.filter(t=>t.type==="low_adherence"):T==="lab_risk"?i.filter(t=>t.type==="lab_high_risk"):i,[i,T]);n.useEffect(()=>{L(t=>t.filter(l=>O.some(h=>h.id===l)))},[O]);const Y=n.useMemo(()=>{const t=i.length,l=i.filter(j=>Number(j.priorityScore||0)>=4).length,h=i.filter(j=>j.type==="pending").length,b=i.filter(j=>j.type==="low_adherence").length,y=i.filter(j=>j.type==="lab_high_risk").length;return[{id:"all",label:"Todos",count:t},{id:"high",label:"Alta prioridade",count:l},{id:"pending",label:"Pendências",count:h},{id:"adherence",label:"Baixa adesão",count:b},{id:"lab_risk",label:"Risco exame",count:y}]},[i]),H=t=>({nutritionistId:a?.id,patientId:t?.patientId||null,sourceType:t?.sourceType||t?.type||"activity",sourceId:t?.sourceId||t?.id,title:t?.title||"Item do feed",description:t?.description||null,priorityScore:Number(t?.priorityScore||0),priorityReason:t?.priorityReason||null,metadata:{item_type:t?.type||null,cta_route:t?.ctaRoute||null}}),_e=t=>{L(l=>l.includes(t)?l.filter(h=>h!==t):[...l,t])},Z=n.useMemo(()=>O.filter(t=>P.includes(t.id)),[O,P]),ke=async()=>{if(!(!Z.length||!a?.id)){C(!0);try{const t=Z.map(h=>H(h)),l=await Nt(t);if(l.error&&l.failedCount===t.length)throw l.error;p(h=>h.filter(b=>!P.includes(b.id))),L([]),o({title:"Ação em lote concluída",description:`${t.length-(l.failedCount||0)} itens resolvidos.`})}catch{o({title:"Erro ao resolver em lote",description:"Não foi possível concluir a ação em lote.",variant:"destructive"})}finally{C(!1)}}},Ce=async(t=120)=>{if(!(!Z.length||!a?.id)){C(!0);try{const l=Z.map(y=>H(y)),h=new Date(Date.now()+t*60*1e3).toISOString(),b=await vt(l,h);if(b.error&&b.failedCount===l.length)throw b.error;p(y=>y.filter(j=>!P.includes(j.id))),L([]),o({title:"Ação em lote concluída",description:`${l.length-(b.failedCount||0)} itens adiados por ${t} minutos.`})}catch{o({title:"Erro ao adiar em lote",description:"Não foi possível concluir a ação em lote.",variant:"destructive"})}finally{C(!1)}}},Se=async t=>{if(a?.id){k(t.id);try{const l=H(t),{error:h}=await _t(l);if(h)throw h;p(b=>b.filter(y=>y.id!==t.id)),o({title:"Pendência resolvida",description:"O item foi marcado como resolvido."})}catch{o({title:"Erro ao resolver item",description:"Não foi possível atualizar o status agora.",variant:"destructive"})}finally{k(null)}}},Ie=async(t,l=120)=>{if(a?.id){k(t.id);try{const h=new Date(Date.now()+l*60*1e3).toISOString(),b=H(t),{error:y}=await kt({...b,snoozeUntil:h});if(y)throw y;p(j=>j.filter(J=>J.id!==t.id)),o({title:"Item adiado",description:`O item voltará ao feed em aproximadamente ${l} minutos.`})}catch{o({title:"Erro ao adiar item",description:"Não foi possível adiar o item agora.",variant:"destructive"})}finally{k(null)}}},le=t=>`${t?.sourceType||"activity"}:${t?.sourceId||t?.id}`,Ae=async t=>{if(!a?.id)return;const l=le(t);if(K===t.id){se(null);return}if(se(t.id),!X[l]){ae(t.id);try{const{data:h,error:b}=await Ct({nutritionistId:a.id,sourceType:t.sourceType,sourceId:t.sourceId,limit:6});if(b)throw b;g(y=>({...y,[l]:h||[]}))}catch{o({title:"Erro ao carregar histórico",description:"Não foi possível buscar a auditoria desse item.",variant:"destructive"})}finally{ae(null)}}};return c?e.jsxs($,{className:"bg-card shadow-card-dark rounded-xl overflow-hidden",children:[e.jsxs(R,{children:[e.jsx(q,{className:"font-clash text-lg font-semibold text-primary",children:"Feed de Atividades"}),e.jsx(te,{className:"text-muted-foreground",children:"Carregando..."})]}),e.jsx(M,{className:"flex items-center justify-center py-10",children:e.jsx(Ye,{className:"w-6 h-6 animate-spin text-primary"})})]}):e.jsxs($,{className:"bg-card shadow-card-dark rounded-xl overflow-hidden",children:[e.jsxs(R,{className:"flex flex-row items-start justify-between gap-2 md:gap-4 pb-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx(q,{className:"font-clash text-base md:text-lg font-semibold text-primary break-words",children:"Feed de Atividades"}),e.jsx(te,{className:"text-muted-foreground text-xs md:text-sm",children:"Tudo o que precisa ver ao iniciar o dia"})]}),e.jsxs(De,{variant:"outline",className:"text-xs",children:[O.length," eventos"]})]}),e.jsxs(M,{children:[e.jsx("div",{className:"mb-3 flex flex-wrap gap-2",children:Y.map(t=>e.jsxs(A,{size:"sm",variant:T===t.id?"default":"outline",className:"h-7 px-2 text-xs",onClick:()=>de(t.id),children:[t.label," (",t.count,")"]},t.id))}),Z.length>0?e.jsxs("div",{className:"mb-3 flex flex-wrap items-center gap-2 rounded-lg border border-border bg-muted/30 p-2",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[Z.length," selecionado(s)"]}),e.jsx(A,{size:"sm",variant:"outline",className:"h-7 px-2 text-xs",disabled:u,onClick:ke,children:"Resolver selecionados"}),e.jsx(A,{size:"sm",variant:"outline",className:"h-7 px-2 text-xs",disabled:u,onClick:()=>Ce(120),children:"Adiar selecionados 2h"}),e.jsx(A,{size:"sm",variant:"ghost",className:"h-7 px-2 text-xs",disabled:u,onClick:()=>L([]),children:"Limpar seleção"})]}):null,O.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Ee,{className:"w-12 h-12 text-muted-foreground/50 mx-auto mb-3"}),e.jsx("p",{className:"text-muted-foreground font-medium mb-1",children:"Tudo em dia!"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Não há alertas ou atividades relevantes no momento"})]}):e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"max-h-[520px] overflow-y-auto pr-2 space-y-2",children:O.map(t=>{const l=We[t.type]||We.default,h=Ge[t.type]||Ge.default,b=Bt(t);return e.jsxs("div",{className:`flex items-start gap-2 md:gap-3 rounded-xl border p-3 md:p-4 shadow-sm hover:shadow-md transition-all min-w-0 ${h.card}`,children:[e.jsxs("div",{className:"mt-0.5 flex items-center gap-2 md:gap-3 shrink-0",children:[e.jsx("div",{className:"h-9 w-9 md:h-10 md:w-10 rounded-full border border-border bg-muted/40 flex items-center justify-center text-xs font-semibold text-muted-foreground",children:t.patientName?t.patientName.substring(0,2).toUpperCase():"HT"}),e.jsx("div",{className:"rounded-full border border-border bg-background p-1.5 md:p-2",children:e.jsx(l,{className:`h-3.5 w-3.5 md:h-4 md:w-4 ${h.icon}`})})]}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-1 sm:gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("p",{className:"text-sm font-semibold text-foreground truncate",children:[t.patientName?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-primary font-semibold",children:t.patientName})," "]}):null,t.title]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5 line-clamp-2",children:t.description}),t.priorityReason?e.jsxs("p",{className:"text-[11px] text-muted-foreground mt-1",children:["Prioridade: ",t.priorityReason]}):null,t.type==="lab_high_risk"&&t.riskReason?e.jsx("p",{className:"text-[11px] text-muted-foreground mt-1",children:t.riskReason}):null]}),t.type==="pending"&&t.ctaRoute?e.jsxs(A,{size:"sm",className:"h-7 px-2 text-xs",onClick:()=>r(t.ctaRoute),children:[t.ctaLabel||"Resolver",e.jsx(Be,{className:"ml-1 h-3 w-3"})]}):e.jsx("span",{className:"text-xs text-muted-foreground whitespace-nowrap",children:E(t.timestamp)})]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2 flex-wrap",children:[e.jsx(De,{variant:"outline",className:`text-xs ${h.badge}`,children:Lt[t.type]||"Atividade"}),b?e.jsx(De,{variant:"outline",className:`text-xs ${b.badgeClass}`,children:b.label}):null,e.jsx(A,{size:"sm",variant:P.includes(t.id)?"default":"outline",className:"h-7 px-2 text-xs",disabled:u,onClick:()=>_e(t.id),children:P.includes(t.id)?"Selecionado":"Selecionar"}),e.jsx(A,{size:"sm",variant:"outline",className:"h-7 px-2 text-xs hover:border-primary/40",disabled:N===t.id||u,onClick:()=>Se(t),children:"Resolver"}),e.jsx(A,{size:"sm",variant:"outline",className:"h-7 px-2 text-xs hover:border-primary/40",disabled:N===t.id||u,onClick:()=>Ie(t),children:"Adiar 2h"}),e.jsx(A,{size:"sm",variant:"outline",className:"h-7 px-2 text-xs hover:border-primary/40",disabled:G===t.id,onClick:()=>Ae(t),children:K===t.id?"Ocultar histórico":"Histórico"}),t.type!=="pending"&&t.ctaRoute?e.jsxs(A,{size:"sm",variant:"outline",className:"h-7 px-2 text-xs hover:border-primary/40",onClick:()=>r(t.ctaRoute),children:[t.ctaLabel||"Ver detalhes",e.jsx(Be,{className:"ml-1 h-3 w-3"})]}):null]}),K===t.id?e.jsx("div",{className:"mt-2 rounded-lg border border-border/70 bg-background/70 p-2",children:G===t.id?e.jsx("p",{className:"text-xs text-muted-foreground",children:"Carregando histórico..."}):(X[le(t)]||[]).length>0?e.jsx("div",{className:"space-y-1.5",children:(X[le(t)]||[]).map((y,j)=>e.jsxs("div",{className:"text-xs text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:Ot(y?.action)})," · ",y?.at?E(y.at):"agora"]},`${y?.at||"entry"}-${j}`))}):e.jsx("p",{className:"text-xs text-muted-foreground",children:"Sem histórico operacional registrado ainda."})}):null]})]},t.id)})}),e.jsx("div",{className:"pointer-events-none absolute inset-x-0 bottom-0 h-10 bg-gradient-to-t from-background to-transparent"})]})]})]})},Ft=a=>{if(!a?.patient_id)return{label:"Ver detalhes",route:"/nutritionist/patients"};switch(a.type){case"meal":return{label:"Ver diário",route:`/nutritionist/patients/${a.patient_id}/food-diary`};case"anthropometry":return{label:"Ver avaliação",route:`/nutritionist/patients/${a.patient_id}/anthropometry`};case"anamnesis":return{label:"Ver anamnese",route:`/nutritionist/patients/${a.patient_id}/anamnesis`};case"meal_plan":return{label:"Ver plano",route:`/nutritionist/patients/${a.patient_id}/meal-plan`};case"prescription":return{label:"Ver cálculo",route:`/nutritionist/patients/${a.patient_id}/energy-expenditure`};case"appointment":return{label:"Ver agenda",route:"/nutritionist/agenda"};case"message":return{label:"Abrir chat",route:`/chat/nutritionist/${a.patient_id}`};case"achievement":return{label:"Ver metas",route:`/nutritionist/patients/${a.patient_id}/goals`};default:return{label:"Ver paciente",route:`/nutritionist/patients/${a.patient_id}/hub`}}},zt=a=>{const r=new Date,o=[];return a.forEach(c=>{if(!c.birth_date)return;const m=new Date(c.birth_date);m.setFullYear(r.getFullYear());const i=Math.ceil((m-r)/(1e3*60*60*24));(i===0||i>0&&i<=7)&&o.push({id:`birthday-${c.id}`,type:"birthday",patientId:c.id,patientName:c.name,patientAvatar:c.avatar_url||null,title:i===0?"Aniversário hoje":`Aniversário em ${i} dia${i>1?"s":""}`,description:`Nascimento: ${ne(new Date(c.birth_date),"dd/MM")}`,timestamp:null,ctaLabel:"Ver perfil",ctaRoute:`/nutritionist/patients/${c.id}/hub`,priority:3})}),o},Bt=a=>{if(!a?.firstSeenAt||!["pending","low_adherence"].includes(a.type))return null;const r=Date.now()-new Date(a.firstSeenAt).getTime();if(Number.isNaN(r))return null;const o=r/(1e3*60*60);return o>=48?{label:"SLA crítico",badgeClass:"bg-red-50 text-red-700 border-red-200"}:o>=24?{label:"SLA atenção",badgeClass:"bg-amber-50 text-amber-700 border-amber-200"}:{label:"Dentro do SLA",badgeClass:"bg-emerald-50 text-emerald-700 border-emerald-200"}},Ot=a=>({resolved:"Resolvido",snoozed:"Adiado",reopened:"Reaberto",resolved_batch:"Resolvido em lote",snoozed_batch:"Adiado em lote"})[a]||"Atualizado";function $e(){return e.jsxs($,{className:"bg-card shadow-card-dark rounded-xl",children:[e.jsx(R,{className:"pb-2",children:e.jsx(ee,{className:"h-4 w-32"})}),e.jsxs(M,{children:[e.jsx(ee,{className:"h-10 w-20 mb-2"}),e.jsx(ee,{className:"h-3 w-40"})]})]})}function he(){return e.jsxs($,{className:"bg-card shadow-card-dark rounded-xl",children:[e.jsxs(R,{className:"pb-3",children:[e.jsx(ee,{className:"h-5 w-48 mb-2"}),e.jsx(ee,{className:"h-4 w-64"})]}),e.jsx(M,{className:"space-y-3",children:[1,2,3].map(a=>e.jsxs("div",{className:"flex items-start gap-3 p-3 rounded-lg border border-border",children:[e.jsx(ee,{className:"h-10 w-10 rounded-full flex-shrink-0"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(ee,{className:"h-4 w-3/4"}),e.jsx(ee,{className:"h-3 w-1/2"})]})]},a))})]})}const Ht=(a,r=[])=>{const o=new Date;o.setDate(o.getDate()-(a-1));const c=Array.from({length:a},(i,p)=>{const N=new Date(o);return N.setDate(o.getDate()+p),ne(N,"yyyy-MM-dd")}),m={};return r.forEach(i=>{if(!i)return;const p=ne(new Date(i),"yyyy-MM-dd");m[p]=(m[p]||0)+1}),c.map(i=>m[i]||0)},Re=({data:a=[]})=>{if(!a.length)return null;const r=Math.max(...a,1),o=140,c=44,m=o/Math.max(1,a.length-1),i=a.map((p,N)=>{const k=N*m,T=c-p/r*(c-4);return`${k},${T}`}).join(" ");return e.jsx("div",{className:"pointer-events-none absolute right-2 bottom-2 opacity-35",children:e.jsx("svg",{viewBox:`0 0 ${o} ${c}`,className:"h-11 w-36","aria-hidden":"true",children:e.jsx("polyline",{points:i,fill:"none",stroke:"white",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round"})})})},Ke=a=>a>=5?"bg-secondary/15 text-secondary border-secondary/30":a>=3?"bg-yellow-100 text-yellow-800 border-yellow-300":"bg-primary/15 text-primary border-primary/30",Ut=a=>{const o=(new Date(a).getTime()-Date.now())/(1e3*60*60);return o<=2?{label:"Muito próxima",rowClass:"border-red-300/80 bg-red-50/70",badgeClass:"bg-red-100 text-red-700 border-red-200",dotClass:"bg-red-500"}:o<=24?{label:"Hoje",rowClass:"border-orange-300/80 bg-orange-50/70",badgeClass:"bg-orange-100 text-orange-700 border-orange-200",dotClass:"bg-orange-500"}:o<=72?{label:"Em breve",rowClass:"border-amber-300/80 bg-amber-50/70",badgeClass:"bg-amber-100 text-amber-700 border-amber-200",dotClass:"bg-amber-500"}:{label:"Programada",rowClass:"border-emerald-300/80 bg-emerald-50/70",badgeClass:"bg-emerald-100 text-emerald-700 border-emerald-200",dotClass:"bg-emerald-500"}},Vt=({stats:a,onOpenFeed:r})=>{const{openCount:o,snoozedCount:c,criticalCount:m,attentionCount:i,highRiskLabCount:p}=a;return e.jsxs($,{className:"bg-card shadow-card-dark rounded-xl overflow-hidden",children:[e.jsxs(R,{className:"pb-2",children:[e.jsx(q,{className:"font-clash text-base md:text-lg font-semibold text-primary break-words",children:"Backlog Operacional"}),e.jsx(te,{className:"text-muted-foreground text-xs md:text-sm",children:"Pendências do feed inteligente"})]}),e.jsxs(M,{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"rounded-lg border border-border bg-muted/20 p-2",children:[e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Abertas"}),e.jsx("p",{className:"text-lg font-semibold text-foreground",children:o})]}),e.jsxs("div",{className:"rounded-lg border border-border bg-muted/20 p-2",children:[e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Adiadas"}),e.jsx("p",{className:"text-lg font-semibold text-foreground",children:c})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full border border-red-200 bg-red-50 px-2 py-0.5 text-red-700",children:[e.jsx(Ee,{className:"h-3 w-3"}),"Crítico: ",m]}),e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full border border-rose-200 bg-rose-50 px-2 py-0.5 text-rose-700",children:["Exames risco alto: ",p||0]}),e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full border border-amber-200 bg-amber-50 px-2 py-0.5 text-amber-700",children:["Atenção: ",i]})]}),e.jsxs(A,{variant:"outline",size:"sm",className:"w-full",onClick:r,children:[e.jsx($t,{className:"h-4 w-4 mr-2"}),"Abrir feed e priorizar"]})]})]})},Xe=({appointments:a,totalUpcoming:r,todayAppointments:o})=>{const c=ve(),m=o>0,i=r>0;return e.jsxs($,{className:"bg-card shadow-card-dark rounded-xl overflow-hidden",children:[e.jsx(R,{className:"pb-2",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 min-w-0",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx(q,{className:"font-clash text-base md:text-lg font-semibold text-primary break-words",children:"Próximas Consultas"}),e.jsx(te,{className:"text-muted-foreground text-xs md:text-sm",children:"Seus próximos agendamentos."})]}),e.jsxs("div",{className:"mt-0.5 flex flex-wrap justify-end gap-1.5",children:[m&&e.jsxs("span",{className:`rounded-full border px-2 py-0.5 text-[10px] font-semibold ${Ke(o)}`,children:["Hoje: ",o]}),i&&e.jsxs("span",{className:`rounded-full border px-2 py-0.5 text-[10px] font-semibold ${Ke(r)}`,children:["Total: ",r]})]})]})}),e.jsx(M,{children:a.length>0?e.jsxs("div",{className:"space-y-4",children:[a.map(p=>{const N=p.patient,k=Ut(p.start_time);return e.jsxs("div",{className:`rounded-lg border p-2.5 ${k.rowClass}`,children:[e.jsx("div",{className:"mb-2 flex justify-end",children:e.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-[11px] font-medium ${k.badgeClass}`,children:[e.jsx("span",{className:`h-1.5 w-1.5 rounded-full ${k.dotClass}`}),k.label]})}),e.jsxs("div",{className:"flex items-center space-x-3 min-w-0",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-emerald-100 flex-shrink-0 flex items-center justify-center",children:e.jsx("span",{className:"font-semibold text-emerald-700 text-xs",children:(N?.name||"P").substring(0,2).toUpperCase()})}),e.jsxs("div",{className:"min-w-0 flex-1 overflow-hidden",children:[e.jsx("p",{className:"text-sm font-medium text-foreground truncate",children:N?.name||"Paciente (Excluído)"}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:ne(Qe(p.start_time),"d 'de' MMMM 'às' HH:mm",{locale:je})})]})]})]},p.id)}),e.jsx(A,{variant:"outline",size:"sm",className:"w-full mt-2",onClick:()=>c("/nutritionist/agenda"),children:"Ver agenda completa"})]}):e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Nenhuma consulta agendada."})})]})},qt=({loading:a,periodDays:r,onPeriodChange:o,stats:c})=>{const m=[{value:7,label:"7d"},{value:30,label:"30d"},{value:90,label:"90d"}];return a?e.jsx(he,{}):e.jsxs($,{className:"bg-card shadow-card-dark rounded-xl overflow-hidden",children:[e.jsx(R,{className:"pb-2",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx(q,{className:"font-clash text-base md:text-lg font-semibold text-primary break-words",children:"No-show por Período"}),e.jsx(te,{className:"text-muted-foreground text-xs md:text-sm",children:"Taxa operacional de ausência na agenda"})]}),e.jsx("div",{className:"inline-flex rounded-md border bg-muted/20 p-0.5",children:m.map(i=>e.jsx("button",{type:"button",onClick:()=>o(i.value),className:`rounded px-2 py-1 text-[11px] font-medium transition ${r===i.value?"bg-primary text-white":"text-muted-foreground hover:bg-muted"}`,children:i.label},i.value))})]})}),e.jsxs(M,{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"rounded-lg border border-red-200 bg-red-50 p-2",children:[e.jsx("p",{className:"text-[11px] text-red-700",children:"No-show"}),e.jsx("p",{className:"text-lg font-semibold text-red-700",children:c.noShowCount})]}),e.jsxs("div",{className:"rounded-lg border border-emerald-200 bg-emerald-50 p-2",children:[e.jsx("p",{className:"text-[11px] text-emerald-700",children:"Concluídas"}),e.jsx("p",{className:"text-lg font-semibold text-emerald-700",children:c.completedCount})]})]}),e.jsxs("div",{className:"rounded-lg border border-border bg-muted/20 p-2",children:[e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Taxa de no-show"}),e.jsxs("p",{className:"text-xl font-semibold text-foreground",children:[c.noShowRate,"%"]}),e.jsxs("p",{className:"text-[11px] text-muted-foreground mt-1",children:["Base: ",c.eligibleCount," consultas (concluídas + faltas)"]})]}),e.jsxs("div",{className:"inline-flex items-center gap-1 rounded-full border border-amber-200 bg-amber-50 px-2 py-0.5 text-[11px] text-amber-700",children:[e.jsx(Rt,{className:"h-3 w-3"}),"Canceladas no período: ",c.canceledCount]})]})]})},Wt=({loading:a,summary:r})=>{if(a)return e.jsx(he,{});const c=(Array.isArray(r?.module_stats)?r.module_stats:[]).slice().sort((m,i)=>Number(i?.error_events||0)-Number(m?.error_events||0)).slice(0,3);return e.jsxs($,{className:"bg-card shadow-card-dark rounded-xl overflow-hidden",children:[e.jsxs(R,{className:"pb-2",children:[e.jsx(q,{className:"font-clash text-base md:text-lg font-semibold text-primary break-words",children:"Observabilidade Técnica"}),e.jsx(te,{className:"text-muted-foreground text-xs md:text-sm",children:"Erros e latência dos fluxos nas últimas 24h"})]}),e.jsxs(M,{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{className:"rounded-lg border border-border bg-muted/20 p-2",children:[e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Eventos"}),e.jsx("p",{className:"text-lg font-semibold text-foreground",children:r?.total_events||0})]}),e.jsxs("div",{className:"rounded-lg border border-red-200 bg-red-50 p-2",children:[e.jsx("p",{className:"text-[11px] text-red-700",children:"Erros"}),e.jsx("p",{className:"text-lg font-semibold text-red-700",children:r?.error_events||0})]}),e.jsxs("div",{className:"rounded-lg border border-amber-200 bg-amber-50 p-2",children:[e.jsx("p",{className:"text-[11px] text-amber-700",children:"Latência"}),e.jsxs("p",{className:"text-lg font-semibold text-amber-700",children:[Number(r?.avg_latency_ms||0).toFixed(0)," ms"]})]})]}),e.jsxs("div",{className:"rounded-lg border border-border bg-muted/20 p-2",children:[e.jsx("p",{className:"text-[11px] text-muted-foreground",children:"Taxa de erro"}),e.jsxs("p",{className:"text-xl font-semibold text-foreground",children:[Number(r?.error_rate||0).toFixed(1),"%"]})]}),e.jsx("div",{className:"space-y-1",children:c.length===0?e.jsx("p",{className:"text-xs text-muted-foreground",children:"Sem eventos instrumentados no período."}):c.map(m=>e.jsxs("div",{className:"flex items-center justify-between rounded border border-border/60 bg-muted/10 px-2 py-1.5 text-xs",children:[e.jsx("span",{className:"font-medium text-foreground",children:m.module}),e.jsxs("span",{className:"text-muted-foreground",children:[m.error_events,"/",m.total_events," erros • ",Number(m.avg_latency_ms||0).toFixed(0)," ms"]})]},m.module))})]})]})};function Ns(){const{toast:a}=Ze(),{user:r}=Le(),o=ve(),[c,m]=n.useState([]),[i,p]=n.useState([]),[N,k]=n.useState(0),[T,de]=n.useState(0),[P,L]=n.useState(30),[u,C]=n.useState({noShowCount:0,completedCount:0,canceledCount:0,eligibleCount:0,noShowRate:0}),[K,se]=n.useState({total_events:0,error_events:0,error_rate:0,avg_latency_ms:0,module_stats:[]}),[G,ae]=n.useState(0),[X,g]=n.useState("--%"),[E,O]=n.useState(0),[Y,H]=n.useState(0),[_e,Z]=n.useState([]),[ke,Ce]=n.useState([]),[Se,Ie]=n.useState([]),[le,Ae]=n.useState({openCount:0,snoozedCount:0,criticalCount:0,attentionCount:0,highRiskLabCount:0}),[t,l]=n.useState(!0),[h,b]=n.useState(!0),[y,j]=n.useState(!0),[J,ge]=n.useState(!0),[ie,ce]=n.useState(!0),me=n.useCallback(async()=>{if(!(!r||!r.id)){l(!0);try{const d=await V.from("user_profiles").select("id, name, created_at").eq("nutritionist_id",r.id).eq("is_active",!0).order("name",{ascending:!0}).then(({data:x,error:_})=>{if(_)throw _;return x||[]}),S=d.map(x=>x.id),U=new Date(Date.now()-1440*60*1e3).toISOString(),D=S.length?await V.from("meals").select("patient_id, created_at").in("patient_id",S).gte("created_at",U).then(({data:x,error:_})=>{if(_)throw _;return x||[]}):[];m(d);const I=d.filter(x=>x.created_at&&new Date(x.created_at)>=new Date(Date.now()-2160*60*60*1e3)).map(x=>x.created_at),F=Ht(90,I),z=Math.max(0,d.length-I.length),B=F.reduce((x,_,we)=>{const et=we===0?z:x[we-1];return x.push(et+_),x},[]);Z(B);const W=d.filter(x=>x.created_at&&new Date(x.created_at)>=new Date(Date.now()-720*60*60*1e3)).length;H(W);const re=D.reduce((x,_)=>(x[_.patient_id]=(x[_.patient_id]||0)+1,x),{}),f=Object.values(re).filter(x=>x>=1).length,Q=Object.values(re).filter(x=>x>=2).length,s=S.length?Math.round(Q/S.length*100):0;ae(f),O(Q),g(`${s}%`);const w=Array.from({length:24},(x,_)=>{const we=new Date(Date.now()-(23-_)*60*60*1e3);return ne(we,"yyyy-MM-dd HH")}),v={},oe={};D.forEach(x=>{const _=ne(new Date(x.created_at),"yyyy-MM-dd HH");oe[_]=(oe[_]||0)+1,v[_]||(v[_]=new Set),v[_].add(x.patient_id)});const Te=w.map(x=>v[x]?.size||0),Fe=w.map(x=>oe[x]||0);Ce(Te),Ie(Fe)}catch(d){console.error("Erro ao carregar estatísticas:",d),a({title:"Erro ao carregar estatísticas",description:pe(d,"Não foi possível carregar as estatísticas."),variant:"destructive"})}finally{l(!1)}}},[r,a]),be=n.useCallback(async()=>{if(!(!r||!r.id)){b(!0);try{const d=new Date().toISOString(),{data:S,error:U}=await V.from("appointments").select("id, start_time, patient:appointments_patient_id_fkey(id, name, avatar_url)").eq("nutritionist_id",r.id).gte("start_time",d).order("start_time",{ascending:!0}).limit(3);if(U)throw U;p(S||[]);const D=new Date().toISOString().split("T")[0],[{count:I,error:F},{count:z,error:B}]=await Promise.all([V.from("appointments").select("*",{count:"exact",head:!0}).eq("nutritionist_id",r.id).gte("start_time",d),V.from("appointments").select("*",{count:"exact",head:!0}).eq("nutritionist_id",r.id).gte("start_time",`${D}T00:00:00`).lte("start_time",`${D}T23:59:59`)]);if(F)throw F;if(B)throw B;de(I||0),k(z||0)}catch(d){console.error("Erro ao carregar agendamentos:",d),a({title:"Erro ao carregar agendamentos",description:pe(d,"Não foi possível carregar os agendamentos."),variant:"destructive"})}finally{b(!1)}}},[r,a]),ue=n.useCallback(async()=>{if(r?.id){ge(!0);try{const d=new Date().toISOString(),S=new Date(Date.now()-P*24*60*60*1e3).toISOString(),{data:U,error:D}=await V.from("appointments").select("status").eq("nutritionist_id",r.id).gte("start_time",S).lte("start_time",d);if(D)throw D;const I=U||[],F=I.filter(f=>f.status==="no_show").length,z=I.filter(f=>f.status==="completed").length,B=I.filter(f=>f.status==="canceled"||f.status==="cancelled").length,W=F+z,re=W>0?Math.round(F/W*100):0;C({noShowCount:F,completedCount:z,canceledCount:B,eligibleCount:W,noShowRate:re})}catch(d){console.error("Erro ao carregar métricas de no-show:",d),a({title:"Erro no no-show",description:pe(d,"Não foi possível carregar as métricas de no-show."),variant:"destructive"})}finally{ge(!1)}}},[r?.id,P,a]),fe=n.useCallback(async()=>{if(r?.id){ce(!0);try{const{data:d,error:S}=await dt({nutritionistId:r.id,windowHours:24});if(S)throw S;se({total_events:Number(d?.total_events||0),error_events:Number(d?.error_events||0),error_rate:Number(d?.error_rate||0),avg_latency_ms:Number(d?.avg_latency_ms||0),module_stats:Array.isArray(d?.module_stats)?d.module_stats:[]})}catch(d){console.error("Erro ao carregar observabilidade técnica:",d),a({title:"Erro na observabilidade",description:pe(d,"Não foi possível carregar o painel técnico."),variant:"destructive"})}finally{ce(!1)}}},[r?.id,a]),ye=n.useCallback(async()=>{if(r?.id){j(!0);try{const{data:d,error:S}=await V.from("feed_tasks").select("status, source_type, snooze_until, first_seen_at, created_at").eq("nutritionist_id",r.id);if(S)throw S;const U=d||[],D=Date.now(),I=U.filter(f=>f.status==="open"),F=U.filter(f=>f.status!=="snoozed"?!1:(f.snooze_until?new Date(f.snooze_until).getTime():0)>D),z=I.map(f=>{const Q=f.first_seen_at||f.created_at,s=Q?(D-new Date(Q).getTime())/(1e3*60*60):0;return Number.isFinite(s)?s:0}),B=z.filter(f=>f>=48).length,W=z.filter(f=>f>=24&&f<48).length,re=I.filter(f=>f.source_type==="lab_high_risk").length;Ae({openCount:I.length,snoozedCount:F.length,criticalCount:B,attentionCount:W,highRiskLabCount:re})}catch(d){console.error("Erro ao carregar backlog operacional:",d),a({title:"Erro no backlog",description:pe(d,"Não foi possível carregar o backlog operacional."),variant:"destructive"})}finally{j(!1)}}},[r?.id,a]);return n.useEffect(()=>{r?.id&&(me(),be(),ye(),ue(),fe())},[r?.id,me,be,ye,ue,fe]),e.jsx("div",{className:"flex flex-col min-h-screen bg-background",children:e.jsxs(it.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"max-w-7xl mx-auto w-full px-4 md:px-8 pt-4 md:pt-8 min-w-0 overflow-x-hidden",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6 md:mb-8 text-center sm:text-left",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("h2",{className:"text-2xl md:text-3xl font-bold font-heading uppercase tracking-wide text-primary break-words",children:"Dashboard"}),e.jsx("p",{className:"text-neutral-600 text-sm md:text-base mt-0.5",children:"Gerencie seus pacientes, Planos e Análises."})]}),e.jsx("div",{className:"flex gap-2 flex-wrap justify-center sm:justify-end",children:e.jsxs(A,{variant:"secondary",onClick:()=>o("/nutritionist/patients"),children:[e.jsx(Ue,{className:"h-4 w-4 mr-2"}),"Ver todos os pacientes"]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-8 lg:order-last order-3",children:[e.jsx("div",{className:"hidden lg:block",children:h?e.jsx(he,{}):e.jsx(Xe,{appointments:i,totalUpcoming:T,todayAppointments:N})}),y?e.jsx(he,{}):e.jsx(Vt,{stats:le,onOpenFeed:()=>{const d=document.getElementById("nutritionist-activity-feed");d&&d.scrollIntoView({behavior:"smooth",block:"start"})}}),e.jsx(qt,{loading:J,periodDays:P,onPeriodChange:L,stats:u}),e.jsx(Wt,{loading:ie,summary:K}),e.jsx(Pt,{})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-8 lg:order-first order-1",children:[e.jsx("div",{className:"grid gap-4 grid-cols-2 lg:grid-cols-3 mb-6",children:t?e.jsxs(e.Fragment,{children:[e.jsx($e,{}),e.jsx($e,{}),e.jsx("div",{className:"col-span-2 lg:col-span-1",children:e.jsx($e,{})})]}):e.jsxs(e.Fragment,{children:[e.jsxs($,{className:"relative overflow-hidden bg-primary text-white border-0 shadow-card-dark",children:[e.jsx(Re,{data:_e}),e.jsxs(R,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(q,{className:"font-heading uppercase text-xs lg:text-sm font-medium text-white/80 tracking-wide leading-tight",children:"Total Pacientes"}),e.jsx(Ue,{className:"h-5 w-5 lg:h-6 lg:w-6 text-white/80 flex-shrink-0"})]}),e.jsxs(M,{className:"relative",children:[e.jsx("div",{className:"text-3xl lg:text-4xl font-bold text-white",children:c.length}),e.jsx("p",{className:"text-xs text-white/70",children:"Evolução dos últimos 90 dias"})]})]}),e.jsxs($,{className:"relative overflow-hidden bg-neutral-800 text-white border-0 shadow-card-dark lg:order-3",children:[e.jsx(Re,{data:ke}),e.jsxs(R,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(q,{className:"font-heading uppercase text-xs lg:text-sm font-medium text-white/80 tracking-wide leading-tight",children:"Pacientes Ativos"}),e.jsx(ot,{className:"h-5 w-5 lg:h-6 lg:w-6 text-white/80 flex-shrink-0"})]}),e.jsxs(M,{className:"relative",children:[e.jsx("div",{className:"text-3xl lg:text-4xl font-bold text-white",children:G}),e.jsxs("p",{className:"text-xs text-white/70 leading-tight",children:[Y," novos nos últimos 30 dias"]})]})]}),e.jsxs($,{className:"relative overflow-hidden bg-secondary text-white border-0 shadow-card-dark col-span-2 lg:col-span-1 lg:order-2",children:[e.jsx(Re,{data:Se}),e.jsxs(R,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(q,{className:"font-heading uppercase text-xs lg:text-sm font-medium text-white/80 tracking-wide leading-tight",children:"Adesão 24h"}),e.jsx(Dt,{className:"h-5 w-5 lg:h-6 lg:w-6 text-white/80 flex-shrink-0"})]}),e.jsxs(M,{className:"relative",children:[e.jsx("div",{className:"text-3xl lg:text-4xl font-bold text-white",children:X}),e.jsxs("p",{className:"text-xs text-white/70",children:[E,"/",c.length," com 2+ registros"]})]})]})]})}),e.jsx("div",{id:"nutritionist-activity-feed",children:e.jsx(Et,{})})]}),e.jsx("div",{className:"lg:hidden order-2",children:h?e.jsx(he,{}):e.jsx(Xe,{appointments:i,totalUpcoming:T,todayAppointments:N})})]})]})})}export{Ns as default};
