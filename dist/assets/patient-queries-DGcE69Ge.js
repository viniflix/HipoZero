import{s}from"./index-DL6VMzkS.js";import{t as u}from"./mealTranslations-B1KHhmEq.js";import{l as m,b as g}from"./query-helpers-mbysFH2_.js";const h=async(r,e)=>{try{const{data:t,error:o}=await s.from("user_profiles").select("*").eq("id",r).eq("nutritionist_id",e).single();if(o)throw o;return{data:t,error:null}}catch(t){return m("Erro ao buscar perfil do paciente",t),{data:null,error:t}}},f=async r=>{try{const{data:e,error:t}=await s.from("growth_records").select("weight, height, record_date").eq("patient_id",r).order("record_date",{ascending:!1}).limit(1).maybeSingle();let o=e?.weight,n=e?.height;if(!o||!n){const{data:p}=await s.from("user_profiles").select("weight, height").eq("id",r).single();o=o||p?.weight,n=n||p?.height}const{data:c,error:l}=await s.from("appointments").select("appointment_time, status").eq("patient_id",r).lte("appointment_time",new Date().toISOString()).order("appointment_time",{ascending:!1}).limit(1).maybeSingle(),{data:a,error:i}=await s.from("appointments").select("appointment_time, status").eq("patient_id",r).gte("appointment_time",new Date().toISOString()).order("appointment_time",{ascending:!0}).limit(1).maybeSingle();return{data:{weight:o||null,height:n||null,last_measurement:e?.record_date||null,last_appointment:c?new Date(c.appointment_time).toLocaleDateString("pt-BR"):null,next_appointment:a?new Date(a.appointment_time).toLocaleDateString("pt-BR"):null},error:null}}catch(e){return m("Erro ao buscar mÃ©tricas do paciente",e),{data:null,error:e}}},y=async r=>{try{const{data:e}=await s.from("anamnese_answers").select("id").eq("patient_id",r).limit(1).maybeSingle(),{data:t}=await s.from("growth_records").select("id").eq("patient_id",r).limit(1).maybeSingle(),{data:o}=await s.from("prescriptions").select("id").eq("patient_id",r).limit(1).maybeSingle(),{data:n}=await s.from("meals").select("id").eq("patient_id",r).is("deleted_at",null).limit(1).maybeSingle(),{data:c}=await s.from("user_achievements").select("id").eq("user_id",r).limit(1).maybeSingle(),{data:l}=await s.from("energy_expenditure_calculations").select("id").eq("patient_id",r).limit(1).maybeSingle(),{data:a}=await s.from("lab_results").select("id").eq("patient_id",r).limit(1).maybeSingle();return{data:{anamnese:e?"completed":"not_started",anthropometry:t?"completed":"not_started",energy_expenditure:l?"completed":"not_started",meal_plan:o?"completed":"not_started",food_diary:n?"completed":"not_started",lab_results:a?"completed":"not_started",prescriptions:o?"completed":"not_started",achievements:c?"completed":"not_started"},error:null}}catch(e){return m("Erro ao buscar status dos mÃ³dulos",e),{data:null,error:e}}},q=async(r,e=10)=>{try{const t=[],{data:o}=await s.from("meal_audit_log").select("id, action, meal_type, details, created_at").eq("patient_id",r).order("created_at",{ascending:!1}).limit(30);o&&o.forEach(a=>{const i=a.details?.total_calories||0,d=u(a.meal_type);let p="",_="";a.action==="create"?(p="RefeiÃ§Ã£o Registrada",_=`${d} - ${i} kcal`):a.action==="update"?(p="RefeiÃ§Ã£o Editada",_=`${d} - ${i} kcal`):a.action==="delete"&&(p="RefeiÃ§Ã£o Deletada",_=`${d} - ${i} kcal`),t.push({id:`audit-${a.id}`,type:"meal",title:p,description:_,timestamp:a.created_at,metadata:[d,`${i} kcal`,a.action==="create"?"Registrado":a.action==="update"?"Editado":"Deletado"]})});const{data:n}=await s.from("growth_records").select("id, weight, height, record_date, created_at").eq("patient_id",r).order("record_date",{ascending:!1}).limit(20);n&&n.forEach(a=>{const i=a.height?(a.weight/Math.pow(a.height/100,2)).toFixed(1):null;t.push({id:`weight-${a.id}`,type:"weight",title:"Peso Registrado",description:`Peso: ${a.weight} kg`,timestamp:a.created_at,metadata:i?[`${a.weight} kg`,`IMC: ${i}`]:[`${a.weight} kg`]})});const{data:c}=await s.from("user_achievements").select("id, achievement_id, achieved_at, achievements(name)").eq("user_id",r).order("achieved_at",{ascending:!1}).limit(15);c&&c.forEach(a=>{t.push({id:`achievement-${a.id}`,type:"achievement",title:"Conquista Desbloqueada",description:a.achievements?.name||"Nova conquista",timestamp:a.achieved_at,metadata:["ðŸ† Conquista"]})});const{data:l}=await s.from("appointments").select("id, appointment_time, status, notes").eq("patient_id",r).order("appointment_time",{ascending:!1}).limit(15);return l&&l.forEach(a=>{t.push({id:`appointment-${a.id}`,type:"appointment",title:"Consulta Realizada",description:a.notes||"Consulta de acompanhamento",timestamp:a.appointment_time,metadata:[a.status||"ConcluÃ­da"]})}),t.sort((a,i)=>new Date(i.timestamp)-new Date(a.timestamp)),{data:t.slice(0,e),error:null}}catch(t){return m("Erro ao buscar atividades do paciente",t),{data:[],error:t}}},D=async(r,e)=>{try{const[t,o,n]=await Promise.all([h(r,e),f(r),y(r)]);if(t.error)throw t.error;return{data:{profile:t.data,metrics:o.data||{},modulesStatus:n.data||{}},error:null}}catch(t){return m("Erro ao buscar resumo do paciente",t),{data:null,error:t}}},E=async r=>{try{const{data:e,error:t}=await s.rpc("get_patients_low_adherence_optimized",{p_nutritionist_id:r,p_days_threshold:2});if(t)throw t;return{data:(e||[]).map(n=>({id:n.patient_id,name:n.patient_name,last_activity:n.last_meal_date,days_inactive:n.days_since_last_meal===9999?null:n.days_since_last_meal})),error:null}}catch(e){return m("Erro ao detectar baixa adesÃ£o",e),{data:[],error:e}}},$=async r=>{try{const{data:e,error:t}=await s.rpc("get_patients_pending_data_optimized",{p_nutritionist_id:r});if(t)throw t;return{data:(e||[]).map(n=>{const c=[];return n.pending_items.forEach(l=>{const a={anamnese:{type:"anamnesis",label:"Anamnese Pendente",route:`/nutritionist/patients/${n.patient_id}/anamnese`},anthropometry:{type:"anthropometry",label:"AvaliaÃ§Ã£o AntropomÃ©trica Pendente",route:`/nutritionist/patients/${n.patient_id}/anthropometry`},meal_plan:{type:"meal_plan",label:"Plano Alimentar Pendente",route:`/nutritionist/patients/${n.patient_id}/meal-plan`},prescription:{type:"prescription",label:"CÃ¡lculo de Necessidades Pendente",route:`/nutritionist/patients/${n.patient_id}/energy-expenditure`}};a[l]&&c.push(a[l])}),{patient_id:n.patient_id,patient_name:n.patient_name,pending_items:c}}),error:null}}catch(e){return m("Erro ao detectar pendÃªncias",e),{data:[],error:e}}},P=async r=>{try{const{data:e,error:t}=await s.from("notification_rules").select("id, scope, nutritionist_id, rule_key, weight, config, is_active, updated_at").eq("scope","feed_priority").eq("is_active",!0).or(`nutritionist_id.is.null,nutritionist_id.eq.${r}`).order("nutritionist_id",{ascending:!0}).order("weight",{ascending:!1});if(t)throw t;return{data:e||[],error:null}}catch(e){return m("Erro ao buscar regras de prioridade do feed",e),{data:[],error:e}}},A=async r=>{try{const e=g(r||{}),{data:t,error:o}=await s.rpc("log_activity_event",{p_event_name:e.event_name,p_event_version:e.event_version,p_source_module:e.source_module,p_patient_id:e.patient_id,p_nutritionist_id:e.nutritionist_id,p_payload:e.payload});if(o)throw o;return{data:t||null,error:null}}catch(e){return m("Erro ao registrar evento de atividade",e),{data:null,error:e}}},S=async(r,e=20)=>{try{const{data:t,error:o}=await s.rpc("get_comprehensive_activity_feed_optimized",{p_nutritionist_id:r,p_limit:e});if(o)throw o;const n=[...new Set(t?.map(i=>i.patient_id)||[])],{data:c}=await s.from("user_profiles").select("id, avatar_url").in("id",n),l=Object.fromEntries((c||[]).map(i=>[i.id,i.avatar_url]));return{data:(t||[]).map(i=>{const d={id:`${i.activity_type}-${i.activity_id}`,type:i.activity_type,patient_id:i.patient_id,patient_name:i.patient_name,patient_avatar:l[i.patient_id]||null,timestamp:i.activity_date,metadata:i.activity_data};switch(i.activity_type){case"meal":return{...d,title:"RefeiÃ§Ã£o Registrada",description:`${i.activity_data.meal_type} - ${i.activity_data.total_calories||0} kcal`};case"anthropometry":const p=i.activity_data.height&&i.activity_data.weight?(i.activity_data.weight/Math.pow(i.activity_data.height/100,2)).toFixed(1):null;return{...d,title:"Peso Registrado",description:`Peso: ${i.activity_data.weight} kg${p?` - IMC: ${p}`:""}`};case"anamnesis":return{...d,title:"Anamnese Preenchida",description:"Anamnese completa"};case"meal_plan":return{...d,title:"Plano Alimentar Criado",description:i.activity_data.name};case"prescription":return{...d,title:"PrescriÃ§Ã£o Nutricional",description:`${i.activity_data.calories||""} kcal`};case"appointment":return{...d,title:"Consulta Agendada",description:i.activity_data.notes||"Consulta de acompanhamento"};case"chat":return{...d,type:"message",title:"Mensagem Recebida",description:i.activity_data.message_preview||"Mensagem"};case"achievement":return{...d,title:"Conquista Desbloqueada",description:i.activity_data.achievement_name||"Nova conquista"};default:return d}}),error:null}}catch(t){return m("Erro ao buscar feed de atividades",t),{data:[],error:t}}},R=async r=>{try{const{data:e,error:t}=await s.from("anamnesis_records").select("id, content, date").eq("patient_id",r).order("date",{ascending:!1}).limit(1).maybeSingle();if(t)throw t;if(!e||!e.content)return{data:null,error:null};const o=e.content;let n=null,c=null;if(typeof o=="object"){const l=["exercise_frequency","exerciseFrequency","frequencia_exercicio","atividade_fisica","physical_activity","nivel_atividade","activity_level"];for(const a of l)if(o[a]){n=o[a];break}if(!n&&o.sections){for(const a of o.sections)if(a.fields){for(const i of a.fields)if(l.includes(i.key||i.id)){n=i.value||i.answer;break}}}}return{data:{exerciseFrequency:n,activityLevel:c,date:e.date},error:null}}catch(e){return m("Erro ao buscar anamnese para energia",e),{data:null,error:e}}},k=async r=>{try{const{data:e,error:t}=await s.from("patient_goals").select("id, goal_type, target_weight, current_weight, description, status").eq("patient_id",r).eq("status","active").order("created_at",{ascending:!1}).limit(1).maybeSingle();if(t)throw t;return{data:e,error:null}}catch(e){return m("Erro ao buscar objetivo para energia",e),{data:null,error:e}}};export{E as a,$ as b,P as c,D as d,q as e,h as f,S as g,R as h,k as i,A as l};
