import{q as He,r as t,j as e,J as ve,K as Ne,M as be,N as ye,ad as we,s as ue,B as b,Q as Qe,O as Pe,X as Oe,V as Ws,C as ee,c as me,d as xe,e as se,T as ss,b as ts,a as Cs,L as Ke,A as _s,h as Ss,i as Fs,k as ks,l as Ms,n as Ps,o as As,p as Ts,$ as ze,a5 as Hs,u as Ks,D as Qs,x as Ys,y as Xs,z as Me,an as ds}from"./index-BvWB-6Y-.js";import{I as fe}from"./input-OBodSLFw.js";import{B as pe}from"./badge-CCK5Bs0D.js";import{A as De,a as Re}from"./alert-BZscs13a.js";import{T as Zs,D as ms}from"./date-input-NufpG6-F.js";import{L as Z}from"./label-Dds-NHUC.js";import{T as as}from"./textarea-DCWQIVw9.js";import{C as Ye}from"./checkbox-CP0b09Ss.js";import{S as Es,a as Is,b as zs,c as Ds,d as Xe}from"./select-CHitR1r5.js";import{S as Js,a as We}from"./SmartFoodForm-aP96dP9u.js";import{P as Ce}from"./plus-BWNKYoo4.js";import{S as rs}from"./search-DAzfs9rU.js";import{l as ls}from"./query-helpers-mbysFH2_.js";import{f as Rs}from"./measureTranslations-AG6EuUvS.js";import{P as Le}from"./pen-square-OCV3PTXs.js";import{R as et}from"./ReferenceValuesModal-D9xbtYIx.js";import{F as xs}from"./flame-DbwLYwhx.js";import{T as Ls}from"./target-Bs9FM_-p.js";import{B as Ze,R as us}from"./refresh-cw-DBLq2CV4.js";import{T as hs}from"./trending-down-Be-17Tpn.js";import{T as ps}from"./trending-up-DCN4wKoA.js";import{M as st}from"./minus-Doq1nRnQ.js";import{getReferenceValues as Os,simulateMealPlanPortionAdjustment as tt,getTemplates as at,getMealPlanById as Ve,applyTemplateToPatient as rt,getMealPlans as lt,getActiveMealPlan as ot,getMealPlanVersions as nt,updateFullMealPlan as it,createMealPlan as ct,addMealToPlan as dt,addFoodToMeal as mt,archiveMealPlan as xt,restoreMealPlanVersion as ut,setActiveMealPlan as ht,deleteMealPlan as pt,copyMealPlanToPatient as ft,savePlanAsTemplate as gt}from"./meal-plan-queries-CiET4OPt.js";import{C as jt}from"./calendar-BxLBJTLY.js";import{S as vt}from"./save-BW9rbxWl.js";import{g as Nt}from"./anamnesis-queries-CYDtzKhB.js";import{g as bt}from"./date-C2sroe8F.js";import{F as Ge}from"./file-text-CyOxrREb.js";import{U as Je}from"./utensils-CLVAb11L.js";import{R as yt}from"./ruler-CYjLqm7s.js";import{e as wt}from"./pdfUtils-DbTjH_I8.js";import{E as Ct}from"./jspdf.es.min-B7ZBL3OL.js";import{a as _t}from"./jspdf.plugin.autotable-C3NxY6Hi.js";import{t as St}from"./mealTranslations-B1KHhmEq.js";import{P as Ft}from"./progress-Di_AUcQX.js";import{P as kt,a as Mt,b as Pt}from"./popover-BK70NwGK.js";import{A as Ue}from"./alert-circle-HzKGSyQg.js";import{C as fs}from"./calculator-CBQEutXX.js";import{I as At}from"./info-Cibi8VF-.js";import{C as gs}from"./check-circle-2-DqvAHxH6.js";import{d as Tt,h as js}from"./anthropometry-queries-6h0yDXkz.js";import{A as vs}from"./arrow-left-c5Ho3YFj.js";import{M as Et}from"./more-vertical-DrBGzXSO.js";import{D as Ns}from"./download-CU2JC9ir.js";import"./calendar-rgGv7qqU.js";import"./endOfMonth-Ca9QmV5D.js";import"./addMonths-hOFFPW3g.js";import"./isSameDay-CSO39H9U.js";import"./chevron-left-FDyjizdT.js";import"./pt-BR-BMtVLtF7.js";import"./parseISO-DtrTOw4I.js";import"./index-DQp_4bzJ.js";import"./extends-CF3RwP-h.js";import"./tabs-CA5k0aJI.js";import"./foodService-BaXPLfK4.js";import"./slider-BvjEZYFe.js";import"./nutrition-calculations-DjYFS08l.js";import"./observability-queries-BxbsnaqH.js";import"./html2canvas.esm-B0tyYwQk.js";import"./patient-queries-DNM8Wnzg.js";import"./lab-results-queries-B3ZMjFH4.js";const It=He("Archive",[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]]),es=He("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]),bs=He("ShoppingCart",[["circle",{cx:"8",cy:"21",r:"1",key:"jimo8o"}],["circle",{cx:"19",cy:"21",r:"1",key:"13723u"}],["path",{d:"M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12",key:"9zh506"}]]),ys=He("Tag",[["path",{d:"M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z",key:"14b2ls"}],["path",{d:"M7 7h.01",key:"7u93v4"}]]);function zt({open:r,onOpenChange:d,initialName:i="",onFoodCreated:h}){const l=t.useRef(null),u=v=>{h&&h(v),m()},m=()=>{d(!1)};return e.jsx(ve,{open:r,onOpenChange:m,children:e.jsxs(Ne,{className:"max-w-4xl max-h-[95vh] overflow-y-auto",children:[e.jsxs(be,{children:[e.jsxs(ye,{className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"h-5 w-5"}),"Cadastrar Alimento Personalizado"]}),e.jsx(we,{children:"Preencha o formulÃ¡rio passo a passo para criar um alimento customizado. VocÃª pode buscar produtos no OpenFoodFacts ou preencher manualmente."})]}),e.jsx(Js,{ref:l,mode:"full",initialName:i,onSuccess:u})]})})}const Dt=({isOpen:r,onClose:d,onSelect:i})=>{const[h,l]=t.useState(""),[u,m]=t.useState([]),[v,p]=t.useState(!1),[_,o]=t.useState(null),[C,f]=t.useState(null),[P,y]=t.useState(!1),F=[{value:null,label:"Todos"},{value:"TACO",label:"TACO"},{value:"IBGE",label:"IBGE"},{value:"USDA",label:"USDA"},{value:"Tucunduva",label:"Tucunduva"},{value:"TBCA",label:"TBCA"},{value:"custom",label:"Personalizados"}];t.useEffect(()=>{r&&E()},[r,h,C]);const E=async()=>{if(h.length<2){m([]);return}p(!0);try{let n=ue.from("foods").select("id, name, group, description, source, calories, protein, carbs, fat, fiber, sodium").eq("is_active",!0).ilike("name",`%${h}%`).order("name",{ascending:!0}).limit(50);C&&(n=n.eq("source",C));const{data:w,error:N}=await n;if(N)throw N;m(w||[])}catch(n){console.error("Erro ao buscar alimentos:",n),m([])}finally{p(!1)}},z=()=>{_&&(i(_),O())},O=()=>{l(""),m([]),o(null),f(null),d()},j=async n=>{y(!1),m([n,...u]),o(n),h&&await E()};return e.jsxs(ve,{open:r,onOpenChange:O,children:[e.jsxs(Ne,{className:"max-w-3xl max-h-[80vh]",children:[e.jsxs(be,{children:[e.jsx(ye,{children:"Buscar Alimento"}),e.jsx(we,{children:"Procure alimentos por nome nas bases de dados nutricionais"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"search",children:"Nome do Alimento"}),e.jsxs("div",{className:"relative",children:[e.jsx(rs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(fe,{id:"search",placeholder:"Digite pelo menos 2 caracteres...",value:h,onChange:n=>l(n.target.value),className:"pl-10",autoFocus:!0})]})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:F.map(n=>e.jsx(pe,{variant:C===n.value?"default":"outline",className:"cursor-pointer",onClick:()=>f(n.value),children:n.label},n.value||"all"))}),e.jsxs(We,{className:"h-[400px] border rounded-md p-4",children:[v&&e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Buscando..."}),!v&&h.length<2&&e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Digite pelo menos 2 caracteres para buscar"}),!v&&h.length>=2&&u.length===0&&e.jsxs("div",{className:"text-center py-8 space-y-4",children:[e.jsx("p",{className:"text-muted-foreground",children:"Nenhum alimento encontrado"}),e.jsxs(b,{variant:"outline",onClick:()=>y(!0),className:"mx-auto",children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),"Cadastrar '",h,"' agora"]})]}),!v&&u.length>0&&e.jsx("div",{className:"space-y-2",children:u.map(n=>e.jsx("div",{className:`
                                            p-3 border rounded-lg cursor-pointer transition-colors
                                            ${_?.id===n.id?"bg-primary/10 border-primary":"hover:bg-muted"}
                                        `,onClick:()=>o(n),children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-semibold",children:n.name}),_?.id===n.id&&e.jsx(Qe,{className:"h-4 w-4 text-primary"})]}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsx(pe,{variant:"outline",className:"text-xs",children:n.source||"N/A"}),n.group&&e.jsx("span",{className:"text-xs text-muted-foreground",children:n.group})]}),n.description&&e.jsx("p",{className:"text-sm text-muted-foreground mt-1 line-clamp-1",children:n.description})]}),e.jsxs("div",{className:"ml-4 text-right text-sm",children:[e.jsxs("div",{className:"font-semibold",children:[n.calories," kcal"]}),e.jsxs("div",{className:"text-muted-foreground text-xs",children:["P: ",n.protein,"g | C: ",n.carbs,"g | G: ",n.fat,"g"]})]})]})},n.id))})]})]}),e.jsxs(Pe,{children:[e.jsxs(b,{variant:"outline",onClick:O,children:[e.jsx(Oe,{className:"h-4 w-4 mr-2"}),"Cancelar"]}),e.jsxs(b,{onClick:z,disabled:!_,children:[e.jsx(Qe,{className:"h-4 w-4 mr-2"}),"Selecionar"]})]})]}),e.jsx(zt,{open:P,onOpenChange:y,initialName:h,onFoodCreated:j})]})},Rt=async()=>{try{const{data:r,error:d}=await ue.from("household_measures").select("*").eq("is_active",!0).order("order_index",{ascending:!0});if(d)throw d;return{data:r||[],error:null}}catch(r){return ls("Erro ao buscar medidas caseiras",r),{data:null,error:r}}},Lt=async r=>{try{const{data:d,error:i}=await ue.from("food_household_measures").select(`
        id,
        food_id,
        measure_id,
        quantity,
        grams,
        created_at,
        updated_at,
        measure:household_measures(
          id,
          name,
          code,
          category,
          description,
          ml_equivalent,
          grams_equivalent,
          order_index
        )
      `).eq("food_id",r).order("measure(order_index)",{ascending:!0});if(i)throw i;return{data:d||[],error:null}}catch(d){return ls("Erro ao buscar medidas do alimento",d),{data:null,error:d}}},Ot=r=>{const[d,i]=t.useState([]),[h,l]=t.useState(!1),[u,m]=t.useState(null),v=t.useCallback(async()=>{if(!r){i([]);return}l(!0),m(null);try{const p=await Lt(r);if(p.error)throw p.error;i(p.data||[])}catch(p){console.error("Erro ao carregar medidas:",p),m(p),i([])}finally{l(!1)}},[r]);return t.useEffect(()=>{v()},[v]),{data:d,isLoading:h,error:u,refetch:v}},$t=(r={})=>{const[d,i]=t.useState([]),[h,l]=t.useState(!0),[u,m]=t.useState(null),v=t.useCallback(async()=>{l(!0),m(null);try{const p=await Rt();if(p.error)throw p.error;i(p.data||[])}catch(p){console.error("Erro ao carregar medidas caseiras:",p),m(p),i([])}finally{l(!1)}},[]);return t.useEffect(()=>{v()},[v]),{data:d,isLoading:h,error:u,refetch:v}};function qt({food:r,value:d={quantity:100,measureId:null},onChange:i,showNutrition:h=!0,className:l="",onNutritionChange:u=null}){const{data:m=[],isLoading:v}=$t(),{data:p=[],isLoading:_}=Ot(r?.id),o=v||_,C=t.useMemo(()=>m.map(j=>({...j,hasSpecificConversion:p.some(n=>n.measure_id===j.id)})),[m,p]),f=t.useMemo(()=>{if(!d.measureId||d.measureId==="grams"||p.find(w=>w.measure_id===d.measureId))return!1;const n=m.find(w=>w.id===d.measureId);return n&&n.grams_equivalent?!1:!!n},[d.measureId,p,m]),P=t.useMemo(()=>{if(!r||!d.quantity)return 0;if(d.measureId===null||d.measureId==="grams")return d.quantity;const j=p.find(w=>w.measure_id===d.measureId);if(j)return j.grams*d.quantity/j.quantity;const n=m.find(w=>w.id===d.measureId);return n&&n.grams_equivalent?n.grams_equivalent*d.quantity:n?(console.warn(`Usando portion_size como fallback para medida "${n.name}"`),(r.portion_size||100)*d.quantity):(console.error(`Medida ${d.measureId} nÃ£o encontrada`),0)},[r,d,p,m]),y=t.useMemo(()=>{if(!r||P===0)return{grams:0,calories:0,protein:0,carbs:0,fat:0,fiber:0,sodium:0};const j=P/100,n=(r.protein||0)*j,w=(r.carbs||0)*j,N=(r.fat||0)*j,W=n*4+w*4+N*9;return{grams:P,calories:parseFloat(W.toFixed(2)),protein:parseFloat(n.toFixed(2)),carbs:parseFloat(w.toFixed(2)),fat:parseFloat(N.toFixed(2)),fiber:r.fiber?parseFloat((r.fiber*j).toFixed(2)):0,sodium:r.sodium?parseFloat((r.sodium*j).toFixed(2)):0}},[r,P]);t.useEffect(()=>{u&&u(y)},[y,u]);const F=j=>{i({...d,quantity:parseFloat(j)||0})},E=j=>{i({...d,measureId:j==="grams"?null:parseInt(j)})},z=t.useMemo(()=>C.reduce((j,n)=>{const w=n.category||"other";return j[w]||(j[w]=[]),j[w].push(n),j},{}),[C]),O={volume:"Medidas de Volume",weight:"Medidas de Peso",unit:"Unidades",other:"Outras"};return e.jsxs("div",{className:`space-y-2 ${l}`,children:[e.jsx(Z,{children:"PorÃ§Ã£o"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fe,{type:"number",value:d.quantity,onChange:j=>F(j.target.value),min:0,step:.5,className:"w-24",placeholder:"0",disabled:!r}),e.jsxs(Es,{value:d.measureId?.toString()??"grams",onValueChange:E,disabled:!r||o,children:[e.jsx(Is,{className:"w-40",children:e.jsx(zs,{placeholder:o?"Carregando...":"Selecione"})}),e.jsxs(Ds,{className:"max-h-[300px]",children:[e.jsx(Xe,{value:"grams",children:"g"}),e.jsx("div",{className:"overflow-y-auto max-h-[280px]",children:Object.entries(z).map(([j,n])=>e.jsxs(Ws.Fragment,{children:[e.jsx("div",{className:"px-2 py-1.5 text-xs font-semibold text-muted-foreground sticky top-0 bg-popover",children:O[j]||j}),n.map(w=>e.jsxs(Xe,{value:w.id.toString(),className:"pl-6",children:[e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsx("span",{children:w.name}),w.hasSpecificConversion&&e.jsx("span",{className:"ml-2 text-xs text-primary",children:"â˜…"})]}),w.description&&e.jsx("div",{className:"text-xs text-muted-foreground",children:w.description})]},w.id))]},j))})]})]}),h&&r&&P>0&&e.jsxs("span",{className:"text-sm text-muted-foreground whitespace-nowrap",children:["â‰ˆ ",y.grams.toFixed(0),"g | ",Math.round(y.calories)," kcal"]})]}),r&&!o&&p.length>0&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"â˜… = ConversÃ£o especÃ­fica para este alimento"}),f&&e.jsxs("div",{className:"text-xs text-amber-600 dark:text-amber-500 bg-amber-50 dark:bg-amber-950/30 p-2 rounded border border-amber-200 dark:border-amber-800",children:["âš ï¸ Estimativa aproximada (",r.portion_size||100,"g por unidade). Para maior precisÃ£o, cadastre a conversÃ£o especÃ­fica."]})]})}const Bt=({isOpen:r,onClose:d,onAdd:i,mealName:h,initialData:l=null})=>{const[u,m]=t.useState(null),[v,p]=t.useState({quantity:100,measureId:null}),[_,o]=t.useState(""),[C,f]=t.useState(null),[P,y]=t.useState(!1),[F,E]=t.useState({});t.useEffect(()=>{l&&(m(l.food),p({quantity:l.quantity||100,measureId:l.unit==="gram"?null:l.unit}),o(l.notes||""),f({calories:l.calories||0,protein:l.protein||0,carbs:l.carbs||0,fat:l.fat||0}))},[l]);const z=N=>{m(N),y(!1),p({quantity:100,measureId:null}),f(null)},O=N=>{f(N)},j=()=>{const N={};return u||(N.food="Selecione um alimento"),(!v.quantity||v.quantity<=0)&&(N.portion="Quantidade deve ser maior que zero"),E(N),Object.keys(N).length===0},n=()=>{if(!j())return;const N={food_id:u.id,food:u,quantity:v.quantity,unit:v.measureId||"gram",calories:C?.calories||0,protein:C?.protein||0,carbs:C?.carbs||0,fat:C?.fat||0,notes:_.trim()||null};i(N),w()},w=()=>{m(null),p({quantity:100,measureId:null}),o(""),f(null),E({}),d()};return e.jsxs(e.Fragment,{children:[e.jsx(ve,{open:r,onOpenChange:w,children:e.jsxs(Ne,{className:"max-w-2xl",children:[e.jsxs(be,{children:[e.jsx(ye,{children:l?"Editar Alimento":"Adicionar Alimento"}),e.jsx(we,{children:l?`Editar alimento: ${l.food?.name||""}`:h?`Adicionar alimento Ã  refeiÃ§Ã£o: ${h}`:"Adicionar novo alimento"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Z,{children:["Alimento ",e.jsx("span",{className:"text-destructive",children:"*"})]}),u?e.jsxs("div",{className:"flex items-center gap-2 p-3 border rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-semibold",children:u.name}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[u.group," â€¢ ",u.source]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:["Base 100g: ",u.calories," kcal | P: ",u.protein,"g | C: ",u.carbs,"g | G: ",u.fat,"g"]})]}),e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>y(!0),children:"Trocar"})]}):e.jsxs(b,{variant:"outline",className:"w-full",onClick:()=>y(!0),children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),"Buscar Alimento"]}),F.food&&e.jsx("p",{className:"text-xs text-destructive",children:F.food})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(qt,{food:u,value:v,onChange:p,showNutrition:!1,onNutritionChange:O}),F.portion&&e.jsx("p",{className:"text-xs text-destructive",children:F.portion})]}),C&&e.jsx(De,{className:"bg-primary/5",children:e.jsxs(Re,{children:[e.jsx("div",{className:"font-semibold mb-2",children:"Valores Nutricionais:"}),e.jsxs("div",{className:"grid grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground text-xs",children:"Calorias"}),e.jsx("div",{className:"font-bold text-lg",children:Math.round(C.calories)}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"kcal"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground text-xs",children:"ProteÃ­nas"}),e.jsx("div",{className:"font-bold text-lg",children:C.protein.toFixed(1)}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"g"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground text-xs",children:"Carboidratos"}),e.jsx("div",{className:"font-bold text-lg",children:C.carbs.toFixed(1)}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"g"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground text-xs",children:"Gorduras"}),e.jsx("div",{className:"font-bold text-lg",children:C.fat.toFixed(1)}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"g"})]})]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"notes",children:"ObservaÃ§Ãµes (opcional)"}),e.jsx(as,{id:"notes",rows:2,placeholder:"Ex: sem sal, sem aÃ§Ãºcar, etc.",value:_,onChange:N=>o(N.target.value)})]})]}),e.jsxs(Pe,{children:[e.jsxs(b,{variant:"outline",onClick:w,children:[e.jsx(Oe,{className:"h-4 w-4 mr-2"}),"Cancelar"]}),e.jsxs(b,{onClick:n,children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),l?"Atualizar":"Adicionar"]})]})]})}),e.jsx(Dt,{isOpen:P,onClose:()=>y(!1),onSelect:z})]})},Vt=({isOpen:r,onClose:d,onSave:i,initialData:h=null})=>{const[l,u]=t.useState({name:"",meal_type:"",meal_time:"",notes:""}),[m,v]=t.useState([]),[p,_]=t.useState(!1),[o,C]=t.useState(null),[f,P]=t.useState({}),y=[{value:"breakfast",label:"CafÃ© da ManhÃ£"},{value:"morning_snack",label:"Lanche da ManhÃ£"},{value:"lunch",label:"AlmoÃ§o"},{value:"afternoon_snack",label:"Lanche da Tarde"},{value:"dinner",label:"Jantar"},{value:"supper",label:"Ceia"},{value:"pre_workout",label:"PrÃ©-Treino"},{value:"post_workout",label:"PÃ³s-Treino"},{value:"other",label:"Outro"}];t.useEffect(()=>{h&&(u({name:h.name||"",meal_type:h.meal_type||"",meal_time:h.meal_time||"",notes:h.notes||""}),v(h.foods||[]))},[h]);const F=(g,$)=>{u(V=>{const Y={...V,[g]:$};return g==="meal_type"&&$!=="other"&&(Y.name=""),Y}),f[g]&&P(V=>({...V,[g]:null}))},E=g=>{v($=>[...$,{...g,tempId:Date.now()}])},z=g=>{C(g),_(!0)},O=g=>{v($=>$.map(V=>V.tempId===o.tempId?{...g,tempId:V.tempId}:V)),C(null)},j=g=>{v($=>$.filter(V=>V.tempId!==g))},n=()=>{_(!1),C(null)},w=()=>m.reduce((g,$)=>({calories:g.calories+($.calories||0),protein:g.protein+($.protein||0),carbs:g.carbs+($.carbs||0),fat:g.fat+($.fat||0)}),{calories:0,protein:0,carbs:0,fat:0}),N=()=>{const g={};return l.meal_type||(g.meal_type="Tipo de refeiÃ§Ã£o Ã© obrigatÃ³rio"),l.meal_type==="other"&&!l.name.trim()&&(g.name='Nome da refeiÃ§Ã£o Ã© obrigatÃ³rio quando tipo Ã© "Outro"'),m.length===0&&(g.foods="Adicione pelo menos um alimento"),P(g),Object.keys(g).length===0},W=()=>{if(!N())return;const g=w(),V={name:l.meal_type==="other"?l.name:y.find(Y=>Y.value===l.meal_type)?.label||"",meal_type:l.meal_type,meal_time:l.meal_time,notes:l.notes,foods:m,...g};i(V),H()},H=()=>{u({name:"",meal_type:"",meal_time:"",notes:""}),v([]),P({}),d()},A=w();return e.jsxs(e.Fragment,{children:[e.jsx(ve,{open:r,onOpenChange:H,children:e.jsxs(Ne,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(be,{children:[e.jsx(ye,{children:h?"Editar RefeiÃ§Ã£o":"Nova RefeiÃ§Ã£o"}),e.jsx(we,{children:"Configure a refeiÃ§Ã£o e adicione os alimentos"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(ee,{children:[e.jsx(me,{children:e.jsx(xe,{className:"text-lg",children:"InformaÃ§Ãµes da RefeiÃ§Ã£o"})}),e.jsxs(se,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Z,{htmlFor:"meal_type",children:["Tipo de RefeiÃ§Ã£o ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs(Es,{value:l.meal_type,onValueChange:g=>F("meal_type",g),children:[e.jsx(Is,{id:"meal_type",className:f.meal_type?"border-destructive":"",children:e.jsx(zs,{placeholder:"Selecione o tipo"})}),e.jsx(Ds,{children:y.map(g=>e.jsx(Xe,{value:g.value,children:g.label},g.value))})]}),f.meal_type&&e.jsx("p",{className:"text-xs text-destructive",children:f.meal_type})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"meal_time",children:"HorÃ¡rio (opcional)"}),e.jsx(Zs,{id:"meal_time",value:l.meal_time,onChange:g=>F("meal_time",g)})]})]}),l.meal_type==="other"&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Z,{htmlFor:"name",children:["Nome da RefeiÃ§Ã£o ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(fe,{id:"name",placeholder:"Ex: Lanche Noturno, SuplementaÃ§Ã£o",value:l.name,onChange:g=>F("name",g.target.value),className:f.name?"border-destructive":""}),f.name&&e.jsx("p",{className:"text-xs text-destructive",children:f.name})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"notes",children:"ObservaÃ§Ãµes (opcional)"}),e.jsx(as,{id:"notes",rows:2,placeholder:"ObservaÃ§Ãµes sobre a refeiÃ§Ã£o...",value:l.notes,onChange:g=>F("notes",g.target.value)})]})]})]}),e.jsxs(ee,{children:[e.jsx(me,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(xe,{className:"text-lg",children:"Alimentos"}),e.jsxs(b,{size:"sm",onClick:()=>_(!0),children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),"Adicionar Alimento"]})]})}),e.jsx(se,{children:m.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:["Nenhum alimento adicionado ainda",f.foods&&e.jsx("p",{className:"text-destructive mt-2",children:f.foods})]}):e.jsxs("div",{className:"space-y-2",children:[m.map(g=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-semibold",children:g.food.name}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[Rs(g.quantity,g.unit,g.measure)," â€¢"," ",g.calories," kcal â€¢ P: ",g.protein,"g â€¢ C: ",g.carbs,"g â€¢ G: ",g.fat,"g"]}),g.notes&&e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:g.notes})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>z(g),title:"Editar alimento",children:e.jsx(Le,{className:"h-4 w-4"})}),e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>j(g.tempId),title:"Remover alimento",children:e.jsx(ss,{className:"h-4 w-4 text-destructive"})})]})]},g.tempId)),e.jsxs("div",{className:"mt-4 p-4 bg-primary/5 rounded-lg",children:[e.jsx("div",{className:"font-semibold mb-2",children:"Totais da RefeiÃ§Ã£o:"}),e.jsxs("div",{className:"grid grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Calorias"}),e.jsx("div",{className:"font-bold text-lg",children:A.calories.toFixed(1)}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"kcal"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"ProteÃ­nas"}),e.jsx("div",{className:"font-bold text-lg",children:A.protein.toFixed(1)}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"g"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Carboidratos"}),e.jsx("div",{className:"font-bold text-lg",children:A.carbs.toFixed(1)}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"g"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground",children:"Gorduras"}),e.jsx("div",{className:"font-bold text-lg",children:A.fat.toFixed(1)}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"g"})]})]})]})]})})]})]}),e.jsxs(Pe,{children:[e.jsxs(b,{variant:"outline",onClick:H,children:[e.jsx(Oe,{className:"h-4 w-4 mr-2"}),"Cancelar"]}),e.jsxs(b,{onClick:W,children:[h?"Atualizar":"Adicionar"," RefeiÃ§Ã£o"]})]})]})}),e.jsx(Bt,{isOpen:p,onClose:n,onAdd:o?O:E,initialData:o,mealName:l.meal_type==="other"?l.name:y.find(g=>g.value===l.meal_type)?.label})]})},$s=({protein:r,carbs:d,fat:i,calories:h,patientId:l,planId:u,referenceValues:m,onReferenceUpdate:v,readOnly:p=!1})=>{const _=ts(),[o,C]=t.useState(!1),f={protein:"#8B3BF2",carbs:"#3B6FF2",fat:"#F28B3B"},P=r*4,y=d*4,F=i*9,E=P+y+F,z=E>0?P/E*100:0,O=E>0?y/E*100:0,j=E>0?F/E*100:0,n=m?.weight_kg?parseFloat(m.weight_kg):null,w=n?r/n:null,N=n?d/n:null,W=n?i/n:null,A=(()=>{if(!m)return null;const S=parseFloat(m.weight_kg),M=parseFloat(m.total_energy_kcal);if(!S||!M)return null;let q,B,U;return m.macro_mode==="percentage"?(q=M*m.protein_percentage/4,B=M*m.carbs_percentage/4,U=M*m.fat_percentage/9):(q=S*m.protein_g_per_kg,B=S*m.carbs_g_per_kg,U=S*m.fat_g_per_kg),{calories:M,protein:q,carbs:B,fat:U,proteinPerKg:q/S,carbsPerKg:B/S,fatPerKg:U/S}})(),g=(S,M)=>{if(!M||M===0)return null;const q=S/M*100,B=S-M,U=q-100;let J="adequate";return q<95||q>105?J="inadequate":q<100?J="below":q>100&&(J="above"),{percentage:q,diff:B,diffPerc:U,status:J}},$=A?g(h,A.calories):null,V=A?g(r,A.protein):null,Y=A?g(d,A.carbs):null,ge=A?g(i,A.fat):null,oe=({adequacy:S,compact:M=!1})=>{if(!S)return null;const B=(U=>{switch(U){case"adequate":return{color:"bg-green-100 text-green-700 border-green-300",icon:e.jsx(st,{className:"w-3 h-3"}),label:"OK"};case"below":return{color:"bg-yellow-100 text-yellow-700 border-yellow-300",icon:e.jsx(hs,{className:"w-3 h-3"}),label:S.diffPerc.toFixed(0)};case"above":return{color:"bg-yellow-100 text-yellow-700 border-yellow-300",icon:e.jsx(ps,{className:"w-3 h-3"}),label:`+${S.diffPerc.toFixed(0)}`};case"inadequate":return{color:S.percentage<95?"bg-red-100 text-red-700 border-red-300":"bg-orange-100 text-orange-700 border-orange-300",icon:S.percentage<95?e.jsx(hs,{className:"w-3 h-3"}):e.jsx(ps,{className:"w-3 h-3"}),label:S.percentage<95?S.diffPerc.toFixed(0):`+${S.diffPerc.toFixed(0)}`};default:return null}})(S.status);return B?M?e.jsxs("div",{className:`inline-flex items-center gap-0.5 px-1.5 py-0.5 rounded-md border text-xs font-semibold ${B.color}`,children:[B.icon,e.jsxs("span",{children:[B.label,"%"]})]}):e.jsxs("div",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-md border text-xs font-semibold ${B.color}`,children:[B.icon,e.jsxs("span",{children:[S.percentage.toFixed(0),"%"]})]}):null},_e=()=>{const U=(D,T)=>{const te=J(75,75,60,T),ce=J(75,75,60,D),le=T-D<=180?"0":"1";return["M",75,75,"L",te.x,te.y,"A",60,60,0,le,0,ce.x,ce.y,"Z"].join(" ")},J=(D,T,te,ce)=>{const le=(ce-90)*Math.PI/180;return{x:D+te*Math.cos(le),y:T+te*Math.sin(le)}};let X=0;const K=z/100*360,ie=O/100*360;return e.jsxs("svg",{width:150,height:150,viewBox:"0 0 150 150",className:"mx-auto",children:[z>0&&e.jsx("path",{d:U(X,X+K),fill:f.protein,opacity:"0.9",className:"hover:opacity-100 transition-opacity cursor-pointer"}),O>0&&e.jsx("path",{d:U(X+K,X+K+ie),fill:f.carbs,opacity:"0.9",className:"hover:opacity-100 transition-opacity cursor-pointer"}),j>0&&e.jsx("path",{d:U(X+K+ie,360),fill:f.fat,opacity:"0.9",className:"hover:opacity-100 transition-opacity cursor-pointer"}),e.jsx("circle",{cx:75,cy:75,r:38,fill:"#fefae0"}),e.jsx("text",{x:75,y:72,textAnchor:"middle",className:"text-xl font-bold",fill:"#000",children:h.toFixed(0)}),e.jsx("text",{x:75,y:87,textAnchor:"middle",className:"text-[10px]",fill:"#666",children:"kcal"})]})},ne=({label:S,color:M,current:q,target:B,currentPerKg:U,targetPerKg:J,percentage:X,adequacy:K,unit:ie="g",isEnergy:D=!1})=>e.jsxs("div",{className:"p-2 rounded-lg border transition-colors",style:M?{backgroundColor:`${M}0D`,borderColor:`${M}33`}:{backgroundColor:"rgb(250 250 249 / 0.3)",borderColor:"rgb(228 228 231)"},children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-0.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[M&&!D&&e.jsx("div",{className:"w-2 h-2 rounded-full flex-shrink-0",style:{backgroundColor:M}}),D&&e.jsx(xs,{className:"w-3 h-3 text-[#c4661f]"}),e.jsx("span",{className:`text-[10px] font-semibold uppercase tracking-wider ${M&&!D?"":"text-muted-foreground"}`,style:M&&!D?{color:M}:void 0,children:S})]}),K&&e.jsx(oe,{adequacy:K,compact:!0})]}),e.jsxs("div",{className:"flex items-baseline justify-between gap-2 flex-wrap min-w-0",children:[e.jsxs("div",{className:"flex items-baseline gap-1 flex-wrap min-w-0",children:[e.jsx("span",{className:`text-lg font-bold ${M&&!D?"":"text-foreground"}`,style:M&&!D?{color:M}:void 0,children:q.toFixed(D?0:1)}),e.jsx("span",{className:"text-[10px] text-muted-foreground font-medium",children:ie}),U&&!D&&e.jsxs("span",{className:"text-[10px] text-muted-foreground whitespace-nowrap",children:["(",U.toFixed(1)," g/kg)"]}),X!==void 0&&!D&&e.jsxs("span",{className:"text-[10px] text-muted-foreground whitespace-nowrap",children:["â€¢ ",X.toFixed(0),"%"]})]}),B&&e.jsxs("div",{className:"flex items-baseline gap-1 text-[10px] flex-wrap",children:[e.jsx("span",{className:"text-muted-foreground font-medium whitespace-nowrap",children:"Meta:"}),e.jsxs("span",{className:"font-bold text-foreground whitespace-nowrap",children:[B.toFixed(D?0:1),ie]}),J&&!D&&e.jsxs("span",{className:"text-muted-foreground whitespace-nowrap",children:["(",J.toFixed(1)," g/kg)"]})]})]})]});return e.jsxs(e.Fragment,{children:[e.jsxs(ee,{className:"h-full bg-gradient-to-br from-[#fefae0]/30 to-[#f9ebc7]/30 border-[#a9b388]",children:[e.jsx(me,{className:"pb-2",children:e.jsxs(xe,{className:"text-base flex items-center gap-2",children:[e.jsx(xs,{className:"w-4 h-4 text-[#c4661f]"}),"DistribuiÃ§Ã£o de Macronutrientes"]})}),e.jsxs(se,{className:"space-y-2",children:[e.jsx(_e,{}),e.jsxs("div",{className:"space-y-1",children:[A&&e.jsx(ne,{label:"Energia",current:h,target:A.calories,adequacy:$,unit:"kcal",isEnergy:!0}),e.jsx(ne,{label:"ProteÃ­nas",color:f.protein,current:r,target:A?.protein,currentPerKg:w,targetPerKg:A?.proteinPerKg,percentage:z,adequacy:V}),e.jsx(ne,{label:"Carboidratos",color:f.carbs,current:d,target:A?.carbs,currentPerKg:N,targetPerKg:A?.carbsPerKg,percentage:O,adequacy:Y}),e.jsx(ne,{label:"Gorduras",color:f.fat,current:i,target:A?.fat,currentPerKg:W,targetPerKg:A?.fatPerKg,percentage:j,adequacy:ge})]}),A&&e.jsx("div",{className:"flex items-center justify-center pt-1 border-t",children:[$,V,Y,ge].every(S=>S?.status==="adequate")?e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-green-700 bg-green-50 px-3 py-1.5 rounded-full border border-green-200",children:[e.jsx("div",{className:"w-1.5 h-1.5 bg-green-500 rounded-full"}),e.jsx("span",{className:"font-medium",children:"Plano adequado"})]}):e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-yellow-700 bg-yellow-50 px-3 py-1.5 rounded-full border border-yellow-200",children:[e.jsx("div",{className:"w-1.5 h-1.5 bg-yellow-500 rounded-full animate-pulse"}),e.jsx("span",{className:"font-medium",children:"Ajustes sugeridos"})]})}),!p&&e.jsxs("div",{className:"pt-1.5 border-t space-y-1",children:[e.jsxs(b,{type:"button",variant:"outline",size:"sm",onClick:()=>C(!0),className:"w-full gap-2",children:[e.jsx(Ls,{className:"w-4 h-4"}),A?"Editar Valores de ReferÃªncia":"Configurar Valores de ReferÃªncia"]}),u&&e.jsxs(b,{type:"button",variant:"outline",size:"sm",onClick:()=>_(`/nutritionist/patients/${l}/meal-plan/${u}/summary`),className:"w-full gap-2",children:[e.jsx(Ze,{className:"w-4 h-4"}),"Ver Resumo Nutricional Completo"]}),!A&&e.jsx("div",{className:"text-[10px] text-muted-foreground bg-[#fefae0] p-2 rounded-lg border border-[#a9b388]/30 text-center",children:"ðŸ’¡ Configure os valores de referÃªncia para ver anÃ¡lise de adequaÃ§Ã£o e g/kg"})]})]})]}),u&&e.jsx(et,{isOpen:o,onClose:()=>{C(!1),v&&v()},planId:u})]})},Gt=({patientId:r,nutritionistId:d,initialData:i=null,onSubmit:h,onCancel:l,loading:u=!1})=>{const[m,v]=t.useState({name:"",description:"",start_date:new Date().toISOString().split("T")[0],end_date:"",active_days:["monday","tuesday","wednesday","thursday","friday","saturday","sunday"]}),[p,_]=t.useState([]),[o,C]=t.useState(!1),[f,P]=t.useState(null),[y,F]=t.useState({}),[E,z]=t.useState(null),[O,j]=t.useState(1),[n,w]=t.useState("all"),[N,W]=t.useState(""),[H,A]=t.useState(""),g=[{value:"monday",label:"Segunda"},{value:"tuesday",label:"TerÃ§a"},{value:"wednesday",label:"Quarta"},{value:"thursday",label:"Quinta"},{value:"friday",label:"Sexta"},{value:"saturday",label:"SÃ¡bado"},{value:"sunday",label:"Domingo"}],$=t.useCallback(async()=>{if(i?.id){const{data:s}=await Os(i.id);z(s)}},[i?.id]);t.useEffect(()=>{if(i){v({name:i.name||"",description:i.description||"",start_date:i.start_date||new Date().toISOString().split("T")[0],end_date:i.end_date||"",active_days:i.active_days||[]});const s=(i.meals||[]).map((c,k)=>({...c,tempId:c.tempId||Date.now()+k,foods:(c.foods||[]).map((I,L)=>({...I,tempId:I.tempId||Date.now()+k+L+1e3}))}));_(s),$()}},[i,$]);const V=(s,c)=>{v(k=>({...k,[s]:c})),y[s]&&F(k=>({...k,[s]:null}))},Y=s=>{v(c=>({...c,active_days:c.active_days.includes(s)?c.active_days.filter(k=>k!==s):[...c.active_days,s]}))},ge=()=>{v(s=>({...s,active_days:s.active_days.length===7?[]:g.map(c=>c.value)}))},oe=()=>{const s=["monday","tuesday","wednesday","thursday","friday"];v(c=>({...c,active_days:s}))},_e=()=>{const s=["saturday","sunday"];v(c=>({...c,active_days:s}))},ne=s=>{_(c=>[...c,{...s,tempId:Date.now(),order_index:c.length}])},S=s=>{P(s),C(!0)},M=s=>{_(c=>c.map(k=>k.tempId===f.tempId?{...s,tempId:k.tempId}:k)),P(null)},q=s=>{_(c=>c.filter(k=>k.tempId!==s))},B=()=>p.reduce((s,c)=>({calories:s.calories+(c.calories||0),protein:s.protein+(c.protein||0),carbs:s.carbs+(c.carbs||0),fat:s.fat+(c.fat||0)}),{calories:0,protein:0,carbs:0,fat:0}),U=()=>{const s={};return m.name.trim()||(s.name="Nome do plano Ã© obrigatÃ³rio"),m.active_days.length===0&&(s.active_days="Selecione pelo menos um dia da semana"),m.start_date||(s.start_date="Data de inÃ­cio Ã© obrigatÃ³ria"),m.end_date&&m.end_date<m.start_date&&(s.end_date="Data final deve ser posterior Ã  data inicial"),p.length===0&&(s.meals="Adicione pelo menos uma refeiÃ§Ã£o"),F(s),Object.keys(s).length===0},J=s=>{if(s.preventDefault(),!U())return;const c=B(),k={patient_id:r,nutritionist_id:d,...m,...c,meals:p};h(k,i?.id)},X=B(),K=t.useMemo(()=>p.map(s=>({id:String(s.tempId??s.id),name:s.name||"RefeiÃ§Ã£o"})),[p]),ie=t.useMemo(()=>p.find(s=>String(s.tempId??s.id)===String(N))||null,[p,N]),D=t.useMemo(()=>(ie?.foods||[]).map(s=>({id:String(s.tempId??s.id),name:s.food?.name||s.foods?.name||"Alimento"})),[ie]);t.useEffect(()=>{if(!K.length){W("");return}(!N||!K.some(s=>s.id===String(N)))&&W(K[0].id)},[K,N]),t.useEffect(()=>{if(n==="food"){if(!D.length){A("");return}(!H||!D.some(s=>s.id===String(H)))&&A(D[0].id)}},[D,H,n]);const T=t.useMemo(()=>p.length?tt(p,O,{scope:n,mealId:N||null,foodId:H||null}):null,[p,O,n,N,H]),te=s=>{const c=Number(s);return Number.isFinite(c)?Math.min(3,Math.max(.3,c)):1},ce=()=>{T?.meals?.length&&(_(T.meals),j(1))},le=(s,c="")=>{const k=Number(s||0);return`${k>0?"+":""}${k.toFixed(c==="kcal"?0:1)}${c?` ${c}`:""}`};return e.jsxs(e.Fragment,{children:[e.jsxs("form",{onSubmit:J,className:"space-y-6",children:[e.jsxs(ee,{children:[e.jsx(me,{children:e.jsx(xe,{className:"text-lg",children:"InformaÃ§Ãµes do Plano"})}),e.jsxs(se,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Z,{htmlFor:"name",children:["Nome do Plano ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(fe,{id:"name",placeholder:"Ex: Dieta Hipertrofia",value:m.name,onChange:s=>V("name",s.target.value),className:y.name?"border-destructive":"",disabled:u}),y.name&&e.jsx("p",{className:"text-xs text-destructive",children:y.name})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"description",children:"DescriÃ§Ã£o (opcional)"}),e.jsx(as,{id:"description",rows:3,placeholder:"Descreva os objetivos e caracterÃ­sticas do plano alimentar...",value:m.description,onChange:s=>V("description",s.target.value),disabled:u})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Z,{htmlFor:"start_date",children:["Data de InÃ­cio ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(ms,{id:"start_date",value:m.start_date,onChange:s=>V("start_date",s),className:y.start_date?"border-destructive":"",disabled:u}),y.start_date&&e.jsx("p",{className:"text-xs text-destructive",children:y.start_date})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"end_date",children:"Data de TÃ©rmino (opcional)"}),e.jsx(ms,{id:"end_date",value:m.end_date,onChange:s=>V("end_date",s),className:y.end_date?"border-destructive":"",disabled:u}),y.end_date&&e.jsx("p",{className:"text-xs text-destructive",children:y.end_date})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[e.jsxs(Z,{children:["Dias Ativos ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsxs("div",{className:"flex gap-2 flex-shrink-0",children:[e.jsx(b,{type:"button",variant:"outline",size:"sm",onClick:oe,className:"flex-1 sm:flex-none text-xs sm:text-sm",children:"Dias Ãºteis"}),e.jsx(b,{type:"button",variant:"outline",size:"sm",onClick:_e,className:"flex-1 sm:flex-none text-xs sm:text-sm",children:"Fins de semana"}),e.jsx(b,{type:"button",variant:"outline",size:"sm",onClick:ge,className:"flex-1 sm:flex-none text-xs sm:text-sm",children:m.active_days.length===7?"Limpar":"Todos"})]})]}),e.jsx("div",{className:"grid grid-cols-7 gap-1 sm:gap-2",children:g.map(s=>e.jsxs("label",{className:`
                                            flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2 px-1 sm:px-3 py-2 border rounded-lg cursor-pointer transition-colors text-xs sm:text-sm
                                            ${m.active_days.includes(s.value)?"bg-primary text-primary-foreground border-primary":"hover:bg-muted"}
                                        `,children:[e.jsx(Ye,{checked:m.active_days.includes(s.value),onCheckedChange:()=>Y(s.value),disabled:u,className:"h-3 w-3 sm:h-4 sm:w-4"}),e.jsx("span",{className:"text-[10px] sm:text-sm leading-tight text-center",children:s.label})]},s.value))}),y.active_days&&e.jsx("p",{className:"text-xs text-destructive",children:y.active_days})]})]})]}),p.length>0&&T?e.jsxs(ee,{children:[e.jsx(me,{children:e.jsx(xe,{className:"text-lg",children:"Simulador de Ajuste de PorÃ§Ãµes"})}),e.jsxs(se,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"portion-factor",children:"Fator de ajuste"}),e.jsx(fe,{id:"portion-factor",type:"number",min:.3,max:3,step:.05,value:O,onChange:s=>j(te(s.target.value)),disabled:u}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Ex.: 1.10 aumenta 10%, 0.90 reduz 10%"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"portion-scope",children:"Aplicar em"}),e.jsxs("select",{id:"portion-scope",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm",value:n,onChange:s=>w(s.target.value),disabled:u,children:[e.jsx("option",{value:"all",children:"Plano completo"}),e.jsx("option",{value:"meal",children:"RefeiÃ§Ã£o especÃ­fica"}),e.jsx("option",{value:"food",children:"Alimento especÃ­fico"})]})]}),n==="meal"||n==="food"?e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"portion-meal",children:"RefeiÃ§Ã£o alvo"}),e.jsx("select",{id:"portion-meal",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm",value:N,onChange:s=>W(s.target.value),disabled:u||K.length===0,children:K.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))})]}):null,n==="food"?e.jsxs("div",{className:"space-y-2 md:col-span-3",children:[e.jsx(Z,{htmlFor:"portion-food",children:"Alimento alvo"}),e.jsx("select",{id:"portion-food",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm",value:H,onChange:s=>A(s.target.value),disabled:u||D.length===0,children:D.length?D.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id)):e.jsx("option",{value:"",children:"Sem alimentos nesta refeiÃ§Ã£o"})})]}):null,e.jsxs("div",{className:"rounded-lg border p-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Antes"}),e.jsxs("p",{className:"text-sm font-medium",children:[T.totalsBefore.calories.toFixed(0)," kcal"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["P ",T.totalsBefore.protein.toFixed(1),"g Â· C ",T.totalsBefore.carbs.toFixed(1),"g Â· G ",T.totalsBefore.fat.toFixed(1),"g"]})]}),e.jsxs("div",{className:"rounded-lg border p-3 bg-muted/20",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Depois (preview)"}),e.jsxs("p",{className:"text-sm font-medium",children:[T.totalsAfter.calories.toFixed(0)," kcal"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["P ",T.totalsAfter.protein.toFixed(1),"g Â· C ",T.totalsAfter.carbs.toFixed(1),"g Â· G ",T.totalsAfter.fat.toFixed(1),"g"]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2 rounded-lg border p-3 bg-muted/10",children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Delta: ",le(T.delta.calories,"kcal")," Â· ",le(T.delta.protein,"g")," proteÃ­na Â· ",le(T.delta.carbs,"g")," carboidrato Â· ",le(T.delta.fat,"g")," gordura"]}),e.jsx(b,{type:"button",size:"sm",variant:"outline",onClick:ce,disabled:u||Math.abs(Number(O||1)-1)<.001,children:"Aplicar ajuste ao plano"})]})]})]}):null,p.length>0&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-10 gap-6",children:[e.jsx("div",{className:"lg:col-span-6",children:e.jsxs(ee,{children:[e.jsx(me,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(xe,{className:"text-lg",children:"RefeiÃ§Ãµes"}),e.jsxs(b,{type:"button",size:"sm",onClick:()=>{P(null),C(!0)},disabled:u,children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),"Adicionar RefeiÃ§Ã£o"]})]})}),e.jsx(se,{children:e.jsx("div",{className:"space-y-3",children:p.map((s,c)=>e.jsx("div",{className:"p-4 border rounded-lg hover:bg-muted/50 transition-colors",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm text-muted-foreground",children:["#",c+1]}),e.jsx("h4",{className:"font-semibold",children:s.name}),s.meal_time&&e.jsxs(pe,{variant:"outline",children:[e.jsx(jt,{className:"h-3 w-3 mr-1"}),s.meal_time]})]}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-1",children:[s.foods?.length||0," alimento(s) â€¢"," ",s.calories?.toFixed(0)||0," kcal â€¢ P: ",s.protein?.toFixed(1)||0,"g â€¢ C: ",s.carbs?.toFixed(1)||0,"g â€¢ G: ",s.fat?.toFixed(1)||0,"g"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(b,{type:"button",variant:"ghost",size:"sm",onClick:()=>S(s),children:e.jsx(Le,{className:"h-4 w-4"})}),e.jsx(b,{type:"button",variant:"ghost",size:"sm",onClick:()=>q(s.tempId),children:e.jsx(ss,{className:"h-4 w-4 text-destructive"})})]})]})},s.tempId))})})]})}),e.jsx("div",{className:"lg:col-span-4",children:e.jsx($s,{protein:X.protein,carbs:X.carbs,fat:X.fat,calories:X.calories,patientId:r,planId:i?.id,referenceValues:E,onReferenceUpdate:$})})]}),p.length===0&&e.jsxs(ee,{children:[e.jsx(me,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(xe,{className:"text-lg",children:"RefeiÃ§Ãµes"}),e.jsxs(b,{type:"button",size:"sm",onClick:()=>{P(null),C(!0)},disabled:u,children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),"Adicionar RefeiÃ§Ã£o"]})]})}),e.jsx(se,{children:e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:["Nenhuma refeiÃ§Ã£o adicionada ainda",y.meals&&e.jsx("p",{className:"text-destructive mt-2",children:y.meals})]})})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsxs(b,{type:"button",variant:"outline",onClick:l,disabled:u,children:[e.jsx(Oe,{className:"w-4 h-4 mr-2"}),"Cancelar"]}),e.jsxs(b,{type:"submit",disabled:u,children:[e.jsx(vt,{className:"w-4 h-4 mr-2"}),u?"Salvando...":i?"Atualizar Plano":"Criar Plano"]})]})]}),e.jsx(Vt,{isOpen:o,onClose:()=>{C(!1),P(null)},onSave:f?M:ne,initialData:f})]})},Ut=({isOpen:r,onClose:d,planId:i,planName:h,onCopy:l})=>{const[u,m]=t.useState([]),[v,p]=t.useState([]),[_,o]=t.useState(""),[C,f]=t.useState(null),[P,y]=t.useState(!1),[F,E]=t.useState(!1);t.useEffect(()=>{r&&z()},[r]),t.useEffect(()=>{if(_){const n=u.filter(w=>w.name?.toLowerCase().includes(_.toLowerCase())||w.email?.toLowerCase().includes(_.toLowerCase()));p(n)}else p(u)},[_,u]);const z=async()=>{y(!0);try{const{data:{user:n}}=await ue.auth.getUser();if(!n)return;const{data:w,error:N}=await ue.from("user_profiles").select("id, name, email").eq("user_type","patient").eq("nutritionist_id",n.id).order("name",{ascending:!0});if(N)throw N;m(w||[]),p(w||[])}catch(n){console.error("Erro ao carregar pacientes:",n)}finally{y(!1)}},O=async()=>{if(C){E(!0);try{await l(C.id),j()}catch(n){console.error("Erro ao copiar modelo:",n)}finally{E(!1)}}},j=()=>{o(""),f(null),d()};return e.jsx(ve,{open:r,onOpenChange:j,children:e.jsxs(Ne,{className:"max-w-2xl",children:[e.jsxs(be,{children:[e.jsx(ye,{children:"Copiar Modelo de Dieta"}),e.jsxs(we,{children:["Selecione o paciente para aplicar o plano: ",e.jsx("strong",{children:h})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Z,{htmlFor:"search",children:"Buscar Paciente"}),e.jsxs("div",{className:"relative",children:[e.jsx(rs,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(fe,{id:"search",placeholder:"Digite o nome ou email do paciente...",value:_,onChange:n=>o(n.target.value),className:"pl-10",autoFocus:!0})]})]}),e.jsxs(We,{className:"h-[400px] border rounded-md p-4",children:[P&&e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Carregando pacientes..."}),!P&&v.length===0&&e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:_?"Nenhum paciente encontrado":"VocÃª nÃ£o tem pacientes cadastrados"}),!P&&v.length>0&&e.jsx("div",{className:"space-y-2",children:v.map(n=>e.jsx("div",{className:`
                                            p-3 border rounded-lg cursor-pointer transition-colors
                                            ${C?.id===n.id?"bg-primary/10 border-primary":"hover:bg-muted"}
                                        `,onClick:()=>f(n),children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-semibold",children:n.name}),C?.id===n.id&&e.jsx(Qe,{className:"h-4 w-4 text-primary"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:n.email})]})})},n.id))})]})]}),e.jsxs(Pe,{children:[e.jsxs(b,{variant:"outline",onClick:j,disabled:F,children:[e.jsx(Oe,{className:"h-4 w-4 mr-2"}),"Cancelar"]}),e.jsxs(b,{onClick:O,disabled:!C||F,children:[e.jsx(es,{className:"h-4 w-4 mr-2"}),F?"Copiando...":"Copiar Modelo"]})]})]})})};function Wt(r,d){if(!r||!d||d.length===0)return null;const i=r.toLowerCase();for(const h of d)if(h&&i.includes(h.toLowerCase()))return h;return null}function Ht({open:r,onOpenChange:d,patientId:i,nutritionistId:h,onTemplateApplied:l}){const{toast:u}=Cs(),[m,v]=t.useState([]),[p,_]=t.useState([]),[o,C]=t.useState(null),[f,P]=t.useState(null),[y,F]=t.useState(""),[E,z]=t.useState(null),[O,j]=t.useState(!1),[n,w]=t.useState(!1),[N,W]=t.useState(null),[H,A]=t.useState(!1),[g,$]=t.useState(1),[V,Y]=t.useState(!1),[ge,oe]=t.useState([]),[_e,ne]=t.useState(null),[S,M]=t.useState(new Set);t.useEffect(()=>{r&&h&&B(),r&&i&&J()},[r,h,i]),t.useEffect(()=>{let s=m;y&&(s=s.filter(c=>c.name.toLowerCase().includes(y.toLowerCase())||c.description&&c.description.toLowerCase().includes(y.toLowerCase()))),E&&(s=s.filter(c=>c.template_tags?(Array.isArray(c.template_tags)?c.template_tags:[c.template_tags]).some(I=>I.toLowerCase()===E.toLowerCase()):!1)),_(s)},[m,y,E]);const q=(s,c=null)=>!s||!s.meals?{calories:0,protein:0,carbs:0,fat:0}:(c&&c.size>0?s.meals.filter(I=>c.has(I.id)):s.meals).reduce((I,L)=>({calories:I.calories+(parseFloat(L.total_calories)||0),protein:I.protein+(parseFloat(L.total_protein)||0),carbs:I.carbs+(parseFloat(L.total_carbs)||0),fat:I.fat+(parseFloat(L.total_fat)||0)}),{calories:0,protein:0,carbs:0,fat:0});t.useEffect(()=>{o&&U(o.id)},[o]),t.useEffect(()=>{if(f&&N&&H&&S.size>0){const s=q(f,S).calories;if(s>0){const c=N/s;$(c)}}else $(1)},[f,N,H,S]);const B=async()=>{j(!0);try{const{data:s,error:c}=await at(h);if(c)throw c;v(s||[]),_(s||[])}catch(s){console.error("Erro ao carregar templates:",s),u({title:"Erro",description:"NÃ£o foi possÃ­vel carregar os templates.",variant:"destructive"})}finally{j(!1)}},U=async s=>{try{const{data:c,error:k}=await Ve(s);if(k)throw k;if(P(c),A(!1),c?.meals){const I=new Set(c.meals.map(L=>L.id));M(I)}else M(new Set)}catch(c){console.error("Erro ao carregar detalhes do template:",c),P(null),M(new Set)}},J=async()=>{if(i)try{const{data:s}=await ue.from("patient_goals").select("daily_calorie_goal").eq("patient_id",i).eq("status","active").order("created_at",{ascending:!1}).limit(1).maybeSingle();if(s?.daily_calorie_goal){W(parseFloat(s.daily_calorie_goal));return}const c=bt(),{data:k}=await ue.from("prescriptions").select("calories").eq("patient_id",i).lte("start_date",c).or(`end_date.is.null,end_date.gte.${c}`).order("start_date",{ascending:!1}).limit(1).maybeSingle();if(k?.calories){W(parseFloat(k.calories));return}const{data:I}=await ue.from("energy_expenditure_calculations").select("get_with_activities, get").eq("patient_id",i).order("created_at",{ascending:!1}).limit(1).maybeSingle(),L=I?.get_with_activities??I?.get??null;if(L){W(parseFloat(L));return}W(null)}catch(s){console.error("Erro ao buscar meta calÃ³rica do paciente:",s),W(null)}},X=async()=>{if(!f||!i)return[];try{const{data:s,error:c}=await Nt(i,!0);if(c||!s||!s.content)return[];const k=s.content,L=(k.historico_clinico?.alergias||[]).filter(Q=>Q&&Q.alimento).map(Q=>Q.alimento.trim()).filter(Q=>Q.length>0),Te=(k.habitos_alimentares?.alimentos_nao_gosta||"").split(/[,;]/).map(Q=>Q.trim()).filter(Q=>Q.length>0),$e=[...L,...Te];if($e.length===0)return[];const Se=[];if(f.meals){for(const Q of f.meals)if(S.has(Q.id)&&Q.foods)for(const Fe of Q.foods){const qe=Fe.food?.name||Fe.foods?.name||Fe.name||"";qe&&Se.push(qe)}}const Ee=[];for(const Q of Se)Wt(Q,$e)&&(Ee.includes(Q)||Ee.push(Q));return Ee}catch(s){return console.error("Erro ao verificar conflitos de alimentos:",s),[]}},K=async(s=!1)=>{if(!(!o||!i)){if(S.size===0){u({title:"Nenhuma RefeiÃ§Ã£o Selecionada",description:"Selecione pelo menos uma refeiÃ§Ã£o para importar.",variant:"destructive"});return}if(!s){const c=await X();if(c.length>0){oe(c),Y(!0),ne({templateId:o.id,patientId:i,scaleFactor:H?g:1,selectedMealIds:Array.from(S)});return}}w(!0);try{const c=_e||{templateId:o.id,patientId:i,scaleFactor:H?g:1,selectedMealIds:Array.from(S)},{data:k,error:I}=await rt(c.templateId,c.patientId,null,c.scaleFactor,c.selectedMealIds);if(I)throw I;const L=c.scaleFactor!==1?` (quantidades ajustadas para ${Math.round(N)} kcal)`:"",Ae=c.selectedMealIds?.length||S.size,Te=Ae<(f?.meals?.length||0)?` (${Ae} de ${f?.meals?.length||0} refeiÃ§Ãµes importadas)`:"";u({title:"Template Aplicado",description:`O template "${o.name}" foi aplicado ao paciente com sucesso.${L}${Te}`}),l&&l(k),ne(null),oe([]),Y(!1),d(!1)}catch(c){console.error("Erro ao aplicar template:",c),u({title:"Erro",description:"NÃ£o foi possÃ­vel aplicar o template.",variant:"destructive"})}finally{w(!1)}}},ie=()=>{Y(!1),K(!0)},D=Array.from(new Set(m.filter(s=>s.template_tags).flatMap(s=>Array.isArray(s.template_tags)?s.template_tags:[s.template_tags]))),T=f?q(f,S):null,te=T&&N&&T.calories>0,ce=te?Math.abs((T.calories-N)/T.calories)*100:0,le=te&&ce>10;return e.jsxs(ve,{open:r,onOpenChange:d,children:[e.jsxs(Ne,{className:"max-w-6xl max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs(be,{children:[e.jsxs(ye,{className:"flex items-center gap-2",children:[e.jsx(Ge,{className:"w-5 h-5"}),"Meus Modelos de Dieta"]}),e.jsx(we,{children:"Selecione um template para aplicar ao paciente"})]}),e.jsxs("div",{className:"flex flex-1 gap-4 overflow-hidden",children:[e.jsxs("div",{className:"w-1/3 flex flex-col border-r pr-4",children:[e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(rs,{className:"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground"}),e.jsx(fe,{placeholder:"Buscar templates...",value:y,onChange:s=>F(s.target.value),className:"pl-8"})]})}),D.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-sm font-semibold mb-2",children:"Filtrar por Tag:"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(b,{variant:E===null?"default":"outline",size:"sm",onClick:()=>z(null),children:"Todos"}),D.map(s=>e.jsx(b,{variant:E===s?"default":"outline",size:"sm",onClick:()=>z(s),children:s},s))]})]}),e.jsx(We,{className:"flex-1",children:O?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(Ke,{className:"w-6 h-6 animate-spin text-muted-foreground"})}):p.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(Ge,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Nenhum template encontrado"})]}):e.jsx("div",{className:"space-y-2",children:p.map(s=>e.jsx(ee,{className:`cursor-pointer transition-colors ${o?.id===s.id?"border-primary bg-primary/5":"hover:bg-muted/50"}`,onClick:()=>C(s),children:e.jsx(se,{className:"p-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-sm",children:s.name}),s.description&&e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-2",children:s.description}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(Je,{className:"w-3 h-3"}),e.jsx("span",{children:s.daily_calories?`${Math.round(s.daily_calories)} kcal`:"N/A"})]}),s.template_tags&&e.jsx("div",{className:"flex flex-wrap gap-1 mt-2",children:(Array.isArray(s.template_tags)?s.template_tags:[s.template_tags]).map((c,k)=>e.jsxs(pe,{variant:"secondary",className:"text-xs",children:[e.jsx(ys,{className:"w-2 h-2 mr-1"}),c]},k))})]})})},s.id))})})]}),e.jsx("div",{className:"flex-1 flex flex-col overflow-hidden",children:o?e.jsxs(e.Fragment,{children:[f?e.jsx(We,{className:"flex-1",children:e.jsxs("div",{className:"space-y-4 pr-4",children:[e.jsxs(ee,{children:[e.jsxs(me,{children:[e.jsx(xe,{children:f.name}),f.description&&e.jsx("p",{className:"text-sm text-muted-foreground",children:f.description})]}),e.jsxs(se,{children:[T&&e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Calorias"}),e.jsx("p",{className:"text-2xl font-bold",children:Math.round(T.calories)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"kcal"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"ProteÃ­nas"}),e.jsx("p",{className:"text-2xl font-bold",children:Math.round(T.protein)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"g"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Carboidratos"}),e.jsx("p",{className:"text-2xl font-bold",children:Math.round(T.carbs)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"g"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Gorduras"}),e.jsx("p",{className:"text-2xl font-bold",children:Math.round(T.fat)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"g"})]})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(Je,{className:"w-4 h-4"}),e.jsxs("span",{children:[f.meals?.length||0," refeiÃ§Ãµes"]})]}),f.template_tags&&e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx(ys,{className:"w-4 h-4 text-muted-foreground"}),(Array.isArray(f.template_tags)?f.template_tags:[f.template_tags]).map((s,c)=>e.jsx(pe,{variant:"secondary",children:s},c))]})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Selecione as RefeiÃ§Ãµes para Importar:"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>{if(f?.meals){const s=new Set(f.meals.map(c=>c.id));M(s)}},className:"text-xs h-7",children:"Selecionar Todas"}),e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>M(new Set),className:"text-xs h-7",children:"Desmarcar Todas"})]})]}),e.jsx("div",{className:"space-y-2",children:f.meals?.map((s,c)=>{const k=S.has(s.id);return e.jsx(ee,{className:`cursor-pointer transition-colors ${k?"border-primary bg-primary/5":"hover:bg-muted/50"}`,onClick:()=>{const I=new Set(S);k?I.delete(s.id):I.add(s.id),M(I)},children:e.jsx(se,{className:"p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Ye,{checked:k,onCheckedChange:I=>{const L=new Set(S);I?L.add(s.id):L.delete(s.id),M(L)},onClick:I=>I.stopPropagation()}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.meal_type})]}),e.jsxs("div",{className:"text-right text-sm",children:[e.jsxs("p",{className:"font-semibold",children:[Math.round(s.total_calories||0)," kcal"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["P: ",Math.round(s.total_protein||0),"g | C: ",Math.round(s.total_carbs||0),"g | G: ",Math.round(s.total_fat||0),"g"]})]})]}),s.foods&&s.foods.length>0&&e.jsx("div",{className:"mt-2 pt-2 border-t",children:e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.foods.length," alimento(s)"]})})]})]})})},s.id||c)})}),f.meals&&f.meals.length>0&&e.jsxs("p",{className:"text-xs text-muted-foreground text-center",children:[S.size," de ",f.meals.length," refeiÃ§Ãµes selecionadas"]})]})]})}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(Ke,{className:"w-6 h-6 animate-spin text-muted-foreground"})}),le&&e.jsxs(De,{className:"bg-blue-50 dark:bg-blue-950/20 border-blue-200 dark:border-blue-800",children:[e.jsx(yt,{className:"h-4 w-4 text-blue-600"}),e.jsx(Re,{children:e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Ye,{id:"auto-scale",checked:H,onCheckedChange:s=>A(s===!0)}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsxs(Z,{htmlFor:"auto-scale",className:"text-sm font-medium cursor-pointer",children:["Ajustar quantidades automaticamente para atingir ",Math.round(N)," kcal?"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["O template tem ",Math.round(T.calories)," kcal.",H&&e.jsxs("span",{className:"block mt-1",children:["As porÃ§Ãµes serÃ£o ajustadas por um fator de ",g.toFixed(2),"x (aproximadamente ",Math.round(T.calories*g)," kcal apÃ³s ajuste)."]})]})]})]})})})]}),e.jsx("div",{className:"mt-4 pt-4 border-t flex justify-end",children:e.jsx(b,{onClick:K,disabled:n||!i,className:"w-full sm:w-auto",children:n?e.jsxs(e.Fragment,{children:[e.jsx(Ke,{className:"w-4 h-4 mr-2 animate-spin"}),"Aplicando..."]}):e.jsx(e.Fragment,{children:"Aplicar este Modelo"})})})]}):e.jsx("div",{className:"flex items-center justify-center h-full text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Ge,{className:"w-16 h-16 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"Selecione um template para visualizar os detalhes"})]})})})]})]}),e.jsx(_s,{open:V,onOpenChange:Y,children:e.jsxs(Ss,{children:[e.jsxs(Fs,{children:[e.jsx(ks,{className:"flex items-center gap-2",children:"âš ï¸ Alerta de RestriÃ§Ã£o Alimentar"}),e.jsxs(Ms,{className:"space-y-3",children:[e.jsx("p",{children:"Este modelo contÃ©m alimentos que o paciente marcou como alergia ou aversÃ£o:"}),e.jsx("div",{className:"bg-destructive/10 border border-destructive/20 rounded-lg p-3",children:e.jsx("ul",{className:"list-disc list-inside space-y-1",children:ge.map((s,c)=>e.jsx("li",{className:"font-semibold text-destructive",children:s},c))})}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Deseja continuar mesmo assim? Esta aÃ§Ã£o pode causar reaÃ§Ãµes adversas no paciente."})]})]}),e.jsxs(Ps,{children:[e.jsx(As,{onClick:()=>{Y(!1),oe([]),ne(null)},children:"Cancelar ImportaÃ§Ã£o"}),e.jsx(Ts,{onClick:ie,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Ignorar e Aplicar"})]})]})})]})}const Kt=async(r,d="Paciente")=>{if(!r||!r.meals||r.meals.length===0)throw new Error("Plano alimentar invÃ¡lido ou sem refeiÃ§Ãµes");const i=Qt(r.meals),h=Yt(i),l=new Ct("p","mm","a4"),u=l.internal.pageSize.width,m=l.internal.pageSize.height,v=[70,125,70],p=[68,64,60],_=[120,113,108];let o=20;l.setFont("helvetica");try{const z=await(await fetch("https://afyoidxrshkmplxhcyeh.supabase.co/storage/v1/object/public/IDV/HIPOZERO%20(2).png")).blob();await new Promise(O=>{const j=new Image;j.onload=()=>{const n=u*.15,w=j.height/j.width*n,N=new FileReader;N.onloadend=()=>{const W=N.result;l.addImage(W,"PNG",14,10,n,w),O()},N.readAsDataURL(z)},j.src=URL.createObjectURL(z)})}catch(F){console.error("Erro ao carregar logo:",F)}l.setFontSize(20),l.setTextColor(...v),l.setFont("helvetica","bold"),l.text("Lista de Compras",u/2,o,{align:"center"}),o+=8,l.setFontSize(12),l.setTextColor(...p),l.setFont("helvetica","normal"),l.text(`Paciente: ${d}`,14,o),o+=6;const C=new Date().toLocaleDateString("pt-BR");l.setFontSize(10),l.setTextColor(..._),l.text(`Gerado em: ${C}`,14,o),o+=10,l.setDrawColor(...v),l.setLineWidth(.5),l.line(14,o,u-14,o),o+=8;const f=Object.keys(h).sort();for(let F=0;F<f.length;F++){const E=f[F],z=h[E];o>m-60&&(l.addPage(),o=20),l.setFontSize(14),l.setTextColor(...v),l.setFont("helvetica","bold"),l.text(E,14,o),o+=6;const O=z.map(j=>["",j.name,j.totalQuantity]);_t(l,{startY:o,head:[["","Item","Quantidade Total"]],body:O,theme:"grid",headStyles:{fillColor:v,textColor:[255,255,255],fontStyle:"bold",fontSize:10},bodyStyles:{textColor:p,fontSize:10},columnStyles:{0:{cellWidth:10,halign:"center"},1:{cellWidth:"auto",halign:"left"},2:{cellWidth:50,halign:"right"}},margin:{left:14,right:14},styles:{lineColor:[200,200,200],lineWidth:.1},didParseCell:function(j){if(j.column.index===0&&j.row.index>=0){const n=j.cell.x+2,w=j.cell.y+2,N=4;l.setDrawColor(150,150,150),l.setLineWidth(.3),l.rect(n,w,N,N)}}}),o=l.lastAutoTable.finalY+8,F<f.length-1&&(o+=5)}const P=m-15;l.setFontSize(8),l.setTextColor(..._),l.setFont("helvetica","italic"),l.text("Gerado por HipoZero",u/2,P,{align:"center"});const y=`lista_compras_${d.replace(/\s+/g,"_")}_${new Date().toISOString().split("T")[0]}.pdf`;l.save(y)};function Qt(r){const d=new Map;for(const i of r)if(!(!i.foods||i.foods.length===0))for(const h of i.foods){const l=h.foods?.name||h.food?.name||h.name||"Alimento nÃ£o identificado",u=parseFloat(h.quantity)||0,m=h.unit||"g",v=h.foods?.group||h.food?.group||"Outros",p=`${l.toLowerCase()}_${m}`;if(d.has(p)){const _=d.get(p);_.totalQuantity=ws(_.totalQuantityValue+u,m),_.totalQuantityValue+=u}else d.set(p,{name:l,unit:m,category:v,totalQuantity:ws(u,m),totalQuantityValue:u})}return Array.from(d.values())}function Yt(r){const d={},i={"Cereais e derivados":"Cereais e Derivados","Verduras, hortaliÃ§as e derivados":"Verduras e HortaliÃ§as","Frutas e sucos":"Frutas","Carnes e derivados":"Carnes","Leite e derivados":"LaticÃ­nios","Ã“leos e gorduras":"Ã“leos e Gorduras","Pescados e frutos do mar":"Peixes e Frutos do Mar",Leguminosas:"Leguminosas","Nozes e sementes":"Nozes e Sementes",Bebidas:"Bebidas",Outros:"Outros"};for(const h of r){const l=i[h.category]||h.category||"Outros";d[l]||(d[l]=[]),d[l].push(h)}for(const h in d)d[h].sort((l,u)=>l.name.localeCompare(u.name,"pt-BR"));return d}function ws(r,d){const i=Math.round(r*100)/100;return i%1===0?`${i} ${d}`:`${i.toFixed(2)} ${d}`}const Xt=async r=>ue.from("energy_expenditure_calculations").select("*").eq("patient_id",r).order("created_at",{ascending:!1}).limit(1).maybeSingle(),Zt=async r=>{try{const{data:d,error:i}=await Xt(r);if(i)throw i;return{data:d,error:null}}catch(d){return ls("Erro ao buscar cÃ¡lculo de energia",d),{data:null,error:d}}};function Jt({targetCalories:r,currentCalories:d=0,patientId:i,energyCalculation:h=null}){const l=ts();if(!r||r<=0)return e.jsx(ee,{className:"border-yellow-500/50 bg-yellow-50/50 dark:bg-yellow-950/20",children:e.jsx(se,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ue,{className:"w-5 h-5 text-yellow-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Gasto EnergÃ©tico nÃ£o definido"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Defina o gasto energÃ©tico para monitorar a meta do plano"})]})]}),e.jsxs(b,{variant:"outline",size:"sm",onClick:()=>l(`/nutritionist/patients/${i}/energy-expenditure`),className:"gap-2",children:[e.jsx(fs,{className:"w-4 h-4"}),"Definir Gasto EnergÃ©tico"]})]})})});const u=d-r,m=Math.abs(u),v=r>0?Math.min(100,d/r*100):0;let p="text-green-600",_="bg-green-100 dark:bg-green-900/30",o="border-green-500/50",C=gs,f="Alinhado";m<=50?(p="text-green-600",_="bg-green-100 dark:bg-green-900/30",o="border-green-500/50",C=gs,f="Alinhado"):m<=200?(p="text-yellow-600",_="bg-yellow-100 dark:bg-yellow-900/30",o="border-yellow-500/50",C=Ue,f="PrÃ³ximo"):(p="text-red-600",_="bg-red-100 dark:bg-red-900/30",o="border-red-500/50",C=Ue,f="Desalinhado");const P=C,F=h?{protocol:{"harris-benedict":"Harris-Benedict (1984)","mifflin-st-jeor":"Mifflin-St Jeor","fao-who":"FAO/WHO",cunningham:"Cunningham (Atletas)",tinsley:"Tinsley (Bodybuilding)"}[h.protocol]||h.protocol,tmb:h.tmb,activityLevel:h.activity_level,get:h.get,goalCalories:h.get_with_activities||h.get}:null;return e.jsx(ee,{className:ze("sticky top-4 z-10",o,_),children:e.jsx(se,{className:"p-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ls,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Prescrito:"}),e.jsxs("span",{className:"text-sm font-bold text-foreground",children:[Math.round(d)," kcal"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Meta Calculada (GET):"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs("span",{className:"text-sm font-bold text-primary",children:[Math.round(r)," kcal"]}),F&&e.jsxs(kt,{children:[e.jsx(Mt,{asChild:!0,children:e.jsx("button",{className:"text-muted-foreground hover:text-foreground transition-colors",children:e.jsx(At,{className:"w-3.5 h-3.5"})})}),e.jsx(Pt,{className:"w-80 p-0",side:"bottom",align:"end",children:e.jsxs("div",{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fs,{className:"w-4 h-4 text-primary"}),e.jsx("h4",{className:"font-semibold text-sm",children:"CÃ¡lculo de Energia"})]}),e.jsxs("div",{className:"space-y-2 text-xs",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Protocolo:"}),e.jsx("span",{className:"font-medium",children:F.protocol})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"TMB:"}),e.jsxs("span",{className:"font-medium",children:[Math.round(F.tmb)," kcal"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"NÃ­vel de Atividade:"}),e.jsxs("span",{className:"font-medium",children:["x",F.activityLevel]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"GET Base:"}),e.jsxs("span",{className:"font-medium",children:[Math.round(F.get)," kcal"]})]}),e.jsx("div",{className:"pt-2 border-t",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-muted-foreground",children:"Meta Final:"}),e.jsxs("span",{className:"font-bold text-primary",children:[Math.round(F.goalCalories)," kcal"]})]})})]})]})})]})]})]})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx(Ft,{value:v,className:ze("h-2",m<=50?"bg-green-500":m<=200?"bg-yellow-500":"bg-red-500")}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-muted-foreground",children:"Progresso em relaÃ§Ã£o Ã  meta"}),e.jsxs("span",{className:ze("font-semibold",p),children:[v.toFixed(1),"%"]})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(pe,{variant:"outline",className:ze("gap-1.5",p,o),children:[e.jsx(P,{className:"w-3 h-3"}),f]}),e.jsxs("span",{className:ze("text-sm font-semibold",u>0?"text-red-600":u<0?"text-blue-600":"text-green-600"),children:[u>0?"+":"",Math.round(u)," kcal"]})]})]})})})}const nr=()=>{const{patientId:r}=Hs(),d=ts(),{toast:i}=Cs(),{user:h}=Ks(),[l,u]=t.useState(!0),[m,v]=t.useState(!1),[p,_]=t.useState([]),[o,C]=t.useState(null),[f,P]=t.useState(""),[y,F]=t.useState(null),[E,z]=t.useState(!1),[O,j]=t.useState(null),[n,w]=t.useState(null),[N,W]=t.useState(!1),[H,A]=t.useState(null),[g,$]=t.useState(!1),[V,Y]=t.useState(null),[ge,oe]=t.useState(!1),[_e,ne]=t.useState(!1),[S,M]=t.useState(!1),[q,B]=t.useState(""),[U,J]=t.useState(""),[X,K]=t.useState([]),[ie,D]=t.useState(!1),[T,te]=t.useState(""),[ce,le]=t.useState(!1),[s,c]=t.useState(null),[k,I]=t.useState(null);t.useEffect(()=>{(async()=>{const{data:{user:x}}=await ue.auth.getUser();x&&w(x.id)})()},[]),t.useEffect(()=>{(async()=>{if(r)try{const{data:x,error:R}=await ue.from("user_profiles").select("name").eq("id",r).single();!R&&x&&P(x.name)}catch(x){console.error("Erro ao carregar nome do paciente:",x)}})()},[r]);const L=t.useCallback(async()=>{if(r){u(!0);try{const[a,x]=await Promise.all([lt(r),ot(r)]);if(a.error)throw a.error;_(a.data||[]),C(x.data)}catch(a){console.error("Erro ao carregar planos:",a),i({title:"Erro",description:"NÃ£o foi possÃ­vel carregar os planos alimentares",variant:"destructive"})}finally{u(!1)}}},[r,i]);t.useEffect(()=>{L()},[L]),t.useEffect(()=>{(async()=>{if(o?.id){const{data:x}=await Os(o.id);F(x)}else F(null)})()},[o?.id]),t.useEffect(()=>{(async()=>{if(!o?.id){K([]),te("");return}D(!0);try{const{data:x,error:R}=await nt(o.id,20);if(R)throw R;const G=x||[];K(G);const ae=G.length>1?G[1]:G[0];te(ae?String(ae.id):"")}catch(x){console.error("Erro ao carregar versÃµes do plano:",x),K([]),te("")}finally{D(!1)}})()},[o?.id]),t.useEffect(()=>{(async()=>{if(r)try{const{data:x,error:R}=await Zt(r);if(R)throw R;c(x)}catch(x){console.error("Erro ao carregar cÃ¡lculo de energia:",x)}})()},[r]),t.useEffect(()=>{(async()=>{if(!r)return;const{data:x}=await Tt(r);I(x||null)})()},[r]);const Ae=a=>{if(!a)return null;const x=new Date(a);if(Number.isNaN(x.getTime()))return null;const R=Date.now()-x.getTime();if(R<0)return`atualizado em ${x.toLocaleString("pt-BR")}`;const G=Math.floor(R/6e4);if(G<1)return"atualizado agora";if(G<60)return`atualizado hÃ¡ ${G} min`;const ae=Math.floor(G/60);if(ae<24)return`atualizado hÃ¡ ${ae}h`;const re=Math.floor(ae/24);return re<=7?`atualizado hÃ¡ ${re} dia${re>1?"s":""}`:`atualizado em ${x.toLocaleDateString("pt-BR")} Ã s ${x.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}`},Te=async()=>{const{error:a}=await js(r,{mealPlan:!0});if(a){i({title:"NÃ£o foi possÃ­vel marcar como revisado",description:"Tente novamente em instantes.",variant:"destructive"});return}I(x=>({...x||{},needs_meal_plan_review:!1})),i({title:"PendÃªncia removida",description:"O mÃ³dulo de plano alimentar foi marcado como revisado.",variant:"success"})},$e=async(a,x=null)=>{v(!0);try{if(x){const G=await it(x,a);if(G.error)throw G.error}else{const G=await ct({patient_id:a.patient_id,nutritionist_id:a.nutritionist_id,name:a.name,description:a.description,active_days:a.active_days,start_date:a.start_date,end_date:a.end_date||null});if(G.error)throw G.error;for(const ae of a.meals){const re=await dt({meal_plan_id:G.data.id,name:ae.name,meal_type:ae.meal_type,meal_time:ae.meal_time,notes:ae.notes,order_index:ae.order_index});if(re.error)throw re.error;for(const he of ae.foods||[]){const cs=await mt({meal_plan_meal_id:re.data.id,food_id:he.food_id,quantity:he.quantity,unit:he.unit,calories:he.calories,protein:he.protein,carbs:he.carbs,fat:he.fat,notes:he.notes,order_index:he.order_index||0});if(cs?.error)throw cs.error}}}i({title:"Sucesso",description:x?"Plano atualizado com sucesso":"Plano criado com sucesso",variant:"success"});const{error:R}=await js(r,{mealPlan:!0});R?console.warn("NÃ£o foi possÃ­vel limpar flag de revisÃ£o do plano automaticamente:",R):I(G=>({...G||{},needs_meal_plan_review:!1})),z(!1),j(null),await L()}catch(R){console.error("Erro ao salvar plano:",R),i({title:"Erro",description:"NÃ£o foi possÃ­vel salvar o plano alimentar",variant:"destructive"})}finally{v(!1)}},Se=async a=>{try{const x=await Ve(a);if(x.error)throw x.error;j(x.data),z(!0)}catch(x){console.error("Erro ao carregar plano para ediÃ§Ã£o:",x),i({title:"Erro",description:"NÃ£o foi possÃ­vel carregar o plano para ediÃ§Ã£o",variant:"destructive"})}},Ee=async a=>{try{const x=await xt(a);if(x.error)throw x.error;i({title:"Sucesso",description:"Plano arquivado com sucesso",variant:"success"}),await L()}catch(x){console.error("Erro ao arquivar plano:",x),i({title:"Erro",description:"NÃ£o foi possÃ­vel arquivar o plano",variant:"destructive"})}},Q=async a=>{try{const x=await ht(a);if(x.error)throw x.error;i({title:"Sucesso",description:"Plano ativado com sucesso",variant:"success"}),await L()}catch(x){console.error("Erro ao ativar plano:",x),i({title:"Erro",description:"NÃ£o foi possÃ­vel ativar o plano",variant:"destructive"})}},Fe=a=>{const x=p.find(R=>R.id===a)||o;x&&(Y(x),$(!0))},qe=async a=>{try{const x=await ft(V.id,a);if(x.error)throw x.error;i({title:"Sucesso",description:"Plano copiado para o paciente com sucesso",variant:"success"}),$(!1),Y(null)}catch(x){console.error("Erro ao copiar modelo:",x),i({title:"Erro",description:"NÃ£o foi possÃ­vel copiar o modelo para o paciente",variant:"destructive"})}},os=async()=>{if(!o){i({title:"Erro",description:"Nenhum plano ativo encontrado.",variant:"destructive"});return}try{const a=await Ve(o.id);if(a.error)throw a.error;const x=a.data;await Kt(x,f),i({title:"Lista de Compras gerada!",description:"O PDF foi baixado com sucesso."})}catch(a){console.error("Erro ao gerar lista de compras:",a),i({title:"Erro",description:"NÃ£o foi possÃ­vel gerar a lista de compras. Tente novamente.",variant:"destructive"})}},ns=async a=>{if(o)try{oe(!1);const x=await Ve(o.id);if(x.error)throw x.error;const R=x.data;await wt(R,f,h?.profile?.name,a,St,Rs),i({title:"PDF gerado!",description:"Plano alimentar exportado com sucesso.",variant:"success"})}catch(x){console.error("Erro ao exportar PDF:",x),i({title:"Erro",description:"NÃ£o foi possÃ­vel exportar o plano alimentar",variant:"destructive"})}},qs=async()=>{if(H)try{const a=await pt(H);if(a.error)throw a.error;i({title:"Sucesso",description:"Plano deletado com sucesso",variant:"success"}),A(null),W(!1),await L()}catch(a){console.error("Erro ao deletar plano:",a),i({title:"Erro",description:"NÃ£o foi possÃ­vel deletar o plano",variant:"destructive"})}},Be=a=>a?new Date(a).toLocaleDateString("pt-BR"):null,is=a=>{if(!a||a.length===0)return"Nenhum dia";if(a.length===7)return"Todos os dias";const x=["monday","tuesday","wednesday","thursday","friday"],R=["saturday","sunday"],G=x.every(re=>a.includes(re))&&!R.some(re=>a.includes(re)),ae=R.every(re=>a.includes(re))&&!x.some(re=>a.includes(re));return G?"Dias Ãºteis":ae?"Fins de semana":`${a.length} dias`},Bs=async()=>{if(!(!o||!q.trim())){v(!0);try{const a=U?U.split(",").map(G=>G.trim()).filter(G=>G.length>0):[],{data:x,error:R}=await gt(o.id,q.trim(),a);if(R)throw R;i({title:"Template Salvo",description:`O plano foi salvo como template "${q}" com sucesso.`,variant:"success"}),M(!1),B(""),J("")}catch(a){console.error("Erro ao salvar template:",a),i({title:"Erro",description:"NÃ£o foi possÃ­vel salvar o template.",variant:"destructive"})}finally{v(!1)}}},Vs=async a=>{await L(),a&&C(a)},Gs=a=>{const x=a?.plan||{},R=Array.isArray(a?.meals)?a.meals:[];return{calories:Number(x.daily_calories||0),protein:Number(x.daily_protein||0),carbs:Number(x.daily_carbs||0),fat:Number(x.daily_fat||0),mealsCount:R.length}},je=X.find(a=>String(a.id)===String(T))||null,de=o?{calories:Number(o.daily_calories||0),protein:Number(o.daily_protein||0),carbs:Number(o.daily_carbs||0),fat:Number(o.daily_fat||0),mealsCount:Number(o.meals?.length||0)}:null,ke=je?Gs(je.snapshot):null,Ie=(a,x)=>{const R=Number(a||0)-Number(x||0);return`${R>0?"+":""}${R.toFixed(1)}`},Us=async()=>{if(!(!je||!window.confirm(`Deseja restaurar a versÃ£o ${je.version_number}? Isso criarÃ¡ uma nova versÃ£o de rollback.`))){le(!0);try{const x=await ut(je.id);if(x.error)throw x.error;i({title:"VersÃ£o restaurada",description:`O plano foi restaurado a partir da versÃ£o ${je.version_number}.`,variant:"success"}),await L()}catch(x){console.error("Erro ao restaurar versÃ£o do plano:",x),i({title:"Erro ao restaurar versÃ£o",description:"NÃ£o foi possÃ­vel concluir a restauraÃ§Ã£o desta versÃ£o.",variant:"destructive"})}finally{le(!1)}}};return l?e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx("div",{className:"text-center",children:"Carregando..."})}):E?e.jsxs("div",{className:"container mx-auto px-4 py-8 max-w-6xl",children:[e.jsx("div",{className:"mb-6",children:e.jsxs(b,{variant:"ghost",onClick:()=>{z(!1),j(null)},children:[e.jsx(vs,{className:"mr-2 h-4 w-4"}),"Voltar"]})}),e.jsx(Gt,{patientId:r,nutritionistId:n,initialData:O,onSubmit:$e,onCancel:()=>{z(!1),j(null)},loading:m})]}):e.jsxs("div",{className:"container mx-auto px-4 py-6 sm:py-8 max-w-6xl",children:[e.jsxs("div",{className:"flex flex-col gap-4 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(b,{variant:"ghost",size:"sm",onClick:()=>d(`/nutritionist/patients/${r}/hub`),className:"-ml-2 text-[#5f6f52] hover:text-[#5f6f52] hover:bg-[#5f6f52]/10",children:[e.jsx(vs,{className:"h-4 w-4 mr-1"}),"Voltar"]}),e.jsxs(b,{variant:"outline",size:"sm",onClick:L,className:"flex-shrink-0",children:[e.jsx(us,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:"hidden sm:inline",children:"Atualizar"})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-end justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("h1",{className:"text-2xl sm:text-3xl font-bold text-foreground flex items-center gap-2",children:[e.jsx(Je,{className:"w-6 h-6 sm:w-8 sm:h-8 text-[#5f6f52]"}),e.jsx("span",{className:"truncate",children:"Planos Alimentares"})]}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Gerencie os planos alimentares do paciente"})]}),e.jsxs(b,{size:"sm",onClick:()=>z(!0),className:"w-full sm:w-auto",children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),"Novo Plano"]})]})]}),k?.needs_meal_plan_review&&e.jsxs(De,{className:"mb-6 border-amber-200 bg-amber-50",children:[e.jsx(Ue,{className:"h-4 w-4 text-amber-700"}),e.jsx(Re,{className:"text-amber-800",children:e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{children:"A antropometria foi atualizada recentemente. Revise o plano alimentar e salve para sincronizar."}),k?.anthropometry_updated_at&&e.jsx("p",{className:"mt-1 text-xs text-amber-700/90",children:Ae(k.anthropometry_updated_at)})]}),e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row",children:[e.jsx(b,{size:"sm",variant:"outline",className:"border-amber-300 bg-white text-amber-800 hover:bg-amber-100",onClick:()=>{o?.id?Se(o.id):z(!0)},children:"Revisar agora"}),e.jsx(b,{size:"sm",variant:"ghost",className:"text-amber-900 hover:bg-amber-100",onClick:Te,children:"Marcar como revisado"})]})]})})]}),e.jsx(Jt,{targetCalories:s?.get_with_activities||s?.get||null,currentCalories:o?.daily_calories||0,patientId:r,energyCalculation:s}),o&&e.jsxs(ee,{className:"mb-6 border-primary shadow-sm",children:[e.jsx(me,{children:e.jsx("div",{className:"flex flex-col gap-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs(xe,{className:"text-lg sm:text-xl flex items-center gap-2",children:[e.jsx("span",{className:"break-words",children:o.name}),e.jsx(pe,{className:"bg-primary",children:"Ativo"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(b,{size:"sm",variant:"outline",onClick:()=>Se(o.id),className:"hidden sm:flex",children:[e.jsx(Le,{className:"h-4 w-4 mr-2"}),"Editar"]}),e.jsxs(b,{size:"sm",onClick:()=>d(`/nutritionist/patients/${r}/meal-plan/${o.id}/summary`),className:"hidden sm:flex",children:[e.jsx(Ze,{className:"h-4 w-4 mr-2"}),"Resumo Nutricional"]}),e.jsxs(b,{size:"sm",variant:"outline",onClick:os,className:"hidden sm:flex",children:[e.jsx(bs,{className:"h-4 w-4 mr-2"}),"Lista de Compras"]}),e.jsxs(Qs,{children:[e.jsx(Ys,{asChild:!0,children:e.jsx(b,{variant:"ghost",size:"icon",className:"h-8 w-8 shrink-0",children:e.jsx(Et,{className:"h-4 w-4"})})}),e.jsxs(Xs,{align:"end",className:"w-56",children:[e.jsxs("div",{className:"sm:hidden",children:[e.jsxs(Me,{onClick:()=>Se(o.id),children:[e.jsx(Le,{className:"h-4 w-4 mr-2"}),"Editar Plano"]}),e.jsxs(Me,{onClick:()=>d(`/nutritionist/patients/${r}/meal-plan/${o.id}/summary`),children:[e.jsx(Ze,{className:"h-4 w-4 mr-2"}),"Ver Resumo Nutricional"]}),e.jsx(ds,{})]}),e.jsxs(Me,{onClick:()=>oe(!0),children:[e.jsx(Ns,{className:"h-4 w-4 mr-2"}),"Exportar PDF"]}),e.jsxs(Me,{onClick:os,children:[e.jsx(bs,{className:"h-4 w-4 mr-2"}),"Gerar Lista de Compras"]}),e.jsxs(Me,{onClick:()=>Fe(o.id),children:[e.jsx(es,{className:"h-4 w-4 mr-2"}),"Copiar como Modelo"]}),e.jsx(ds,{}),e.jsxs(Me,{onClick:()=>Ee(o.id),className:"text-destructive focus:text-destructive",children:[e.jsx(It,{className:"h-4 w-4 mr-2"}),"Arquivar Plano"]})]})]})]})]})})}),e.jsxs(se,{children:[o.description&&e.jsx("p",{className:"text-muted-foreground mb-4",children:o.description}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"InÃ­cio"}),e.jsx("div",{className:"font-semibold",children:Be(o.start_date)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"TÃ©rmino"}),e.jsx("div",{className:"font-semibold",children:o.end_date?Be(o.end_date):"Indeterminado"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Dias Ativos"}),e.jsx("div",{className:"font-semibold",children:is(o.active_days)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"RefeiÃ§Ãµes"}),e.jsx("div",{className:"font-semibold",children:o.meals?.length||0})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-10 gap-6",children:[e.jsx("div",{className:"lg:col-span-6",children:o.meals&&o.meals.length>0?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"font-semibold mb-3",children:"RefeiÃ§Ãµes:"}),o.meals.map((a,x)=>e.jsx("div",{className:"p-3 border rounded-lg bg-muted/30",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsxs("div",{className:"font-medium",children:[x+1,". ",a.name,a.meal_time&&e.jsxs("span",{className:"text-sm text-muted-foreground ml-2",children:["Ã s ",a.meal_time]})]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[a.foods?.length||0," alimento(s) â€¢"," ",a.total_calories?.toFixed(0)||0," kcal"]})]})})},a.id))]}):e.jsx(De,{children:e.jsx(Re,{children:"Nenhuma refeiÃ§Ã£o adicionada ainda."})})}),e.jsx("div",{className:"lg:col-span-4",children:e.jsx($s,{protein:o.daily_protein||0,carbs:o.daily_carbs||0,fat:o.daily_fat||0,calories:o.daily_calories||0,patientId:r,planId:null,referenceValues:y,onReferenceUpdate:null,readOnly:!0})})]})]})]}),o&&e.jsxs(ee,{className:"mb-6",children:[e.jsx(me,{children:e.jsx(xe,{className:"text-lg",children:"HistÃ³rico de VersÃµes do Plano"})}),e.jsx(se,{className:"space-y-4",children:ie?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Carregando versÃµes..."}):X.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Nenhuma versÃ£o registrada ainda. Ao salvar ediÃ§Ãµes, o histÃ³rico serÃ¡ criado automaticamente."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid gap-3 md:grid-cols-[1fr_auto] items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Comparar plano atual com versÃ£o"}),e.jsx("select",{className:"mt-1 w-full rounded-md border border-input bg-background px-3 py-2 text-sm",value:T,onChange:a=>te(a.target.value),children:X.map(a=>e.jsxs("option",{value:String(a.id),children:["VersÃ£o ",a.version_number," â€¢ ",new Date(a.created_at).toLocaleString("pt-BR"),a.is_rollback?" â€¢ rollback":""]},a.id))})]}),e.jsx(b,{variant:"outline",disabled:!je||ce,onClick:Us,children:ce?"Restaurando...":"Restaurar versÃ£o"})]}),je&&de&&ke?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-3",children:[e.jsxs("div",{className:"rounded-lg border p-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Kcal/dia"}),e.jsx("p",{className:"text-lg font-semibold",children:de.calories.toFixed(0)}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Delta: ",Ie(de.calories,ke.calories)]})]}),e.jsxs("div",{className:"rounded-lg border p-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"ProteÃ­na"}),e.jsxs("p",{className:"text-lg font-semibold",children:[de.protein.toFixed(1)," g"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Delta: ",Ie(de.protein,ke.protein)]})]}),e.jsxs("div",{className:"rounded-lg border p-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Carboidratos"}),e.jsxs("p",{className:"text-lg font-semibold",children:[de.carbs.toFixed(1)," g"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Delta: ",Ie(de.carbs,ke.carbs)]})]}),e.jsxs("div",{className:"rounded-lg border p-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Gorduras"}),e.jsxs("p",{className:"text-lg font-semibold",children:[de.fat.toFixed(1)," g"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Delta: ",Ie(de.fat,ke.fat)]})]}),e.jsxs("div",{className:"rounded-lg border p-3",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"RefeiÃ§Ãµes"}),e.jsx("p",{className:"text-lg font-semibold",children:de.mealsCount}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Delta: ",Ie(de.mealsCount,ke.mealsCount)]})]})]}):null]})})]}),e.jsxs(ee,{children:[e.jsx(me,{children:e.jsx(xe,{children:"Todos os Planos"})}),e.jsx(se,{children:p.length===0?e.jsx(De,{children:e.jsx(Re,{children:'Nenhum plano alimentar criado ainda. Clique em "Novo Plano" para comeÃ§ar.'})}):e.jsx("div",{className:"space-y-3",children:p.map(a=>e.jsx("div",{className:"p-4 border rounded-lg hover:bg-muted/50 transition-colors",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-semibold",children:a.name}),a.is_active&&e.jsx(pe,{variant:"outline",children:"Ativo"}),!a.is_active&&e.jsx(pe,{variant:"secondary",children:"Arquivado"})]}),e.jsxs("div",{className:"text-sm text-muted-foreground mt-1",children:[Be(a.start_date),a.end_date&&` atÃ© ${Be(a.end_date)}`," ","â€¢ ",is(a.active_days)," ","â€¢ ",a.daily_calories?.toFixed(0)||0," kcal/dia"]})]}),e.jsxs("div",{className:"flex gap-2",children:[!a.is_active&&e.jsx(b,{variant:"default",size:"sm",onClick:()=>Q(a.id),title:"Ativar este plano",children:e.jsx(us,{className:"h-4 w-4"})}),e.jsx(b,{variant:"outline",size:"sm",onClick:()=>Se(a.id),title:"Editar plano",children:e.jsx(Le,{className:"h-4 w-4"})}),e.jsx(b,{variant:"outline",size:"sm",onClick:()=>Fe(a.id),title:"Copiar modelo",children:e.jsx(es,{className:"h-4 w-4"})}),e.jsx(b,{variant:"outline",size:"sm",onClick:()=>{A(a.id),W(!0)},title:"Deletar plano",children:e.jsx(ss,{className:"h-4 w-4 text-destructive"})})]})]})},a.id))})})]}),e.jsx(_s,{open:N,onOpenChange:W,children:e.jsxs(Ss,{children:[e.jsxs(Fs,{children:[e.jsx(ks,{children:"Confirmar ExclusÃ£o"}),e.jsx(Ms,{children:"Tem certeza que deseja deletar este plano alimentar? Esta aÃ§Ã£o nÃ£o pode ser desfeita."})]}),e.jsxs(Ps,{children:[e.jsx(As,{onClick:()=>A(null),children:"Cancelar"}),e.jsx(Ts,{onClick:qs,className:"bg-destructive",children:"Deletar"})]})]})}),e.jsx(Ut,{isOpen:g,onClose:()=>{$(!1),Y(null)},planId:V?.id,planName:V?.name,onCopy:qe}),e.jsx(ve,{open:S,onOpenChange:M,children:e.jsxs(Ne,{children:[e.jsxs(be,{children:[e.jsx(ye,{children:"Salvar Plano como Modelo"}),e.jsx(we,{children:"Salve este plano como um template para reutilizar em outros pacientes."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{htmlFor:"template-name",className:"text-sm font-medium",children:["Nome do Modelo ",e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(fe,{id:"template-name",placeholder:"Ex: Hipertrofia 3000kcal",value:q,onChange:a=>B(a.target.value),disabled:m})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"template-tags",className:"text-sm font-medium",children:"Tags (separadas por vÃ­rgula)"}),e.jsx(fe,{id:"template-tags",placeholder:"Ex: hipertrofia, ganho de peso, 3000kcal",value:U,onChange:a=>J(a.target.value),disabled:m}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Use tags para facilitar a busca dos templates"})]})]}),e.jsxs(Pe,{children:[e.jsx(b,{variant:"outline",onClick:()=>{M(!1),B(""),J("")},disabled:m,children:"Cancelar"}),e.jsx(b,{onClick:Bs,disabled:m||!q.trim(),children:m?"Salvando...":"Salvar Modelo"})]})]})}),e.jsx(Ht,{open:_e,onOpenChange:ne,patientId:r,nutritionistId:n,onTemplateApplied:Vs}),e.jsx(ve,{open:ge,onOpenChange:oe,children:e.jsxs(Ne,{className:"sm:max-w-md",children:[e.jsxs(be,{children:[e.jsx(ye,{children:"Exportar Plano Alimentar"}),e.jsx(we,{children:"Escolha o formato de exportaÃ§Ã£o para PDF"})]}),e.jsxs("div",{className:"grid gap-3 py-4",children:[e.jsx(ee,{className:"cursor-pointer hover:bg-accent/50 transition-colors border-2 hover:border-primary",onClick:()=>ns(!1),children:e.jsxs(se,{className:"flex items-start gap-3 p-4",children:[e.jsx("div",{className:"flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-primary/10 text-primary",children:e.jsx(Ge,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("h4",{className:"text-sm font-semibold leading-none",children:"Plano Simples"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Macronutrientes bÃ¡sicos (calorias, proteÃ­nas, carboidratos e gorduras)"})]})]})}),e.jsx(ee,{className:"cursor-pointer hover:bg-accent/50 transition-colors border-2 hover:border-primary",onClick:()=>ns(!0),children:e.jsxs(se,{className:"flex items-start gap-3 p-4",children:[e.jsx("div",{className:"flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-secondary/10 text-secondary",children:e.jsx(Ns,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("h4",{className:"text-sm font-semibold leading-none",children:"Plano Completo"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Macros + micronutrientes (fibras, vitaminas, minerais)"})]})]})})]}),e.jsx(Pe,{className:"sm:justify-start",children:e.jsx(b,{variant:"ghost",onClick:()=>oe(!1),className:"w-full sm:w-auto",children:"Cancelar"})})]})})]})};export{nr as default};
