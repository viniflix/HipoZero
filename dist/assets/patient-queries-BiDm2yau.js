import{s as o}from"./index-Cl9S2_vK.js";import{t as _}from"./mealTranslations-B1KHhmEq.js";const u=async(i,t)=>{try{const{data:a,error:n}=await o.from("user_profiles").select("*").eq("id",i).eq("nutritionist_id",t).single();if(n)throw n;return{data:a,error:null}}catch(a){return console.error("Erro ao buscar perfil do paciente:",a),{data:null,error:a}}},g=async i=>{try{const{data:t,error:a}=await o.from("growth_records").select("weight, height, record_date").eq("patient_id",i).order("record_date",{ascending:!1}).limit(1).maybeSingle();let n=t?.weight,r=t?.height;if(!n||!r){const{data:d}=await o.from("user_profiles").select("weight, height").eq("id",i).single();n=n||d?.weight,r=r||d?.height}const{data:l,error:c}=await o.from("appointments").select("appointment_time, status").eq("patient_id",i).lte("appointment_time",new Date().toISOString()).order("appointment_time",{ascending:!1}).limit(1).maybeSingle(),{data:e,error:s}=await o.from("appointments").select("appointment_time, status").eq("patient_id",i).gte("appointment_time",new Date().toISOString()).order("appointment_time",{ascending:!0}).limit(1).maybeSingle();return{data:{weight:n||null,height:r||null,last_measurement:t?.record_date||null,last_appointment:l?new Date(l.appointment_time).toLocaleDateString("pt-BR"):null,next_appointment:e?new Date(e.appointment_time).toLocaleDateString("pt-BR"):null},error:null}}catch(t){return console.error("Erro ao buscar mÃ©tricas do paciente:",t),{data:null,error:t}}},h=async i=>{try{const{data:t}=await o.from("anamnese_answers").select("id").eq("patient_id",i).limit(1).maybeSingle(),{data:a}=await o.from("growth_records").select("id").eq("patient_id",i).limit(1).maybeSingle(),{data:n}=await o.from("prescriptions").select("id").eq("patient_id",i).limit(1).maybeSingle(),{data:r}=await o.from("meals").select("id").eq("patient_id",i).is("deleted_at",null).limit(1).maybeSingle(),{data:l}=await o.from("user_achievements").select("id").eq("user_id",i).limit(1).maybeSingle(),{data:c}=await o.from("energy_expenditure_calculations").select("id").eq("patient_id",i).limit(1).maybeSingle(),{data:e}=await o.from("lab_results").select("id").eq("patient_id",i).limit(1).maybeSingle();return{data:{anamnese:t?"completed":"not_started",anthropometry:a?"completed":"not_started",energy_expenditure:c?"completed":"not_started",meal_plan:n?"completed":"not_started",food_diary:r?"completed":"not_started",lab_results:e?"completed":"not_started",prescriptions:n?"completed":"not_started",achievements:l?"completed":"not_started"},error:null}}catch(t){return console.error("Erro ao buscar status dos mÃ³dulos:",t),{data:null,error:t}}},w=async(i,t=10)=>{try{const a=[],{data:n}=await o.from("meal_audit_log").select("id, action, meal_type, details, created_at").eq("patient_id",i).order("created_at",{ascending:!1}).limit(30);n&&n.forEach(e=>{const s=e.details?.total_calories||0,m=_(e.meal_type);let d="",p="";e.action==="create"?(d="RefeiÃ§Ã£o Registrada",p=`${m} - ${s} kcal`):e.action==="update"?(d="RefeiÃ§Ã£o Editada",p=`${m} - ${s} kcal`):e.action==="delete"&&(d="RefeiÃ§Ã£o Deletada",p=`${m} - ${s} kcal`),a.push({id:`audit-${e.id}`,type:"meal",title:d,description:p,timestamp:e.created_at,metadata:[m,`${s} kcal`,e.action==="create"?"Registrado":e.action==="update"?"Editado":"Deletado"]})});const{data:r}=await o.from("growth_records").select("id, weight, height, record_date, created_at").eq("patient_id",i).order("record_date",{ascending:!1}).limit(20);r&&r.forEach(e=>{const s=e.height?(e.weight/Math.pow(e.height/100,2)).toFixed(1):null;a.push({id:`weight-${e.id}`,type:"weight",title:"Peso Registrado",description:`Peso: ${e.weight} kg`,timestamp:e.created_at,metadata:s?[`${e.weight} kg`,`IMC: ${s}`]:[`${e.weight} kg`]})});const{data:l}=await o.from("user_achievements").select("id, achievement_id, achieved_at, achievements(name)").eq("user_id",i).order("achieved_at",{ascending:!1}).limit(15);l&&l.forEach(e=>{a.push({id:`achievement-${e.id}`,type:"achievement",title:"Conquista Desbloqueada",description:e.achievements?.name||"Nova conquista",timestamp:e.achieved_at,metadata:["ðŸ† Conquista"]})});const{data:c}=await o.from("appointments").select("id, appointment_time, status, notes").eq("patient_id",i).order("appointment_time",{ascending:!1}).limit(15);return c&&c.forEach(e=>{a.push({id:`appointment-${e.id}`,type:"appointment",title:"Consulta Realizada",description:e.notes||"Consulta de acompanhamento",timestamp:e.appointment_time,metadata:[e.status||"ConcluÃ­da"]})}),a.sort((e,s)=>new Date(s.timestamp)-new Date(e.timestamp)),{data:a.slice(0,t),error:null}}catch(a){return console.error("Erro ao buscar atividades do paciente:",a),{data:[],error:a}}},b=async(i,t)=>{try{const[a,n,r]=await Promise.all([u(i,t),g(i),h(i)]);if(a.error)throw a.error;return{data:{profile:a.data,metrics:n.data||{},modulesStatus:r.data||{}},error:null}}catch(a){return console.error("Erro ao buscar resumo do paciente:",a),{data:null,error:a}}},v=async i=>{try{const{data:t,error:a}=await o.rpc("get_patients_low_adherence_optimized",{p_nutritionist_id:i,p_days_threshold:2});if(a)throw a;return{data:(t||[]).map(r=>({id:r.patient_id,name:r.patient_name,last_activity:r.last_meal_date,days_inactive:r.days_since_last_meal===9999?null:r.days_since_last_meal})),error:null}}catch(t){return console.error("Erro ao detectar baixa adesÃ£o:",t),{data:[],error:t}}},q=async i=>{try{const{data:t,error:a}=await o.rpc("get_patients_pending_data_optimized",{p_nutritionist_id:i});if(a)throw a;return{data:(t||[]).map(r=>{const l=[];return r.pending_items.forEach(c=>{const e={anamnese:{type:"anamnesis",label:"Anamnese Pendente",route:`/nutritionist/patients/${r.patient_id}/anamnese`},anthropometry:{type:"anthropometry",label:"AvaliaÃ§Ã£o AntropomÃ©trica Pendente",route:`/nutritionist/patients/${r.patient_id}/anthropometry`},meal_plan:{type:"meal_plan",label:"Plano Alimentar Pendente",route:`/nutritionist/patients/${r.patient_id}/meal-plan`},prescription:{type:"prescription",label:"CÃ¡lculo de Necessidades Pendente",route:`/nutritionist/patients/${r.patient_id}/energy-expenditure`}};e[c]&&l.push(e[c])}),{patient_id:r.patient_id,patient_name:r.patient_name,pending_items:l}}),error:null}}catch(t){return console.error("Erro ao detectar pendÃªncias:",t),{data:[],error:t}}},D=async i=>{try{const{data:t,error:a}=await o.from("anamnesis_records").select("id, content, date").eq("patient_id",i).order("date",{ascending:!1}).limit(1).maybeSingle();if(a)throw a;if(!t||!t.content)return{data:null,error:null};const n=t.content;let r=null,l=null;if(typeof n=="object"){const c=["exercise_frequency","exerciseFrequency","frequencia_exercicio","atividade_fisica","physical_activity","nivel_atividade","activity_level"];for(const e of c)if(n[e]){r=n[e];break}if(!r&&n.sections){for(const e of n.sections)if(e.fields){for(const s of e.fields)if(c.includes(s.key||s.id)){r=s.value||s.answer;break}}}}return{data:{exerciseFrequency:r,activityLevel:l,date:t.date},error:null}}catch(t){return console.error("Erro ao buscar anamnese para energia:",t),{data:null,error:t}}},E=async i=>{try{const{data:t,error:a}=await o.from("patient_goals").select("id, type, target_weight, current_weight, description, status").eq("patient_id",i).eq("status","active").order("created_at",{ascending:!1}).limit(1).maybeSingle();if(a)throw a;return{data:t,error:null}}catch(t){return console.error("Erro ao buscar objetivo para energia:",t),{data:null,error:t}}};export{q as a,b,w as c,u as d,D as e,E as f,v as g};
