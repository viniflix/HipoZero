import{s as n}from"./index-D2NJdUSJ.js";import{t as _}from"./mealTranslations-B1KHhmEq.js";const u=async(a,i)=>{try{const{data:e,error:o}=await n.from("user_profiles").select("*").eq("id",a).eq("nutritionist_id",i).single();if(o)throw o;return{data:e,error:null}}catch(e){return console.error("Erro ao buscar perfil do paciente:",e),{data:null,error:e}}},h=async a=>{try{const{data:i,error:e}=await n.from("growth_records").select("weight, height, record_date").eq("patient_id",a).order("record_date",{ascending:!1}).limit(1).maybeSingle();let o=i?.weight,r=i?.height;if(!o||!r){const{data:c}=await n.from("user_profiles").select("weight, height").eq("id",a).single();o=o||c?.weight,r=r||c?.height}const{data:l,error:d}=await n.from("appointments").select("appointment_time, status").eq("patient_id",a).lte("appointment_time",new Date().toISOString()).order("appointment_time",{ascending:!1}).limit(1).maybeSingle(),{data:t,error:s}=await n.from("appointments").select("appointment_time, status").eq("patient_id",a).gte("appointment_time",new Date().toISOString()).order("appointment_time",{ascending:!0}).limit(1).maybeSingle();return{data:{weight:o||null,height:r||null,last_measurement:i?.record_date||null,last_appointment:l?new Date(l.appointment_time).toLocaleDateString("pt-BR"):null,next_appointment:t?new Date(t.appointment_time).toLocaleDateString("pt-BR"):null},error:null}}catch(i){return console.error("Erro ao buscar mÃ©tricas do paciente:",i),{data:null,error:i}}},g=async a=>{try{const{data:i}=await n.from("anamnese_answers").select("id").eq("patient_id",a).limit(1).maybeSingle(),{data:e}=await n.from("growth_records").select("id").eq("patient_id",a).limit(1).maybeSingle(),{data:o}=await n.from("prescriptions").select("id").eq("patient_id",a).limit(1).maybeSingle(),{data:r}=await n.from("meals").select("id").eq("patient_id",a).is("deleted_at",null).limit(1).maybeSingle(),{data:l}=await n.from("user_achievements").select("id").eq("user_id",a).limit(1).maybeSingle(),{data:d}=await n.from("energy_expenditure_calculations").select("id").eq("patient_id",a).limit(1).maybeSingle(),{data:t}=await n.from("lab_results").select("id").eq("patient_id",a).limit(1).maybeSingle();return{data:{anamnese:i?"completed":"not_started",anthropometry:e?"completed":"not_started",energy_expenditure:d?"completed":"not_started",meal_plan:o?"completed":"not_started",food_diary:r?"completed":"not_started",lab_results:t?"completed":"not_started",prescriptions:o?"completed":"not_started",achievements:l?"completed":"not_started"},error:null}}catch(i){return console.error("Erro ao buscar status dos mÃ³dulos:",i),{data:null,error:i}}},y=async(a,i=10)=>{try{const e=[],{data:o}=await n.from("meal_audit_log").select("id, action, meal_type, details, created_at").eq("patient_id",a).order("created_at",{ascending:!1}).limit(30);o&&o.forEach(t=>{const s=t.details?.total_calories||0,m=_(t.meal_type);let c="",p="";t.action==="create"?(c="RefeiÃ§Ã£o Registrada",p=`${m} - ${s} kcal`):t.action==="update"?(c="RefeiÃ§Ã£o Editada",p=`${m} - ${s} kcal`):t.action==="delete"&&(c="RefeiÃ§Ã£o Deletada",p=`${m} - ${s} kcal`),e.push({id:`audit-${t.id}`,type:"meal",title:c,description:p,timestamp:t.created_at,metadata:[m,`${s} kcal`,t.action==="create"?"Registrado":t.action==="update"?"Editado":"Deletado"]})});const{data:r}=await n.from("growth_records").select("id, weight, height, record_date, created_at").eq("patient_id",a).order("record_date",{ascending:!1}).limit(20);r&&r.forEach(t=>{const s=t.height?(t.weight/Math.pow(t.height/100,2)).toFixed(1):null;e.push({id:`weight-${t.id}`,type:"weight",title:"Peso Registrado",description:`Peso: ${t.weight} kg`,timestamp:t.created_at,metadata:s?[`${t.weight} kg`,`IMC: ${s}`]:[`${t.weight} kg`]})});const{data:l}=await n.from("user_achievements").select("id, achievement_id, achieved_at, achievements(name)").eq("user_id",a).order("achieved_at",{ascending:!1}).limit(15);l&&l.forEach(t=>{e.push({id:`achievement-${t.id}`,type:"achievement",title:"Conquista Desbloqueada",description:t.achievements?.name||"Nova conquista",timestamp:t.achieved_at,metadata:["ğŸ† Conquista"]})});const{data:d}=await n.from("appointments").select("id, appointment_time, status, notes").eq("patient_id",a).order("appointment_time",{ascending:!1}).limit(15);return d&&d.forEach(t=>{e.push({id:`appointment-${t.id}`,type:"appointment",title:"Consulta Realizada",description:t.notes||"Consulta de acompanhamento",timestamp:t.appointment_time,metadata:[t.status||"ConcluÃ­da"]})}),e.sort((t,s)=>new Date(s.timestamp)-new Date(t.timestamp)),{data:e.slice(0,i),error:null}}catch(e){return console.error("Erro ao buscar atividades do paciente:",e),{data:[],error:e}}},D=async(a,i)=>{try{const[e,o,r]=await Promise.all([u(a,i),h(a),g(a)]);if(e.error)throw e.error;return{data:{profile:e.data,metrics:o.data||{},modulesStatus:r.data||{}},error:null}}catch(e){return console.error("Erro ao buscar resumo do paciente:",e),{data:null,error:e}}},b=async a=>{try{const{data:i,error:e}=await n.rpc("get_patients_low_adherence_optimized",{p_nutritionist_id:a,p_days_threshold:2});if(e)throw e;return{data:(i||[]).map(r=>({id:r.patient_id,name:r.patient_name,last_activity:r.last_meal_date,days_inactive:r.days_since_last_meal===9999?null:r.days_since_last_meal})),error:null}}catch(i){return console.error("Erro ao detectar baixa adesÃ£o:",i),{data:[],error:i}}},q=async a=>{try{const{data:i,error:e}=await n.rpc("get_patients_pending_data_optimized",{p_nutritionist_id:a});if(e)throw e;return{data:(i||[]).map(r=>{const l=[];return r.pending_items.forEach(d=>{const t={anamnese:{type:"anamnesis",label:"Anamnese Pendente",route:`/nutritionist/patients/${r.patient_id}/anamnese`},anthropometry:{type:"anthropometry",label:"AvaliaÃ§Ã£o AntropomÃ©trica Pendente",route:`/nutritionist/patients/${r.patient_id}/anthropometry`},meal_plan:{type:"meal_plan",label:"Plano Alimentar Pendente",route:`/nutritionist/patients/${r.patient_id}/meal-plan`},prescription:{type:"prescription",label:"CÃ¡lculo de Necessidades Pendente",route:`/nutritionist/patients/${r.patient_id}/energy-expenditure`}};t[d]&&l.push(t[d])}),{patient_id:r.patient_id,patient_name:r.patient_name,pending_items:l}}),error:null}}catch(i){return console.error("Erro ao detectar pendÃªncias:",i),{data:[],error:i}}};export{q as a,D as b,y as c,u as d,b as g};
