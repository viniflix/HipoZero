import{s as c}from"./index-BvWB-6Y-.js";import{calculateCaloriesFromMacros as B}from"./nutrition-calculations-DjYFS08l.js";import{g as M}from"./date-C2sroe8F.js";import{l as m}from"./query-helpers-mbysFH2_.js";import{l as S}from"./observability-queries-BxbsnaqH.js";const R=`
    id,
    name,
    source,
    description,
    portion_size,
    calories,
    protein,
    carbs,
    fat,
    fiber,
    sodium,
    saturated_fat,
    trans_fat,
    cholesterol,
    sugar,
    calcium,
    iron,
    magnesium,
    phosphorus,
    potassium,
    zinc,
    vitamin_a,
    vitamin_c,
    vitamin_d,
    vitamin_e,
    vitamin_b12,
    folate
`,V=async r=>{const e=[...new Set((r||[]).filter(Boolean).map(String))];if(e.length===0)return{};const{data:a,error:t}=await c.from("foods").select(R).in("id",e);if(t)throw t;return(a||[]).reduce((n,o)=>(n[String(o.id)]=o,n),{})},y=r=>{const e=Number(r);return Number.isFinite(e)?e:0},v=r=>Math.round(y(r)*100)/100,k=(r=[])=>(r||[]).reduce((e,a)=>({calories:e.calories+y(a?.calories),protein:e.protein+y(a?.protein),carbs:e.carbs+y(a?.carbs),fat:e.fat+y(a?.fat)}),{calories:0,protein:0,carbs:0,fat:0}),T=r=>r?.tempId??r?.id??null,H=(r=[],e=1,a={})=>{const t=Number.isFinite(Number(e))&&Number(e)>0?Number(e):1,n=a?.scope||"all",o=a?.mealId??null,i=a?.foodId??null,l=k(r),u=(r||[]).map(d=>{const p=T(d),f=n==="all"||n!=="all"&&String(p)===String(o),_=(d?.foods||[]).map(b=>{const q=T(b);return n==="all"||n==="meal"&&f||n==="food"&&f&&String(q)===String(i)?{...b,quantity:v(y(b?.quantity)*t),calories:v(y(b?.calories)*t),protein:v(y(b?.protein)*t),carbs:v(y(b?.carbs)*t),fat:v(y(b?.fat)*t)}:b}),w=_.length>0,g=n==="all"||n==="meal"&&f,h=w?_.reduce((b,q)=>({calories:b.calories+y(q?.calories),protein:b.protein+y(q?.protein),carbs:b.carbs+y(q?.carbs),fat:b.fat+y(q?.fat)}),{calories:0,protein:0,carbs:0,fat:0}):{calories:g?y(d?.calories)*t:y(d?.calories),protein:g?y(d?.protein)*t:y(d?.protein),carbs:g?y(d?.carbs)*t:y(d?.carbs),fat:g?y(d?.fat)*t:y(d?.fat)};return{...d,calories:v(h.calories),protein:v(h.protein),carbs:v(h.carbs),fat:v(h.fat),foods:_}}),s=k(u);return{scaleFactor:t,scope:n,meals:u,totalsBefore:l,totalsAfter:s,delta:{calories:v(s.calories-l.calories),protein:v(s.protein-l.protein),carbs:v(s.carbs-l.carbs),fat:v(s.fat-l.fat)}}},z=async r=>{try{const{patient_id:e,nutritionist_id:a,name:t,description:n,active_days:o,start_date:i,end_date:l}=r,{error:u}=await c.from("meal_plans").update({is_active:!1}).eq("patient_id",e).eq("is_active",!0);u&&console.warn("Erro ao desativar planos anteriores:",u);const{data:s,error:d}=await c.from("meal_plans").insert([{patient_id:e,nutritionist_id:a,name:t,description:n||null,active_days:o||["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],start_date:i||M(),end_date:l||null,is_active:!0}]).select().single();if(d)throw d;return{data:s,error:null}}catch(e){return m("Erro ao criar plano alimentar",e),{data:null,error:e}}},J=async(r,e=!1)=>{try{let a=c.from("meal_plans").select("*").eq("patient_id",r).order("created_at",{ascending:!1});e&&(a=a.eq("is_active",!0));const{data:t,error:n}=await a;if(n)throw n;return{data:t||[],error:null}}catch(a){return m("Erro ao buscar planos alimentares",a),{data:[],error:a}}},E=async r=>{try{const{data:e,error:a}=await c.from("meal_plans").select("*").eq("id",r).single();if(a)throw a;const{data:t,error:n}=await c.from("meal_plan_meals").select("*").eq("meal_plan_id",r).order("order_index",{ascending:!0});if(n)throw n;const o=await Promise.all((t||[]).map(async i=>{const{data:l,error:u}=await c.from("meal_plan_foods").select("*").eq("meal_plan_meal_id",i.id).order("order_index",{ascending:!0});if(u)return m("Erro ao buscar alimentos da refeição",u),{...i,calories:i.total_calories||0,protein:i.total_protein||0,carbs:i.total_carbs||0,fat:i.total_fat||0,foods:[]};const s=await V((l||[]).map(_=>_.food_id)),d=(l||[]).filter(_=>_.unit&&typeof _.unit=="number").map(_=>_.unit);let p={};if(d.length>0){const{data:_}=await c.from("household_measures").select("id, name, code, grams_equivalent").in("id",d);p=(_||[]).reduce((w,g)=>(w[g.id]=g,w),{})}const f=(l||[]).map(_=>({..._,food:s[String(_.food_id)]||null,foods:s[String(_.food_id)]||null,measure:typeof _.unit=="number"?p[_.unit]:null}));return{...i,calories:i.total_calories||0,protein:i.total_protein||0,carbs:i.total_carbs||0,fat:i.total_fat||0,foods:f}}));return{data:{...e,meals:o},error:null}}catch(e){return m("Erro ao buscar plano alimentar",e),{data:null,error:e}}},K=async r=>{try{const e=M(),{data:a,error:t}=await c.from("meal_plans").select("*").eq("patient_id",r).eq("is_active",!0).lte("start_date",e).or(`end_date.is.null,end_date.gte.${e}`).order("start_date",{ascending:!1}).limit(1).maybeSingle();if(t)throw t;return a?E(a.id):{data:null,error:null}}catch(e){return m("Erro ao buscar plano ativo",e),{data:null,error:e}}},I=async(r,e)=>{try{const{data:a,error:t}=await c.from("meal_plans").update(e).eq("id",r).select().single();if(t)throw t;return{data:a,error:null}}catch(a){return m("Erro ao atualizar plano alimentar",a),{data:null,error:a}}},X=async r=>I(r,{is_active:!1}),Y=async r=>{try{const{data:e,error:a}=await c.from("meal_plans").select("patient_id").eq("id",r).single();if(a)throw a;const{error:t}=await c.from("meal_plans").update({is_active:!1}).eq("patient_id",e.patient_id).eq("is_active",!0);if(t)throw t;const{data:n,error:o}=await c.from("meal_plans").update({is_active:!0}).eq("id",r).select().single();if(o)throw o;return{data:n,error:null}}catch(e){return m("Erro ao ativar plano alimentar",e),{data:null,error:e}}},Z=async r=>{try{const{data:e,error:a}=await c.from("meal_plans").delete().eq("id",r).select().single();if(a)throw a;return{data:e,error:null}}catch(e){return m("Erro ao deletar plano alimentar",e),{data:null,error:e}}},F=async r=>{try{const{meal_plan_id:e,name:a,meal_type:t,meal_time:n,notes:o,order_index:i}=r,{data:l,error:u}=await c.from("meal_plan_meals").insert([{meal_plan_id:e,name:a,meal_type:t,meal_time:n||null,notes:o||null,order_index:i||0}]).select().single();if(u)throw u;return{data:l,error:null}}catch(e){return m("Erro ao adicionar refeição ao plano",e),{data:null,error:e}}},x=async r=>{try{const{meal_plan_meal_id:e,food_id:a,quantity:t,unit:n,calories:o,protein:i,carbs:l,fat:u,notes:s,order_index:d}=r,{data:p,error:f}=await c.from("meal_plan_foods").insert([{meal_plan_meal_id:e,food_id:a,quantity:t,unit:n,calories:o,protein:i,carbs:l,fat:u,notes:s||null,order_index:d||0}]).select("*").single();if(f)throw f;const _=await V([p?.food_id]),w={...p,food:_[String(p?.food_id)]||null,foods:_[String(p?.food_id)]||null};return await O(e),{data:w,error:null}}catch(e){return m("Erro ao adicionar alimento à refeição",e),{data:null,error:e}}},O=async r=>{try{const{data:e,error:a}=await c.from("meal_plan_foods").select("calories, protein, carbs, fat").eq("meal_plan_meal_id",r);if(a)throw a;const t=(e||[]).reduce((i,l)=>({total_calories:i.total_calories+(parseFloat(l.calories)||0),total_protein:i.total_protein+(parseFloat(l.protein)||0),total_carbs:i.total_carbs+(parseFloat(l.carbs)||0),total_fat:i.total_fat+(parseFloat(l.fat)||0)}),{total_calories:0,total_protein:0,total_carbs:0,total_fat:0}),{data:n,error:o}=await c.from("meal_plan_meals").update(t).eq("id",r).select("meal_plan_id").single();if(o)throw o;return n&&await j(n.meal_plan_id),{data:t,error:null}}catch(e){return m("Erro ao recalcular nutrição da refeição",e),{data:null,error:e}}},j=async r=>{try{const{data:e,error:a}=await c.from("meal_plan_meals").select("total_calories, total_protein, total_carbs, total_fat").eq("meal_plan_id",r);if(a)throw a;const t=(e||[]).reduce((i,l)=>({daily_calories:i.daily_calories+(parseFloat(l.total_calories)||0),daily_protein:i.daily_protein+(parseFloat(l.total_protein)||0),daily_carbs:i.daily_carbs+(parseFloat(l.total_carbs)||0),daily_fat:i.daily_fat+(parseFloat(l.total_fat)||0)}),{daily_calories:0,daily_protein:0,daily_carbs:0,daily_fat:0}),{data:n,error:o}=await c.from("meal_plans").update(t).eq("id",r).select().single();if(o)throw o;return{data:n,error:null}}catch(e){return m("Erro ao recalcular nutrição do plano",e),{data:null,error:e}}},ee=async(r,e,a)=>{try{let t=null;if(a==="gram"||a==="ml")t=e;else{let s=a;if(typeof a=="string"){const{data:d}=await c.from("household_measures").select("id").eq("code",a).maybeSingle();s=d?.id}if(s){const{data:d}=await c.from("food_household_measures").select("quantity, grams").eq("food_id",r.id).eq("measure_id",s).maybeSingle();if(d)t=d.grams*(e/d.quantity);else{const{data:p}=await c.from("household_measures").select("grams_equivalent").eq("id",s).maybeSingle();p&&p.grams_equivalent?t=p.grams_equivalent*e:t=(r.portion_size||100)*e}}else t=(r.portion_size||100)*e}if(!t||t<=0)return{calories:0,protein:0,carbs:0,fat:0};const n=t/100,o=(r.protein||0)*n,i=(r.carbs||0)*n,l=(r.fat||0)*n,u=B(o,i,l);return{calories:parseFloat(u.toFixed(2)),protein:parseFloat(o.toFixed(2)),carbs:parseFloat(i.toFixed(2)),fat:parseFloat(l.toFixed(2))}}catch(t){return m("Erro ao calcular nutrição",t),{calories:0,protein:0,carbs:0,fat:0}}},ae=async(r,e)=>{try{const{data:a,error:t}=await E(r);if(t)throw t;const{data:n,error:o}=await z({patient_id:e,nutritionist_id:a.nutritionist_id,name:a.name,description:a.description,active_days:a.active_days,start_date:M()});if(o)throw o;for(const i of a.meals||[]){const{data:l,error:u}=await F({meal_plan_id:n.id,name:i.name,meal_type:i.meal_type,meal_time:i.meal_time,notes:i.notes,order_index:i.order_index});if(u)throw u;for(const s of i.foods||[])await x({meal_plan_meal_id:l.id,food_id:s.food_id,quantity:s.quantity,unit:s.unit,calories:s.calories,protein:s.protein,carbs:s.carbs,fat:s.fat,notes:s.notes,order_index:s.order_index})}return E(n.id)}catch(a){return m("Erro ao copiar plano para paciente",a),{data:null,error:a}}},C=r=>{if(!r)return null;const e=(r.meals||[]).map(a=>({id:a.id,name:a.name,meal_type:a.meal_type,meal_time:a.meal_time||null,notes:a.notes||null,order_index:a.order_index??0,total_calories:a.total_calories??a.calories??0,total_protein:a.total_protein??a.protein??0,total_carbs:a.total_carbs??a.carbs??0,total_fat:a.total_fat??a.fat??0,foods:(a.foods||[]).map(t=>({id:t.id,food_id:t.food_id,quantity:t.quantity??0,unit:t.unit||null,calories:t.calories??0,protein:t.protein??0,carbs:t.carbs??0,fat:t.fat??0,notes:t.notes||null,order_index:t.order_index??0}))}));return{plan:{id:r.id,patient_id:r.patient_id,nutritionist_id:r.nutritionist_id,name:r.name,description:r.description||null,active_days:r.active_days||[],start_date:r.start_date,end_date:r.end_date||null,is_active:!!r.is_active,daily_calories:r.daily_calories??0,daily_protein:r.daily_protein??0,daily_carbs:r.daily_carbs??0,daily_fat:r.daily_fat??0},meals:e}},L=async r=>{const{data:e,error:a}=await c.from("meal_plan_versions").select("id, version_number").eq("meal_plan_id",r).order("version_number",{ascending:!1}).limit(1).maybeSingle();if(a)throw a;return e||null},N=async({mealPlan:r,versionNumber:e,changeReason:a=null,createdBy:t=null,isRollback:n=!1,metadata:o={}})=>{try{if(!r?.id)return{data:null,error:new Error("Plano inválido para gerar versão")};const i=C(r);if(!i)return{data:null,error:new Error("Snapshot inválido para versão do plano")};const{data:l,error:u}=await c.from("meal_plan_versions").insert([{meal_plan_id:r.id,nutritionist_id:r.nutritionist_id,patient_id:r.patient_id,version_number:e,change_reason:a,snapshot:i,is_rollback:!!n,metadata:o&&typeof o=="object"?o:{},created_by:t||null}]).select().single();if(u)throw u;return{data:l,error:null}}catch(i){return m("Erro ao criar versão do plano alimentar",i),{data:null,error:i}}},re=async(r,e=20)=>{try{const{data:a,error:t}=await c.from("meal_plan_versions").select("*").eq("meal_plan_id",r).order("version_number",{ascending:!1}).limit(e);if(t)throw t;return{data:a||[],error:null}}catch(a){return m("Erro ao buscar versões do plano alimentar",a),{data:[],error:a}}},W=async(r,e)=>{const a=Date.now();try{const[{data:t,error:n},{data:o}]=await Promise.all([E(r),c.auth.getUser()]);if(n)throw n;if(!t)throw new Error("Plano não encontrado para versionamento");const i=await L(r),l=o?.user?.id||null;let u=(i?.version_number||0)+1;if(!i){const _=await N({mealPlan:t,versionNumber:1,changeReason:"baseline_inicial",createdBy:l,metadata:{origin:"updateFullMealPlan"}});if(_.error)throw _.error;u=2}const{error:s}=await c.from("meal_plans").update({name:e.name,description:e.description,active_days:e.active_days,start_date:e.start_date,end_date:e.end_date||null}).eq("id",r);if(s)throw s;const{error:d}=await c.from("meal_plan_meals").delete().eq("meal_plan_id",r);if(d)throw d;for(const _ of e.meals||[]){const{data:w,error:g}=await F({meal_plan_id:r,name:_.name,meal_type:_.meal_type,meal_time:_.meal_time,notes:_.notes,order_index:_.order_index});if(g)throw g;for(const h of _.foods||[])await x({meal_plan_meal_id:w.id,food_id:h.food_id,quantity:h.quantity,unit:h.unit,calories:h.calories,protein:h.protein,carbs:h.carbs,fat:h.fat,notes:h.notes,order_index:h.order_index||0})}const p=await E(r);if(p.error)throw p.error;const f=await N({mealPlan:p.data,versionNumber:u,changeReason:e?.change_reason||"edicao_manual_plano",createdBy:l,isRollback:!!e?.is_rollback,metadata:{origin:"updateFullMealPlan"}});if(f.error)throw f.error;return await S({module:"meal_plan",operation:"update_full_meal_plan",eventType:"success",latencyMs:Date.now()-a,nutritionistId:l,patientId:p?.data?.patient_id||null,metadata:{plan_id:r,meals_count:Array.isArray(e?.meals)?e.meals.length:0,is_rollback:!!e?.is_rollback}}),p}catch(t){return m("Erro ao atualizar plano alimentar",t),await S({module:"meal_plan",operation:"update_full_meal_plan",eventType:"error",latencyMs:Date.now()-a,nutritionistId:null,patientId:null,errorMessage:t?.message||String(t),metadata:{plan_id:r}}),{data:null,error:t}}},te=async(r,e)=>{try{const{weight_kg:a,weight_type:t,total_energy_kcal:n,macro_mode:o,protein_percentage:i,carbs_percentage:l,fat_percentage:u,protein_g_per_kg:s,carbs_g_per_kg:d,fat_g_per_kg:p}=e,{data:f}=await c.from("meal_plan_reference_values").select("id").eq("meal_plan_id",r).maybeSingle();if(f){const{data:_,error:w}=await c.from("meal_plan_reference_values").update({weight_kg:a,weight_type:t||"current",total_energy_kcal:n,macro_mode:o||"percentage",protein_percentage:o==="percentage"?i:null,carbs_percentage:o==="percentage"?l:null,fat_percentage:o==="percentage"?u:null,protein_g_per_kg:o==="g_per_kg"?s:null,carbs_g_per_kg:o==="g_per_kg"?d:null,fat_g_per_kg:o==="g_per_kg"?p:null,updated_at:new Date().toISOString()}).eq("id",f.id).select().single();if(w)throw w;return{data:_,error:null}}else{const{data:_,error:w}=await c.from("meal_plan_reference_values").insert([{meal_plan_id:r,weight_kg:a,weight_type:t||"current",total_energy_kcal:n,macro_mode:o||"percentage",protein_percentage:o==="percentage"?i:null,carbs_percentage:o==="percentage"?l:null,fat_percentage:o==="percentage"?u:null,protein_g_per_kg:o==="g_per_kg"?s:null,carbs_g_per_kg:o==="g_per_kg"?d:null,fat_g_per_kg:o==="g_per_kg"?p:null}]).select().single();if(w)throw w;return{data:_,error:null}}}catch(a){return m("Erro ao salvar valores de referência",a),{data:null,error:a}}},oe=async r=>{try{const{data:e,error:a}=await c.from("meal_plan_reference_values").select("*").eq("meal_plan_id",r).maybeSingle();if(a)throw a;return{data:e,error:null}}catch(e){return m("Erro ao buscar valores de referência",e),{data:null,error:e}}},ne=async r=>{try{const{data:e,error:a}=await c.from("meal_plan_reference_values").delete().eq("meal_plan_id",r).select().single();if(a)throw a;return{data:e,error:null}}catch(e){return m("Erro ao deletar valores de referência",e),{data:null,error:e}}},ie=async(r,e,a=[])=>{try{const{data:t,error:n}=await E(r);if(n)throw n;const{data:o,error:i}=await c.from("meal_plans").insert([{patient_id:null,nutritionist_id:t.nutritionist_id,name:e,description:t.description||null,active_days:t.active_days,start_date:null,end_date:null,is_active:!1,is_template:!0,template_tags:a.length>0?a:null}]).select().single();if(i)throw i;for(const l of t.meals||[]){const{data:u,error:s}=await F({meal_plan_id:o.id,name:l.name,meal_type:l.meal_type,meal_time:l.meal_time,notes:l.notes,order_index:l.order_index});if(s)throw s;for(const d of l.foods||[])await x({meal_plan_meal_id:u.id,food_id:d.food_id,quantity:d.quantity,unit:d.unit,calories:d.calories,protein:d.protein,carbs:d.carbs,fat:d.fat,notes:d.notes,order_index:d.order_index})}return E(o.id)}catch(t){return m("Erro ao salvar plano como template",t),{data:null,error:t}}},le=async r=>{try{const{data:e,error:a}=await c.from("meal_plans").select("*").eq("nutritionist_id",r).eq("is_template",!0).order("created_at",{ascending:!1});if(a)throw a;return{data:e||[],error:null}}catch(e){return m("Erro ao buscar templates",e),{data:[],error:e}}},se=async(r,e,a=null,t=1,n=null)=>{try{const{data:o,error:i}=await E(r);if(i)throw i;if(!o.is_template)throw new Error("O plano selecionado não é um template");const{error:l}=await c.from("meal_plans").update({is_active:!1}).eq("patient_id",e).eq("is_active",!0);l&&console.warn("Erro ao desativar planos anteriores:",l);const u=a||M(),{data:s,error:d}=await c.from("meal_plans").insert([{patient_id:e,nutritionist_id:o.nutritionist_id,name:o.name,description:o.description||null,active_days:o.active_days,start_date:u,end_date:null,is_active:!0,is_template:!1}]).select().single();if(d)throw d;const p=n&&n.length>0?(o.meals||[]).filter(f=>n.includes(f.id)):o.meals||[];if(p.length===0)throw new Error("Nenhuma refeição selecionada para importar");for(const f of p){const{data:_,error:w}=await F({meal_plan_id:s.id,name:f.name,meal_type:f.meal_type,meal_time:f.meal_time,notes:f.notes,order_index:f.order_index});if(w)throw w;for(const g of f.foods||[]){const h=Math.round((parseFloat(g.quantity)||0)*t*100)/100,b=Math.round((parseFloat(g.calories)||0)*t*100)/100,q=Math.round((parseFloat(g.protein)||0)*t*100)/100,P=Math.round((parseFloat(g.carbs)||0)*t*100)/100,A=Math.round((parseFloat(g.fat)||0)*t*100)/100;await x({meal_plan_meal_id:_.id,food_id:g.food_id,quantity:h,unit:g.unit,calories:b,protein:q,carbs:P,fat:A,notes:g.notes,order_index:g.order_index})}}return E(s.id)}catch(o){return m("Erro ao aplicar template ao paciente",o),{data:null,error:o}}},de=async r=>{try{const{data:e,error:a}=await c.from("meal_plan_versions").select("*").eq("id",r).single();if(a)throw a;const t=e?.snapshot,n=t?.plan,o=Array.isArray(t?.meals)?t.meals:[];if(!e?.meal_plan_id||!n)throw new Error("Versão inválida para restauração");const i={name:n.name,description:n.description||"",active_days:n.active_days||[],start_date:n.start_date||M(),end_date:n.end_date||null,meals:o.map((l,u)=>({name:l.name,meal_type:l.meal_type,meal_time:l.meal_time||null,notes:l.notes||null,order_index:l.order_index??u,foods:(l.foods||[]).map((s,d)=>({food_id:s.food_id,quantity:s.quantity??0,unit:s.unit||null,calories:s.calories??0,protein:s.protein??0,carbs:s.carbs??0,fat:s.fat??0,notes:s.notes||null,order_index:s.order_index??d}))})),change_reason:`rollback_versao_${e.version_number}`,is_rollback:!0};return W(e.meal_plan_id,i)}catch(e){return m("Erro ao restaurar versão do plano alimentar",e),{data:null,error:e}}};export{x as addFoodToMeal,F as addMealToPlan,se as applyTemplateToPatient,X as archiveMealPlan,ee as calculateNutrition,ae as copyMealPlanToPatient,z as createMealPlan,N as createMealPlanVersionSnapshot,Z as deleteMealPlan,ne as deleteReferenceValues,K as getActiveMealPlan,E as getMealPlanById,re as getMealPlanVersions,J as getMealPlans,oe as getReferenceValues,le as getTemplates,O as recalculateMealNutrition,j as recalculatePlanNutrition,de as restoreMealPlanVersion,ie as savePlanAsTemplate,te as saveReferenceValues,Y as setActiveMealPlan,H as simulateMealPlanPortionAdjustment,W as updateFullMealPlan,I as updateMealPlan};
