import{s as c,F as y,at as D,au as S}from"./index-qjbGaV1R.js";import{l as f}from"./query-helpers-CC2p4I3d.js";import{s as h}from"./calendar-BroojJTJ.js";import{e as M}from"./endOfMonth-Dlk4l2Ma.js";import{p as F}from"./parseISO-CVV90SIz.js";async function P(n,e){if(!e)throw new Error("nutritionistId is required for getFinancialSummary");const t=h(n),a=M(n),{data:r,error:i}=await c.from("financial_transactions").select("type, amount, status").eq("nutritionist_id",e).gte("transaction_date",y(t,"yyyy-MM-dd")).lte("transaction_date",y(a,"yyyy-MM-dd"));if(i)throw f("Error fetching financial summary",i),i;const u=(r||[]).filter(s=>s.type==="income").reduce((s,l)=>s+parseFloat(l.amount||0),0),d=u,o=(r||[]).filter(s=>s.type==="expense").reduce((s,l)=>s+parseFloat(l.amount||0),0),p=(r||[]).filter(s=>s.status==="overdue").reduce((s,l)=>s+parseFloat(l.amount||0),0);return{income:u,netIncome:d,expenses:o,netResult:d-o,overdue:p}}async function j(n,e={},t={},a={}){let r=c.from("financial_transactions").select(`
            *,
            patient:user_profiles!financial_transactions_patient_id_fkey(
                id,
                name
            )
        `,{count:"exact"}).eq("nutritionist_id",n);if(e.type&&(r=r.eq("type",e.type)),e.status&&(r=r.eq("status",e.status)),e.search&&(r=r.ilike("description",`%${e.search}%`)),e.month&&e.year){const s=h(new Date(e.year,e.month-1,1)),l=M(new Date(e.year,e.month-1,1));r=r.gte("transaction_date",y(s,"yyyy-MM-dd")).lte("transaction_date",y(l,"yyyy-MM-dd"))}const i=a.field||"transaction_date",u=a.order||"desc";if(r=r.order(i,{ascending:u==="asc"}),t.page&&t.pageSize){const s=(t.page-1)*t.pageSize,l=s+t.pageSize-1;r=r.range(s,l)}const{data:d,error:o,count:p}=await r;if(o)throw f("Error fetching transactions",o),o;return{data:d||[],total:p||0}}async function C(n){const{id:e,...t}=n;t.status||(t.status=t.isPaid?"paid":"pending"),t.status==="pending"&&!t.due_date&&(t.due_date=t.transaction_date),delete t.isPaid;let a;e?a=c.from("financial_transactions").update(t).eq("id",e).select().single():a=c.from("financial_transactions").insert(t).select().single();const{data:r,error:i}=await a;if(i)throw f("Error saving transaction",i),i;return r}async function z(n){const{error:e}=await c.from("financial_transactions").delete().eq("id",n);if(e)throw f("Error deleting transaction",e),e}async function B(n,e,t="day"){const a=h(e),r=M(e),{data:i,error:u}=await c.from("financial_transactions").select("transaction_date, type, amount").eq("nutritionist_id",n).gte("transaction_date",y(a,"yyyy-MM-dd")).lte("transaction_date",y(r,"yyyy-MM-dd")).order("transaction_date",{ascending:!0});if(u)throw f("Error fetching cash flow data",u),u;const d={};return i.forEach(o=>{const p=new Date(o.transaction_date);let s;if(t==="week"){const l=new Date(p);l.setDate(p.getDate()-p.getDay()),s=y(l,"yyyy-MM-dd")}else s=y(p,"yyyy-MM-dd");d[s]||(d[s]={date:s,income:0,expenses:0}),o.type==="income"?d[s].income+=parseFloat(o.amount||0):d[s].expenses+=parseFloat(o.amount||0)}),Object.values(d).sort((o,p)=>o.date.localeCompare(p.date))}async function A(n,e){const t=h(e),a=M(e),{data:r,error:i}=await c.from("financial_transactions").select("category, amount").eq("nutritionist_id",n).eq("type","expense").gte("transaction_date",y(t,"yyyy-MM-dd")).lte("transaction_date",y(a,"yyyy-MM-dd"));if(i)throw f("Error fetching expense distribution",i),i;const u={};return r.forEach(d=>{const o=d.category||"outros";u[o]||(u[o]=0),u[o]+=parseFloat(d.amount||0)}),Object.entries(u).map(([d,o])=>({name:d.charAt(0).toUpperCase()+d.slice(1).replace("_"," "),value:o}))}async function K(n,e){const t=D(e),a=S(t,30),{data:r,error:i}=await c.from("financial_transactions").select("type, amount").eq("nutritionist_id",n).eq("status","paid");if(i)throw f("Error fetching paid transactions for balance",i),i;let u=0;(r||[]).forEach(m=>{const w=parseFloat(m.amount||0);m.type==="income"?u+=w:u-=w});const{data:d,error:o}=await c.from("financial_transactions").select("type, amount, due_date, transaction_date").eq("nutritionist_id",n).eq("status","pending").gte("due_date",y(t,"yyyy-MM-dd")).lte("due_date",y(a,"yyyy-MM-dd")),{data:p,error:s}=await c.from("financial_transactions").select("type, amount, due_date, transaction_date").eq("nutritionist_id",n).eq("status","pending").is("due_date",null).gte("transaction_date",y(t,"yyyy-MM-dd")).lte("transaction_date",y(a,"yyyy-MM-dd"));if(o||s)throw f("Error fetching pending transactions",o||s),o||s;const l=[...d||[],...p||[]],g={};l.forEach(m=>{const w=m.due_date||m.transaction_date;if(!w)return;const _=y(F(w),"yyyy-MM-dd");g[_]||(g[_]={income:0,expenses:0});const E=parseFloat(m.amount||0);m.type==="income"?g[_].income+=E:g[_].expenses+=E});const q=[];let v=u;for(let m=0;m<=30;m++){const w=S(t,m),_=y(w,"yyyy-MM-dd");g[_]&&(v+=g[_].income,v-=g[_].expenses),q.push({date:_,balance:Math.round(v*100)/100})}return q}async function W(n){const{data:e,error:t}=await c.from("user_profiles").select("id, name").eq("nutritionist_id",n).order("name",{ascending:!0});if(t)throw f("Error fetching patients",t),t;return e||[]}async function I(n){const{data:e,error:t}=await c.from("services").select("*").eq("nutritionist_id",n).order("name",{ascending:!0});if(t)throw f("Error fetching services",t),t;return(e||[]).filter(r=>r.is_active!==!1&&r.active!==!1)}async function R(n){const{id:e,...t}=n;t.updated_at=new Date().toISOString();let a;e?a=c.from("services").update(t).eq("id",e).select().single():a=c.from("services").insert(t).select().single();const{data:r,error:i}=await a;if(i)throw f("Error saving service",i),i;return r}async function U(n){let e={updated_at:new Date().toISOString()};e.is_active=!1;const{error:t}=await c.from("services").update(e).eq("id",n);if(t)if(t.message&&t.message.includes("is_active")){delete e.is_active,e.active=!1;const{error:a}=await c.from("services").update(e).eq("id",n);if(a)throw f("Error deleting service",a),a}else throw f("Error deleting service",t),t}async function $(n){const{data:e,error:t}=await c.from("financial_transactions").insert(n).select();if(t)throw f("Error saving multiple transactions",t),t;return e||[]}async function G(n){const e=y(new Date,"yyyy-MM-dd"),{data:t,error:a}=await c.from("financial_transactions").select(`
            *,
            patient:user_profiles!financial_transactions_patient_id_fkey(
                id,
                name
            )
        `).eq("nutritionist_id",n).eq("type","income").eq("status","pending").lte("transaction_date",e).order("transaction_date",{ascending:!0});if(a)throw f("Error fetching pending payments",a),a;return t||[]}async function H(n,e){const{data:t,error:a}=await c.from("financial_transactions").update({status:e}).eq("id",n).select().single();if(a)throw f("Error updating transaction status",a),a;return t}async function J(n,e){const{data:t,error:a}=await c.from("financial_transactions").update({transaction_date:e,due_date:e}).eq("id",n).select().single();if(a)throw f("Error rescheduling transaction",a),a;return t}export{G as a,z as b,P as c,U as d,j as e,B as f,I as g,A as h,K as i,W as j,$ as k,C as l,J as r,R as s,H as u};
