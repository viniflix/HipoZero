import{aO as w,s as c,O as y,aN as D,ad as v}from"./index-D4vQBr8M.js";import{s as h}from"./startOfMonth-CC2MBgMy.js";import{p as S}from"./parseISO-xF-pTD1Y.js";async function b(a,t){if(!t)throw new Error("nutritionistId is required for getFinancialSummary");const e=h(a),n=w(a),{data:o,error:s}=await c.from("financial_transactions").select("type, amount, status").eq("nutritionist_id",t).gte("transaction_date",y(e,"yyyy-MM-dd")).lte("transaction_date",y(n,"yyyy-MM-dd"));if(s)throw console.error("Error fetching financial summary:",s),s;const u=(o||[]).filter(r=>r.type==="income").reduce((r,l)=>r+parseFloat(l.amount||0),0),d=u,i=(o||[]).filter(r=>r.type==="expense").reduce((r,l)=>r+parseFloat(l.amount||0),0),f=(o||[]).filter(r=>r.status==="overdue").reduce((r,l)=>r+parseFloat(l.amount||0),0);return{income:u,netIncome:d,expenses:i,netResult:d-i,overdue:f}}async function T(a,t={},e={},n={}){let o=c.from("financial_transactions").select(`
            *,
            patient:user_profiles!financial_transactions_patient_id_fkey(
                id,
                name
            )
        `,{count:"exact"}).eq("nutritionist_id",a);if(t.type&&(o=o.eq("type",t.type)),t.status&&(o=o.eq("status",t.status)),t.search&&(o=o.ilike("description",`%${t.search}%`)),t.month&&t.year){const r=h(new Date(t.year,t.month-1,1)),l=w(new Date(t.year,t.month-1,1));o=o.gte("transaction_date",y(r,"yyyy-MM-dd")).lte("transaction_date",y(l,"yyyy-MM-dd"))}const s=n.field||"transaction_date",u=n.order||"desc";if(o=o.order(s,{ascending:u==="asc"}),e.page&&e.pageSize){const r=(e.page-1)*e.pageSize,l=r+e.pageSize-1;o=o.range(r,l)}const{data:d,error:i,count:f}=await o;if(i)throw console.error("Error fetching transactions:",i),i;return{data:d||[],total:f||0}}async function k(a){const{id:t,...e}=a;e.status||(e.status=e.isPaid?"paid":"pending"),e.status==="pending"&&!e.due_date&&(e.due_date=e.transaction_date),delete e.isPaid;let n;t?n=c.from("financial_transactions").update(e).eq("id",t).select().single():n=c.from("financial_transactions").insert(e).select().single();const{data:o,error:s}=await n;if(s)throw console.error("Error saving transaction:",s),s;return o}async function P(a){const{error:t}=await c.from("financial_transactions").delete().eq("id",a);if(t)throw console.error("Error deleting transaction:",t),t}async function j(a,t,e="day"){const n=h(t),o=w(t),{data:s,error:u}=await c.from("financial_transactions").select("transaction_date, type, amount").eq("nutritionist_id",a).gte("transaction_date",y(n,"yyyy-MM-dd")).lte("transaction_date",y(o,"yyyy-MM-dd")).order("transaction_date",{ascending:!0});if(u)throw console.error("Error fetching cash flow data:",u),u;const d={};return s.forEach(i=>{const f=new Date(i.transaction_date);let r;if(e==="week"){const l=new Date(f);l.setDate(f.getDate()-f.getDay()),r=y(l,"yyyy-MM-dd")}else r=y(f,"yyyy-MM-dd");d[r]||(d[r]={date:r,income:0,expenses:0}),i.type==="income"?d[r].income+=parseFloat(i.amount||0):d[r].expenses+=parseFloat(i.amount||0)}),Object.values(d).sort((i,f)=>i.date.localeCompare(f.date))}async function C(a,t){const e=h(t),n=w(t),{data:o,error:s}=await c.from("financial_transactions").select("category, amount").eq("nutritionist_id",a).eq("type","expense").gte("transaction_date",y(e,"yyyy-MM-dd")).lte("transaction_date",y(n,"yyyy-MM-dd"));if(s)throw console.error("Error fetching expense distribution:",s),s;const u={};return o.forEach(d=>{const i=d.category||"outros";u[i]||(u[i]=0),u[i]+=parseFloat(d.amount||0)}),Object.entries(u).map(([d,i])=>({name:d.charAt(0).toUpperCase()+d.slice(1).replace("_"," "),value:i}))}async function z(a,t){const e=D(t),n=v(e,30),{data:o,error:s}=await c.from("financial_transactions").select("type, amount").eq("nutritionist_id",a).eq("status","paid");if(s)throw console.error("Error fetching paid transactions for balance:",s),s;let u=0;(o||[]).forEach(p=>{const g=parseFloat(p.amount||0);p.type==="income"?u+=g:u-=g});const{data:d,error:i}=await c.from("financial_transactions").select("type, amount, due_date, transaction_date").eq("nutritionist_id",a).eq("status","pending").gte("due_date",y(e,"yyyy-MM-dd")).lte("due_date",y(n,"yyyy-MM-dd")),{data:f,error:r}=await c.from("financial_transactions").select("type, amount, due_date, transaction_date").eq("nutritionist_id",a).eq("status","pending").is("due_date",null).gte("transaction_date",y(e,"yyyy-MM-dd")).lte("transaction_date",y(n,"yyyy-MM-dd"));if(i||r)throw console.error("Error fetching pending transactions:",i||r),i||r;const l=[...d||[],...f||[]],_={};l.forEach(p=>{const g=p.due_date||p.transaction_date;if(!g)return;const m=y(S(g),"yyyy-MM-dd");_[m]||(_[m]={income:0,expenses:0});const E=parseFloat(p.amount||0);p.type==="income"?_[m].income+=E:_[m].expenses+=E});const q=[];let M=u;for(let p=0;p<=30;p++){const g=v(e,p),m=y(g,"yyyy-MM-dd");_[m]&&(M+=_[m].income,M-=_[m].expenses),q.push({date:m,balance:Math.round(M*100)/100})}return q}async function B(a){const{data:t,error:e}=await c.from("user_profiles").select("id, name").eq("nutritionist_id",a).order("name",{ascending:!0});if(e)throw console.error("Error fetching patients:",e),e;return t||[]}async function A(a){const{data:t,error:e}=await c.from("services").select("*").eq("nutritionist_id",a).eq("is_active",!0).order("name",{ascending:!0});if(e)throw console.error("Error fetching services:",e),e;return t||[]}async function I(a){const{id:t,...e}=a;e.updated_at=new Date().toISOString();let n;t?n=c.from("services").update(e).eq("id",t).select().single():n=c.from("services").insert(e).select().single();const{data:o,error:s}=await n;if(s)throw console.error("Error saving service:",s),s;return o}async function K(a){const{error:t}=await c.from("services").update({is_active:!1,updated_at:new Date().toISOString()}).eq("id",a);if(t)throw console.error("Error deleting service:",t),t}async function W(a){const{data:t,error:e}=await c.from("financial_transactions").insert(a).select();if(e)throw console.error("Error saving multiple transactions:",e),e;return t||[]}async function N(a){const t=y(new Date,"yyyy-MM-dd"),{data:e,error:n}=await c.from("financial_transactions").select(`
            *,
            patient:user_profiles!financial_transactions_patient_id_fkey(
                id,
                name
            )
        `).eq("nutritionist_id",a).eq("type","income").eq("status","pending").lte("transaction_date",t).order("transaction_date",{ascending:!0});if(n)throw console.error("Error fetching pending payments:",n),n;return e||[]}async function R(a,t){const{data:e,error:n}=await c.from("financial_transactions").update({status:t}).eq("id",a).select().single();if(n)throw console.error("Error updating transaction status:",n),n;return e}async function U(a,t){const{data:e,error:n}=await c.from("financial_transactions").update({transaction_date:t,due_date:t}).eq("id",a).select().single();if(n)throw console.error("Error rescheduling transaction:",n),n;return e}export{N as a,P as b,b as c,K as d,T as e,j as f,A as g,C as h,z as i,B as j,W as k,k as l,U as r,I as s,R as u};
