import{s}from"./index-qjbGaV1R.js";import{calculateCaloriesFromMacros as S}from"./nutrition-calculations-DjYFS08l.js";import{g as h}from"./date-C2sroe8F.js";import{l as m}from"./query-helpers-CC2p4I3d.js";const k=`
    id,
    name,
    source,
    description,
    portion_size,
    calories,
    protein,
    carbs,
    fat,
    fiber,
    sodium,
    saturated_fat,
    trans_fat,
    cholesterol,
    sugar,
    calcium,
    iron,
    magnesium,
    phosphorus,
    potassium,
    zinc,
    vitamin_a,
    vitamin_c,
    vitamin_d,
    vitamin_e,
    vitamin_b12,
    folate
`,E=async t=>{const e=[...new Set((t||[]).filter(Boolean).map(String))];if(e.length===0)return{};const{data:a,error:r}=await s.from("foods").select(k).in("id",e);if(r)throw r;return(a||[]).reduce((i,o)=>(i[String(o.id)]=o,i),{})},T=async t=>{try{const{patient_id:e,nutritionist_id:a,name:r,description:i,active_days:o,start_date:n,end_date:l}=t,{error:u}=await s.from("meal_plans").update({is_active:!1}).eq("patient_id",e).eq("is_active",!0);u&&console.warn("Erro ao desativar planos anteriores:",u);const{data:d,error:c}=await s.from("meal_plans").insert([{patient_id:e,nutritionist_id:a,name:r,description:i||null,active_days:o||["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],start_date:n||h(),end_date:l||null,is_active:!0}]).select().single();if(c)throw c;return{data:d,error:null}}catch(e){return m("Erro ao criar plano alimentar",e),{data:null,error:e}}},V=async(t,e=!1)=>{try{let a=s.from("meal_plans").select("*").eq("patient_id",t).order("created_at",{ascending:!1});e&&(a=a.eq("is_active",!0));const{data:r,error:i}=await a;if(i)throw i;return{data:r||[],error:null}}catch(a){return m("Erro ao buscar planos alimentares",a),{data:[],error:a}}},w=async t=>{try{const{data:e,error:a}=await s.from("meal_plans").select("*").eq("id",t).single();if(a)throw a;const{data:r,error:i}=await s.from("meal_plan_meals").select("*").eq("meal_plan_id",t).order("order_index",{ascending:!0});if(i)throw i;const o=await Promise.all((r||[]).map(async n=>{const{data:l,error:u}=await s.from("meal_plan_foods").select("*").eq("meal_plan_meal_id",n.id).order("order_index",{ascending:!0});if(u)return m("Erro ao buscar alimentos da refeição",u),{...n,calories:n.total_calories||0,protein:n.total_protein||0,carbs:n.total_carbs||0,fat:n.total_fat||0,foods:[]};const d=await E((l||[]).map(_=>_.food_id)),c=(l||[]).filter(_=>_.unit&&typeof _.unit=="number").map(_=>_.unit);let p={};if(c.length>0){const{data:_}=await s.from("household_measures").select("id, name, code, grams_equivalent").in("id",c);p=(_||[]).reduce((g,y)=>(g[y.id]=y,g),{})}const f=(l||[]).map(_=>({..._,food:d[String(_.food_id)]||null,foods:d[String(_.food_id)]||null,measure:typeof _.unit=="number"?p[_.unit]:null}));return{...n,calories:n.total_calories||0,protein:n.total_protein||0,carbs:n.total_carbs||0,fat:n.total_fat||0,foods:f}}));return{data:{...e,meals:o},error:null}}catch(e){return m("Erro ao buscar plano alimentar",e),{data:null,error:e}}},W=async t=>{try{const e=h(),{data:a,error:r}=await s.from("meal_plans").select("*").eq("patient_id",t).eq("is_active",!0).lte("start_date",e).or(`end_date.is.null,end_date.gte.${e}`).order("start_date",{ascending:!1}).limit(1).maybeSingle();if(r)throw r;return a?w(a.id):{data:null,error:null}}catch(e){return m("Erro ao buscar plano ativo",e),{data:null,error:e}}},z=async(t,e)=>{try{const{data:a,error:r}=await s.from("meal_plans").update(e).eq("id",t).select().single();if(r)throw r;return{data:a,error:null}}catch(a){return m("Erro ao atualizar plano alimentar",a),{data:null,error:a}}},L=async t=>z(t,{is_active:!1}),Q=async t=>{try{const{data:e,error:a}=await s.from("meal_plans").select("patient_id").eq("id",t).single();if(a)throw a;const{error:r}=await s.from("meal_plans").update({is_active:!1}).eq("patient_id",e.patient_id).eq("is_active",!0);if(r)throw r;const{data:i,error:o}=await s.from("meal_plans").update({is_active:!0}).eq("id",t).select().single();if(o)throw o;return{data:i,error:null}}catch(e){return m("Erro ao ativar plano alimentar",e),{data:null,error:e}}},$=async t=>{try{const{data:e,error:a}=await s.from("meal_plans").delete().eq("id",t).select().single();if(a)throw a;return{data:e,error:null}}catch(e){return m("Erro ao deletar plano alimentar",e),{data:null,error:e}}},v=async t=>{try{const{meal_plan_id:e,name:a,meal_type:r,meal_time:i,notes:o,order_index:n}=t,{data:l,error:u}=await s.from("meal_plan_meals").insert([{meal_plan_id:e,name:a,meal_type:r,meal_time:i||null,notes:o||null,order_index:n||0}]).select().single();if(u)throw u;return{data:l,error:null}}catch(e){return m("Erro ao adicionar refeição ao plano",e),{data:null,error:e}}},b=async t=>{try{const{meal_plan_meal_id:e,food_id:a,quantity:r,unit:i,calories:o,protein:n,carbs:l,fat:u,notes:d,order_index:c}=t,{data:p,error:f}=await s.from("meal_plan_foods").insert([{meal_plan_meal_id:e,food_id:a,quantity:r,unit:i,calories:o,protein:n,carbs:l,fat:u,notes:d||null,order_index:c||0}]).select("*").single();if(f)throw f;const _=await E([p?.food_id]),g={...p,food:_[String(p?.food_id)]||null,foods:_[String(p?.food_id)]||null};return await N(e),{data:g,error:null}}catch(e){return m("Erro ao adicionar alimento à refeição",e),{data:null,error:e}}},N=async t=>{try{const{data:e,error:a}=await s.from("meal_plan_foods").select("calories, protein, carbs, fat").eq("meal_plan_meal_id",t);if(a)throw a;const r=(e||[]).reduce((n,l)=>({total_calories:n.total_calories+(parseFloat(l.calories)||0),total_protein:n.total_protein+(parseFloat(l.protein)||0),total_carbs:n.total_carbs+(parseFloat(l.carbs)||0),total_fat:n.total_fat+(parseFloat(l.fat)||0)}),{total_calories:0,total_protein:0,total_carbs:0,total_fat:0}),{data:i,error:o}=await s.from("meal_plan_meals").update(r).eq("id",t).select("meal_plan_id").single();if(o)throw o;return i&&await O(i.meal_plan_id),{data:r,error:null}}catch(e){return m("Erro ao recalcular nutrição da refeição",e),{data:null,error:e}}},O=async t=>{try{const{data:e,error:a}=await s.from("meal_plan_meals").select("total_calories, total_protein, total_carbs, total_fat").eq("meal_plan_id",t);if(a)throw a;const r=(e||[]).reduce((n,l)=>({daily_calories:n.daily_calories+(parseFloat(l.total_calories)||0),daily_protein:n.daily_protein+(parseFloat(l.total_protein)||0),daily_carbs:n.daily_carbs+(parseFloat(l.total_carbs)||0),daily_fat:n.daily_fat+(parseFloat(l.total_fat)||0)}),{daily_calories:0,daily_protein:0,daily_carbs:0,daily_fat:0}),{data:i,error:o}=await s.from("meal_plans").update(r).eq("id",t).select().single();if(o)throw o;return{data:i,error:null}}catch(e){return m("Erro ao recalcular nutrição do plano",e),{data:null,error:e}}},j=async(t,e,a)=>{try{let r=null;if(a==="gram"||a==="ml")r=e;else{let d=a;if(typeof a=="string"){const{data:c}=await s.from("household_measures").select("id").eq("code",a).maybeSingle();d=c?.id}if(d){const{data:c}=await s.from("food_household_measures").select("quantity, grams").eq("food_id",t.id).eq("measure_id",d).maybeSingle();if(c)r=c.grams*(e/c.quantity);else{const{data:p}=await s.from("household_measures").select("grams_equivalent").eq("id",d).maybeSingle();p&&p.grams_equivalent?r=p.grams_equivalent*e:r=(t.portion_size||100)*e}}else r=(t.portion_size||100)*e}if(!r||r<=0)return{calories:0,protein:0,carbs:0,fat:0};const i=r/100,o=(t.protein||0)*i,n=(t.carbs||0)*i,l=(t.fat||0)*i,u=S(o,n,l);return{calories:parseFloat(u.toFixed(2)),protein:parseFloat(o.toFixed(2)),carbs:parseFloat(n.toFixed(2)),fat:parseFloat(l.toFixed(2))}}catch(r){return m("Erro ao calcular nutrição",r),{calories:0,protein:0,carbs:0,fat:0}}},D=async(t,e)=>{try{const{data:a,error:r}=await w(t);if(r)throw r;const{data:i,error:o}=await T({patient_id:e,nutritionist_id:a.nutritionist_id,name:a.name,description:a.description,active_days:a.active_days,start_date:h()});if(o)throw o;for(const n of a.meals||[]){const{data:l,error:u}=await v({meal_plan_id:i.id,name:n.name,meal_type:n.meal_type,meal_time:n.meal_time,notes:n.notes,order_index:n.order_index});if(u)throw u;for(const d of n.foods||[])await b({meal_plan_meal_id:l.id,food_id:d.food_id,quantity:d.quantity,unit:d.unit,calories:d.calories,protein:d.protein,carbs:d.carbs,fat:d.fat,notes:d.notes,order_index:d.order_index})}return w(i.id)}catch(a){return m("Erro ao copiar plano para paciente",a),{data:null,error:a}}},G=async(t,e)=>{try{const{error:a}=await s.from("meal_plans").update({name:e.name,description:e.description,active_days:e.active_days,start_date:e.start_date,end_date:e.end_date||null}).eq("id",t);if(a)throw a;const{error:r}=await s.from("meal_plan_meals").delete().eq("meal_plan_id",t);if(r)throw r;for(const i of e.meals||[]){const{data:o,error:n}=await v({meal_plan_id:t,name:i.name,meal_type:i.meal_type,meal_time:i.meal_time,notes:i.notes,order_index:i.order_index});if(n)throw n;for(const l of i.foods||[])await b({meal_plan_meal_id:o.id,food_id:l.food_id,quantity:l.quantity,unit:l.unit,calories:l.calories,protein:l.protein,carbs:l.carbs,fat:l.fat,notes:l.notes,order_index:l.order_index||0})}return w(t)}catch(a){return m("Erro ao atualizar plano alimentar",a),{data:null,error:a}}},H=async(t,e)=>{try{const{weight_kg:a,weight_type:r,total_energy_kcal:i,macro_mode:o,protein_percentage:n,carbs_percentage:l,fat_percentage:u,protein_g_per_kg:d,carbs_g_per_kg:c,fat_g_per_kg:p}=e,{data:f}=await s.from("meal_plan_reference_values").select("id").eq("meal_plan_id",t).maybeSingle();if(f){const{data:_,error:g}=await s.from("meal_plan_reference_values").update({weight_kg:a,weight_type:r||"current",total_energy_kcal:i,macro_mode:o||"percentage",protein_percentage:o==="percentage"?n:null,carbs_percentage:o==="percentage"?l:null,fat_percentage:o==="percentage"?u:null,protein_g_per_kg:o==="g_per_kg"?d:null,carbs_g_per_kg:o==="g_per_kg"?c:null,fat_g_per_kg:o==="g_per_kg"?p:null,updated_at:new Date().toISOString()}).eq("id",f.id).select().single();if(g)throw g;return{data:_,error:null}}else{const{data:_,error:g}=await s.from("meal_plan_reference_values").insert([{meal_plan_id:t,weight_kg:a,weight_type:r||"current",total_energy_kcal:i,macro_mode:o||"percentage",protein_percentage:o==="percentage"?n:null,carbs_percentage:o==="percentage"?l:null,fat_percentage:o==="percentage"?u:null,protein_g_per_kg:o==="g_per_kg"?d:null,carbs_g_per_kg:o==="g_per_kg"?c:null,fat_g_per_kg:o==="g_per_kg"?p:null}]).select().single();if(g)throw g;return{data:_,error:null}}}catch(a){return m("Erro ao salvar valores de referência",a),{data:null,error:a}}},J=async t=>{try{const{data:e,error:a}=await s.from("meal_plan_reference_values").select("*").eq("meal_plan_id",t).maybeSingle();if(a)throw a;return{data:e,error:null}}catch(e){return m("Erro ao buscar valores de referência",e),{data:null,error:e}}},K=async t=>{try{const{data:e,error:a}=await s.from("meal_plan_reference_values").delete().eq("meal_plan_id",t).select().single();if(a)throw a;return{data:e,error:null}}catch(e){return m("Erro ao deletar valores de referência",e),{data:null,error:e}}},U=async(t,e,a=[])=>{try{const{data:r,error:i}=await w(t);if(i)throw i;const{data:o,error:n}=await s.from("meal_plans").insert([{patient_id:null,nutritionist_id:r.nutritionist_id,name:e,description:r.description||null,active_days:r.active_days,start_date:null,end_date:null,is_active:!1,is_template:!0,template_tags:a.length>0?a:null}]).select().single();if(n)throw n;for(const l of r.meals||[]){const{data:u,error:d}=await v({meal_plan_id:o.id,name:l.name,meal_type:l.meal_type,meal_time:l.meal_time,notes:l.notes,order_index:l.order_index});if(d)throw d;for(const c of l.foods||[])await b({meal_plan_meal_id:u.id,food_id:c.food_id,quantity:c.quantity,unit:c.unit,calories:c.calories,protein:c.protein,carbs:c.carbs,fat:c.fat,notes:c.notes,order_index:c.order_index})}return w(o.id)}catch(r){return m("Erro ao salvar plano como template",r),{data:null,error:r}}},X=async t=>{try{const{data:e,error:a}=await s.from("meal_plans").select("*").eq("nutritionist_id",t).eq("is_template",!0).order("created_at",{ascending:!1});if(a)throw a;return{data:e||[],error:null}}catch(e){return m("Erro ao buscar templates",e),{data:[],error:e}}},Y=async(t,e,a=null,r=1,i=null)=>{try{const{data:o,error:n}=await w(t);if(n)throw n;if(!o.is_template)throw new Error("O plano selecionado não é um template");const{error:l}=await s.from("meal_plans").update({is_active:!1}).eq("patient_id",e).eq("is_active",!0);l&&console.warn("Erro ao desativar planos anteriores:",l);const u=a||h(),{data:d,error:c}=await s.from("meal_plans").insert([{patient_id:e,nutritionist_id:o.nutritionist_id,name:o.name,description:o.description||null,active_days:o.active_days,start_date:u,end_date:null,is_active:!0,is_template:!1}]).select().single();if(c)throw c;const p=i&&i.length>0?(o.meals||[]).filter(f=>i.includes(f.id)):o.meals||[];if(p.length===0)throw new Error("Nenhuma refeição selecionada para importar");for(const f of p){const{data:_,error:g}=await v({meal_plan_id:d.id,name:f.name,meal_type:f.meal_type,meal_time:f.meal_time,notes:f.notes,order_index:f.order_index});if(g)throw g;for(const y of f.foods||[]){const q=Math.round((parseFloat(y.quantity)||0)*r*100)/100,x=Math.round((parseFloat(y.calories)||0)*r*100)/100,F=Math.round((parseFloat(y.protein)||0)*r*100)/100,M=Math.round((parseFloat(y.carbs)||0)*r*100)/100,P=Math.round((parseFloat(y.fat)||0)*r*100)/100;await b({meal_plan_meal_id:_.id,food_id:y.food_id,quantity:q,unit:y.unit,calories:x,protein:F,carbs:M,fat:P,notes:y.notes,order_index:y.order_index})}}return w(d.id)}catch(o){return m("Erro ao aplicar template ao paciente",o),{data:null,error:o}}};export{b as addFoodToMeal,v as addMealToPlan,Y as applyTemplateToPatient,L as archiveMealPlan,j as calculateNutrition,D as copyMealPlanToPatient,T as createMealPlan,$ as deleteMealPlan,K as deleteReferenceValues,W as getActiveMealPlan,w as getMealPlanById,V as getMealPlans,J as getReferenceValues,X as getTemplates,N as recalculateMealNutrition,O as recalculatePlanNutrition,U as savePlanAsTemplate,H as saveReferenceValues,Q as setActiveMealPlan,G as updateFullMealPlan,z as updateMealPlan};
