import{s}from"./index-qjbGaV1R.js";import{l as u}from"./query-helpers-CC2p4I3d.js";const h=a=>{const r=String(a?.message||"").toLowerCase();return r.includes("column")&&(r.includes("supersedes_record_id")||r.includes("revision_group_id")||r.includes("revision_number")||r.includes("is_latest_revision")||r.includes("change_reason")||r.includes("created_by_user_id"))},M=async(a,r={})=>{const{limit:t=50,offset:e=0,orderBy:i="record_date",ascending:o=!1,latestOnly:l=!1}=r;try{const n=()=>s.from("growth_records").select("*").eq("patient_id",a).order(i,{ascending:o}).range(e,e+t-1);if(l){const{data:g,error:c}=await n().eq("is_latest_revision",!0);if(!c)return{data:g||[],error:null};if(!h(c))throw c}const{data:_,error:d}=await n();if(d)throw d;return{data:_||[],error:null}}catch(n){return u("Erro ao buscar registros antropométricos",n),{data:[],error:n}}},R=async a=>{try{const r=()=>s.from("growth_records").select("id, weight, height, record_date").eq("patient_id",a).order("record_date",{ascending:!0});let t,e;if({data:t,error:e}=await r().eq("is_latest_revision",!0),e&&!h(e)||(e&&h(e)&&({data:t,error:e}=await r()),e))throw e;return{data:(t||[]).map(o=>{const l=o.height&&o.weight?o.weight/Math.pow(o.height/100,2):null;return{...o,bmi:l,calculatedBmi:l}}),error:null}}catch(r){return u("Erro ao buscar dados para gráficos",r),{data:[],error:r}}},B=async a=>{try{const{patient_id:r,weight:t,height:e,record_date:i,notes:o,circumferences:l,skinfolds:n,bone_diameters:_,bioimpedance:d,photos:g,results:c,supersedes_record_id:f,change_reason:p,created_by_user_id:y}=a,w={patient_id:r,weight:t,height:e,record_date:i,notes:o||null,...l&&{circumferences:l},...n&&{skinfolds:n},..._&&{bone_diameters:_},...d&&{bioimpedance:d},...g&&{photos:g},...c&&{results:c},...f&&{supersedes_record_id:f},...p&&{change_reason:p},...y&&{created_by_user_id:y}};let{data:b,error:m}=await s.from("growth_records").insert([w]).select().single();if(m&&h(m)){const{supersedes_record_id:E,change_reason:q,created_by_user_id:v,...S}=w;({data:b,error:m}=await s.from("growth_records").insert([S]).select().single())}if(m)throw m;return{data:b,error:null}}catch(r){return u("Erro ao criar registro antropométrico",r),{data:null,error:r}}},C=async a=>{try{const{data:r,error:t}=await s.from("growth_records").delete().eq("id",a).select().single();if(t)throw t;return{data:r,error:null}}catch(r){return u("Erro ao deletar registro antropométrico",r),{data:null,error:r}}},L=async a=>{try{const r=()=>s.from("growth_records").select("weight, height, notes").eq("patient_id",a).order("record_date",{ascending:!1}).limit(1);let t,e;if({data:t,error:e}=await r().eq("is_latest_revision",!0).maybeSingle(),e&&!h(e)||(e&&h(e)&&({data:t,error:e}=await r().maybeSingle()),e))throw e;return{data:t,error:null}}catch(r){return u("Erro ao buscar último registro",r),{data:null,error:r}}},O=async a=>{try{const{data:r,error:t}=await s.rpc("get_anthropometry_longitudinal_score",{p_patient_id:a});if(t)throw t;return{data:r||null,error:null}}catch(r){return u("Erro ao buscar score longitudinal antropométrico",r),{data:null,error:r}}},P=async a=>{try{const{data:r,error:t}=await s.from("patient_module_sync_flags").select("*").eq("patient_id",a).maybeSingle();if(t)throw t;return{data:r||null,error:null}}catch(r){return u("Erro ao buscar flags de sincronização de módulos",r),{data:null,error:r}}},Q=async(a,r={})=>{const{energy:t=!1,mealPlan:e=!1}=r;try{const{data:i,error:o}=await s.from("patient_module_sync_flags").select("patient_id").eq("patient_id",a).maybeSingle();if(o)throw o;const l={patient_id:a,updated_at:new Date().toISOString(),...t?{needs_energy_recalc:!1}:{},...e?{needs_meal_plan_review:!1}:{}};if(i?.patient_id){const{data:g,error:c}=await s.from("patient_module_sync_flags").update(l).eq("patient_id",a).select().maybeSingle();if(c)throw c;return{data:g,error:null}}const n={patient_id:a,anthropometry_updated_at:null,needs_energy_recalc:!1,needs_meal_plan_review:!1,updated_at:new Date().toISOString()},{data:_,error:d}=await s.from("patient_module_sync_flags").insert(n).select().maybeSingle();if(d)throw d;return{data:_,error:null}}catch(i){return u("Erro ao limpar flags de sincronização de módulos",i),{data:null,error:i}}};export{M as a,R as b,O as c,P as d,B as e,C as f,L as g,Q as h};
