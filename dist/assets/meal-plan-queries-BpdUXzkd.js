import{s}from"./index-D4vQBr8M.js";const F=async t=>{try{const{patient_id:e,nutritionist_id:r,name:a,description:i,active_days:o,start_date:n,end_date:l}=t,{error:u}=await s.from("meal_plans").update({is_active:!1}).eq("patient_id",e).eq("is_active",!0);u&&console.warn("Erro ao desativar planos anteriores:",u);const{data:c,error:d}=await s.from("meal_plans").insert([{patient_id:e,nutritionist_id:r,name:a,description:i||null,active_days:o||["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],start_date:n||new Date().toISOString().split("T")[0],end_date:l||null,is_active:!0}]).select().single();if(d)throw d;return{data:c,error:null}}catch(e){return console.error("Erro ao criar plano alimentar:",e),{data:null,error:e}}},T=async(t,e=!1)=>{try{let r=s.from("meal_plans").select("*").eq("patient_id",t).order("created_at",{ascending:!1});e&&(r=r.eq("is_active",!0));const{data:a,error:i}=await r;if(i)throw i;return{data:a||[],error:null}}catch(r){return console.error("Erro ao buscar planos alimentares:",r),{data:[],error:r}}},y=async t=>{try{const{data:e,error:r}=await s.from("meal_plans").select("*").eq("id",t).single();if(r)throw r;const{data:a,error:i}=await s.from("meal_plan_meals").select("*").eq("meal_plan_id",t).order("order_index",{ascending:!0});if(i)throw i;const o=await Promise.all((a||[]).map(async n=>{const{data:l,error:u}=await s.from("meal_plan_foods").select(`
                        *,
                        foods (
                            id,
                            name,
                            group,
                            description,
                            source,
                            portion_size,
                            calories,
                            protein,
                            carbs,
                            fat,
                            fiber,
                            sodium,
                            saturated_fat,
                            trans_fat,
                            cholesterol,
                            sugar,
                            calcium,
                            iron,
                            magnesium,
                            phosphorus,
                            potassium,
                            zinc,
                            vitamin_a,
                            vitamin_c,
                            vitamin_d,
                            vitamin_e,
                            vitamin_b12,
                            folate
                        )
                    `).eq("meal_plan_meal_id",n.id).order("order_index",{ascending:!0});if(u)return console.error("Erro ao buscar alimentos da refeição:",u),{...n,calories:n.total_calories||0,protein:n.total_protein||0,carbs:n.total_carbs||0,fat:n.total_fat||0,foods:[]};const c=(l||[]).filter(_=>_.unit&&typeof _.unit=="number").map(_=>_.unit);let d={};if(c.length>0){const{data:_}=await s.from("household_measures").select("id, name, code, grams_equivalent").in("id",c);d=(_||[]).reduce((g,m)=>(g[m.id]=m,g),{})}const p=(l||[]).map(_=>({..._,food:_.foods,measure:typeof _.unit=="number"?d[_.unit]:null}));return{...n,calories:n.total_calories||0,protein:n.total_protein||0,carbs:n.total_carbs||0,fat:n.total_fat||0,foods:p}}));return{data:{...e,meals:o},error:null}}catch(e){return console.error("Erro ao buscar plano alimentar:",e),{data:null,error:e}}},z=async t=>{try{const e=new Date().toISOString().split("T")[0],{data:r,error:a}=await s.from("meal_plans").select("*").eq("patient_id",t).eq("is_active",!0).lte("start_date",e).or(`end_date.is.null,end_date.gte.${e}`).order("start_date",{ascending:!1}).limit(1).maybeSingle();if(a)throw a;return r?y(r.id):{data:null,error:null}}catch(e){return console.error("Erro ao buscar plano ativo:",e),{data:null,error:e}}},M=async(t,e)=>{try{const{data:r,error:a}=await s.from("meal_plans").update(e).eq("id",t).select().single();if(a)throw a;return{data:r,error:null}}catch(r){return console.error("Erro ao atualizar plano alimentar:",r),{data:null,error:r}}},O=async t=>M(t,{is_active:!1}),N=async t=>{try{const{data:e,error:r}=await s.from("meal_plans").select("patient_id").eq("id",t).single();if(r)throw r;const{error:a}=await s.from("meal_plans").update({is_active:!1}).eq("patient_id",e.patient_id).eq("is_active",!0);if(a)throw a;const{data:i,error:o}=await s.from("meal_plans").update({is_active:!0}).eq("id",t).select().single();if(o)throw o;return{data:i,error:null}}catch(e){return console.error("Erro ao ativar plano alimentar:",e),{data:null,error:e}}},A=async t=>{try{const{data:e,error:r}=await s.from("meal_plans").delete().eq("id",t).select().single();if(r)throw r;return{data:e,error:null}}catch(e){return console.error("Erro ao deletar plano alimentar:",e),{data:null,error:e}}},w=async t=>{try{const{meal_plan_id:e,name:r,meal_type:a,meal_time:i,notes:o,order_index:n}=t,{data:l,error:u}=await s.from("meal_plan_meals").insert([{meal_plan_id:e,name:r,meal_type:a,meal_time:i||null,notes:o||null,order_index:n||0}]).select().single();if(u)throw u;return{data:l,error:null}}catch(e){return console.error("Erro ao adicionar refeição ao plano:",e),{data:null,error:e}}},h=async t=>{try{const{meal_plan_meal_id:e,food_id:r,quantity:a,unit:i,calories:o,protein:n,carbs:l,fat:u,notes:c,order_index:d}=t,{data:p,error:_}=await s.from("meal_plan_foods").insert([{meal_plan_meal_id:e,food_id:r,quantity:a,unit:i,calories:o,protein:n,carbs:l,fat:u,notes:c||null,order_index:d||0}]).select(`
                *,
                foods (
                    id,
                    name,
                    group,
                    description
                )
            `).single();if(_)throw _;return await P(e),{data:p,error:null}}catch(e){return console.error("Erro ao adicionar alimento à refeição:",e),{data:null,error:e}}},P=async t=>{try{const{data:e,error:r}=await s.from("meal_plan_foods").select("calories, protein, carbs, fat").eq("meal_plan_meal_id",t);if(r)throw r;const a=(e||[]).reduce((n,l)=>({total_calories:n.total_calories+(parseFloat(l.calories)||0),total_protein:n.total_protein+(parseFloat(l.protein)||0),total_carbs:n.total_carbs+(parseFloat(l.carbs)||0),total_fat:n.total_fat+(parseFloat(l.fat)||0)}),{total_calories:0,total_protein:0,total_carbs:0,total_fat:0}),{data:i,error:o}=await s.from("meal_plan_meals").update(a).eq("id",t).select("meal_plan_id").single();if(o)throw o;return i&&await k(i.meal_plan_id),{data:a,error:null}}catch(e){return console.error("Erro ao recalcular nutrição da refeição:",e),{data:null,error:e}}},k=async t=>{try{const{data:e,error:r}=await s.from("meal_plan_meals").select("total_calories, total_protein, total_carbs, total_fat").eq("meal_plan_id",t);if(r)throw r;const a=(e||[]).reduce((n,l)=>({daily_calories:n.daily_calories+(parseFloat(l.total_calories)||0),daily_protein:n.daily_protein+(parseFloat(l.total_protein)||0),daily_carbs:n.daily_carbs+(parseFloat(l.total_carbs)||0),daily_fat:n.daily_fat+(parseFloat(l.total_fat)||0)}),{daily_calories:0,daily_protein:0,daily_carbs:0,daily_fat:0}),{data:i,error:o}=await s.from("meal_plans").update(a).eq("id",t).select().single();if(o)throw o;return{data:i,error:null}}catch(e){return console.error("Erro ao recalcular nutrição do plano:",e),{data:null,error:e}}},R=async(t,e,r)=>{try{let a=null;if(r==="gram"||r==="ml")a=e;else{let c=r;if(typeof r=="string"){const{data:d}=await s.from("household_measures").select("id").eq("code",r).maybeSingle();c=d?.id}if(c){const{data:d}=await s.from("food_household_measures").select("quantity, grams").eq("food_id",t.id).eq("measure_id",c).maybeSingle();if(d)a=d.grams*(e/d.quantity);else{const{data:p}=await s.from("household_measures").select("grams_equivalent").eq("id",c).maybeSingle();p&&p.grams_equivalent?a=p.grams_equivalent*e:a=(t.portion_size||100)*e}}else a=(t.portion_size||100)*e}if(!a||a<=0)return{calories:0,protein:0,carbs:0,fat:0};const i=a/100,o=(t.protein||0)*i,n=(t.carbs||0)*i,l=(t.fat||0)*i,u=o*4+n*4+l*9;return{calories:parseFloat(u.toFixed(2)),protein:parseFloat(o.toFixed(2)),carbs:parseFloat(n.toFixed(2)),fat:parseFloat(l.toFixed(2))}}catch(a){return console.error("Erro ao calcular nutrição:",a),{calories:0,protein:0,carbs:0,fat:0}}},V=async(t,e)=>{try{const{data:r,error:a}=await y(t);if(a)throw a;const{data:i,error:o}=await F({patient_id:e,nutritionist_id:r.nutritionist_id,name:r.name,description:r.description,active_days:r.active_days,start_date:new Date().toISOString().split("T")[0]});if(o)throw o;for(const n of r.meals||[]){const{data:l,error:u}=await w({meal_plan_id:i.id,name:n.name,meal_type:n.meal_type,meal_time:n.meal_time,notes:n.notes,order_index:n.order_index});if(u)throw u;for(const c of n.foods||[])await h({meal_plan_meal_id:l.id,food_id:c.food_id,quantity:c.quantity,unit:c.unit,calories:c.calories,protein:c.protein,carbs:c.carbs,fat:c.fat,notes:c.notes,order_index:c.order_index})}return y(i.id)}catch(r){return console.error("Erro ao copiar plano para paciente:",r),{data:null,error:r}}},C=async(t,e)=>{try{const{error:r}=await s.from("meal_plans").update({name:e.name,description:e.description,active_days:e.active_days,start_date:e.start_date,end_date:e.end_date||null}).eq("id",t);if(r)throw r;const{error:a}=await s.from("meal_plan_meals").delete().eq("meal_plan_id",t);if(a)throw a;for(const i of e.meals||[]){const{data:o,error:n}=await w({meal_plan_id:t,name:i.name,meal_type:i.meal_type,meal_time:i.meal_time,notes:i.notes,order_index:i.order_index});if(n)throw n;for(const l of i.foods||[])await h({meal_plan_meal_id:o.id,food_id:l.food_id,quantity:l.quantity,unit:l.unit,calories:l.calories,protein:l.protein,carbs:l.carbs,fat:l.fat,notes:l.notes,order_index:l.order_index||0})}return y(t)}catch(r){return console.error("Erro ao atualizar plano alimentar:",r),{data:null,error:r}}},B=async(t,e)=>{try{const{weight_kg:r,weight_type:a,total_energy_kcal:i,macro_mode:o,protein_percentage:n,carbs_percentage:l,fat_percentage:u,protein_g_per_kg:c,carbs_g_per_kg:d,fat_g_per_kg:p}=e,{data:_}=await s.from("meal_plan_reference_values").select("id").eq("meal_plan_id",t).maybeSingle();if(_){const{data:g,error:m}=await s.from("meal_plan_reference_values").update({weight_kg:r,weight_type:a||"current",total_energy_kcal:i,macro_mode:o||"percentage",protein_percentage:o==="percentage"?n:null,carbs_percentage:o==="percentage"?l:null,fat_percentage:o==="percentage"?u:null,protein_g_per_kg:o==="g_per_kg"?c:null,carbs_g_per_kg:o==="g_per_kg"?d:null,fat_g_per_kg:o==="g_per_kg"?p:null,updated_at:new Date().toISOString()}).eq("id",_.id).select().single();if(m)throw m;return{data:g,error:null}}else{const{data:g,error:m}=await s.from("meal_plan_reference_values").insert([{meal_plan_id:t,weight_kg:r,weight_type:a||"current",total_energy_kcal:i,macro_mode:o||"percentage",protein_percentage:o==="percentage"?n:null,carbs_percentage:o==="percentage"?l:null,fat_percentage:o==="percentage"?u:null,protein_g_per_kg:o==="g_per_kg"?c:null,carbs_g_per_kg:o==="g_per_kg"?d:null,fat_g_per_kg:o==="g_per_kg"?p:null}]).select().single();if(m)throw m;return{data:g,error:null}}}catch(r){return console.error("Erro ao salvar valores de referência:",r),{data:null,error:r}}},D=async t=>{try{const{data:e,error:r}=await s.from("meal_plan_reference_values").select("*").eq("meal_plan_id",t).maybeSingle();if(r)throw r;return{data:e,error:null}}catch(e){return console.error("Erro ao buscar valores de referência:",e),{data:null,error:e}}},Q=async t=>{try{const{data:e,error:r}=await s.from("meal_plan_reference_values").delete().eq("meal_plan_id",t).select().single();if(r)throw r;return{data:e,error:null}}catch(e){return console.error("Erro ao deletar valores de referência:",e),{data:null,error:e}}},W=async(t,e,r=[])=>{try{const{data:a,error:i}=await y(t);if(i)throw i;const{data:o,error:n}=await s.from("meal_plans").insert([{patient_id:null,nutritionist_id:a.nutritionist_id,name:e,description:a.description||null,active_days:a.active_days,start_date:null,end_date:null,is_active:!1,is_template:!0,template_tags:r.length>0?r:null}]).select().single();if(n)throw n;for(const l of a.meals||[]){const{data:u,error:c}=await w({meal_plan_id:o.id,name:l.name,meal_type:l.meal_type,meal_time:l.meal_time,notes:l.notes,order_index:l.order_index});if(c)throw c;for(const d of l.foods||[])await h({meal_plan_meal_id:u.id,food_id:d.food_id,quantity:d.quantity,unit:d.unit,calories:d.calories,protein:d.protein,carbs:d.carbs,fat:d.fat,notes:d.notes,order_index:d.order_index})}return y(o.id)}catch(a){return console.error("Erro ao salvar plano como template:",a),{data:null,error:a}}},$=async t=>{try{const{data:e,error:r}=await s.from("meal_plans").select("*").eq("nutritionist_id",t).eq("is_template",!0).order("created_at",{ascending:!1});if(r)throw r;return{data:e||[],error:null}}catch(e){return console.error("Erro ao buscar templates:",e),{data:[],error:e}}},j=async(t,e,r=null,a=1,i=null)=>{try{const{data:o,error:n}=await y(t);if(n)throw n;if(!o.is_template)throw new Error("O plano selecionado não é um template");const{error:l}=await s.from("meal_plans").update({is_active:!1}).eq("patient_id",e).eq("is_active",!0);l&&console.warn("Erro ao desativar planos anteriores:",l);const u=r||new Date().toISOString().split("T")[0],{data:c,error:d}=await s.from("meal_plans").insert([{patient_id:e,nutritionist_id:o.nutritionist_id,name:o.name,description:o.description||null,active_days:o.active_days,start_date:u,end_date:null,is_active:!0,is_template:!1}]).select().single();if(d)throw d;const p=i&&i.length>0?(o.meals||[]).filter(_=>i.includes(_.id)):o.meals||[];if(p.length===0)throw new Error("Nenhuma refeição selecionada para importar");for(const _ of p){const{data:g,error:m}=await w({meal_plan_id:c.id,name:_.name,meal_type:_.meal_type,meal_time:_.meal_time,notes:_.notes,order_index:_.order_index});if(m)throw m;for(const f of _.foods||[]){const v=Math.round((parseFloat(f.quantity)||0)*a*100)/100,b=Math.round((parseFloat(f.calories)||0)*a*100)/100,E=Math.round((parseFloat(f.protein)||0)*a*100)/100,q=Math.round((parseFloat(f.carbs)||0)*a*100)/100,x=Math.round((parseFloat(f.fat)||0)*a*100)/100;await h({meal_plan_meal_id:g.id,food_id:f.food_id,quantity:v,unit:f.unit,calories:b,protein:E,carbs:q,fat:x,notes:f.notes,order_index:f.order_index})}}return y(c.id)}catch(o){return console.error("Erro ao aplicar template ao paciente:",o),{data:null,error:o}}};export{h as addFoodToMeal,w as addMealToPlan,j as applyTemplateToPatient,O as archiveMealPlan,R as calculateNutrition,V as copyMealPlanToPatient,F as createMealPlan,A as deleteMealPlan,Q as deleteReferenceValues,z as getActiveMealPlan,y as getMealPlanById,T as getMealPlans,D as getReferenceValues,$ as getTemplates,P as recalculateMealNutrition,k as recalculatePlanNutrition,W as savePlanAsTemplate,B as saveReferenceValues,N as setActiveMealPlan,C as updateFullMealPlan,M as updateMealPlan};
