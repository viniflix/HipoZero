import{q as ae,r as p,u as se,b as X,j as e,C as N,c as v,d as S,w as B,e as _,L as Ce,X as Le,D as Re,x as Fe,B as U,y as He,z as H,T as pe,s as y,E as xe,F as T,G as Be,a as Ue,t as he,m as Ve,H as qe}from"./index-qjbGaV1R.js";import{I as Oe}from"./input-DMmXNW5d.js";import{t as ze}from"./mealTranslations-B1KHhmEq.js";import{S as We}from"./search-CZaMVAuB.js";import{F as Ge}from"./filter-Cms1GFVZ.js";import{U as ee}from"./utensils-DHo71328.js";import{W as te}from"./weight-PPl9fV3l.js";import{f as De}from"./formatDistanceToNow-CNU5nHJ-.js";import{p as Y}from"./pt-BR-Dk83-zmM.js";import{B as ue}from"./badge-Du_-s9xo.js";import{g as Ye,a as Xe,b as Ze}from"./patient-queries-BD-xdZDl.js";import{A as Je}from"./alert-triangle-XuTU77WB.js";import{S as Ke,a as D}from"./skeleton-CFubCHdq.js";import{A as ge}from"./activity-DyXgAM1j.js";import{M as Qe}from"./message-square-CINCOv96.js";import{C as fe}from"./calendar-CuwgVPpP.js";import{B as et}from"./book-open-LAjwbCzq.js";import{F as tt}from"./file-text-sauH5YB4.js";import{p as Se}from"./parseISO-CVV90SIz.js";import{U as be}from"./users-v6ZecX9z.js";import{T as at}from"./trending-up-Bjnf_8I8.js";import"./constructNow-Bf7Fz9zL.js";import"./compareAsc-BU68rOeS.js";import"./endOfMonth-Dlk4l2Ma.js";import"./query-helpers-CC2p4I3d.js";const we=ae("Clipboard",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}]]),st=ae("Gift",[["rect",{x:"3",y:"8",width:"18",height:"4",rx:"1",key:"bkv52"}],["path",{d:"M12 8v13",key:"1c76mn"}],["path",{d:"M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7",key:"6wjy6b"}],["path",{d:"M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5",key:"1ihvrl"}]]),je=ae("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z",key:"ymcmye"}]]),rt=()=>{const[t,n]=p.useState([]),[c,o]=p.useState(!0),[x,l]=p.useState(""),[m,s]=p.useState("all"),{user:h}=se(),f=X(),A=i=>{const w=Number.parseFloat(i);return Number.isNaN(w)?i?`${i} kcal`:null:`${w.toFixed(2)} kcal`};p.useEffect(()=>{(async()=>{if(h?.id){o(!0);try{const{data:w}=await y.from("user_profiles").select("id, name").eq("nutritionist_id",h.id).eq("user_type","patient");if(!w||w.length===0){n([]),o(!1);return}const P=w.map(d=>d.id),I=Object.fromEntries(w.map(d=>[d.id,d])),k=[],[E,R]=await Promise.all([y.from("meal_audit_log").select("id, patient_id, action, meal_type, details, created_at").in("patient_id",P).order("created_at",{ascending:!1}).limit(100),y.from("growth_records").select("id, patient_id, weight, created_at").in("patient_id",P).order("created_at",{ascending:!1}).limit(100)]);E.data&&E.data.forEach(d=>{const a=I[d.patient_id];if(a){const g=d.details?.total_calories??0;let C="",$="";d.action==="create"?(C="registrou",$="meal"):d.action==="update"?(C="editou",$="edit"):d.action==="delete"&&(C="deletou",$="delete"),k.push({id:`audit-${d.id}`,type:$,patient_id:d.patient_id,patient_name:a.name,description:C,meal_type:ze(d.meal_type),detail:A(g),timestamp:d.created_at})}}),R.data&&R.data.forEach(d=>{const a=I[d.patient_id];a&&k.push({id:`weight-${d.id}`,type:"weight",patient_id:d.patient_id,patient_name:a.name,description:"registrou peso",detail:`${d.weight} kg`,timestamp:d.created_at})}),k.sort((d,a)=>new Date(a.timestamp)-new Date(d.timestamp)),n(k)}catch(w){console.error("Erro ao buscar atualizações:",w),n([])}o(!1)}})()},[h]);const M=i=>{switch(i){case"meal":return e.jsx(ee,{className:"h-5 w-5 text-secondary"});case"weight":return e.jsx(te,{className:"h-5 w-5 text-primary"});case"edit":return e.jsx(je,{className:"h-5 w-5 text-blue-600"});case"delete":return e.jsx(pe,{className:"h-5 w-5 text-red-600"});default:return null}},j=t.filter(i=>!(m!=="all"&&i.type!==m||x&&!i.patient_name.toLowerCase().includes(x.toLowerCase())));return c?e.jsxs(N,{className:"bg-card shadow-card-dark rounded-xl overflow-hidden",children:[e.jsxs(v,{children:[e.jsx(S,{className:"font-clash text-lg font-semibold text-primary",children:"Registros Recentes"}),e.jsx(B,{className:"text-muted-foreground",children:"Carregando..."})]}),e.jsx(_,{className:"flex items-center justify-center py-10",children:e.jsx(Ce,{className:"w-6 h-6 animate-spin text-primary"})})]}):e.jsxs(N,{className:"bg-card shadow-card-dark rounded-xl overflow-hidden",children:[e.jsxs(v,{className:"pb-3",children:[e.jsx(S,{className:"font-clash text-base md:text-lg font-semibold text-primary break-words",children:"Registros Recentes"}),e.jsx(B,{className:"text-muted-foreground text-xs md:text-sm",children:"Últimos registros dos seus pacientes"}),e.jsxs("div",{className:"flex gap-2 mt-3 min-w-0",children:[e.jsxs("div",{className:"relative flex-1 min-w-0",children:[e.jsx(We,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Oe,{placeholder:"Pesquisar por paciente...",value:x,onChange:i=>l(i.target.value),className:"pl-9 pr-9 min-w-0"}),x&&e.jsx("button",{onClick:()=>l(""),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-muted-foreground hover:text-foreground",children:e.jsx(Le,{className:"h-4 w-4"})})]}),e.jsxs(Re,{children:[e.jsx(Fe,{asChild:!0,children:e.jsx(U,{variant:"outline",size:"icon",children:e.jsx(Ge,{className:"h-4 w-4"})})}),e.jsxs(He,{align:"end",children:[e.jsx(H,{onClick:()=>s("all"),children:e.jsx("span",{className:m==="all"?"font-semibold":"",children:"Todos"})}),e.jsxs(H,{onClick:()=>s("meal"),children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:m==="meal"?"font-semibold":"",children:"Refeições"})]}),e.jsxs(H,{onClick:()=>s("weight"),children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:m==="weight"?"font-semibold":"",children:"Peso"})]}),e.jsxs(H,{onClick:()=>s("edit"),children:[e.jsx(je,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:m==="edit"?"font-semibold":"",children:"Edições"})]}),e.jsxs(H,{onClick:()=>s("delete"),children:[e.jsx(pe,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:m==="delete"?"font-semibold":"",children:"Exclusões"})]})]})]})]})]}),e.jsx(_,{children:j.length===0?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:x||m!=="all"?"Nenhum registro encontrado com os filtros aplicados":"Nenhum registro recente."})}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-xs text-muted-foreground mb-3",children:[j.length," ",j.length===1?"registro":"registros"]}),e.jsx("div",{className:"space-y-3 max-h-[400px] overflow-y-auto pr-2",children:j.map(i=>e.jsxs("div",{className:"flex items-start gap-3 min-w-0",children:[e.jsx("div",{className:"bg-muted p-2 rounded-full flex-shrink-0",children:M(i.type)}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsxs("p",{className:"text-sm break-words",children:[i.patient_id?e.jsx("button",{type:"button",className:"font-semibold text-primary hover:underline",onClick:()=>f(`/nutritionist/patients/${i.patient_id}/hub`),children:i.patient_name}):e.jsx("span",{className:"font-semibold text-primary",children:i.patient_name})," ",e.jsx("span",{className:"text-foreground",children:i.description}),i.meal_type&&e.jsxs(e.Fragment,{children:[" seu ",e.jsx("span",{className:"font-semibold text-foreground",children:i.meal_type})]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[i.detail&&`${i.detail} • `,De(new Date(i.timestamp),{addSuffix:!0,locale:Y})]})]})]},i.id))})]})})]})},ye={pending:we,low_adherence:ge,birthday:st,appointment_upcoming:fe,meal:ee,anthropometry:te,anamnesis:tt,meal_plan:et,prescription:we,appointment:fe,message:Qe,achievement:ge,default:Ke},nt={pending:"Pendência",low_adherence:"Baixa adesão",birthday:"Aniversário",appointment_upcoming:"Consulta próxima",meal:"Refeição",anthropometry:"Avaliação",anamnesis:"Anamnese",meal_plan:"Plano alimentar",prescription:"Cálculo",appointment:"Consulta",message:"Mensagem",achievement:"Conquista"},Ne={pending:{card:"bg-amber-50/60 border-amber-200/60",badge:"bg-amber-50 text-amber-700 border-amber-200",icon:"text-amber-600"},low_adherence:{card:"bg-rose-50/60 border-rose-200/60",badge:"bg-rose-50 text-rose-700 border-rose-200",icon:"text-rose-600"},birthday:{card:"bg-violet-50/60 border-violet-200/60",badge:"bg-violet-50 text-violet-700 border-violet-200",icon:"text-violet-600"},appointment_upcoming:{card:"bg-sky-50/60 border-sky-200/60",badge:"bg-sky-50 text-sky-700 border-sky-200",icon:"text-sky-600"},meal:{card:"bg-orange-50/60 border-orange-200/60",badge:"bg-orange-50 text-orange-700 border-orange-200",icon:"text-orange-600"},anthropometry:{card:"bg-emerald-50/60 border-emerald-200/60",badge:"bg-emerald-50 text-emerald-700 border-emerald-200",icon:"text-emerald-600"},anamnesis:{card:"bg-indigo-50/60 border-indigo-200/60",badge:"bg-indigo-50 text-indigo-700 border-indigo-200",icon:"text-indigo-600"},meal_plan:{card:"bg-cyan-50/60 border-cyan-200/60",badge:"bg-cyan-50 text-cyan-700 border-cyan-200",icon:"text-cyan-600"},prescription:{card:"bg-yellow-50/60 border-yellow-200/60",badge:"bg-yellow-50 text-yellow-700 border-yellow-200",icon:"text-yellow-600"},appointment:{card:"bg-blue-50/60 border-blue-200/60",badge:"bg-blue-50 text-blue-700 border-blue-200",icon:"text-blue-600"},message:{card:"bg-slate-50/60 border-slate-200/60",badge:"bg-slate-50 text-slate-700 border-slate-200",icon:"text-slate-600"},achievement:{card:"bg-amber-50/60 border-amber-200/60",badge:"bg-amber-50 text-amber-700 border-amber-200",icon:"text-amber-600"},default:{card:"bg-muted/40 border-border/70",badge:"bg-muted text-muted-foreground border-border",icon:"text-muted-foreground"}},it=()=>{const{user:t}=se(),n=X(),[c,o]=p.useState(!0),[x,l]=p.useState([]);p.useEffect(()=>{(async()=>{if(t?.id){o(!0);try{const h=new Date,[f,A,M,j,i]=await Promise.all([Ye(t.id,40),Xe(t.id),Ze(t.id),y.from("appointments").select("id, appointment_time, patient_id, patient:appointments_patient_id_fkey(id, name, avatar_url)").eq("nutritionist_id",t.id).gte("appointment_time",h.toISOString()).order("appointment_time",{ascending:!0}).limit(5),y.from("user_profiles").select("id, name, birth_date, avatar_url").eq("nutritionist_id",t.id).eq("is_active",!0)]);if(f.error)throw f.error;if(A.error)throw A.error;if(M.error)throw M.error;if(j.error)throw j.error;if(i.error)throw i.error;const w=(f.data||[]).map(a=>{const g=ot(a);return{id:`activity-${a.id}`,type:a.type,patientId:a.patient_id,patientName:a.patient_name,patientAvatar:a.patient_avatar||null,title:a.title,description:a.description,timestamp:a.timestamp,ctaLabel:g.label,ctaRoute:g.route,priority:5}}),P=(M.data||[]).flatMap(a=>a.pending_items.map(g=>({id:`pending-${a.patient_id}-${g.type}`,type:"pending",patientId:a.patient_id,patientName:a.patient_name,title:g.label,description:"Cadastro pendente",timestamp:null,ctaLabel:"Resolver",ctaRoute:g.route,priority:1}))),I=(A.data||[]).map(a=>({id:`low-adherence-${a.id}`,type:"low_adherence",patientId:a.id,patientName:a.name,title:"Baixa adesão",description:a.days_inactive===null?"Sem registros de refeição":`Sem registros há ${a.days_inactive} dia${a.days_inactive!==1?"s":""}`,timestamp:null,ctaLabel:"Ver diário",ctaRoute:`/nutritionist/patients/${a.id}/food-diary`,priority:4})),k=(j.data||[]).map(a=>({id:`appt-${a.id}`,type:"appointment_upcoming",patientId:a.patient_id,patientName:a.patient?.name||"Paciente",patientAvatar:a.patient?.avatar_url||null,title:"Consulta próxima",description:a.appointment_time?T(Se(a.appointment_time),"d 'de' MMMM 'às' HH:mm",{locale:Y}):"Consulta agendada",timestamp:a.appointment_time,ctaLabel:"Ver agenda",ctaRoute:"/nutritionist/agenda",priority:2})),E=dt(i.data||[]),d=[...P,...k,...E,...I,...w].sort((a,g)=>{if(a.priority!==g.priority)return a.priority-g.priority;const C=a.timestamp?new Date(a.timestamp).getTime():0;return(g.timestamp?new Date(g.timestamp).getTime():0)-C});l(d)}catch(h){console.error("Erro ao carregar feed:",h),l([])}finally{o(!1)}}})()},[t]);const m=s=>{if(!s)return"Pendente";const h=typeof s=="string"?new Date(s):s;return Be(h)?De(h,{addSuffix:!0,locale:Y}):"Pendente"};return c?e.jsxs(N,{className:"bg-card shadow-card-dark rounded-xl overflow-hidden",children:[e.jsxs(v,{children:[e.jsx(S,{className:"font-clash text-lg font-semibold text-primary",children:"Feed de Atividades"}),e.jsx(B,{className:"text-muted-foreground",children:"Carregando..."})]}),e.jsx(_,{className:"flex items-center justify-center py-10",children:e.jsx(Ce,{className:"w-6 h-6 animate-spin text-primary"})})]}):e.jsxs(N,{className:"bg-card shadow-card-dark rounded-xl overflow-hidden",children:[e.jsxs(v,{className:"flex flex-row items-start justify-between gap-2 md:gap-4 pb-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx(S,{className:"font-clash text-base md:text-lg font-semibold text-primary break-words",children:"Feed de Atividades"}),e.jsx(B,{className:"text-muted-foreground text-xs md:text-sm",children:"Tudo o que precisa ver ao iniciar o dia"})]}),e.jsxs(ue,{variant:"outline",className:"text-xs",children:[x.length," eventos"]})]}),e.jsx(_,{children:x.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Je,{className:"w-12 h-12 text-muted-foreground/50 mx-auto mb-3"}),e.jsx("p",{className:"text-muted-foreground font-medium mb-1",children:"Tudo em dia!"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Não há alertas ou atividades relevantes no momento"})]}):e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"max-h-[520px] overflow-y-auto pr-2 space-y-2",children:x.map(s=>{const h=ye[s.type]||ye.default,f=Ne[s.type]||Ne.default;return e.jsxs("div",{className:`flex items-start gap-2 md:gap-3 rounded-xl border p-3 md:p-4 shadow-sm hover:shadow-md transition-all min-w-0 ${f.card}`,children:[e.jsxs("div",{className:"mt-0.5 flex items-center gap-2 md:gap-3 shrink-0",children:[e.jsx("div",{className:"h-9 w-9 md:h-10 md:w-10 rounded-full border border-border bg-muted/40 flex items-center justify-center text-xs font-semibold text-muted-foreground",children:s.patientName?s.patientName.substring(0,2).toUpperCase():"HT"}),e.jsx("div",{className:"rounded-full border border-border bg-background p-1.5 md:p-2",children:e.jsx(h,{className:`h-3.5 w-3.5 md:h-4 md:w-4 ${f.icon}`})})]}),e.jsxs("div",{className:"flex-1 min-w-0 overflow-hidden",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-1 sm:gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("p",{className:"text-sm font-semibold text-foreground truncate",children:[s.patientName?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-primary font-semibold",children:s.patientName})," "]}):null,s.title]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5 line-clamp-2",children:s.description})]}),s.type==="pending"&&s.ctaRoute?e.jsxs(U,{size:"sm",className:"h-7 px-2 text-xs",onClick:()=>n(s.ctaRoute),children:[s.ctaLabel||"Resolver",e.jsx(xe,{className:"ml-1 h-3 w-3"})]}):e.jsx("span",{className:"text-xs text-muted-foreground whitespace-nowrap",children:m(s.timestamp)})]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx(ue,{variant:"outline",className:`text-xs ${f.badge}`,children:nt[s.type]||"Atividade"}),s.type!=="pending"&&s.ctaRoute?e.jsxs(U,{size:"sm",variant:"outline",className:"h-7 px-2 text-xs hover:border-primary/40",onClick:()=>n(s.ctaRoute),children:[s.ctaLabel||"Ver detalhes",e.jsx(xe,{className:"ml-1 h-3 w-3"})]}):null]})]})]},s.id)})}),e.jsx("div",{className:"pointer-events-none absolute inset-x-0 bottom-0 h-10 bg-gradient-to-t from-background to-transparent"})]})})]})},ot=t=>{if(!t?.patient_id)return{label:"Ver detalhes",route:"/nutritionist/patients"};switch(t.type){case"meal":return{label:"Ver diário",route:`/nutritionist/patients/${t.patient_id}/food-diary`};case"anthropometry":return{label:"Ver avaliação",route:`/nutritionist/patients/${t.patient_id}/anthropometry`};case"anamnesis":return{label:"Ver anamnese",route:`/nutritionist/patients/${t.patient_id}/anamnesis`};case"meal_plan":return{label:"Ver plano",route:`/nutritionist/patients/${t.patient_id}/meal-plan`};case"prescription":return{label:"Ver cálculo",route:`/nutritionist/patients/${t.patient_id}/energy-expenditure`};case"appointment":return{label:"Ver agenda",route:"/nutritionist/agenda"};case"message":return{label:"Abrir chat",route:`/chat/nutritionist/${t.patient_id}`};case"achievement":return{label:"Ver metas",route:`/nutritionist/patients/${t.patient_id}/goals`};default:return{label:"Ver paciente",route:`/nutritionist/patients/${t.patient_id}/hub`}}},dt=t=>{const n=new Date,c=[];return t.forEach(o=>{if(!o.birth_date)return;const x=new Date(o.birth_date);x.setFullYear(n.getFullYear());const l=Math.ceil((x-n)/(1e3*60*60*24));(l===0||l>0&&l<=7)&&c.push({id:`birthday-${o.id}`,type:"birthday",patientId:o.id,patientName:o.name,patientAvatar:o.avatar_url||null,title:l===0?"Aniversário hoje":`Aniversário em ${l} dia${l>1?"s":""}`,description:`Nascimento: ${T(new Date(o.birth_date),"dd/MM")}`,timestamp:null,ctaLabel:"Ver perfil",ctaRoute:`/nutritionist/patients/${o.id}/hub`,priority:3})}),c};function K(){return e.jsxs(N,{className:"bg-card shadow-card-dark rounded-xl",children:[e.jsx(v,{className:"pb-2",children:e.jsx(D,{className:"h-4 w-32"})}),e.jsxs(_,{children:[e.jsx(D,{className:"h-10 w-20 mb-2"}),e.jsx(D,{className:"h-3 w-40"})]})]})}function ve(){return e.jsxs(N,{className:"bg-card shadow-card-dark rounded-xl",children:[e.jsxs(v,{className:"pb-3",children:[e.jsx(D,{className:"h-5 w-48 mb-2"}),e.jsx(D,{className:"h-4 w-64"})]}),e.jsx(_,{className:"space-y-3",children:[1,2,3].map(t=>e.jsxs("div",{className:"flex items-start gap-3 p-3 rounded-lg border border-border",children:[e.jsx(D,{className:"h-10 w-10 rounded-full flex-shrink-0"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(D,{className:"h-4 w-3/4"}),e.jsx(D,{className:"h-3 w-1/2"})]})]},t))})]})}const lt=(t,n=[])=>{const c=new Date;c.setDate(c.getDate()-(t-1));const o=Array.from({length:t},(l,m)=>{const s=new Date(c);return s.setDate(c.getDate()+m),T(s,"yyyy-MM-dd")}),x={};return n.forEach(l=>{if(!l)return;const m=T(new Date(l),"yyyy-MM-dd");x[m]=(x[m]||0)+1}),o.map(l=>x[l]||0)},Q=({data:t=[]})=>{if(!t.length)return null;const n=Math.max(...t,1),c=140,o=44,x=c/Math.max(1,t.length-1),l=t.map((m,s)=>{const h=s*x,f=o-m/n*(o-4);return`${h},${f}`}).join(" ");return e.jsx("div",{className:"pointer-events-none absolute right-2 bottom-2 opacity-35",children:e.jsx("svg",{viewBox:`0 0 ${c} ${o}`,className:"h-11 w-36","aria-hidden":"true",children:e.jsx("polyline",{points:l,fill:"none",stroke:"white",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round"})})})},_e=t=>t>=5?"bg-secondary/15 text-secondary border-secondary/30":t>=3?"bg-yellow-100 text-yellow-800 border-yellow-300":"bg-primary/15 text-primary border-primary/30",ct=t=>{const c=(new Date(t).getTime()-Date.now())/(1e3*60*60);return c<=2?{label:"Muito próxima",rowClass:"border-red-300/80 bg-red-50/70",badgeClass:"bg-red-100 text-red-700 border-red-200",dotClass:"bg-red-500"}:c<=24?{label:"Hoje",rowClass:"border-orange-300/80 bg-orange-50/70",badgeClass:"bg-orange-100 text-orange-700 border-orange-200",dotClass:"bg-orange-500"}:c<=72?{label:"Em breve",rowClass:"border-amber-300/80 bg-amber-50/70",badgeClass:"bg-amber-100 text-amber-700 border-amber-200",dotClass:"bg-amber-500"}:{label:"Programada",rowClass:"border-emerald-300/80 bg-emerald-50/70",badgeClass:"bg-emerald-100 text-emerald-700 border-emerald-200",dotClass:"bg-emerald-500"}},ke=({appointments:t,totalUpcoming:n,todayAppointments:c})=>{const o=X(),x=c>0,l=n>0;return e.jsxs(N,{className:"bg-card shadow-card-dark rounded-xl overflow-hidden",children:[e.jsx(v,{className:"pb-2",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 min-w-0",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx(S,{className:"font-clash text-base md:text-lg font-semibold text-primary break-words",children:"Próximas Consultas"}),e.jsx(B,{className:"text-muted-foreground text-xs md:text-sm",children:"Seus próximos agendamentos."})]}),e.jsxs("div",{className:"mt-0.5 flex flex-wrap justify-end gap-1.5",children:[x&&e.jsxs("span",{className:`rounded-full border px-2 py-0.5 text-[10px] font-semibold ${_e(c)}`,children:["Hoje: ",c]}),l&&e.jsxs("span",{className:`rounded-full border px-2 py-0.5 text-[10px] font-semibold ${_e(n)}`,children:["Total: ",n]})]})]})}),e.jsx(_,{children:t.length>0?e.jsxs("div",{className:"space-y-4",children:[t.map(m=>{const s=m.patient,h=ct(m.appointment_time);return e.jsxs("div",{className:`rounded-lg border p-2.5 ${h.rowClass}`,children:[e.jsx("div",{className:"mb-2 flex justify-end",children:e.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-[11px] font-medium ${h.badgeClass}`,children:[e.jsx("span",{className:`h-1.5 w-1.5 rounded-full ${h.dotClass}`}),h.label]})}),e.jsxs("div",{className:"flex items-center space-x-3 min-w-0",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-emerald-100 flex-shrink-0 flex items-center justify-center",children:e.jsx("span",{className:"font-semibold text-emerald-700 text-xs",children:(s?.name||"P").substring(0,2).toUpperCase()})}),e.jsxs("div",{className:"min-w-0 flex-1 overflow-hidden",children:[e.jsx("p",{className:"text-sm font-medium text-foreground truncate",children:s?.name||"Paciente (Excluído)"}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:T(Se(m.appointment_time),"d 'de' MMMM 'às' HH:mm",{locale:Y})})]})]})]},m.id)}),e.jsx(U,{variant:"outline",size:"sm",className:"w-full mt-2",onClick:()=>o("/nutritionist/agenda"),children:"Ver agenda completa"})]}):e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Nenhuma consulta agendada."})})]})};function Lt(){const{toast:t}=Ue(),{user:n}=se(),c=X(),[o,x]=p.useState([]),[l,m]=p.useState([]),[s,h]=p.useState(0),[f,A]=p.useState(0),[M,j]=p.useState(0),[i,w]=p.useState("--%"),[P,I]=p.useState(0),[k,E]=p.useState(0),[R,d]=p.useState([]),[a,g]=p.useState([]),[C,$]=p.useState([]),[Ae,re]=p.useState(!0),[ne,ie]=p.useState(!0),oe=p.useCallback(async()=>{if(!(!n||!n.id)){re(!0);try{const b=await y.from("user_profiles").select("id, name, created_at").eq("nutritionist_id",n.id).eq("is_active",!0).order("name",{ascending:!0}).then(({data:r,error:u})=>{if(u)throw u;return r||[]}),L=b.map(r=>r.id),V=new Date(Date.now()-1440*60*1e3).toISOString(),F=L.length?await y.from("meals").select("patient_id, created_at").in("patient_id",L).gte("created_at",V).then(({data:r,error:u})=>{if(u)throw u;return r||[]}):[];x(b);const q=b.filter(r=>r.created_at&&new Date(r.created_at)>=new Date(Date.now()-2160*60*60*1e3)).map(r=>r.created_at),O=lt(90,q),Z=Math.max(0,b.length-q.length),z=O.reduce((r,u,G)=>{const Ee=G===0?Z:r[G-1];return r.push(Ee+u),r},[]);d(z);const Me=b.filter(r=>r.created_at&&new Date(r.created_at)>=new Date(Date.now()-720*60*60*1e3)).length;E(Me);const le=F.reduce((r,u)=>(r[u.patient_id]=(r[u.patient_id]||0)+1,r),{}),$e=Object.values(le).filter(r=>r>=1).length,ce=Object.values(le).filter(r=>r>=2).length,Te=L.length?Math.round(ce/L.length*100):0;j($e),I(ce),w(`${Te}%`);const me=Array.from({length:24},(r,u)=>{const G=new Date(Date.now()-(23-u)*60*60*1e3);return T(G,"yyyy-MM-dd HH")}),W={},J={};F.forEach(r=>{const u=T(new Date(r.created_at),"yyyy-MM-dd HH");J[u]=(J[u]||0)+1,W[u]||(W[u]=new Set),W[u].add(r.patient_id)});const Pe=me.map(r=>W[r]?.size||0),Ie=me.map(r=>J[r]||0);g(Pe),$(Ie)}catch(b){console.error("Erro ao carregar estatísticas:",b),t({title:"Erro ao carregar estatísticas",description:he(b,"Não foi possível carregar as estatísticas."),variant:"destructive"})}finally{re(!1)}}},[n,t]),de=p.useCallback(async()=>{if(!(!n||!n.id)){ie(!0);try{const b=new Date().toISOString(),{data:L,error:V}=await y.from("appointments").select("id, appointment_time, patient:appointments_patient_id_fkey(id, name, avatar_url)").eq("nutritionist_id",n.id).gte("appointment_time",b).order("appointment_time",{ascending:!0}).limit(3);if(V)throw V;m(L||[]);const F=new Date().toISOString().split("T")[0],[{count:q,error:O},{count:Z,error:z}]=await Promise.all([y.from("appointments").select("*",{count:"exact",head:!0}).eq("nutritionist_id",n.id).gte("appointment_time",b),y.from("appointments").select("*",{count:"exact",head:!0}).eq("nutritionist_id",n.id).gte("appointment_time",`${F}T00:00:00`).lte("appointment_time",`${F}T23:59:59`)]);if(O)throw O;if(z)throw z;A(q||0),h(Z||0)}catch(b){console.error("Erro ao carregar agendamentos:",b),t({title:"Erro ao carregar agendamentos",description:he(b,"Não foi possível carregar os agendamentos."),variant:"destructive"})}finally{ie(!1)}}},[n,t]);return p.useEffect(()=>{n?.id&&(oe(),de())},[n?.id,oe,de]),e.jsx("div",{className:"flex flex-col min-h-screen bg-background",children:e.jsxs(Ve.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"max-w-7xl mx-auto w-full px-4 md:px-8 pt-4 md:pt-8 min-w-0 overflow-x-hidden",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6 md:mb-8 text-center sm:text-left",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("h2",{className:"text-2xl md:text-3xl font-bold font-heading uppercase tracking-wide text-primary break-words",children:"Dashboard"}),e.jsx("p",{className:"text-neutral-600 text-sm md:text-base mt-0.5",children:"Gerencie seus pacientes, Planos e Análises."})]}),e.jsx("div",{className:"flex gap-2 flex-wrap justify-center sm:justify-end",children:e.jsxs(U,{variant:"secondary",onClick:()=>c("/nutritionist/patients"),children:[e.jsx(be,{className:"h-4 w-4 mr-2"}),"Ver todos os pacientes"]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-8 lg:order-last order-3",children:[e.jsx("div",{className:"hidden lg:block",children:ne?e.jsx(ve,{}):e.jsx(ke,{appointments:l,totalUpcoming:f,todayAppointments:s})}),e.jsx(rt,{})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-8 lg:order-first order-1",children:[e.jsx("div",{className:"grid gap-4 grid-cols-2 lg:grid-cols-3 mb-6",children:Ae?e.jsxs(e.Fragment,{children:[e.jsx(K,{}),e.jsx(K,{}),e.jsx("div",{className:"col-span-2 lg:col-span-1",children:e.jsx(K,{})})]}):e.jsxs(e.Fragment,{children:[e.jsxs(N,{className:"relative overflow-hidden bg-primary text-white border-0 shadow-card-dark",children:[e.jsx(Q,{data:R}),e.jsxs(v,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(S,{className:"font-heading uppercase text-xs lg:text-sm font-medium text-white/80 tracking-wide leading-tight",children:"Total Pacientes"}),e.jsx(be,{className:"h-5 w-5 lg:h-6 lg:w-6 text-white/80 flex-shrink-0"})]}),e.jsxs(_,{className:"relative",children:[e.jsx("div",{className:"text-3xl lg:text-4xl font-bold text-white",children:o.length}),e.jsx("p",{className:"text-xs text-white/70",children:"Evolução dos últimos 90 dias"})]})]}),e.jsxs(N,{className:"relative overflow-hidden bg-neutral-800 text-white border-0 shadow-card-dark lg:order-3",children:[e.jsx(Q,{data:a}),e.jsxs(v,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(S,{className:"font-heading uppercase text-xs lg:text-sm font-medium text-white/80 tracking-wide leading-tight",children:"Pacientes Ativos"}),e.jsx(qe,{className:"h-5 w-5 lg:h-6 lg:w-6 text-white/80 flex-shrink-0"})]}),e.jsxs(_,{className:"relative",children:[e.jsx("div",{className:"text-3xl lg:text-4xl font-bold text-white",children:M}),e.jsxs("p",{className:"text-xs text-white/70 leading-tight",children:[k," novos nos últimos 30 dias"]})]})]}),e.jsxs(N,{className:"relative overflow-hidden bg-secondary text-white border-0 shadow-card-dark col-span-2 lg:col-span-1 lg:order-2",children:[e.jsx(Q,{data:C}),e.jsxs(v,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(S,{className:"font-heading uppercase text-xs lg:text-sm font-medium text-white/80 tracking-wide leading-tight",children:"Adesão 24h"}),e.jsx(at,{className:"h-5 w-5 lg:h-6 lg:w-6 text-white/80 flex-shrink-0"})]}),e.jsxs(_,{className:"relative",children:[e.jsx("div",{className:"text-3xl lg:text-4xl font-bold text-white",children:i}),e.jsxs("p",{className:"text-xs text-white/70",children:[P,"/",o.length," com 2+ registros"]})]})]})]})}),e.jsx(it,{})]}),e.jsx("div",{className:"lg:hidden order-2",children:ne?e.jsx(ve,{}):e.jsx(ke,{appointments:l,totalUpcoming:f,todayAppointments:s})})]})]})})}export{Lt as default};
