import{as as be,b as we,a as ye,r as t,s as Fe,j as e,B as l,C as F,e as C,I as p,v as Ce,F as W,ai as T,aj as z,ak as O,al as V,au as Y,X as Z,an as B,L as ee,R as De}from"./index-DGgtqe62.js";import{I as h}from"./input-C1Ic9mBe.js";import{L as m}from"./label-ByZ_-J2k.js";import{B as se}from"./badge-DGVDmpcG.js";import{S as Se,a as Ee,b as Pe,c as Le,d as g}from"./select-D8SYYGjz.js";import{a as Ae,c as Re,u as ke,d as Te,b as ze,e as Oe,f as Ve}from"./lab-results-queries-DYfaEC-P.js";import{A as Be}from"./arrow-left-Dh54ORp5.js";import{D as q}from"./droplet-tZSZrfj3.js";import{P as ae}from"./plus-DLJbgUL_.js";import{S as qe}from"./search-BxmDnKV2.js";import{E as te}from"./eye-C6RVoRY3.js";import{P as re}from"./pen-square-UGEIzMfA.js";import{U as Ie}from"./upload-Hr03q-L3.js";import{S as Me}from"./save-Ca_h8coN.js";import{A as Ue}from"./alert-circle-DxwQXhkG.js";import{D as He}from"./download-DMbtZ0RA.js";import"./extends-CF3RwP-h.js";const os=()=>{const{patientId:f}=be(),le=we(),{toast:i}=ye(),[ne,I]=t.useState(!0),[D,M]=t.useState(!1),[ie,oe]=t.useState(""),[x,ce]=t.useState([]),[v,de]=t.useState([]),[me,S]=t.useState(!1),[n,E]=t.useState(null),[xe,N]=t.useState(!1),[P,U]=t.useState(null),[ue,L]=t.useState(!1),[_,he]=t.useState(null),[o,j]=t.useState(null),[b,H]=t.useState(!1),$=t.useRef(null),[a,A]=t.useState({test_name:"",test_value:"",test_unit:"",reference_min:"",reference_max:"",test_date:new Date().toISOString().split("T")[0],notes:""}),[w,fe]=t.useState(""),[y,pe]=t.useState("all");t.useEffect(()=>{je(),R()},[f]),t.useEffect(()=>{ge()},[x,w,y]);const je=async()=>{try{const{data:s}=await Fe.from("user_profiles").select("name").eq("id",f).single();s&&oe(s.name)}catch(s){console.error("Erro ao carregar dados do paciente:",s)}},R=async()=>{I(!0);try{const{data:s,error:r}=await Ae(f);if(r)throw r;ce(s||[])}catch(s){console.error("Erro ao carregar exames:",s),i({title:"Erro",description:"Não foi possível carregar os exames.",variant:"destructive"})}finally{I(!1)}},ge=()=>{let s=[...x];w&&(s=s.filter(r=>r.test_name.toLowerCase().includes(w.toLowerCase()))),y!=="all"&&(s=s.filter(r=>r.status===y)),de(s)},k=(s=null)=>{s?(E(s),A({test_name:s.test_name,test_value:s.test_value||"",test_unit:s.test_unit||"",reference_min:s.reference_min?.toString()||"",reference_max:s.reference_max?.toString()||"",test_date:s.test_date,notes:s.notes||""}),j(null)):(E(null),A({test_name:"",test_value:"",test_unit:"",reference_min:"",reference_max:"",test_date:new Date().toISOString().split("T")[0],notes:""}),j(null)),S(!0)},G=()=>{S(!1),E(null),j(null)},ve=s=>{const r=s.target.files?.[0];if(r){if(r.type!=="application/pdf"){i({title:"Tipo de arquivo inválido",description:"Apenas arquivos PDF são permitidos.",variant:"destructive"});return}if(r.size>10*1024*1024){i({title:"Arquivo muito grande",description:"O arquivo deve ter no máximo 10MB.",variant:"destructive"});return}j(r)}},X=s=>{he(s),L(!0)},u=(s,r)=>{A(c=>({...c,[s]:r}))},Ne=async()=>{if(!a.test_name||!a.test_date){i({title:"Campos obrigatórios",description:"Preencha nome do exame e data.",variant:"destructive"});return}const s=a.test_value&&a.test_value.trim()!=="",r=o||n?.pdf_url;if(!s&&!r){i({title:"Dados obrigatórios",description:"Preencha os valores do exame OU anexe um PDF (ou ambos).",variant:"destructive"});return}M(!0),H(!0);try{let c=n?.pdf_url||null,K=n?.pdf_filename||null;if(o){const d=await ke(f,o);if(d.error)throw new Error(d.error.message||"Erro ao fazer upload do PDF");c=d.url,K=d.filename,n?.pdf_url&&await Te(n.pdf_url)}const Q={patient_id:f,test_name:a.test_name,test_date:a.test_date,notes:a.notes||null,test_value:a.test_value||null,test_unit:a.test_unit||null,reference_min:a.reference_min?parseFloat(a.reference_min):null,reference_max:a.reference_max?parseFloat(a.reference_max):null,pdf_url:c,pdf_filename:K};if(n){const{error:d}=await ze(n.id,Q);if(d)throw d;i({title:"Atualizado!",description:"Exame atualizado com sucesso."})}else{const{error:d}=await Oe(Q);if(d)throw d;i({title:"Adicionado!",description:"Exame adicionado com sucesso."})}G(),R()}catch(c){console.error("Erro ao salvar exame:",c),i({title:"Erro",description:c.message||"Não foi possível salvar o exame.",variant:"destructive"})}finally{M(!1),H(!1)}},_e=async()=>{if(P)try{const{error:s}=await Ve(P.id);if(s)throw s;i({title:"Excluído!",description:"Exame excluído com sucesso."}),N(!1),U(null),R()}catch(s){console.error("Erro ao excluir exame:",s),i({title:"Erro",description:"Não foi possível excluir o exame.",variant:"destructive"})}},J=s=>{const r={normal:{label:"Normal",className:"bg-emerald-100 text-emerald-800 border-emerald-300"},low:{label:"Baixo",className:"bg-amber-100 text-amber-800 border-amber-300"},high:{label:"Alto",className:"bg-red-100 text-red-800 border-red-300"},pending:{label:"Pendente",className:"bg-gray-100 text-gray-800 border-gray-300"}},c=r[s]||r.pending;return e.jsx(se,{variant:"outline",className:De("text-xs",c.className),children:c.label})};return ne?null:e.jsxs("div",{className:"flex flex-col min-h-screen bg-background",children:[e.jsxs("div",{className:"max-w-7xl mx-auto w-full px-4 md:px-8 py-6 md:py-8",children:[e.jsxs("div",{className:"flex flex-col gap-4 mb-6",children:[e.jsxs(l,{variant:"ghost",size:"sm",onClick:()=>le(`/nutritionist/patients/${f}/hub`),className:"-ml-2 w-fit text-[#5f6f52] hover:text-[#5f6f52] hover:bg-[#5f6f52]/10",children:[e.jsx(Be,{className:"w-4 h-4 mr-1"}),"Voltar"]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-end justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("h1",{className:"text-2xl md:text-3xl font-bold text-foreground flex items-center gap-2",children:[e.jsx(q,{className:"w-6 h-6 md:w-8 md:h-8 text-[#b99470]"}),e.jsx("span",{className:"truncate",children:"Exames Laboratoriais"})]}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1 truncate",children:["Paciente: ",e.jsx("span",{className:"font-medium text-foreground",children:ie})]})]}),e.jsxs(l,{onClick:()=>k(),className:"gap-2 w-full sm:w-auto",children:[e.jsx(ae,{className:"w-4 h-4"}),"Adicionar Exame"]})]})]}),e.jsx(F,{className:"mb-6",children:e.jsx(C,{className:"pt-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(m,{htmlFor:"search",children:"Buscar exame"}),e.jsxs("div",{className:"relative",children:[e.jsx(qe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(h,{id:"search",placeholder:"Digite o nome do exame...",value:w,onChange:s=>fe(s.target.value),className:"pl-10"})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"status-filter",children:"Filtrar por status"}),e.jsxs(Se,{value:y,onValueChange:pe,children:[e.jsx(Ee,{id:"status-filter",children:e.jsx(Pe,{})}),e.jsxs(Le,{children:[e.jsx(g,{value:"all",children:"Todos"}),e.jsx(g,{value:"normal",children:"Normal"}),e.jsx(g,{value:"low",children:"Baixo"}),e.jsx(g,{value:"high",children:"Alto"}),e.jsx(g,{value:"pending",children:"Pendente"})]})]})]})]})})}),v.length===0?e.jsx(F,{className:"border-dashed",children:e.jsxs(C,{className:"py-12 text-center",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-muted flex items-center justify-center mx-auto mb-4",children:e.jsx(q,{className:"w-8 h-8 text-muted-foreground"})}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:x.length===0?"Nenhum exame registrado":"Nenhum resultado encontrado"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:x.length===0?"Adicione o primeiro exame laboratorial do paciente":"Tente ajustar os filtros de busca"}),x.length===0&&e.jsxs(l,{onClick:()=>k(),className:"gap-2",children:[e.jsx(ae,{className:"w-4 h-4"}),"Adicionar Primeiro Exame"]})]})}):e.jsx("div",{className:"space-y-3",children:v.map(s=>e.jsx(F,{className:"hover:shadow-md transition-all",children:e.jsx(C,{className:"py-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2 flex-wrap",children:[e.jsx("h3",{className:"text-lg font-semibold truncate",children:s.test_name}),s.pdf_url&&e.jsxs(se,{variant:"outline",className:"text-xs bg-blue-50 text-blue-700 border-blue-300",children:[e.jsx(p,{className:"w-3 h-3 mr-1"}),"PDF"]}),s.test_value&&s.status&&J(s.status)]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2 text-sm",children:[s.test_value&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Valor:"})," ",e.jsxs("span",{className:"font-medium",children:[s.test_value," ",s.test_unit||""]})]}),s.reference_min!=null&&s.reference_max!=null&&e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Referência:"})," ",e.jsxs("span",{className:"font-medium",children:[s.reference_min," - ",s.reference_max]})]})]}),s.pdf_url&&!s.test_value&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(p,{className:"w-3 h-3 text-muted-foreground"}),e.jsx("span",{className:"text-muted-foreground truncate",children:s.pdf_filename||"Arquivo PDF"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ce,{className:"w-3 h-3 text-muted-foreground"}),e.jsx("span",{className:"text-muted-foreground",children:new Date(s.test_date).toLocaleDateString("pt-BR")})]})]}),s.notes&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-2 italic",children:["Obs: ",s.notes]})]}),e.jsxs("div",{className:"flex gap-2",children:[s.pdf_url&&e.jsx(l,{variant:"outline",size:"icon",onClick:()=>X(s.pdf_url),title:"Visualizar PDF",children:e.jsx(te,{className:"w-4 h-4 text-blue-600"})}),e.jsx(l,{variant:"outline",size:"icon",onClick:()=>k(s),title:"Editar",children:e.jsx(re,{className:"w-4 h-4"})}),e.jsx(l,{variant:"outline",size:"icon",onClick:()=>{U(s),N(!0)},title:"Excluir",children:e.jsx(W,{className:"w-4 h-4 text-destructive"})})]})]})})},s.id))}),x.length>0&&e.jsx(F,{className:"mt-6",children:e.jsx(C,{className:"py-4",children:e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Total de exames: ",e.jsx("strong",{children:x.length})]}),v.length!==x.length&&e.jsxs("span",{className:"text-muted-foreground",children:["Exibindo: ",e.jsx("strong",{children:v.length})]})]})})})]}),e.jsx(T,{open:me,onOpenChange:S,children:e.jsxs(z,{className:"sm:max-w-[650px] max-h-[90vh] overflow-y-auto",children:[e.jsxs(O,{children:[e.jsxs(V,{className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-5 h-5 text-primary"}),n?"Editar Exame":"Adicionar Novo Exame"]}),e.jsx(Y,{children:n?"Atualize as informações do exame":"Preencha valores e/ou anexe PDF"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"test_name",children:"Nome do Exame *"}),e.jsx(h,{id:"test_name",placeholder:"Ex: Hemograma, Glicemia, Colesterol Total",value:a.test_name,onChange:s=>u("test_name",s.target.value)})]}),e.jsxs("div",{className:"space-y-3 p-4 bg-muted/50 rounded-lg border border-muted",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium text-muted-foreground",children:[e.jsx(re,{className:"w-4 h-4"}),"Valores Manuais (opcional)"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"test_value",children:"Valor do Resultado"}),e.jsx(h,{id:"test_value",placeholder:"Ex: 95",value:a.test_value,onChange:s=>u("test_value",s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"test_unit",children:"Unidade"}),e.jsx(h,{id:"test_unit",placeholder:"Ex: mg/dL, ng/mL",value:a.test_unit,onChange:s=>u("test_unit",s.target.value)})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"reference_min",children:"Referência Mínima"}),e.jsx(h,{id:"reference_min",type:"number",step:"0.01",placeholder:"Ex: 70",value:a.reference_min,onChange:s=>u("reference_min",s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"reference_max",children:"Referência Máxima"}),e.jsx(h,{id:"reference_max",type:"number",step:"0.01",placeholder:"Ex: 100",value:a.reference_max,onChange:s=>u("reference_max",s.target.value)})]})]}),a.test_value&&a.reference_min&&a.reference_max&&e.jsxs("div",{className:"p-3 bg-background rounded-lg border",children:[e.jsx("div",{className:"text-xs font-medium text-muted-foreground mb-1",children:"Status calculado:"}),e.jsx("div",{children:J(Re(a.test_value,a.reference_min,a.reference_max))})]})]}),e.jsxs("div",{className:"space-y-3 p-4 bg-muted/50 rounded-lg border border-muted",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium text-muted-foreground",children:[e.jsx(p,{className:"w-4 h-4"}),"Anexar PDF (opcional)"]}),n?.pdf_url&&!o&&e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(p,{className:"w-4 h-4 text-green-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-green-900",children:"PDF anexado"}),e.jsx("div",{className:"text-xs text-green-700",children:n.pdf_filename})]})]}),e.jsxs(l,{type:"button",size:"sm",variant:"outline",onClick:()=>X(n.pdf_url),children:[e.jsx(te,{className:"w-4 h-4 mr-1"}),"Ver PDF"]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"pdf-upload",children:o||n?.pdf_url?"Substituir PDF":"Anexar PDF do Exame"}),e.jsx("input",{ref:$,id:"pdf-upload",type:"file",accept:"application/pdf",onChange:ve,className:"hidden"}),e.jsxs(l,{type:"button",variant:"outline",className:"w-full",onClick:()=>$.current?.click(),children:[e.jsx(Ie,{className:"w-4 h-4 mr-2"}),o?`Arquivo selecionado: ${o.name}`:"Escolher arquivo PDF"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Formato: PDF • Tamanho máximo: 10MB"})]}),o&&e.jsx("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(p,{className:"w-4 h-4 text-blue-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-blue-900",children:"Novo arquivo selecionado"}),e.jsxs("div",{className:"text-xs text-blue-700",children:[o.name," • ",(o.size/1024/1024).toFixed(2)," MB"]})]})]}),e.jsx(l,{type:"button",size:"sm",variant:"ghost",onClick:()=>j(null),children:e.jsx(Z,{className:"w-4 h-4"})})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"test_date",children:"Data do Exame *"}),e.jsx(h,{id:"test_date",type:"date",value:a.test_date,onChange:s=>u("test_date",s.target.value),max:new Date().toISOString().split("T")[0]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"notes",children:"Observações"}),e.jsx("textarea",{id:"notes",className:"w-full min-h-[80px] px-3 py-2 text-sm rounded-md border border-input bg-background resize-none",placeholder:"Notas adicionais sobre o exame...",value:a.notes,onChange:s=>u("notes",s.target.value)})]})]}),e.jsxs(B,{children:[e.jsxs(l,{variant:"outline",onClick:G,disabled:D||b,children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"Cancelar"]}),e.jsx(l,{onClick:Ne,disabled:D||b,children:D||b?e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"w-4 h-4 mr-2 animate-spin"}),b?"Enviando...":"Salvando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Me,{className:"w-4 h-4 mr-2"}),n?"Atualizar":"Adicionar"]})})]})]})}),e.jsx(T,{open:xe,onOpenChange:N,children:e.jsxs(z,{children:[e.jsxs(O,{children:[e.jsxs(V,{className:"flex items-center gap-2",children:[e.jsx(Ue,{className:"w-5 h-5 text-destructive"}),"Confirmar Exclusão"]}),e.jsxs(Y,{children:["Tem certeza que deseja excluir o exame ",e.jsx("strong",{children:P?.test_name}),"? Esta ação não pode ser desfeita."]})]}),e.jsxs(B,{children:[e.jsx(l,{variant:"outline",onClick:()=>N(!1),children:"Cancelar"}),e.jsxs(l,{variant:"destructive",onClick:_e,children:[e.jsx(W,{className:"w-4 h-4 mr-2"}),"Excluir"]})]})]})}),e.jsx(T,{open:ue,onOpenChange:L,children:e.jsxs(z,{className:"sm:max-w-[90vw] max-h-[90vh] p-0",children:[e.jsx(O,{className:"p-6 pb-0",children:e.jsxs(V,{className:"flex items-center gap-2",children:[e.jsx(p,{className:"w-5 h-5 text-primary"}),"Visualizar Exame (PDF)"]})}),e.jsx("div",{className:"h-[75vh] p-6 pt-4",children:_?e.jsx("iframe",{src:_,className:"w-full h-full rounded-lg border border-border",title:"Visualizador de PDF"}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(ee,{className:"w-8 h-8 animate-spin text-muted-foreground"})})}),e.jsxs(B,{className:"p-6 pt-0",children:[e.jsx(l,{variant:"outline",onClick:()=>L(!1),children:"Fechar"}),_&&e.jsxs(l,{onClick:()=>window.open(_,"_blank"),children:[e.jsx(He,{className:"w-4 h-4 mr-2"}),"Abrir em nova aba"]})]})]})})]})};export{os as default};
