import{s as o}from"./index-qjbGaV1R.js";import{t as u}from"./mealTranslations-B1KHhmEq.js";import{l as p}from"./query-helpers-CC2p4I3d.js";const g=async(r,a)=>{try{const{data:i,error:s}=await o.from("user_profiles").select("*").eq("id",r).eq("nutritionist_id",a).single();if(s)throw s;return{data:i,error:null}}catch(i){return p("Erro ao buscar perfil do paciente",i),{data:null,error:i}}},h=async r=>{try{const{data:a,error:i}=await o.from("growth_records").select("weight, height, record_date").eq("patient_id",r).order("record_date",{ascending:!1}).limit(1).maybeSingle();let s=a?.weight,n=a?.height;if(!s||!n){const{data:m}=await o.from("user_profiles").select("weight, height").eq("id",r).single();s=s||m?.weight,n=n||m?.height}const{data:l,error:d}=await o.from("appointments").select("appointment_time, status").eq("patient_id",r).lte("appointment_time",new Date().toISOString()).order("appointment_time",{ascending:!1}).limit(1).maybeSingle(),{data:e,error:t}=await o.from("appointments").select("appointment_time, status").eq("patient_id",r).gte("appointment_time",new Date().toISOString()).order("appointment_time",{ascending:!0}).limit(1).maybeSingle();return{data:{weight:s||null,height:n||null,last_measurement:a?.record_date||null,last_appointment:l?new Date(l.appointment_time).toLocaleDateString("pt-BR"):null,next_appointment:e?new Date(e.appointment_time).toLocaleDateString("pt-BR"):null},error:null}}catch(a){return p("Erro ao buscar mÃ©tricas do paciente",a),{data:null,error:a}}},f=async r=>{try{const{data:a}=await o.from("anamnese_answers").select("id").eq("patient_id",r).limit(1).maybeSingle(),{data:i}=await o.from("growth_records").select("id").eq("patient_id",r).limit(1).maybeSingle(),{data:s}=await o.from("prescriptions").select("id").eq("patient_id",r).limit(1).maybeSingle(),{data:n}=await o.from("meals").select("id").eq("patient_id",r).is("deleted_at",null).limit(1).maybeSingle(),{data:l}=await o.from("user_achievements").select("id").eq("user_id",r).limit(1).maybeSingle(),{data:d}=await o.from("energy_expenditure_calculations").select("id").eq("patient_id",r).limit(1).maybeSingle(),{data:e}=await o.from("lab_results").select("id").eq("patient_id",r).limit(1).maybeSingle();return{data:{anamnese:a?"completed":"not_started",anthropometry:i?"completed":"not_started",energy_expenditure:d?"completed":"not_started",meal_plan:s?"completed":"not_started",food_diary:n?"completed":"not_started",lab_results:e?"completed":"not_started",prescriptions:s?"completed":"not_started",achievements:l?"completed":"not_started"},error:null}}catch(a){return p("Erro ao buscar status dos mÃ³dulos",a),{data:null,error:a}}},b=async(r,a=10)=>{try{const i=[],{data:s}=await o.from("meal_audit_log").select("id, action, meal_type, details, created_at").eq("patient_id",r).order("created_at",{ascending:!1}).limit(30);s&&s.forEach(e=>{const t=e.details?.total_calories||0,c=u(e.meal_type);let m="",_="";e.action==="create"?(m="RefeiÃ§Ã£o Registrada",_=`${c} - ${t} kcal`):e.action==="update"?(m="RefeiÃ§Ã£o Editada",_=`${c} - ${t} kcal`):e.action==="delete"&&(m="RefeiÃ§Ã£o Deletada",_=`${c} - ${t} kcal`),i.push({id:`audit-${e.id}`,type:"meal",title:m,description:_,timestamp:e.created_at,metadata:[c,`${t} kcal`,e.action==="create"?"Registrado":e.action==="update"?"Editado":"Deletado"]})});const{data:n}=await o.from("growth_records").select("id, weight, height, record_date, created_at").eq("patient_id",r).order("record_date",{ascending:!1}).limit(20);n&&n.forEach(e=>{const t=e.height?(e.weight/Math.pow(e.height/100,2)).toFixed(1):null;i.push({id:`weight-${e.id}`,type:"weight",title:"Peso Registrado",description:`Peso: ${e.weight} kg`,timestamp:e.created_at,metadata:t?[`${e.weight} kg`,`IMC: ${t}`]:[`${e.weight} kg`]})});const{data:l}=await o.from("user_achievements").select("id, achievement_id, achieved_at, achievements(name)").eq("user_id",r).order("achieved_at",{ascending:!1}).limit(15);l&&l.forEach(e=>{i.push({id:`achievement-${e.id}`,type:"achievement",title:"Conquista Desbloqueada",description:e.achievements?.name||"Nova conquista",timestamp:e.achieved_at,metadata:["ðŸ† Conquista"]})});const{data:d}=await o.from("appointments").select("id, appointment_time, status, notes").eq("patient_id",r).order("appointment_time",{ascending:!1}).limit(15);return d&&d.forEach(e=>{i.push({id:`appointment-${e.id}`,type:"appointment",title:"Consulta Realizada",description:e.notes||"Consulta de acompanhamento",timestamp:e.appointment_time,metadata:[e.status||"ConcluÃ­da"]})}),i.sort((e,t)=>new Date(t.timestamp)-new Date(e.timestamp)),{data:i.slice(0,a),error:null}}catch(i){return p("Erro ao buscar atividades do paciente",i),{data:[],error:i}}},q=async(r,a)=>{try{const[i,s,n]=await Promise.all([g(r,a),h(r),f(r)]);if(i.error)throw i.error;return{data:{profile:i.data,metrics:s.data||{},modulesStatus:n.data||{}},error:null}}catch(i){return p("Erro ao buscar resumo do paciente",i),{data:null,error:i}}},D=async r=>{try{const{data:a,error:i}=await o.rpc("get_patients_low_adherence_optimized",{p_nutritionist_id:r,p_days_threshold:2});if(i)throw i;return{data:(a||[]).map(n=>({id:n.patient_id,name:n.patient_name,last_activity:n.last_meal_date,days_inactive:n.days_since_last_meal===9999?null:n.days_since_last_meal})),error:null}}catch(a){return p("Erro ao detectar baixa adesÃ£o",a),{data:[],error:a}}},$=async r=>{try{const{data:a,error:i}=await o.rpc("get_patients_pending_data_optimized",{p_nutritionist_id:r});if(i)throw i;return{data:(a||[]).map(n=>{const l=[];return n.pending_items.forEach(d=>{const e={anamnese:{type:"anamnesis",label:"Anamnese Pendente",route:`/nutritionist/patients/${n.patient_id}/anamnese`},anthropometry:{type:"anthropometry",label:"AvaliaÃ§Ã£o AntropomÃ©trica Pendente",route:`/nutritionist/patients/${n.patient_id}/anthropometry`},meal_plan:{type:"meal_plan",label:"Plano Alimentar Pendente",route:`/nutritionist/patients/${n.patient_id}/meal-plan`},prescription:{type:"prescription",label:"CÃ¡lculo de Necessidades Pendente",route:`/nutritionist/patients/${n.patient_id}/energy-expenditure`}};e[d]&&l.push(e[d])}),{patient_id:n.patient_id,patient_name:n.patient_name,pending_items:l}}),error:null}}catch(a){return p("Erro ao detectar pendÃªncias",a),{data:[],error:a}}},E=async(r,a=20)=>{try{const{data:i,error:s}=await o.rpc("get_comprehensive_activity_feed_optimized",{p_nutritionist_id:r,p_limit:a});if(s)throw s;const n=[...new Set(i?.map(t=>t.patient_id)||[])],{data:l}=await o.from("user_profiles").select("id, avatar_url").in("id",n),d=Object.fromEntries((l||[]).map(t=>[t.id,t.avatar_url]));return{data:(i||[]).map(t=>{const c={id:`${t.activity_type}-${t.activity_id}`,type:t.activity_type,patient_id:t.patient_id,patient_name:t.patient_name,patient_avatar:d[t.patient_id]||null,timestamp:t.activity_date,metadata:t.activity_data};switch(t.activity_type){case"meal":return{...c,title:"RefeiÃ§Ã£o Registrada",description:`${t.activity_data.meal_type} - ${t.activity_data.total_calories||0} kcal`};case"anthropometry":const m=t.activity_data.height&&t.activity_data.weight?(t.activity_data.weight/Math.pow(t.activity_data.height/100,2)).toFixed(1):null;return{...c,title:"Peso Registrado",description:`Peso: ${t.activity_data.weight} kg${m?` - IMC: ${m}`:""}`};case"anamnesis":return{...c,title:"Anamnese Preenchida",description:"Anamnese completa"};case"meal_plan":return{...c,title:"Plano Alimentar Criado",description:t.activity_data.name};case"prescription":return{...c,title:"PrescriÃ§Ã£o Nutricional",description:`${t.activity_data.calories||""} kcal`};case"appointment":return{...c,title:"Consulta Agendada",description:t.activity_data.notes||"Consulta de acompanhamento"};case"chat":return{...c,type:"message",title:"Mensagem Recebida",description:t.activity_data.message_preview||"Mensagem"};case"achievement":return{...c,title:"Conquista Desbloqueada",description:t.activity_data.achievement_name||"Nova conquista"};default:return c}}),error:null}}catch(i){return p("Erro ao buscar feed de atividades",i),{data:[],error:i}}},S=async r=>{try{const{data:a,error:i}=await o.from("anamnesis_records").select("id, content, date").eq("patient_id",r).order("date",{ascending:!1}).limit(1).maybeSingle();if(i)throw i;if(!a||!a.content)return{data:null,error:null};const s=a.content;let n=null,l=null;if(typeof s=="object"){const d=["exercise_frequency","exerciseFrequency","frequencia_exercicio","atividade_fisica","physical_activity","nivel_atividade","activity_level"];for(const e of d)if(s[e]){n=s[e];break}if(!n&&s.sections){for(const e of s.sections)if(e.fields){for(const t of e.fields)if(d.includes(t.key||t.id)){n=t.value||t.answer;break}}}}return{data:{exerciseFrequency:n,activityLevel:l,date:a.date},error:null}}catch(a){return p("Erro ao buscar anamnese para energia",a),{data:null,error:a}}},P=async r=>{try{const{data:a,error:i}=await o.from("patient_goals").select("id, goal_type, target_weight, current_weight, description, status").eq("patient_id",r).eq("status","active").order("created_at",{ascending:!1}).limit(1).maybeSingle();if(i)throw i;return{data:a,error:null}}catch(a){return p("Erro ao buscar objetivo para energia",a),{data:null,error:a}}};export{D as a,$ as b,q as c,b as d,g as e,S as f,E as g,P as h};
