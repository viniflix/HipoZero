import{u as oe,a as le,b as ce,as as de,r as i,s as u,j as e,B as p,m as B,C as q,c as T,d as A,e as R,F as me}from"./index-tlGv3_XP.js";import{I}from"./input-LGp_IBjh.js";import{L as j}from"./label-VXhiBOq2.js";import{S as V,a as H,b as U,c as K,d as b}from"./select-0mldc7nn.js";import{T as ue}from"./textarea-B0qyavR-.js";import{calculateNutrition as he}from"./nutrition-calculations-DjYFS08l.js";import{A as xe}from"./arrow-left-BjB0YXx2.js";import{S as fe}from"./search-DtgGXOie.js";import{P as pe}from"./plus-DnrmLjkx.js";import{S as je}from"./save-3SR3qEUM.js";import"./extends-CF3RwP-h.js";const ve=l=>{if(!l)return"";const t=parseInt(l.split(":")[0],10);return t>=5&&t<11?"Caf√© da Manh√£":t>=11&&t<14?"Almo√ßo":t>=14&&t<18?"Lanche":t>=18&&t<22?"Jantar":"Ceia"},ge=["Caf√© da Manh√£","Almo√ßo","Lanche","Jantar","Ceia"],Te=()=>{const{user:l}=oe(),{toast:t}=le(),w=ce(),{mealId:c}=de(),[Ne,W]=i.useState(null),[D,X]=i.useState([]),[v,F]=i.useState(""),[Y,M]=i.useState(!1),[x,E]=i.useState([]),[f,z]=i.useState(null),[g,L]=i.useState("grams"),[N,k]=i.useState(""),[o,y]=i.useState({time:new Date().toTimeString().slice(0,5),type:"",notes:""}),[P,S]=i.useState(!1),[O,G]=i.useState([]),[_,C]=i.useState("direct");i.useEffect(()=>{y(s=>({...s,type:ve(s.time)}))},[o.time]);const J=i.useCallback(async()=>{if(!l||!l.profile)return;const s=l.profile.nutritionist_id,{data:a,error:r}=await u.from("foods").select("*").or(`nutritionist_id.is.null,nutritionist_id.eq.${s}`).limit(1e3);r?t({title:"Erro",description:"N√£o foi poss√≠vel carregar os alimentos.",variant:"destructive"}):X(a||[])},[l,t]);i.useEffect(()=>{J(),c&&(async()=>{const{data:a,error:r}=await u.from("meals").select("*, meal_items(*)").eq("id",c).single();if(r||!a)t({title:"Erro",description:"Refei√ß√£o n√£o encontrada.",variant:"destructive"}),w("/patient/records");else{W(JSON.parse(JSON.stringify(a))),y({time:a.meal_time,type:a.meal_type,notes:a.notes||""});const m=a.meal_items.map(h=>({...h,food_name:h.name}));E(m)}})()},[c,w,t,J]);const Q=i.useMemo(()=>v?D.filter(s=>s.name.toLowerCase().includes(v.toLowerCase())).slice(0,5):[],[v,D]),Z=(s,a)=>!s||!a?{calories:0,protein:0,fat:0,carbs:0}:he(s,a),ee=async s=>{z(s),F(s.name),M(!1),L("grams"),C("direct"),k("");const{data:a,error:r}=await u.from("measure_conversions").select("*").eq("food_id",s.id).limit(50);r?console.error(r):G(a||[])},se=()=>{if(!N)return 0;const s=parseFloat(N);if(isNaN(s)||s<=0)return 0;if(_==="direct"){if(g==="grams"||g==="ml")return s;if(g==="unit")return s*100}else{const a=O.find(r=>r.measure_name===g);if(a)return a.grams_equivalent*s}return 0},ae=()=>{if(!f||!N){t({title:"Erro",description:"Selecione um alimento e a quantidade.",variant:"destructive"});return}const s=parseFloat(N);if(isNaN(s)||s<=0){t({title:"Erro",description:"A quantidade deve ser maior que zero.",variant:"destructive"});return}const a=se();if(a<=0){t({title:"Erro",description:"N√£o foi poss√≠vel converter a medida para gramas.",variant:"destructive"});return}const r=Z(f,a),m={id:Date.now(),food_id:f.id,name:f.name,food_name:f.name,quantity:a,calories:r.calories,protein:r.protein,fat:r.fat,carbs:r.carbs};E(h=>[...h,m]),z(null),F(""),k(""),G([]),C("direct")},te=s=>{E(a=>a.filter(r=>r.id!==s))},d=i.useMemo(()=>x.reduce((s,a)=>({calories:s.calories+(a.calories||0),protein:s.protein+(a.protein||0),fat:s.fat+(a.fat||0),carbs:s.carbs+(a.carbs||0)}),{calories:0,protein:0,fat:0,carbs:0}),[x]),re=async()=>{if(x.length===0){t({title:"Refei√ß√£o vazia",description:"Adicione pelo menos um alimento.",variant:"destructive"});return}S(!0);const s={patient_id:l.id,meal_date:new Date().toISOString().split("T")[0],meal_time:o.time,meal_type:o.type,notes:o.notes,total_calories:d.calories,total_protein:d.protein,total_fat:d.fat,total_carbs:d.carbs},a=async r=>{const m=x.map(n=>({meal_id:r,food_id:n.food_id,name:n.name,quantity:n.quantity,calories:n.calories,protein:n.protein,fat:n.fat,carbs:n.carbs})),{error:h}=await u.from("meal_items").insert(m);if(h)t({title:"Erro",description:`N√£o foi poss√≠vel salvar os itens: ${h.message}`,variant:"destructive"});else{t({title:"Sucesso!",description:"Refei√ß√£o salva."});const{data:n,error:$}=await u.rpc("check_and_grant_achievements",{p_user_id:l.id});$?console.error("Error checking achievements:",$):n&&n.length>0&&n.forEach((ie,ne)=>{setTimeout(()=>{t({title:"üéâ Conquista Desbloqueada!",description:ie.name,duration:5e3})},500*(ne+1))}),w("/patient/records")}};if(c){const{error:r}=await u.from("meals").update(s).eq("id",c);if(r){t({title:"Erro",description:`N√£o foi poss√≠vel atualizar a refei√ß√£o: ${r.message}`,variant:"destructive"}),S(!1);return}await u.from("meal_items").delete().eq("meal_id",c),await a(c)}else{const{data:r,error:m}=await u.from("meals").insert(s).select().single();if(m){t({title:"Erro",description:`N√£o foi poss√≠vel salvar a refei√ß√£o: ${m.message}`,variant:"destructive"}),S(!1);return}await a(r.id)}S(!1)};return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx("header",{className:"sticky top-0 z-10 bg-background/80 backdrop-blur-md",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 h-16 flex items-center",children:[e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>w(-1),className:"mr-2",children:e.jsx(xe,{className:"w-5 h-5"})}),e.jsx("h1",{className:"text-xl font-bold text-foreground",children:c?"Editar Refei√ß√£o":"Adicionar Refei√ß√£o"})]})}),e.jsx("main",{className:"max-w-4xl mx-auto p-4 pb-24",children:e.jsx(B.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs(q,{children:[e.jsx(T,{children:e.jsx(A,{children:"Adicionar Alimento"})}),e.jsxs(R,{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(j,{htmlFor:"search",children:"Buscar alimento"}),e.jsxs("div",{className:"relative",children:[e.jsx(fe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),e.jsx(I,{id:"search",placeholder:"Digite o nome do alimento...",value:v,onChange:s=>{F(s.target.value),M(!0)},onFocus:()=>M(!0),className:"pl-10 bg-muted"})]}),Y&&v&&e.jsx("div",{className:"mt-2 border rounded-lg bg-card max-h-48 overflow-y-auto z-20 absolute w-full shadow-lg",children:Q.length>0?Q.map(s=>e.jsxs("div",{className:"p-3 border-b cursor-pointer hover:bg-muted",onClick:()=>ee(s),children:[e.jsx("p",{className:"font-medium",children:s.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.calories," kcal por 100g"]})]},s.id)):e.jsx("div",{className:"p-3 text-center text-muted-foreground",children:"Nenhum alimento encontrado."})})]}),f&&e.jsxs(B.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},className:"pt-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsx(p,{variant:_==="direct"?"default":"outline",onClick:()=>C("direct"),children:"Medida Direta"}),e.jsx(p,{variant:_==="household"?"default":"outline",onClick:()=>C("household"),children:"Medida Caseira"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 items-end",children:[e.jsxs("div",{className:"sm:col-span-1",children:[e.jsx(j,{htmlFor:"measure",children:"Medida"}),e.jsxs(V,{value:g,onValueChange:L,children:[e.jsx(H,{children:e.jsx(U,{})}),e.jsx(K,{children:_==="direct"?e.jsxs(e.Fragment,{children:[e.jsx(b,{value:"grams",children:"Gramas (g)"}),e.jsx(b,{value:"ml",children:"Mililitros (ml)"}),e.jsx(b,{value:"unit",children:"Unidade"})]}):O.map(s=>e.jsx(b,{value:s.measure_name,children:s.measure_name},s.id))})]})]}),e.jsxs("div",{className:"sm:col-span-1",children:[e.jsx(j,{htmlFor:"quantity",children:"Quantidade"}),e.jsx(I,{id:"quantity",type:"number",placeholder:"100",value:N,onChange:s=>k(s.target.value),className:"bg-muted"})]}),e.jsxs(p,{onClick:ae,className:"w-full",children:[e.jsx(pe,{className:"w-4 h-4 mr-2"}),"Adicionar"]})]})]})]})]}),e.jsxs(q,{children:[e.jsx(T,{children:e.jsx(A,{children:"Itens da Refei√ß√£o"})}),e.jsx(R,{children:e.jsx("div",{className:"space-y-3",children:x.length>0?x.map(s=>e.jsxs("div",{className:"flex justify-between items-center p-3 bg-muted/50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.food_name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[Math.round(s.quantity),"g"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"font-semibold text-destructive",children:[Math.round(s.calories)," kcal"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["P:",s.protein.toFixed(1),"g G:",s.fat.toFixed(1),"g C:",s.carbs.toFixed(1),"g"]})]}),e.jsx(p,{variant:"ghost",size:"icon",onClick:()=>te(s.id),children:e.jsx(me,{className:"w-4 h-4 text-destructive"})})]},s.id)):e.jsx("p",{className:"text-muted-foreground text-center py-4",children:"Nenhum item adicionado."})})})]})]}),e.jsx("div",{className:"space-y-6",children:e.jsxs(q,{className:"sticky top-24",children:[e.jsx(T,{children:e.jsx(A,{children:"Resumo da Refei√ß√£o"})}),e.jsxs(R,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(j,{htmlFor:"meal-time",children:"Hor√°rio"}),e.jsx(I,{id:"meal-time",type:"time",value:o.time,onChange:s=>y({...o,time:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"meal-type",children:"Tipo"}),e.jsxs(V,{value:o.type,onValueChange:s=>y({...o,type:s}),children:[e.jsx(H,{children:e.jsx(U,{})}),e.jsx(K,{children:ge.map(s=>e.jsx(b,{value:s,children:s},s))})]})]})]}),e.jsxs("div",{children:[e.jsx(j,{htmlFor:"meal-notes",children:"Observa√ß√µes"}),e.jsx(ue,{id:"meal-notes",placeholder:"Ex: senti muita fome, comi antes do treino...",value:o.notes,onChange:s=>y({...o,notes:s.target.value})})]}),e.jsxs("div",{className:"flex justify-between items-baseline p-3 bg-muted rounded-lg mt-4",children:[e.jsx("span",{className:"font-medium text-foreground",children:"Calorias"}),e.jsxs("span",{className:"text-2xl font-bold text-destructive",children:[Math.round(d.calories)," kcal"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Prote√≠nas"}),e.jsxs("span",{className:"font-medium",children:[d.protein.toFixed(1)," g"]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Gorduras"}),e.jsxs("span",{className:"font-medium",children:[d.fat.toFixed(1)," g"]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Carboidratos"}),e.jsxs("span",{className:"font-medium",children:[d.carbs.toFixed(1)," g"]})]})]}),e.jsxs(p,{className:"w-full mt-4",disabled:P,onClick:re,children:[e.jsx(je,{className:"w-4 h-4 mr-2"}),P?"Salvando...":c?"Atualizar Refei√ß√£o":"Salvar no Di√°rio"]})]})]})})]})})})]})};export{Te as default};
