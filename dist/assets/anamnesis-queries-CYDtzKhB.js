import{s as n}from"./index-BvWB-6Y-.js";import{g as c}from"./date-C2sroe8F.js";import{l as o}from"./query-helpers-mbysFH2_.js";const _=async t=>{try{const{data:e,error:r}=await n.from("anamnesis_templates").select("*").or(`is_system_default.eq.true,nutritionist_id.eq.${t}`).eq("is_active",!0).order("is_system_default",{ascending:!1}).order("title",{ascending:!0});if(r)throw r;return{data:e,error:null}}catch(e){return o("Erro ao buscar templates de anamnese",e),{data:null,error:e}}},y=async t=>{try{const{data:e,error:r}=await n.from("anamnesis_records").select(`
                id,
                date,
                version,
                status,
                notes,
                created_at,
                updated_at,
                template:anamnesis_templates(title)
            `).eq("patient_id",t).order("date",{ascending:!1}).order("version",{ascending:!1});if(r)throw r;return{data:e,error:null}}catch(e){return o("Erro ao buscar anamneses do paciente",e),{data:null,error:e}}},w=async t=>{try{const{data:e,error:r}=await n.from("anamnesis_records").select("*").eq("id",t).single();if(r)throw o("Erro ao buscar anamnesis_records",r),r;let a=null;if(e.template_id){const{data:l,error:d}=await n.from("anamnesis_templates").select("id, title, sections").eq("id",e.template_id).single();d||(a=l)}let s=null;if(e.patient_id){const{data:l,error:d}=await n.from("user_profiles").select("id, full_name, name").eq("id",e.patient_id).single();d||(s=l)}return{data:{...e,template:a,patient:s},error:null}}catch(e){return o("Erro ao buscar anamnese",e),{data:null,error:e}}},h=async t=>{try{const{data:e,error:r}=await n.from("anamnesis_records").insert([{patient_id:t.patientId,template_id:t.templateId,nutritionist_id:t.nutritionistId,date:t.date||c(),content:t.content,notes:t.notes||null,status:t.status||"draft",version:1}]).select().single();if(r)throw r;return{data:e,error:null}}catch(e){return o("Erro ao criar anamnese",e),{data:null,error:e}}},g=async(t,e)=>{try{const{data:r,error:a}=await n.from("anamnesis_records").select("version").eq("id",t).single();if(a)throw a;const{data:s,error:i}=await n.from("anamnesis_records").update({content:e.content,notes:e.notes,status:e.status,version:(r.version||1)+1,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(i)throw i;return{data:s,error:null}}catch(r){return o("Erro ao atualizar anamnese",r),{data:null,error:r}}},q=async t=>{try{const{error:e}=await n.from("anamnesis_records").delete().eq("id",t);if(e)throw e;return{error:null}}catch(e){return o("Erro ao deletar anamnese",e),{error:e}}},E=async(t,e=!1)=>{try{let r=`
            id,
            date,
            status,
            version,
            template:anamnesis_templates(title)
        `;e&&(r+=", content");const{data:a,error:s}=await n.from("anamnesis_records").select(r).eq("patient_id",t).order("date",{ascending:!1}).order("version",{ascending:!1}).limit(1).maybeSingle();if(s){if(s.code==="PGRST116")return{data:null,error:null};throw s}return{data:a,error:null}}catch(r){return o("Erro ao buscar última anamnese",r),{data:null,error:r}}},b=async(t,e=null)=>{try{if(e){const{data:r,error:a}=await n.from("anamnesis_template_fields").select(`
                    field_id,
                    field_order,
                    anamnese_fields (*)
                `).eq("template_id",e).order("field_order",{ascending:!0});if(a)throw a;return{data:(r||[]).map(i=>i.anamnese_fields).filter(Boolean),error:null}}else{const{data:r,error:a}=await n.from("anamnese_fields").select("*").eq("nutritionist_id",t).order("id",{ascending:!0});if(a)throw a;return{data:r||[],error:null}}}catch(r){return o("Erro ao buscar campos de anamnese",r),{data:null,error:r}}},A=async t=>{try{const{data:e,error:r}=await n.from("anamnese_fields").insert([{nutritionist_id:t.nutritionistId,field_label:t.fieldLabel,field_type:t.fieldType,category:t.category||"geral",is_required:t.isRequired||!1}]).select().single();if(r)throw r;return{data:e,error:null}}catch(e){return o("Erro ao criar campo de anamnese",e),{data:null,error:e}}},v=async(t,e)=>{try{const r={field_label:e.fieldLabel,field_type:e.fieldType};e.category!==void 0&&(r.category=e.category),e.isRequired!==void 0&&(r.is_required=e.isRequired);const{data:a,error:s}=await n.from("anamnese_fields").update(r).eq("id",t).select().single();if(s)throw s;return{data:a,error:null}}catch(r){return o("Erro ao atualizar campo de anamnese",r),{data:null,error:r}}},F=async t=>{try{const{error:e}=await n.from("anamnese_fields").delete().eq("id",t);if(e)throw e;return{error:null}}catch(e){return o("Erro ao deletar campo de anamnese",e),{error:e}}},T=async(t,e,r=0)=>{try{const{data:a,error:s}=await n.from("anamnesis_template_fields").insert([{template_id:t,field_id:e,field_order:r}]).select();if(s)throw s;return{data:a,error:null}}catch(a){return o("Erro ao associar campo ao template",a),{data:null,error:a}}},z=async t=>{try{const{data:e,error:r}=await n.from("anamnese_field_options").select("*").eq("field_id",t).order("option_order",{ascending:!0});if(r)throw r;return{data:e,error:null}}catch(e){return o("Erro ao buscar opções do campo",e),{data:null,error:e}}},u=async(t,e)=>{try{const r=e.map((i,l)=>({field_id:t,option_text:i,option_order:l})),{data:a,error:s}=await n.from("anamnese_field_options").insert(r).select();if(s)throw s;return{data:a,error:null}}catch(r){return o("Erro ao criar opções do campo",r),{data:null,error:r}}},I=async(t,e)=>{try{const{error:r}=await n.from("anamnese_field_options").delete().eq("field_id",t);if(r)throw r;if(e&&e.length>0){const{data:a,error:s}=await u(t,e);if(s)throw s;return{data:a,error:null}}return{data:[],error:null}}catch(r){return o("Erro ao atualizar opções do campo",r),{data:null,error:r}}},S=async t=>{try{const{data:e,error:r}=await n.from("anamnese_answers").select("*").eq("patient_id",t);if(r)throw r;return{data:e,error:null}}catch(e){return o("Erro ao buscar respostas de anamnese",e),{data:null,error:e}}},C=async t=>{try{const{data:e,error:r}=await n.from("anamnese_answers").upsert(t,{onConflict:"patient_id,field_id"}).select();if(r)throw r;return{data:e,error:null}}catch(e){return o("Erro ao salvar respostas de anamnese",e),{data:null,error:e}}},L=async t=>{try{const{data:e,error:r}=await n.from("anamnesis_templates").select("*").eq("nutritionist_id",t).eq("is_system_default",!1).eq("is_active",!0).order("created_at",{ascending:!1});if(r)throw r;return{data:e,error:null}}catch(e){return o("Erro ao buscar formulários personalizados",e),{data:null,error:e}}},O=async t=>{try{const{data:e,error:r}=await n.from("anamnesis_templates").insert([{nutritionist_id:t.nutritionistId,title:t.title,description:t.description||null,is_system_default:!1,is_active:!0,sections:[]}]).select().single();if(r)throw r;return{data:e,error:null}}catch(e){return o("Erro ao criar formulário personalizado",e),{data:null,error:e}}},R=async t=>{try{const{error:e}=await n.from("anamnesis_templates").delete().eq("id",t);if(e)throw e;return{error:null}}catch(e){return o("Erro ao deletar formulário personalizado",e),{error:e}}};export{y as a,_ as b,L as c,b as d,z as e,I as f,E as g,A as h,u as i,T as j,O as k,q as l,R as m,F as n,S as o,w as p,g as q,h as r,C as s,v as u};
