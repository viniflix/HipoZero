import{s as i}from"./index-BvWB-6Y-.js";import{f as b,g as D}from"./date-C2sroe8F.js";import{l as d}from"./query-helpers-mbysFH2_.js";import{l as f}from"./observability-queries-BxbsnaqH.js";const p={daily_log_enabled:!0,measurement_enabled:!0,daily_log_time:"20:00",measurement_time:"09:00",channel_in_app:!0,timezone:"America/Sao_Paulo",quiet_hours_start:null,quiet_hours_end:null},C=async(a,e={},t=50,r=0)=>{const n=Date.now();try{let o=i.from("meals").select(`
                *,
                meal_items (
                    *
                )
            `).eq("patient_id",a).order("meal_date",{ascending:!1}).order("meal_time",{ascending:!1}).range(r,r+t-1);e.startDate&&(o=o.gte("meal_date",e.startDate)),e.endDate&&(o=o.lte("meal_date",e.endDate)),e.mealType&&(o=o.eq("meal_type",e.mealType));const{data:s,error:l,count:u}=await o;if(l)throw l;return await f({module:"food_diary",operation:"get_patient_meals",eventType:"success",latencyMs:Date.now()-n,patientId:a||null,metadata:{items_count:Array.isArray(s)?s.length:0}}),{data:s,error:null,count:u}}catch(o){return d("Erro ao buscar refeições",o),await f({module:"food_diary",operation:"get_patient_meals",eventType:"error",latencyMs:Date.now()-n,patientId:a||null,errorMessage:o?.message||String(o)}),{data:null,error:o}}},v=async a=>{try{const{data:e,error:t}=await i.from("meal_audit_log").select("*").eq("meal_id",a).order("created_at",{ascending:!1});if(t)throw t;return{data:e,error:null}}catch(e){return d("Erro ao buscar histórico de auditoria",e),{data:null,error:e}}},A=async(a,e={},t=100)=>{try{let r=i.from("meal_audit_log").select("*").eq("patient_id",a).order("created_at",{ascending:!1}).limit(t);e.action&&(r=r.eq("action",e.action)),e.startDate&&(r=r.gte("meal_date",e.startDate)),e.endDate&&(r=r.lte("meal_date",e.endDate));const{data:n,error:o}=await r;if(o)throw o;return{data:n,error:null}}catch(r){return d("Erro ao buscar histórico completo",r),{data:null,error:r}}},R=async(a,e=30)=>{try{const t=new Date;t.setDate(t.getDate()-e);const r=b(t),{data:n,error:o}=await i.from("meals").select("meal_date").eq("patient_id",a).gte("meal_date",r);if(o)throw o;const s=new Set(n.map(g=>g.meal_date)),l=s.size,u=l/e*100;let c=0;const _=D(),m=Array.from(s).sort().reverse();for(let g=0;g<e;g++){const h=new Date;h.setDate(h.getDate()-g);const y=b(h);if(m.includes(y))c++;else if(y!==_)break}return{data:{totalDays:e,daysWithRecords:l,adherencePercentage:Math.round(u),currentStreak:c,totalMeals:n.length},error:null}}catch(t){return d("Erro ao calcular adesão",t),{data:null,error:t}}},S=async(a,e,t)=>{try{const{data:r,error:n}=await i.from("meals").select(`
                *,
                meal_items (
                    quantity,
                    calories,
                    protein,
                    carbs,
                    fat
                )
            `).eq("patient_id",a).gte("meal_date",e).lte("meal_date",t);if(n)throw n;let o=0,s=0,l=0,u=0;r.forEach(_=>{_.meal_items?.forEach(m=>{o+=m.calories||0,s+=m.protein||0,l+=m.carbs||0,u+=m.fat||0})});const c=r.length>0?new Set(r.map(_=>_.meal_date)).size:1;return{data:{totalMeals:r.length,days:c,avgCaloriesPerDay:Math.round(o/c),avgProteinPerDay:Math.round(s/c),avgCarbsPerDay:Math.round(l/c),avgFatPerDay:Math.round(u/c),totals:{calories:Math.round(o),protein:Math.round(s),carbs:Math.round(l),fat:Math.round(u)}},error:null}}catch(r){return d("Erro ao calcular resumo nutricional",r),{data:null,error:r}}},T=a=>{const e={create:{icon:"Plus",color:"text-green-600",bgColor:"bg-green-50",borderColor:"border-green-200",label:"Registrou",description:"Nova refeição adicionada"},update:{icon:"Edit",color:"text-blue-600",bgColor:"bg-blue-50",borderColor:"border-blue-200",label:"Editou",description:"Refeição modificada"},delete:{icon:"Trash2",color:"text-red-600",bgColor:"bg-red-50",borderColor:"border-red-200",label:"Excluiu",description:"Refeição removida"}};return e[a.action]||e.create},x=async a=>{try{const{data:e,error:t}=await i.from("patient_reminder_preferences").select("*").eq("patient_id",a).maybeSingle();if(t)throw t;return{data:e?{...p,...e}:{...p,patient_id:a},error:null}}catch(e){return d("Erro ao buscar preferências de lembrete",e),{data:{...p,patient_id:a},error:e}}},k=async(a,e={})=>{try{const t={patient_id:a,...p,...e&&typeof e=="object"?e:{}},{data:r,error:n}=await i.from("patient_reminder_preferences").upsert(t,{onConflict:"patient_id"}).select("*").single();if(n)throw n;return{data:r,error:null}}catch(t){return d("Erro ao salvar preferências de lembrete",t),{data:null,error:t}}},F=async a=>{try{const{data:e,error:t}=await i.rpc("process_patient_reminders",{p_patient_id:a});if(t)throw t;return{data:e,error:null}}catch(e){return d("Erro ao processar lembretes do paciente",e),{data:null,error:e}}},N=a=>{if(!a||!a.changes)return[];const e=[];return Object.keys(a.changes).forEach(t=>{const r=a.changes[t];e.push({field:t,oldValue:r.old,newValue:r.new,label:w(t)})}),e},w=a=>({meal_type:"Tipo de Refeição",meal_date:"Data",meal_time:"Horário",notes:"Observações",foods:"Alimentos"})[a]||a;export{C as a,A as b,R as c,v as d,N as e,T as f,S as g,x as h,F as p,k as u};
