import{aO as h,s as d,O as l,aN as D,ad as E}from"./index-Cl9S2_vK.js";import{s as w}from"./startOfMonth-BPzLXFQb.js";import{p as F}from"./parseISO-1naG7898.js";async function b(n){const t=w(n),e=h(n),{data:a,error:r}=await d.from("financial_transactions").select("type, amount, net_amount, status").gte("transaction_date",l(t,"yyyy-MM-dd")).lte("transaction_date",l(e,"yyyy-MM-dd"));if(r)throw console.error("Error fetching financial summary:",r),r;const c=a.filter(o=>o.type==="income").reduce((o,s)=>o+parseFloat(s.amount||0),0),y=a.filter(o=>o.type==="income").reduce((o,s)=>o+parseFloat(s.net_amount||s.amount||0),0),u=a.filter(o=>o.type==="expense").reduce((o,s)=>o+parseFloat(s.amount||0),0),i=a.filter(o=>o.status==="overdue").reduce((o,s)=>o+parseFloat(s.amount||0),0);return{income:c,netIncome:y,expenses:u,netResult:y-u,overdue:i}}async function T(n,t={},e={},a={}){let r=d.from("financial_transactions").select(`
            *,
            patient:user_profiles!financial_transactions_patient_id_fkey(
                id,
                name
            )
        `,{count:"exact"}).eq("nutritionist_id",n);if(t.type&&(r=r.eq("type",t.type)),t.status&&(r=r.eq("status",t.status)),t.search&&(r=r.ilike("description",`%${t.search}%`)),t.month&&t.year){const s=w(new Date(t.year,t.month-1,1)),m=h(new Date(t.year,t.month-1,1));r=r.gte("transaction_date",l(s,"yyyy-MM-dd")).lte("transaction_date",l(m,"yyyy-MM-dd"))}const c=a.field||"transaction_date",y=a.order||"desc";if(r=r.order(c,{ascending:y==="asc"}),e.page&&e.pageSize){const s=(e.page-1)*e.pageSize,m=s+e.pageSize-1;r=r.range(s,m)}const{data:u,error:i,count:o}=await r;if(i)throw console.error("Error fetching transactions:",i),i;return{data:u||[],total:o||0}}async function k(n){const{id:t,...e}=n;e.status||(e.status=e.isPaid?"paid":"pending"),e.status==="pending"&&!e.due_date&&(e.due_date=e.transaction_date),delete e.isPaid;let a;t?a=d.from("financial_transactions").update(e).eq("id",t).select().single():a=d.from("financial_transactions").insert(e).select().single();const{data:r,error:c}=await a;if(c)throw console.error("Error saving transaction:",c),c;return r}async function P(n){const{error:t}=await d.from("financial_transactions").delete().eq("id",n);if(t)throw console.error("Error deleting transaction:",t),t}async function j(n,t,e="day"){const a=w(t),r=h(t),{data:c,error:y}=await d.from("financial_transactions").select("transaction_date, type, amount").eq("nutritionist_id",n).gte("transaction_date",l(a,"yyyy-MM-dd")).lte("transaction_date",l(r,"yyyy-MM-dd")).order("transaction_date",{ascending:!0});if(y)throw console.error("Error fetching cash flow data:",y),y;const u={};return c.forEach(i=>{const o=new Date(i.transaction_date);let s;if(e==="week"){const m=new Date(o);m.setDate(o.getDate()-o.getDay()),s=l(m,"yyyy-MM-dd")}else s=l(o,"yyyy-MM-dd");u[s]||(u[s]={date:s,income:0,expenses:0}),i.type==="income"?u[s].income+=parseFloat(i.amount||0):u[s].expenses+=parseFloat(i.amount||0)}),Object.values(u).sort((i,o)=>i.date.localeCompare(o.date))}async function C(n,t){const e=w(t),a=h(t),{data:r,error:c}=await d.from("financial_transactions").select("category, amount").eq("nutritionist_id",n).eq("type","expense").gte("transaction_date",l(e,"yyyy-MM-dd")).lte("transaction_date",l(a,"yyyy-MM-dd"));if(c)throw console.error("Error fetching expense distribution:",c),c;const y={};return r.forEach(u=>{const i=u.category||"outros";y[i]||(y[i]=0),y[i]+=parseFloat(u.amount||0)}),Object.entries(y).map(([u,i])=>({name:u.charAt(0).toUpperCase()+u.slice(1).replace("_"," "),value:i}))}async function z(n,t){const e=D(t),a=E(e,30),{data:r,error:c}=await d.from("financial_transactions").select("type, net_amount, amount").eq("nutritionist_id",n).eq("status","paid");if(c)throw console.error("Error fetching paid transactions for balance:",c),c;let y=0;r.forEach(f=>{const g=parseFloat(f.net_amount||f.amount||0);f.type==="income"?y+=g:y-=g});const{data:u,error:i}=await d.from("financial_transactions").select("type, net_amount, amount, due_date, transaction_date").eq("nutritionist_id",n).eq("status","pending").gte("due_date",l(e,"yyyy-MM-dd")).lte("due_date",l(a,"yyyy-MM-dd")),{data:o,error:s}=await d.from("financial_transactions").select("type, net_amount, amount, due_date, transaction_date").eq("nutritionist_id",n).eq("status","pending").is("due_date",null).gte("transaction_date",l(e,"yyyy-MM-dd")).lte("transaction_date",l(a,"yyyy-MM-dd"));if(i||s)throw console.error("Error fetching pending transactions:",i||s),i||s;const m=[...u||[],...o||[]],_={};m.forEach(f=>{const g=f.due_date||f.transaction_date;if(!g)return;const p=l(F(g),"yyyy-MM-dd");_[p]||(_[p]={income:0,expenses:0});const v=parseFloat(f.net_amount||f.amount||0);f.type==="income"?_[p].income+=v:_[p].expenses+=v});const q=[];let M=y;for(let f=0;f<=30;f++){const g=E(e,f),p=l(g,"yyyy-MM-dd");_[p]&&(M+=_[p].income,M-=_[p].expenses),q.push({date:p,balance:Math.round(M*100)/100})}return q}async function B(n){const{data:t,error:e}=await d.from("user_profiles").select("id, name").eq("nutritionist_id",n).order("name",{ascending:!0});if(e)throw console.error("Error fetching patients:",e),e;return t||[]}async function A(n){const{data:t,error:e}=await d.from("services").select("*").eq("nutritionist_id",n).eq("is_active",!0).order("name",{ascending:!0});if(e)throw console.error("Error fetching services:",e),e;return t||[]}async function I(n){const{id:t,...e}=n;e.updated_at=new Date().toISOString();let a;t?a=d.from("services").update(e).eq("id",t).select().single():a=d.from("services").insert(e).select().single();const{data:r,error:c}=await a;if(c)throw console.error("Error saving service:",c),c;return r}async function K(n){const{error:t}=await d.from("services").update({is_active:!1,updated_at:new Date().toISOString()}).eq("id",n);if(t)throw console.error("Error deleting service:",t),t}async function W(n){const{data:t,error:e}=await d.from("financial_transactions").insert(n).select();if(e)throw console.error("Error saving multiple transactions:",e),e;return t||[]}async function N(n){const t=l(new Date,"yyyy-MM-dd"),{data:e,error:a}=await d.from("financial_transactions").select(`
            *,
            patient:user_profiles!financial_transactions_patient_id_fkey(
                id,
                name
            )
        `).eq("nutritionist_id",n).eq("type","income").eq("status","pending").lte("transaction_date",t).order("transaction_date",{ascending:!0});if(a)throw console.error("Error fetching pending payments:",a),a;return e||[]}async function R(n,t){const{data:e,error:a}=await d.from("financial_transactions").update({status:t}).eq("id",n).select().single();if(a)throw console.error("Error updating transaction status:",a),a;return e}async function U(n,t){const{data:e,error:a}=await d.from("financial_transactions").update({transaction_date:t,due_date:t}).eq("id",n).select().single();if(a)throw console.error("Error rescheduling transaction:",a),a;return e}export{N as a,P as b,b as c,K as d,T as e,j as f,A as g,C as h,z as i,B as j,W as k,k as l,U as r,I as s,R as u};
