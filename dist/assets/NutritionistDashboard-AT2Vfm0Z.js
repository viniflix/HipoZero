import{q as se,r as l,u as q,j as e,C as j,c as N,d as C,w as $,e as w,L as X,X as ae,D as re,x as ne,B as R,y as ie,z as D,E as z,F as G,G as le,s as v,H as Z,b as B,I as oe,J as ce,K as de,M as me,a as xe,N as he,O,m as pe,P as ue,Q as fe}from"./index-CzP_nI2M.js";import{I as ge}from"./input-DpEF2plu.js";import{t as je}from"./mealTranslations-B1KHhmEq.js";import{S as Ne}from"./search-Cz9zTWBR.js";import{F as we}from"./filter-DqqEoVtD.js";import{W as U}from"./weight-CPzu1rZ1.js";import{B as ye}from"./badge-NOGldadv.js";import{g as be,a as ve}from"./patient-queries-BXknbmTx.js";import{C as _e}from"./calculator-CIVz4-s9.js";import{B as Ce}from"./book-open-VyjWFNnY.js";import{C as ke}from"./clock-Bx-qP7aU.js";import{A as Se}from"./alert-triangle-BiGZoyHD.js";import{S as _}from"./skeleton-DOplORX0.js";import{U as V}from"./users-BsM0tOxm.js";import{C as Ae}from"./calendar-days-B4pBU107.js";import{p as Pe}from"./parseISO-BczzEZ0Y.js";const J=se("PenLine",[["path",{d:"M12 20h9",key:"t2du7b"}],["path",{d:"M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z",key:"ymcmye"}]]),De=()=>{const[d,r]=l.useState([]),[x,i]=l.useState(!0),[p,y]=l.useState(""),[o,c]=l.useState("all"),{user:t}=q();l.useEffect(()=>{(async()=>{if(t?.id){i(!0);try{const{data:u}=await v.from("user_profiles").select("id, name").eq("nutritionist_id",t.id).eq("user_type","patient");if(!u||u.length===0){r([]),i(!1);return}const M=u.map(n=>n.id),I=Object.fromEntries(u.map(n=>[n.id,n])),S=[],[A,P]=await Promise.all([v.from("meal_audit_log").select("id, patient_id, action, meal_type, details, created_at").in("patient_id",M).order("created_at",{ascending:!1}).limit(100),v.from("growth_records").select("id, patient_id, weight, created_at").in("patient_id",M).order("created_at",{ascending:!1}).limit(100)]);A.data&&A.data.forEach(n=>{const f=I[n.patient_id];if(f){const L=n.details?.total_calories||0;let h="",b="";n.action==="create"?(h="registrou",b="meal"):n.action==="update"?(h="editou",b="edit"):n.action==="delete"&&(h="deletou",b="delete"),S.push({id:`audit-${n.id}`,type:b,patient_name:f.name,description:h,meal_type:je(n.meal_type),detail:`${L} kcal`,timestamp:n.created_at})}}),P.data&&P.data.forEach(n=>{const f=I[n.patient_id];f&&S.push({id:`weight-${n.id}`,type:"weight",patient_name:f.name,description:"registrou peso",detail:`${n.weight} kg`,timestamp:n.created_at})}),S.sort((n,f)=>new Date(f.timestamp)-new Date(n.timestamp)),r(S)}catch(u){console.error("Erro ao buscar atualizações:",u),r([])}i(!1)}})()},[t]);const k=a=>{switch(a){case"meal":return e.jsx(z,{className:"h-5 w-5 text-secondary"});case"weight":return e.jsx(U,{className:"h-5 w-5 text-primary"});case"edit":return e.jsx(J,{className:"h-5 w-5 text-blue-600"});case"delete":return e.jsx(G,{className:"h-5 w-5 text-red-600"});default:return null}},s=d.filter(a=>!(o!=="all"&&a.type!==o||p&&!a.patient_name.toLowerCase().includes(p.toLowerCase())));return x?e.jsxs(j,{className:"bg-card shadow-card-dark rounded-xl",children:[e.jsxs(N,{children:[e.jsx(C,{className:"font-clash text-lg font-semibold text-primary",children:"Registros Recentes"}),e.jsx($,{className:"text-muted-foreground",children:"Carregando..."})]}),e.jsx(w,{className:"flex items-center justify-center py-10",children:e.jsx(X,{className:"w-6 h-6 animate-spin text-primary"})})]}):e.jsxs(j,{className:"bg-card shadow-card-dark rounded-xl",children:[e.jsxs(N,{className:"pb-3",children:[e.jsx(C,{className:"font-clash text-lg font-semibold text-primary",children:"Registros Recentes"}),e.jsx($,{className:"text-muted-foreground",children:"Últimos registros dos seus pacientes"}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Ne,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ge,{placeholder:"Pesquisar por paciente...",value:p,onChange:a=>y(a.target.value),className:"pl-9 pr-9"}),p&&e.jsx("button",{onClick:()=>y(""),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-muted-foreground hover:text-foreground",children:e.jsx(ae,{className:"h-4 w-4"})})]}),e.jsxs(re,{children:[e.jsx(ne,{asChild:!0,children:e.jsx(R,{variant:"outline",size:"icon",children:e.jsx(we,{className:"h-4 w-4"})})}),e.jsxs(ie,{align:"end",children:[e.jsx(D,{onClick:()=>c("all"),children:e.jsx("span",{className:o==="all"?"font-semibold":"",children:"Todos"})}),e.jsxs(D,{onClick:()=>c("meal"),children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:o==="meal"?"font-semibold":"",children:"Refeições"})]}),e.jsxs(D,{onClick:()=>c("weight"),children:[e.jsx(U,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:o==="weight"?"font-semibold":"",children:"Peso"})]}),e.jsxs(D,{onClick:()=>c("edit"),children:[e.jsx(J,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:o==="edit"?"font-semibold":"",children:"Edições"})]}),e.jsxs(D,{onClick:()=>c("delete"),children:[e.jsx(G,{className:"h-4 w-4 mr-2"}),e.jsx("span",{className:o==="delete"?"font-semibold":"",children:"Exclusões"})]})]})]})]})]}),e.jsx(w,{children:s.length===0?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:p||o!=="all"?"Nenhum registro encontrado com os filtros aplicados":"Nenhum registro recente."})}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-xs text-muted-foreground mb-3",children:[s.length," ",s.length===1?"registro":"registros"]}),e.jsx("div",{className:"space-y-3 max-h-[400px] overflow-y-auto pr-2",children:s.map(a=>e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"bg-muted p-2 rounded-full flex-shrink-0",children:k(a.type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("p",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold text-primary",children:a.patient_name})," ",e.jsx("span",{className:"text-foreground",children:a.description}),a.meal_type&&e.jsxs(e.Fragment,{children:[" seu ",e.jsx("span",{className:"font-semibold text-foreground",children:a.meal_type})]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[a.detail&&`${a.detail} • `,le(new Date(a.timestamp),{addSuffix:!0,locale:Z})]})]})]},a.id))})]})})]})},E=({title:d,icon:r,items:x,color:i,onItemClick:p,defaultExpanded:y=!1})=>{const[o,c]=l.useState(y);return x.length===0?null:e.jsxs("div",{className:`rounded-lg border-2 border-${i}/20 bg-${i}/5 overflow-hidden`,children:[e.jsxs("button",{onClick:()=>c(!o),className:`w-full flex items-center justify-between p-4 hover:bg-${i}/10 transition-colors`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-full bg-${i}/20`,children:e.jsx(r,{className:`h-5 w-5 text-${i}`})}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:d}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[x.length," ",x.length===1?"paciente":"pacientes"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ye,{variant:"outline",className:`border-${i} text-${i}`,children:x.length}),o?e.jsx(ce,{className:`h-5 w-5 text-${i}`}):e.jsx(de,{className:`h-5 w-5 text-${i}`})]})]}),o&&e.jsx("div",{className:"border-t-2 border-border",children:e.jsx("div",{className:"max-h-[300px] overflow-y-auto",children:x.map((t,k)=>e.jsxs("div",{onClick:()=>p(t),className:`flex items-center justify-between p-4 hover:bg-${i}/10 transition-colors cursor-pointer border-b border-border last:border-b-0 group`,children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:t.patient_name||t.name}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:t.detail||t.description})]}),e.jsx(me,{className:`h-4 w-4 text-muted-foreground group-hover:text-${i} transition-colors flex-shrink-0 ml-2`})]},k))})})]})},Ee=()=>{const[d,r]=l.useState([]),[x,i]=l.useState([]),[p,y]=l.useState(!0),{user:o}=q(),c=B();if(l.useEffect(()=>{(async()=>{if(o?.id){y(!0);try{const[a,u]=await Promise.all([be(o.id),ve(o.id)]);r(a.data||[]),i(u.data||[])}catch(a){console.error("Erro ao buscar alertas:",a)}y(!1)}})()},[o]),p)return e.jsxs(j,{className:"bg-card shadow-card-dark rounded-xl",children:[e.jsxs(N,{children:[e.jsx(C,{className:"font-clash text-lg font-semibold text-primary",children:"Feed de Atividades"}),e.jsx($,{className:"text-muted-foreground",children:"Carregando..."})]}),e.jsx(w,{className:"flex items-center justify-center py-10",children:e.jsx(X,{className:"w-6 h-6 animate-spin text-primary"})})]});const t={low_adherence:{title:"Baixa Adesão",icon:ke,color:"secondary",items:d.map(s=>({...s,patient_name:s.name,detail:s.days_inactive===null?"Sem registros de refeição":`Sem registros há ${s.days_inactive} dia${s.days_inactive!==1?"s":""}`,route:`/nutritionist/patients/${s.id}`}))},anamnesis:{title:"Anamnese Pendente",icon:oe,color:"primary",items:[]},anthropometry:{title:"Avaliação Pendente",icon:U,color:"primary",items:[]},meal_plan:{title:"Plano Alimentar Pendente",icon:Ce,color:"primary",items:[]},prescription:{title:"Cálculo Pendente",icon:_e,color:"primary",items:[]}};x.forEach(s=>{s.pending_items.forEach(a=>{t[a.type]&&t[a.type].items.push({patient_name:s.patient_name,detail:a.label,route:a.route})})});const k=Object.values(t).reduce((s,a)=>s+a.items.length,0);return e.jsxs(j,{className:"bg-card shadow-card-dark rounded-xl",children:[e.jsxs(N,{children:[e.jsx(C,{className:"font-clash text-lg font-semibold text-primary",children:"Feed de Atividades"}),e.jsx($,{className:"text-muted-foreground",children:"Alertas e pendências dos seus pacientes"})]}),e.jsx(w,{children:k===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Se,{className:"w-12 h-12 text-muted-foreground/50 mx-auto mb-3"}),e.jsx("p",{className:"text-muted-foreground font-medium mb-1",children:"Tudo em dia!"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Não há alertas ou pendências no momento"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx(E,{title:t.low_adherence.title,icon:t.low_adherence.icon,items:t.low_adherence.items,color:t.low_adherence.color,onItemClick:s=>c(s.route)}),e.jsx(E,{title:t.anamnesis.title,icon:t.anamnesis.icon,items:t.anamnesis.items,color:t.anamnesis.color,onItemClick:s=>c(s.route)}),e.jsx(E,{title:t.anthropometry.title,icon:t.anthropometry.icon,items:t.anthropometry.items,color:t.anthropometry.color,onItemClick:s=>c(s.route)}),e.jsx(E,{title:t.meal_plan.title,icon:t.meal_plan.icon,items:t.meal_plan.items,color:t.meal_plan.color,onItemClick:s=>c(s.route)}),e.jsx(E,{title:t.prescription.title,icon:t.prescription.icon,items:t.prescription.items,color:t.prescription.color,onItemClick:s=>c(s.route)})]})})]})};function F(){return e.jsxs(j,{className:"bg-card shadow-card-dark rounded-xl",children:[e.jsx(N,{className:"pb-2",children:e.jsx(_,{className:"h-4 w-32"})}),e.jsxs(w,{children:[e.jsx(_,{className:"h-10 w-20 mb-2"}),e.jsx(_,{className:"h-3 w-40"})]})]})}function K(){return e.jsxs(j,{className:"bg-card shadow-card-dark rounded-xl",children:[e.jsxs(N,{className:"pb-3",children:[e.jsx(_,{className:"h-5 w-48 mb-2"}),e.jsx(_,{className:"h-4 w-64"})]}),e.jsx(w,{className:"space-y-3",children:[1,2,3].map(d=>e.jsxs("div",{className:"flex items-start gap-3 p-3 rounded-lg border border-border",children:[e.jsx(_,{className:"h-10 w-10 rounded-full flex-shrink-0"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(_,{className:"h-4 w-3/4"}),e.jsx(_,{className:"h-3 w-1/2"})]})]},d))})]})}const Q=({appointments:d})=>{const r=B();return e.jsxs(j,{className:"bg-card shadow-card-dark rounded-xl",children:[e.jsxs(N,{children:[e.jsx(C,{className:"font-clash text-lg font-semibold text-primary",children:"Próximas Consultas"}),e.jsx($,{className:"text-muted-foreground",children:"Seus próximos agendamentos."})]}),e.jsx(w,{children:d.length>0?e.jsxs("div",{className:"space-y-4",children:[d.map(x=>{const i=x.patient;return e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-emerald-100 flex-shrink-0 flex items-center justify-center",children:e.jsx("span",{className:"font-semibold text-emerald-700",children:(i?.name||"P").substring(0,2).toUpperCase()})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:i?.name||"Paciente (Excluído)"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:O(Pe(x.appointment_time),"d 'de' MMMM 'às' HH:mm",{locale:Z})})]})]},x.id)}),e.jsx(R,{variant:"outline",size:"sm",className:"w-full mt-2",onClick:()=>r("/nutritionist/agenda"),children:"Ver agenda completa"})]}):e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Nenhuma consulta agendada."})})]})};function Je(){const{toast:d}=xe(),{user:r,signOut:x}=q(),{unreadSenders:i}=he(),p=B(),[y,o]=l.useState([]),[c,t]=l.useState([]),[k,s]=l.useState(0),[a,u]=l.useState("--%"),[M,I]=l.useState(!1),[S,A]=l.useState(!0),[P,n]=l.useState(!0),f=l.useCallback(async()=>{if(!(!r||!r.id)){A(!0);try{const h=new Date().toISOString(),b=new Date().toISOString().split("T")[0],T=O(new Date,"MM-dd"),[H,Y,ee,W]=await Promise.all([v.from("user_profiles").select("id, name, birth_date").eq("nutritionist_id",r.id).eq("is_active",!0).order("name",{ascending:!0}).then(({data:g,error:m})=>{if(m)throw m;return g||[]}),v.from("notifications").select("*",{count:"exact",head:!0}).eq("user_id",r.id).eq("is_read",!1).then(({count:g,error:m})=>{if(m)throw m;return g||0}),v.from("appointments").select("*",{count:"exact",head:!0}).eq("nutritionist_id",r.id).gte("appointment_time",`${b}T00:00:00`).lte("appointment_time",`${b}T23:59:59`).then(({count:g,error:m})=>{if(m)throw m;return g||0}),v.rpc("get_daily_adherence",{p_nutritionist_id:r.id}).then(({data:g,error:m})=>{if(m)throw m;return g})]);o(H);const te=H.filter(g=>{if(!g.birth_date)return!1;const m=new Date(g.birth_date);return m.setHours(m.getHours()+4),O(m,"MM-dd")===T}).length;s(Y+ee+te),u(W?Math.round(W)+"%":"--%")}catch(h){console.error("Erro ao carregar estatísticas:",h),d({title:"Erro ao carregar estatísticas",description:h.message,variant:"destructive"})}finally{A(!1)}}},[r,d]),L=l.useCallback(async()=>{if(!(!r||!r.id)){n(!0);try{const h=new Date().toISOString(),{data:b,error:T}=await v.from("appointments").select("id, appointment_time, patient:appointments_patient_id_fkey(id, name, avatar_url)").eq("nutritionist_id",r.id).gte("appointment_time",h).order("appointment_time",{ascending:!0}).limit(3);if(T)throw T;t(b||[])}catch(h){console.error("Erro ao carregar agendamentos:",h),d({title:"Erro ao carregar agendamentos",description:h.message,variant:"destructive"})}finally{n(!1)}}},[r,d]);return l.useEffect(()=>{r?.id&&(f(),L())},[r?.id,f,L]),e.jsxs("div",{className:"flex flex-col min-h-screen bg-background",children:[e.jsxs(pe.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"max-w-7xl mx-auto w-full px-4 md:px-8 pt-8",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8 text-center sm:text-left",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold font-heading uppercase tracking-wide text-primary",children:"Dashboard"}),e.jsx("p",{className:"text-neutral-600",children:"Gerencie seus pacientes, Planos e Análises."})]}),e.jsx("div",{className:"flex gap-2 flex-wrap justify-center sm:justify-end",children:e.jsxs(R,{variant:"secondary",onClick:()=>p("/nutritionist/patients"),children:[e.jsx(V,{className:"h-4 w-4 mr-2"}),"Ver todos os pacientes"]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-8 lg:order-last order-3",children:[e.jsx("div",{className:"hidden lg:block",children:P?e.jsx(K,{}):e.jsx(Q,{appointments:c})}),e.jsx(De,{})]}),e.jsxs("div",{className:"lg:col-span-2 space-y-8 lg:order-first order-1",children:[e.jsx("div",{className:"grid gap-4 grid-cols-2 lg:grid-cols-3 mb-6",children:S?e.jsxs(e.Fragment,{children:[e.jsx(F,{}),e.jsx(F,{}),e.jsx("div",{className:"col-span-2 lg:col-span-1",children:e.jsx(F,{})})]}):e.jsxs(e.Fragment,{children:[e.jsxs(j,{className:"bg-primary text-white border-0 shadow-card-dark",children:[e.jsxs(N,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsxs(C,{className:"font-heading uppercase text-xs lg:text-sm font-medium text-white/80 tracking-wide leading-tight",children:["Total de",e.jsx("br",{className:"lg:hidden"})," Pacientes"]}),e.jsx(V,{className:"h-5 w-5 lg:h-6 lg:w-6 text-white/80 flex-shrink-0"})]}),e.jsxs(w,{children:[e.jsx("div",{className:"text-3xl lg:text-4xl font-bold text-white",children:y.length}),e.jsx("p",{className:"text-xs text-white/70",children:"Pacientes ativos"})]})]}),e.jsxs(j,{className:"bg-neutral-800 text-white border-0 shadow-card-dark lg:order-3",children:[e.jsxs(N,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsxs(C,{className:"font-heading uppercase text-xs lg:text-sm font-medium text-white/80 tracking-wide leading-tight",children:["Alertas do",e.jsx("br",{className:"lg:hidden"})," Dia"]}),e.jsx(ue,{className:"h-5 w-5 lg:h-6 lg:w-6 text-white/80 flex-shrink-0"})]}),e.jsxs(w,{children:[e.jsx("div",{className:"text-3xl lg:text-4xl font-bold text-white",children:k}),e.jsxs("p",{className:"text-xs text-white/70 leading-tight",children:["Consultas e",e.jsx("br",{className:"lg:hidden"})," notificações"]})]})]}),e.jsxs(j,{className:"bg-secondary text-white border-0 shadow-card-dark col-span-2 lg:col-span-1 lg:order-2",children:[e.jsxs(N,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(C,{className:"font-heading uppercase text-xs lg:text-sm font-medium text-white/80 tracking-wide leading-tight",children:"Consultas Agendadas"}),e.jsx(Ae,{className:"h-5 w-5 lg:h-6 lg:w-6 text-white/80 flex-shrink-0"})]}),e.jsxs(w,{children:[e.jsx("div",{className:"text-3xl lg:text-4xl font-bold text-white",children:c.length}),e.jsx("p",{className:"text-xs text-white/70",children:"Próximas consultas"})]})]})]})}),e.jsx(Ee,{})]}),e.jsx("div",{className:"lg:hidden order-2",children:P?e.jsx(K,{}):e.jsx(Q,{appointments:c})})]})]}),e.jsx(fe,{isOpen:M,setIsOpen:I})]})}export{Je as default};
