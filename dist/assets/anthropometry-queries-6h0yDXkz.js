import{s as n}from"./index-BvWB-6Y-.js";import{l as u}from"./query-helpers-mbysFH2_.js";import{t as S}from"./patient-queries-DNM8Wnzg.js";const p=a=>{const e=String(a?.message||"").toLowerCase();return e.includes("column")&&(e.includes("supersedes_record_id")||e.includes("revision_group_id")||e.includes("revision_number")||e.includes("is_latest_revision")||e.includes("change_reason")||e.includes("created_by_user_id"))},B=async(a,e={})=>{const{limit:t=50,offset:r=0,orderBy:s="record_date",ascending:o=!1,latestOnly:l=!1}=e;try{const i=()=>n.from("growth_records").select("*").eq("patient_id",a).order(s,{ascending:o}).range(r,r+t-1);if(l){const{data:g,error:d}=await i().eq("is_latest_revision",!0);if(!d)return{data:g||[],error:null};if(!p(d))throw d}const{data:_,error:c}=await i();if(c)throw c;return{data:_||[],error:null}}catch(i){return u("Erro ao buscar registros antropométricos",i),{data:[],error:i}}},C=async a=>{try{const e=()=>n.from("growth_records").select("id, weight, height, record_date").eq("patient_id",a).order("record_date",{ascending:!0});let t,r;if({data:t,error:r}=await e().eq("is_latest_revision",!0),r&&!p(r)||(r&&p(r)&&({data:t,error:r}=await e()),r))throw r;return{data:(t||[]).map(o=>{const l=o.height&&o.weight?o.weight/Math.pow(o.height/100,2):null;return{...o,bmi:l,calculatedBmi:l}}),error:null}}catch(e){return u("Erro ao buscar dados para gráficos",e),{data:[],error:e}}},L=async a=>{try{const{patient_id:e,weight:t,height:r,record_date:s,notes:o,circumferences:l,skinfolds:i,bone_diameters:_,bioimpedance:c,photos:g,results:d,supersedes_record_id:f,change_reason:y,created_by_user_id:w}=a,b={patient_id:e,weight:t,height:r,record_date:s,notes:o||null,...l&&{circumferences:l},...i&&{skinfolds:i},..._&&{bone_diameters:_},...c&&{bioimpedance:c},...g&&{photos:g},...d&&{results:d},...f&&{supersedes_record_id:f},...y&&{change_reason:y},...w&&{created_by_user_id:w}};let{data:m,error:h}=await n.from("growth_records").insert([b]).select().single();if(h&&p(h)){const{supersedes_record_id:E,change_reason:q,created_by_user_id:D,...v}=b;({data:m,error:h}=await n.from("growth_records").insert([v]).select().single())}if(h)throw h;return await S({eventName:"anthropometry.record.created",sourceModule:"anthropometry",patientId:m?.patient_id||e,nutritionistId:m?.nutritionist_id||null,payload:{record_id:m?.id||null,record_date:m?.record_date||s||null}}),{data:m,error:null}}catch(e){return u("Erro ao criar registro antropométrico",e),{data:null,error:e}}},O=async a=>{try{const{data:e,error:t}=await n.from("growth_records").delete().eq("id",a).select().single();if(t)throw t;return await S({eventName:"anthropometry.record.deleted",sourceModule:"anthropometry",patientId:e?.patient_id||null,nutritionistId:e?.nutritionist_id||null,payload:{record_id:e?.id||a}}),{data:e,error:null}}catch(e){return u("Erro ao deletar registro antropométrico",e),{data:null,error:e}}},P=async a=>{try{const e=()=>n.from("growth_records").select("weight, height, notes").eq("patient_id",a).order("record_date",{ascending:!1}).limit(1);let t,r;if({data:t,error:r}=await e().eq("is_latest_revision",!0).maybeSingle(),r&&!p(r)||(r&&p(r)&&({data:t,error:r}=await e().maybeSingle()),r))throw r;return{data:t,error:null}}catch(e){return u("Erro ao buscar último registro",e),{data:null,error:e}}},Q=async a=>{try{const{data:e,error:t}=await n.rpc("get_anthropometry_longitudinal_score",{p_patient_id:a});if(t)throw t;return{data:e||null,error:null}}catch(e){return u("Erro ao buscar score longitudinal antropométrico",e),{data:null,error:e}}},k=async a=>{try{const{data:e,error:t}=await n.from("patient_module_sync_flags").select("*").eq("patient_id",a).maybeSingle();if(t)throw t;return{data:e||null,error:null}}catch(e){return u("Erro ao buscar flags de sincronização de módulos",e),{data:null,error:e}}},x=async(a,e={})=>{const{energy:t=!1,mealPlan:r=!1}=e;try{const{data:s,error:o}=await n.from("patient_module_sync_flags").select("patient_id").eq("patient_id",a).maybeSingle();if(o)throw o;const l={patient_id:a,updated_at:new Date().toISOString(),...t?{needs_energy_recalc:!1}:{},...r?{needs_meal_plan_review:!1}:{}};if(s?.patient_id){const{data:g,error:d}=await n.from("patient_module_sync_flags").update(l).eq("patient_id",a).select().maybeSingle();if(d)throw d;return{data:g,error:null}}const i={patient_id:a,anthropometry_updated_at:null,needs_energy_recalc:!1,needs_meal_plan_review:!1,updated_at:new Date().toISOString()},{data:_,error:c}=await n.from("patient_module_sync_flags").insert(i).select().maybeSingle();if(c)throw c;return{data:_,error:null}}catch(s){return u("Erro ao limpar flags de sincronização de módulos",s),{data:null,error:s}}};export{B as a,C as b,Q as c,k as d,L as e,O as f,P as g,x as h};
