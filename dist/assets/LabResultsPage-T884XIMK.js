import{a5 as we,b as ye,a as Ce,r as t,s as Fe,j as e,B as l,C,e as F,T as Y,J as z,K as T,M as O,N as V,ad as Z,X as ee,O as B,L as se,$ as De,t as Ee}from"./index-qjbGaV1R.js";import{I as f}from"./input-DMmXNW5d.js";import{D as Pe}from"./date-input-UcZ3CJMj.js";import{L as m}from"./label-TnYOms6c.js";import{B as ae}from"./badge-Du_-s9xo.js";import{S as Se,a as Le,b as Ae,c as Re,d as g}from"./select-DG44e7yv.js";import{g as q}from"./date-C2sroe8F.js";import{a as ke,c as ze,u as Te,d as Oe,b as Ve,e as Be,f as qe}from"./lab-results-queries-Rsfr3edC.js";import{A as Me}from"./arrow-left-DncQmOX0.js";import{D as M}from"./droplet-OqU81R6S.js";import{P as te}from"./plus-D0VXwTZj.js";import{S as Ie}from"./search-CZaMVAuB.js";import{F as p}from"./file-text-sauH5YB4.js";import{C as Ue}from"./calendar-CuwgVPpP.js";import{E as re}from"./eye-Bb_eQPku.js";import{P as le}from"./pen-square-DMkr_5gI.js";import{U as $e}from"./upload-CNWHNRq6.js";import{S as He}from"./save-BFnQGCtf.js";import{A as Ge}from"./alert-circle-Bmhv_HxM.js";import{D as Je}from"./download-CCo5fqfe.js";import"./calendar-BroojJTJ.js";import"./endOfMonth-Dlk4l2Ma.js";import"./addMonths-ChI471e9.js";import"./isSameDay-BT2gHB-J.js";import"./chevron-left-Klv_B5pP.js";import"./popover-BDxVETTl.js";import"./extends-CF3RwP-h.js";import"./pt-BR-Dk83-zmM.js";import"./parseISO-CVV90SIz.js";import"./query-helpers-CC2p4I3d.js";const ys=()=>{const{patientId:h}=we(),ne=ye(),{toast:i}=Ce(),[ie,I]=t.useState(!0),[D,U]=t.useState(!1),[oe,ce]=t.useState(""),[x,de]=t.useState([]),[v,me]=t.useState([]),[xe,E]=t.useState(!1),[n,P]=t.useState(null),[ue,N]=t.useState(!1),[S,$]=t.useState(null),[he,L]=t.useState(!1),[_,fe]=t.useState(null),[o,j]=t.useState(null),[b,H]=t.useState(!1),G=t.useRef(null),[a,A]=t.useState({test_name:"",test_value:"",test_unit:"",reference_min:"",reference_max:"",test_date:q(),notes:""}),[w,pe]=t.useState(""),[y,je]=t.useState("all");t.useEffect(()=>{ge(),R()},[h]),t.useEffect(()=>{ve()},[x,w,y]);const ge=async()=>{try{const{data:s}=await Fe.from("user_profiles").select("name").eq("id",h).single();s&&ce(s.name)}catch(s){console.error("Erro ao carregar dados do paciente:",s)}},R=async()=>{I(!0);try{const{data:s,error:r}=await ke(h);if(r)throw r;de(s||[])}catch(s){console.error("Erro ao carregar exames:",s),i({title:"Erro",description:"Não foi possível carregar os exames.",variant:"destructive"})}finally{I(!1)}},ve=()=>{let s=[...x];w&&(s=s.filter(r=>r.test_name.toLowerCase().includes(w.toLowerCase()))),y!=="all"&&(s=s.filter(r=>r.status===y)),me(s)},k=(s=null)=>{s?(P(s),A({test_name:s.test_name,test_value:s.test_value||"",test_unit:s.test_unit||"",reference_min:s.reference_min?.toString()||"",reference_max:s.reference_max?.toString()||"",test_date:s.test_date,notes:s.notes||""}),j(null)):(P(null),A({test_name:"",test_value:"",test_unit:"",reference_min:"",reference_max:"",test_date:q(),notes:""}),j(null)),E(!0)},J=()=>{E(!1),P(null),j(null)},Ne=s=>{const r=s.target.files?.[0];if(r){if(r.type!=="application/pdf"){i({title:"Tipo de arquivo inválido",description:"Apenas arquivos PDF são permitidos.",variant:"destructive"});return}if(r.size>10*1024*1024){i({title:"Arquivo muito grande",description:"O arquivo deve ter no máximo 10MB.",variant:"destructive"});return}j(r)}},K=s=>{fe(s),L(!0)},u=(s,r)=>{A(c=>({...c,[s]:r}))},_e=async()=>{if(!a.test_name||!a.test_date){i({title:"Campos obrigatórios",description:"Preencha nome do exame e data.",variant:"destructive"});return}const s=a.test_value&&a.test_value.trim()!=="",r=o||n?.pdf_url;if(!s&&!r){i({title:"Dados obrigatórios",description:"Preencha os valores do exame OU anexe um PDF (ou ambos).",variant:"destructive"});return}U(!0),H(!0);try{let c=n?.pdf_url||null,X=n?.pdf_filename||null;if(o){const d=await Te(h,o);if(d.error)throw new Error(d.error.message||"Erro ao fazer upload do PDF");c=d.url,X=d.filename,n?.pdf_url&&await Oe(n.pdf_url)}const Q={patient_id:h,test_name:a.test_name,test_date:a.test_date,notes:a.notes||null,test_value:a.test_value||null,test_unit:a.test_unit||null,reference_min:a.reference_min?parseFloat(a.reference_min):null,reference_max:a.reference_max?parseFloat(a.reference_max):null,pdf_url:c,pdf_filename:X};if(n){const{error:d}=await Ve(n.id,Q);if(d)throw d;i({title:"Atualizado!",description:"Exame atualizado com sucesso."})}else{const{error:d}=await Be(Q);if(d)throw d;i({title:"Adicionado!",description:"Exame adicionado com sucesso."})}J(),R()}catch(c){console.error("Erro ao salvar exame:",c),i({title:"Erro",description:Ee(c,"Não foi possível salvar o exame."),variant:"destructive"})}finally{U(!1),H(!1)}},be=async()=>{if(S)try{const{error:s}=await qe(S.id);if(s)throw s;i({title:"Excluído!",description:"Exame excluído com sucesso."}),N(!1),$(null),R()}catch(s){console.error("Erro ao excluir exame:",s),i({title:"Erro",description:"Não foi possível excluir o exame.",variant:"destructive"})}},W=s=>{const r={normal:{label:"Normal",className:"bg-emerald-100 text-emerald-800 border-emerald-300"},low:{label:"Baixo",className:"bg-amber-100 text-amber-800 border-amber-300"},high:{label:"Alto",className:"bg-red-100 text-red-800 border-red-300"},pending:{label:"Pendente",className:"bg-gray-100 text-gray-800 border-gray-300"}},c=r[s]||r.pending;return e.jsx(ae,{variant:"outline",className:De("text-xs",c.className),children:c.label})};return ie?null:e.jsxs("div",{className:"flex flex-col min-h-screen bg-background overflow-x-hidden",children:[e.jsxs("div",{className:"max-w-7xl mx-auto w-full px-4 md:px-8 py-4 md:py-8 min-w-0",children:[e.jsxs("div",{className:"flex flex-col gap-4 mb-6",children:[e.jsxs(l,{variant:"ghost",size:"sm",onClick:()=>ne(`/nutritionist/patients/${h}/hub`),className:"-ml-2 w-fit text-[#5f6f52] hover:text-[#5f6f52] hover:bg-[#5f6f52]/10",children:[e.jsx(Me,{className:"w-4 h-4 mr-1"}),"Voltar"]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-end justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("h1",{className:"text-2xl md:text-3xl font-bold text-foreground flex items-center gap-2",children:[e.jsx(M,{className:"w-6 h-6 md:w-8 md:h-8 text-[#b99470]"}),e.jsx("span",{className:"truncate",children:"Exames Laboratoriais"})]}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1 truncate",children:["Paciente: ",e.jsx("span",{className:"font-medium text-foreground",children:oe})]})]}),e.jsxs(l,{onClick:()=>k(),className:"gap-2 w-full sm:w-auto",children:[e.jsx(te,{className:"w-4 h-4"}),"Adicionar Exame"]})]})]}),e.jsx(C,{className:"mb-6",children:e.jsx(F,{className:"pt-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(m,{htmlFor:"search",children:"Buscar exame"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ie,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(f,{id:"search",placeholder:"Digite o nome do exame...",value:w,onChange:s=>pe(s.target.value),className:"pl-10"})]})]}),e.jsxs("div",{children:[e.jsx(m,{htmlFor:"status-filter",children:"Filtrar por status"}),e.jsxs(Se,{value:y,onValueChange:je,children:[e.jsx(Le,{id:"status-filter",children:e.jsx(Ae,{})}),e.jsxs(Re,{children:[e.jsx(g,{value:"all",children:"Todos"}),e.jsx(g,{value:"normal",children:"Normal"}),e.jsx(g,{value:"low",children:"Baixo"}),e.jsx(g,{value:"high",children:"Alto"}),e.jsx(g,{value:"pending",children:"Pendente"})]})]})]})]})})}),v.length===0?e.jsx(C,{className:"border-dashed",children:e.jsxs(F,{className:"py-12 text-center",children:[e.jsx("div",{className:"w-16 h-16 rounded-full bg-muted flex items-center justify-center mx-auto mb-4",children:e.jsx(M,{className:"w-8 h-8 text-muted-foreground"})}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:x.length===0?"Nenhum exame registrado":"Nenhum resultado encontrado"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:x.length===0?"Adicione o primeiro exame laboratorial do paciente":"Tente ajustar os filtros de busca"}),x.length===0&&e.jsxs(l,{onClick:()=>k(),className:"gap-2",children:[e.jsx(te,{className:"w-4 h-4"}),"Adicionar Primeiro Exame"]})]})}):e.jsx("div",{className:"space-y-3",children:v.map(s=>e.jsx(C,{className:"hover:shadow-md transition-all",children:e.jsx(F,{className:"py-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2 flex-wrap",children:[e.jsx("h3",{className:"text-lg font-semibold truncate",children:s.test_name}),s.pdf_url&&e.jsxs(ae,{variant:"outline",className:"text-xs bg-blue-50 text-blue-700 border-blue-300",children:[e.jsx(p,{className:"w-3 h-3 mr-1"}),"PDF"]}),s.test_value&&s.status&&W(s.status)]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2 text-sm",children:[s.test_value&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Valor:"})," ",e.jsxs("span",{className:"font-medium",children:[s.test_value," ",s.test_unit||""]})]}),s.reference_min!=null&&s.reference_max!=null&&e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Referência:"})," ",e.jsxs("span",{className:"font-medium",children:[s.reference_min," - ",s.reference_max]})]})]}),s.pdf_url&&!s.test_value&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(p,{className:"w-3 h-3 text-muted-foreground"}),e.jsx("span",{className:"text-muted-foreground truncate",children:s.pdf_filename||"Arquivo PDF"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ue,{className:"w-3 h-3 text-muted-foreground"}),e.jsx("span",{className:"text-muted-foreground",children:new Date(s.test_date).toLocaleDateString("pt-BR")})]})]}),s.notes&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-2 italic",children:["Obs: ",s.notes]})]}),e.jsxs("div",{className:"flex gap-2",children:[s.pdf_url&&e.jsx(l,{variant:"outline",size:"icon",onClick:()=>K(s.pdf_url),title:"Visualizar PDF",children:e.jsx(re,{className:"w-4 h-4 text-blue-600"})}),e.jsx(l,{variant:"outline",size:"icon",onClick:()=>k(s),title:"Editar",children:e.jsx(le,{className:"w-4 h-4"})}),e.jsx(l,{variant:"outline",size:"icon",onClick:()=>{$(s),N(!0)},title:"Excluir",children:e.jsx(Y,{className:"w-4 h-4 text-destructive"})})]})]})})},s.id))}),x.length>0&&e.jsx(C,{className:"mt-6",children:e.jsx(F,{className:"py-4",children:e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Total de exames: ",e.jsx("strong",{children:x.length})]}),v.length!==x.length&&e.jsxs("span",{className:"text-muted-foreground",children:["Exibindo: ",e.jsx("strong",{children:v.length})]})]})})})]}),e.jsx(z,{open:xe,onOpenChange:E,children:e.jsxs(T,{className:"sm:max-w-[650px] max-h-[90vh] overflow-y-auto",children:[e.jsxs(O,{children:[e.jsxs(V,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5 text-primary"}),n?"Editar Exame":"Adicionar Novo Exame"]}),e.jsx(Z,{children:n?"Atualize as informações do exame":"Preencha valores e/ou anexe PDF"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"test_name",children:"Nome do Exame *"}),e.jsx(f,{id:"test_name",placeholder:"Ex: Hemograma, Glicemia, Colesterol Total",value:a.test_name,onChange:s=>u("test_name",s.target.value)})]}),e.jsxs("div",{className:"space-y-3 p-4 bg-muted/50 rounded-lg border border-muted",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium text-muted-foreground",children:[e.jsx(le,{className:"w-4 h-4"}),"Valores Manuais (opcional)"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"test_value",children:"Valor do Resultado"}),e.jsx(f,{id:"test_value",placeholder:"Ex: 95",value:a.test_value,onChange:s=>u("test_value",s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"test_unit",children:"Unidade"}),e.jsx(f,{id:"test_unit",placeholder:"Ex: mg/dL, ng/mL",value:a.test_unit,onChange:s=>u("test_unit",s.target.value)})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"reference_min",children:"Referência Mínima"}),e.jsx(f,{id:"reference_min",type:"number",step:"0.01",placeholder:"Ex: 70",value:a.reference_min,onChange:s=>u("reference_min",s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"reference_max",children:"Referência Máxima"}),e.jsx(f,{id:"reference_max",type:"number",step:"0.01",placeholder:"Ex: 100",value:a.reference_max,onChange:s=>u("reference_max",s.target.value)})]})]}),a.test_value&&a.reference_min&&a.reference_max&&e.jsxs("div",{className:"p-3 bg-background rounded-lg border",children:[e.jsx("div",{className:"text-xs font-medium text-muted-foreground mb-1",children:"Status calculado:"}),e.jsx("div",{children:W(ze(a.test_value,a.reference_min,a.reference_max))})]})]}),e.jsxs("div",{className:"space-y-3 p-4 bg-muted/50 rounded-lg border border-muted",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium text-muted-foreground",children:[e.jsx(p,{className:"w-4 h-4"}),"Anexar PDF (opcional)"]}),n?.pdf_url&&!o&&e.jsx("div",{className:"p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(p,{className:"w-4 h-4 text-green-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-green-900",children:"PDF anexado"}),e.jsx("div",{className:"text-xs text-green-700",children:n.pdf_filename})]})]}),e.jsxs(l,{type:"button",size:"sm",variant:"outline",onClick:()=>K(n.pdf_url),children:[e.jsx(re,{className:"w-4 h-4 mr-1"}),"Ver PDF"]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"pdf-upload",children:o||n?.pdf_url?"Substituir PDF":"Anexar PDF do Exame"}),e.jsx("input",{ref:G,id:"pdf-upload",type:"file",accept:"application/pdf",onChange:Ne,className:"hidden"}),e.jsxs(l,{type:"button",variant:"outline",className:"w-full",onClick:()=>G.current?.click(),children:[e.jsx($e,{className:"w-4 h-4 mr-2"}),o?`Arquivo selecionado: ${o.name}`:"Escolher arquivo PDF"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Formato: PDF • Tamanho máximo: 10MB"})]}),o&&e.jsx("div",{className:"p-3 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(p,{className:"w-4 h-4 text-blue-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-blue-900",children:"Novo arquivo selecionado"}),e.jsxs("div",{className:"text-xs text-blue-700",children:[o.name," • ",(o.size/1024/1024).toFixed(2)," MB"]})]})]}),e.jsx(l,{type:"button",size:"sm",variant:"ghost",onClick:()=>j(null),children:e.jsx(ee,{className:"w-4 h-4"})})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"test_date",children:"Data do Exame *"}),e.jsx(Pe,{id:"test_date",value:a.test_date,onChange:s=>u("test_date",s),max:q()})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"notes",children:"Observações"}),e.jsx("textarea",{id:"notes",className:"w-full min-h-[80px] px-3 py-2 text-sm rounded-md border border-input bg-background resize-none",placeholder:"Notas adicionais sobre o exame...",value:a.notes,onChange:s=>u("notes",s.target.value)})]})]}),e.jsxs(B,{children:[e.jsxs(l,{variant:"outline",onClick:J,disabled:D||b,children:[e.jsx(ee,{className:"w-4 h-4 mr-2"}),"Cancelar"]}),e.jsx(l,{onClick:_e,disabled:D||b,children:D||b?e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"w-4 h-4 mr-2 animate-spin"}),b?"Enviando...":"Salvando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(He,{className:"w-4 h-4 mr-2"}),n?"Atualizar":"Adicionar"]})})]})]})}),e.jsx(z,{open:ue,onOpenChange:N,children:e.jsxs(T,{children:[e.jsxs(O,{children:[e.jsxs(V,{className:"flex items-center gap-2",children:[e.jsx(Ge,{className:"w-5 h-5 text-destructive"}),"Confirmar Exclusão"]}),e.jsxs(Z,{children:["Tem certeza que deseja excluir o exame ",e.jsx("strong",{children:S?.test_name}),"? Esta ação não pode ser desfeita."]})]}),e.jsxs(B,{children:[e.jsx(l,{variant:"outline",onClick:()=>N(!1),children:"Cancelar"}),e.jsxs(l,{variant:"destructive",onClick:be,children:[e.jsx(Y,{className:"w-4 h-4 mr-2"}),"Excluir"]})]})]})}),e.jsx(z,{open:he,onOpenChange:L,children:e.jsxs(T,{className:"sm:max-w-[90vw] max-h-[90vh] p-0",children:[e.jsx(O,{className:"p-6 pb-0",children:e.jsxs(V,{className:"flex items-center gap-2",children:[e.jsx(p,{className:"w-5 h-5 text-primary"}),"Visualizar Exame (PDF)"]})}),e.jsx("div",{className:"h-[75vh] p-6 pt-4",children:_?e.jsx("iframe",{src:_,className:"w-full h-full rounded-lg border border-border",title:"Visualizador de PDF"}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(se,{className:"w-8 h-8 animate-spin text-muted-foreground"})})}),e.jsxs(B,{className:"p-6 pt-0",children:[e.jsx(l,{variant:"outline",onClick:()=>L(!1),children:"Fechar"}),_&&e.jsxs(l,{onClick:()=>window.open(_,"_blank"),children:[e.jsx(Je,{className:"w-4 h-4 mr-2"}),"Abrir em nova aba"]})]})]})})]})};export{ys as default};
