import{q as le,r as a,a as ie,u as ne,j as e,B as I,L as J,X as ce,s as T}from"./index-DGgtqe62.js";import{I as f}from"./input-C1Ic9mBe.js";import{L as n}from"./label-ByZ_-J2k.js";import{B as de}from"./badge-DGVDmpcG.js";import{T as me,a as ue,b as Q,c as W}from"./tabs-CsBOgm3t.js";import{c as pe}from"./foodService-BX23jDYT.js";import{C as he}from"./calculator-BZhWNrQj.js";import{P as Y}from"./plus-DLJbgUL_.js";const Z=le("Barcode",[["path",{d:"M3 5v14",key:"1nt18q"}],["path",{d:"M8 5v14",key:"1ybrkv"}],["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"M17 5v14",key:"ycjyhj"}],["path",{d:"M21 5v14",key:"nzette"}]]),Fe=a.forwardRef(function({initialData:r=null,onSuccess:$,mode:D="full",initialName:_=""},ee){const{toast:d}=ie(),{user:se}=ne(),[w,S]=a.useState(""),[E,P]=a.useState(""),[m,B]=a.useState("100g"),[l,q]=a.useState(100),[u,z]=a.useState(""),[p,A]=a.useState(""),[h,L]=a.useState(""),[j,y]=a.useState(""),[v,C]=a.useState(!0),[g,V]=a.useState([]),[R,G]=a.useState(!1),[k,ae]=a.useState(""),[X,H]=a.useState(!1);a.useEffect(()=>{r?(S(r.name||""),P(r.description?.replace("Marca: ","")||""),z(r.protein?.toString()||""),A(r.carbs?.toString()||""),L(r.fat?.toString()||""),y(r.calories?.toString()||""),C(!1),B("100g")):_&&S(_)},[r,_]);const N=a.useMemo(()=>{if(m==="portion"&&l>0){const s=100/l;return{protein:u?((parseFloat(u)||0)*s).toFixed(2):"",carbs:p?((parseFloat(p)||0)*s).toFixed(2):"",fat:h?((parseFloat(h)||0)*s).toFixed(2):"",calories:j?((parseFloat(j)||0)*s).toFixed(2):""}}return null},[m,l,u,p,h,j]);a.useEffect(()=>{if(v&&u&&p&&h){let s=parseFloat(u)||0,t=parseFloat(p)||0,i=parseFloat(h)||0;const o=s*4+t*4+i*9;y(Math.round(o*100)/100)}},[u,p,h,v,m,l]);const re=[{label:"Colher de Sopa",grams:15},{label:"Colher de Chá",grams:5},{label:"Xícara",grams:200},{label:"Unidade",grams:1},{label:"Fatia",grams:30},{label:"Colher de Servir",grams:20}],te=s=>{if(g.some(i=>i.label===s.label)){d({title:"Medida já adicionada",description:`${s.label} já está na lista.`,variant:"default"});return}V([...g,s])},oe=s=>{V(g.filter((t,i)=>i!==s))},O=async()=>{if(!k.trim()){d({title:"Erro",description:"Digite um código de barras válido.",variant:"destructive"});return}H(!0);try{const t=await(await fetch(`https://world.openfoodfacts.org/api/v0/product/${k.trim()}.json`)).json();if(t.status===0||!t.product){d({title:"Produto não encontrado",description:"Não foi possível encontrar este produto no OpenFoodFacts.",variant:"default"});return}const i=t.product,o=i.nutriments||{};if(i.product_name&&S(i.product_name),i.brands&&P(i.brands.split(",")[0].trim()),o.proteins_100g!==void 0&&z(o.proteins_100g.toString()),o.carbohydrates_100g!==void 0&&A(o.carbohydrates_100g.toString()),o.fat_100g!==void 0&&L(o.fat_100g.toString()),o.energy_kcal_100g!==void 0)y(o.energy_kcal_100g.toString()),C(!1);else if(o.energy_100g!==void 0){const M=o.energy_100g/4.184;y(M.toFixed(2)),C(!1)}B("100g"),q(100),d({title:"Produto encontrado!",description:"Campos preenchidos automaticamente."})}catch(s){console.error("Erro ao buscar produto:",s),d({title:"Erro",description:"Não foi possível buscar o produto. Verifique sua conexão.",variant:"destructive"})}finally{H(!1)}},K=async()=>{if(!w.trim()){d({title:"Erro",description:"Nome do alimento é obrigatório.",variant:"destructive"});return}if(!u||!p||!h||!j){d({title:"Erro",description:"Preencha todos os valores nutricionais.",variant:"destructive"});return}if(m==="portion"&&(!l||parseFloat(l)<=0)){d({title:"Erro",description:"Informe o tamanho da porção do rótulo.",variant:"destructive"});return}G(!0);try{let s=parseFloat(u)||0,t=parseFloat(p)||0,i=parseFloat(h)||0,o=parseFloat(j)||0;if(m==="portion"&&l>0){const c=100/l;s=s*c,t=t*c,i=i*c,o=o*c}const M={name:w.trim(),description:E.trim()?`Marca: ${E.trim()}`:null,calories:Math.round(o*100)/100,protein:Math.round(s*100)/100,carbs:Math.round(t*100)/100,fat:Math.round(i*100)/100,portion_size:100,source:"custom",nutritionist_id:se?.id||null,group:"Personalizado",is_active:!0};let F;if(r){const{data:c,error:x}=await T.from("foods").update(M).eq("id",r.id).select("id, name, group, description, source, calories, protein, carbs, fat, fiber, sodium, portion_size").single();if(x)throw x;F=c}else{const{data:c,error:x}=await pe(M);if(x)throw x;if(!c)throw new Error("Alimento criado mas não retornado");F=c}if(g.length>0){r&&await T.from("food_measures").delete().eq("food_id",F.id);const c=g.map(U=>({food_id:F.id,measure_label:U.label,quantity_grams:U.grams})),{error:x}=await T.from("food_measures").insert(c);x&&console.warn("Erro ao criar medidas caseiras:",x)}d({title:r?"Alimento atualizado!":"Alimento criado!",description:`${w} foi ${r?"atualizado":"adicionado"} ao banco de dados.`}),$&&$(F)}catch(s){console.error("Erro ao salvar alimento:",s),d({title:"Erro",description:s.message||"Não foi possível salvar o alimento.",variant:"destructive"})}finally{G(!1)}};a.useImperativeHandle(ee,()=>({submit:K}));const b=D==="compact";return e.jsxs("div",{className:b?"space-y-3":"space-y-4",children:[!b&&e.jsxs("div",{className:"space-y-2 border-b pb-4",children:[e.jsxs(n,{className:"text-base font-semibold flex items-center gap-2",children:[e.jsx(Z,{className:"h-4 w-4"}),"Buscar por Código de Barras"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{placeholder:"Digite o código EAN (ex: 7891000100103)",value:k,onChange:s=>ae(s.target.value),onKeyDown:s=>{s.key==="Enter"&&O()}}),e.jsx(I,{onClick:O,disabled:X||!k.trim(),variant:"outline",children:X?e.jsx(J,{className:"h-4 w-4 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(Z,{className:"h-4 w-4 mr-2"}),"Buscar"]})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Busca automática de dados nutricionais via OpenFoodFacts"})]}),e.jsxs("div",{className:`space-y-${b?"3":"4"}`,children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"name",children:"Nome do Alimento *"}),e.jsx(f,{id:"name",value:w,onChange:s=>S(s.target.value),placeholder:"Ex: Bolo de Chocolate",autoFocus:!r})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"brand",children:"Marca (opcional)"}),e.jsx(f,{id:"brand",value:E,onChange:s=>P(s.target.value),placeholder:"Ex: Marca X"})]})]}),e.jsxs("div",{className:`${b?"space-y-3 border-t pt-3":"space-y-4 border-t pt-4"}`,children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(n,{className:"text-base font-semibold",children:"Macronutrientes"})]})}),e.jsxs(me,{value:m,onValueChange:B,className:"w-full",children:[e.jsxs(ue,{className:"grid w-full grid-cols-2",children:[e.jsx(Q,{value:"100g",children:"Dados por 100g"}),e.jsx(Q,{value:"portion",children:"Dados do Rótulo (Porção)"})]}),e.jsx(W,{value:"100g",className:"space-y-4 mt-4",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Informe os valores nutricionais por 100g do alimento"})}),e.jsxs(W,{value:"portion",className:"space-y-4 mt-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{htmlFor:"labelPortionSize",children:"Tamanho da Porção do Rótulo (g) *"}),e.jsx(f,{id:"labelPortionSize",type:"number",value:l,onChange:s=>q(s.target.value),placeholder:"Ex: 30"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Informe o tamanho da porção indicada no rótulo"})]}),N&&e.jsxs("div",{className:"p-3 bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg",children:[e.jsx("p",{className:"text-xs font-semibold text-blue-900 dark:text-blue-100 mb-1",children:"Equivalente por 100g:"}),e.jsxs("div",{className:"text-xs text-blue-800 dark:text-blue-200 space-y-1",children:[e.jsxs("p",{children:["Proteína: ",N.protein,"g"]}),e.jsxs("p",{children:["Carboidratos: ",N.carbs,"g"]}),e.jsxs("p",{children:["Gorduras: ",N.fat,"g"]}),N.calories&&e.jsxs("p",{children:["Calorias: ",N.calories," kcal"]})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(n,{htmlFor:"protein",children:["Proteína (g) *",m==="portion"&&l>0&&e.jsxs("span",{className:"text-xs text-muted-foreground block",children:["por ",l,"g"]})]}),e.jsx(f,{id:"protein",type:"number",step:"0.1",value:u,onChange:s=>z(s.target.value),placeholder:"0"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(n,{htmlFor:"carbs",children:["Carboidratos (g) *",m==="portion"&&l>0&&e.jsxs("span",{className:"text-xs text-muted-foreground block",children:["por ",l,"g"]})]}),e.jsx(f,{id:"carbs",type:"number",step:"0.1",value:p,onChange:s=>A(s.target.value),placeholder:"0"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(n,{htmlFor:"fat",children:["Gorduras (g) *",m==="portion"&&l>0&&e.jsxs("span",{className:"text-xs text-muted-foreground block",children:["por ",l,"g"]})]}),e.jsx(f,{id:"fat",type:"number",step:"0.1",value:h,onChange:s=>L(s.target.value),placeholder:"0"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(n,{htmlFor:"calories",children:"Calorias (kcal) *"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"autoCalc",checked:v,onChange:s=>C(s.target.checked),className:"w-4 h-4"}),e.jsx(n,{htmlFor:"autoCalc",className:"text-sm font-normal cursor-pointer",children:"Calcular automaticamente"})]})]}),e.jsx(f,{id:"calories",type:"number",step:"0.1",value:j,onChange:s=>{y(s.target.value),C(!1)},placeholder:"0",disabled:v,className:v?"bg-muted":""}),v&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Cálculo: (Proteína × 4) + (Carboidratos × 4) + (Gorduras × 9)"})]})]}),e.jsxs("div",{className:`space-y-${b?"3":"4"} border-t pt-${b?"3":"4"}`,children:[e.jsx(n,{className:"text-base font-semibold",children:"Medidas Caseiras Comuns"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Clique nos botões abaixo para adicionar medidas rapidamente"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:re.map((s,t)=>e.jsxs(de,{variant:"outline",className:"cursor-pointer hover:bg-primary hover:text-primary-foreground transition-colors px-3 py-1",onClick:()=>te(s),children:[e.jsx(Y,{className:"h-3 w-3 mr-1"}),s.label," (",s.grams,"g)"]},t))}),g.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(n,{className:"text-sm",children:"Medidas Adicionadas:"}),e.jsx("div",{className:"space-y-2",children:g.map((s,t)=>e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-lg bg-muted/30",children:[e.jsxs("span",{className:"text-sm",children:[s.label," - ",s.grams,"g"]}),e.jsx(I,{variant:"ghost",size:"sm",onClick:()=>oe(t),className:"h-6 w-6 p-0",children:e.jsx(ce,{className:"h-3 w-3"})})]},t))})]})]}),!b&&e.jsx("div",{className:"flex justify-end gap-2 pt-4 border-t",children:e.jsx(I,{onClick:K,disabled:R,children:R?e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"h-4 w-4 mr-2 animate-spin"}),r?"Atualizando...":"Criando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),r?"Atualizar Alimento":"Criar Alimento"]})})})]})});export{Fe as S};
