import{s as c}from"./index-BvWB-6Y-.js";import{t as $}from"./mealTranslations-B1KHhmEq.js";import{l as p,b as x}from"./query-helpers-mbysFH2_.js";import{b as z,c as T}from"./lab-results-queries-B3ZMjFH4.js";import{l as E}from"./observability-queries-BxbsnaqH.js";const F=async(r,e)=>{try{const{data:t,error:i}=await c.from("user_profiles").select("*").eq("id",r).eq("nutritionist_id",e).single();if(i)throw i;return{data:t,error:null}}catch(t){return p("Erro ao buscar perfil do paciente",t),{data:null,error:t}}},C=async r=>{try{const{data:e,error:t}=await c.from("growth_records").select("weight, height, record_date").eq("patient_id",r).order("record_date",{ascending:!1}).limit(1).maybeSingle();let i=e?.weight,n=e?.height;if(!i||!n){const{data:u}=await c.from("user_profiles").select("weight, height").eq("id",r).single();i=i||u?.weight,n=n||u?.height}const{data:s,error:l}=await c.from("appointments").select("start_time, status").eq("patient_id",r).lte("start_time",new Date().toISOString()).order("start_time",{ascending:!1}).limit(1).maybeSingle(),{data:a,error:d}=await c.from("appointments").select("start_time, status").eq("patient_id",r).gte("start_time",new Date().toISOString()).order("start_time",{ascending:!0}).limit(1).maybeSingle();return{data:{weight:i||null,height:n||null,last_measurement:e?.record_date||null,last_appointment:s?new Date(s.start_time).toLocaleDateString("pt-BR"):null,next_appointment:a?new Date(a.start_time).toLocaleDateString("pt-BR"):null},error:null}}catch(e){return p("Erro ao buscar mÃ©tricas do paciente",e),{data:null,error:e}}},M=async r=>{try{const{data:e}=await c.from("anamnese_answers").select("id").eq("patient_id",r).limit(1).maybeSingle(),{data:t}=await c.from("growth_records").select("id").eq("patient_id",r).limit(1).maybeSingle(),{data:i}=await c.from("prescriptions").select("id").eq("patient_id",r).limit(1).maybeSingle(),{data:n}=await c.from("meals").select("id").eq("patient_id",r).is("deleted_at",null).limit(1).maybeSingle(),{data:s}=await c.from("user_achievements").select("id").eq("user_id",r).limit(1).maybeSingle(),{data:l}=await c.from("energy_expenditure_calculations").select("id").eq("patient_id",r).limit(1).maybeSingle(),{data:a}=await c.from("lab_results").select("id").eq("patient_id",r).limit(1).maybeSingle();return{data:{anamnese:e?"completed":"not_started",anthropometry:t?"completed":"not_started",energy_expenditure:l?"completed":"not_started",meal_plan:i?"completed":"not_started",food_diary:n?"completed":"not_started",lab_results:a?"completed":"not_started",prescriptions:i?"completed":"not_started",achievements:s?"completed":"not_started"},error:null}}catch(e){return p("Erro ao buscar status dos mÃ³dulos",e),{data:null,error:e}}},U=async(r,e=10)=>{try{const t=[],{data:i}=await c.from("meal_audit_log").select("id, action, meal_type, details, created_at").eq("patient_id",r).order("created_at",{ascending:!1}).limit(30);i&&i.forEach(a=>{const d=a.details?.total_calories||0,o=$(a.meal_type);let u="",m="";a.action==="create"?(u="RefeiÃ§Ã£o Registrada",m=`${o} - ${d} kcal`):a.action==="update"?(u="RefeiÃ§Ã£o Editada",m=`${o} - ${d} kcal`):a.action==="delete"&&(u="RefeiÃ§Ã£o Deletada",m=`${o} - ${d} kcal`),t.push({id:`audit-${a.id}`,type:"meal",title:u,description:m,timestamp:a.created_at,metadata:[o,`${d} kcal`,a.action==="create"?"Registrado":a.action==="update"?"Editado":"Deletado"]})});const{data:n}=await c.from("growth_records").select("id, weight, height, record_date, created_at").eq("patient_id",r).order("record_date",{ascending:!1}).limit(20);n&&n.forEach(a=>{const d=a.height?(a.weight/Math.pow(a.height/100,2)).toFixed(1):null;t.push({id:`weight-${a.id}`,type:"weight",title:"Peso Registrado",description:`Peso: ${a.weight} kg`,timestamp:a.created_at,metadata:d?[`${a.weight} kg`,`IMC: ${d}`]:[`${a.weight} kg`]})});const{data:s}=await c.from("user_achievements").select("id, achievement_id, achieved_at, achievements(name)").eq("user_id",r).order("achieved_at",{ascending:!1}).limit(15);s&&s.forEach(a=>{t.push({id:`achievement-${a.id}`,type:"achievement",title:"Conquista Desbloqueada",description:a.achievements?.name||"Nova conquista",timestamp:a.achieved_at,metadata:["ðŸ† Conquista"]})});const{data:l}=await c.from("appointments").select("id, start_time, status, notes").eq("patient_id",r).order("start_time",{ascending:!1}).limit(15);return l&&l.forEach(a=>{t.push({id:`appointment-${a.id}`,type:"appointment",title:"Consulta Realizada",description:a.notes||"Consulta de acompanhamento",timestamp:a.start_time,metadata:[a.status||"ConcluÃ­da"]})}),t.sort((a,d)=>new Date(d.timestamp)-new Date(a.timestamp)),{data:t.slice(0,e),error:null}}catch(t){return p("Erro ao buscar atividades do paciente",t),{data:[],error:t}}},W=async(r,e)=>{try{const[t,i,n]=await Promise.all([F(r,e),C(r),M(r)]);if(t.error)throw t.error;return{data:{profile:t.data,metrics:i.data||{},modulesStatus:n.data||{}},error:null}}catch(t){return p("Erro ao buscar resumo do paciente",t),{data:null,error:t}}},K=async r=>{try{const{data:e,error:t}=await c.rpc("get_patients_low_adherence_optimized",{p_nutritionist_id:r,p_days_threshold:2});if(t)throw t;return{data:(e||[]).map(n=>({id:n.patient_id,name:n.patient_name,last_activity:n.last_meal_date,days_inactive:n.days_since_last_meal===9999?null:n.days_since_last_meal})),error:null}}catch(e){return p("Erro ao detectar baixa adesÃ£o",e),{data:[],error:e}}},G=async r=>{try{const{data:e,error:t}=await c.rpc("get_patients_pending_data_optimized",{p_nutritionist_id:r});if(t)throw t;return{data:(e||[]).map(n=>{const s=[];return n.pending_items.forEach(l=>{const a={anamnese:{type:"anamnesis",label:"Anamnese Pendente",route:`/nutritionist/patients/${n.patient_id}/anamnese`},anthropometry:{type:"anthropometry",label:"AvaliaÃ§Ã£o AntropomÃ©trica Pendente",route:`/nutritionist/patients/${n.patient_id}/anthropometry`},meal_plan:{type:"meal_plan",label:"Plano Alimentar Pendente",route:`/nutritionist/patients/${n.patient_id}/meal-plan`},prescription:{type:"prescription",label:"CÃ¡lculo de Necessidades Pendente",route:`/nutritionist/patients/${n.patient_id}/energy-expenditure`}};a[l]&&s.push(a[l])}),{patient_id:n.patient_id,patient_name:n.patient_name,pending_items:s}}),error:null}}catch(e){return p("Erro ao detectar pendÃªncias",e),{data:[],error:e}}},J=async({nutritionistId:r,patientIds:e=[],daysWindow:t=120})=>{try{const i=(e||[]).filter(Boolean);if(!r||!i.length)return{data:[],error:null};const n=new Date(Date.now()-Math.max(1,Number(t)||120)*24*60*60*1e3).toISOString().slice(0,10),[{data:s,error:l},{data:a,error:d}]=await Promise.all([z(r),c.from("lab_results").select("id, patient_id, test_name, test_value, test_unit, reference_min, reference_max, test_date, created_at").in("patient_id",i).gte("test_date",n).order("test_date",{ascending:!1}).limit(500)]);if(l)throw l;if(d)throw d;const u=(T(a||[],s||[]).data||[]).filter(_=>_.risk_level==="high"),m=new Map;return u.forEach(_=>{const f=_.marker_key||String(_.test_name||"").toLowerCase(),y=`${_.patient_id}:${f}`;m.has(y)||m.set(y,{patient_id:_.patient_id,marker_key:f,test_name:_.test_name,test_value:_.test_value,test_unit:_.test_unit,risk_reason:_.risk_reason,test_date:_.test_date,created_at:_.created_at,risk_level:_.risk_level})}),{data:Array.from(m.values()),error:null}}catch(i){return p("Erro ao buscar alertas de risco laboratorial alto",i),{data:[],error:i}}},Q=async r=>{try{const{data:e,error:t}=await c.from("notification_rules").select("id, scope, nutritionist_id, rule_key, weight, config, is_active, updated_at").eq("scope","feed_priority").eq("is_active",!0).or(`nutritionist_id.is.null,nutritionist_id.eq.${r}`).order("nutritionist_id",{ascending:!0}).order("weight",{ascending:!1});if(t)throw t;return{data:e||[],error:null}}catch(e){return p("Erro ao buscar regras de prioridade do feed",e),{data:[],error:e}}},V=async r=>{try{const e=x(r||{}),{data:t,error:i}=await c.rpc("log_activity_event",{p_event_name:e.event_name,p_event_version:e.event_version,p_source_module:e.source_module,p_patient_id:e.patient_id,p_nutritionist_id:e.nutritionist_id,p_payload:e.payload});if(i)throw i;return{data:t||null,error:null}}catch(e){return p("Erro ao registrar evento de atividade",e),{data:null,error:e}}},D=({nutritionistId:r,sourceType:e,sourceId:t})=>({nutritionist_id:r,source_type:e,source_id:t}),N=(r,e)=>{const t=r&&typeof r=="object"?r:{},i=Array.isArray(t.audit_history)?t.audit_history:[],n=[e,...i].slice(0,10);return{...t,audit_history:n,last_action:e.action,last_action_at:e.at}},X=async r=>{try{const{data:e,error:t}=await c.from("feed_tasks").select("id, source_type, source_id, status, snooze_until, first_seen_at, created_at, updated_at, priority_score, priority_reason").eq("nutritionist_id",r);if(t)throw t;return{data:e||[],error:null}}catch(e){return p("Erro ao buscar estados do feed",e),{data:[],error:e}}},Y=async r=>{try{const{data:e,error:t}=await c.from("user_profiles").select("id, name, birth_date, avatar_url").eq("nutritionist_id",r).eq("is_active",!0);if(!t)return{data:e||[],error:null};const{data:i,error:n}=await c.from("nutritionist_patients").select("patient_id").eq("nutritionist_id",r);if(n)throw n;const s=(i||[]).map(o=>o.patient_id).filter(Boolean);if(!s.length)return{data:[],error:null};const{data:l,error:a}=await c.from("user_profiles").select("id, full_name, birth_date, avatar_url").in("id",s);if(a)throw a;return{data:(l||[]).map(o=>({id:o.id,name:o.full_name||"Paciente",birth_date:o.birth_date,avatar_url:o.avatar_url})),error:null}}catch(e){return p("Erro ao buscar pacientes do nutricionista para feed",e),{data:[],error:e}}},g=async({nutritionistId:r,patientId:e=null,sourceType:t,sourceId:i,title:n,description:s=null,priorityScore:l=0,priorityReason:a=null,status:d="open",snoozeUntil:o=null,metadata:u={},auditAction:m=null})=>{try{const _=D({nutritionistId:r,sourceType:t,sourceId:i}),{data:f,error:y}=await c.from("feed_tasks").select("id, metadata").match(_).maybeSingle();if(y)throw y;const v=new Date().toISOString(),b={...f?.metadata&&typeof f.metadata=="object"?f.metadata:{},...u&&typeof u=="object"?u:{}},q=m?N(b,{action:m,at:v,nutritionist_id:r||null,patient_id:e||null,source_type:t||null,source_id:i||null,status:d||"open",snooze_until:o||null}):b,w={..._,patient_id:e,title:n,description:s,priority_score:Number(l||0),priority_reason:a,status:d,snooze_until:o,metadata:q,last_seen_at:v};if(d==="resolved"?w.resolved_at=new Date().toISOString():w.resolved_at=null,f?.id){const{data:R,error:k}=await c.from("feed_tasks").update(w).eq("id",f.id).select().single();if(k)throw k;return{data:R,error:null}}const A={...w,first_seen_at:new Date().toISOString()},{data:P,error:S}=await c.from("feed_tasks").insert(A).select().single();if(S)throw S;return{data:P,error:null}}catch(_){return p("Erro ao salvar tarefa do feed",_),{data:null,error:_}}},Z=async r=>g({...r,status:"resolved",snoozeUntil:null,auditAction:"resolved"}),ee=async r=>g({...r,status:"snoozed",auditAction:"snoozed"}),te=async(r=[])=>{try{const e=(r||[]).map(n=>g({...n,status:"resolved",snoozeUntil:null,auditAction:"resolved_batch"})),t=await Promise.all(e),i=t.filter(n=>n?.error);return{data:t.map(n=>n?.data).filter(Boolean),error:i.length?i[0].error:null,failedCount:i.length}}catch(e){return p("Erro ao resolver tarefas em lote",e),{data:[],error:e,failedCount:(r||[]).length}}},ae=async(r=[],e)=>{try{const t=(r||[]).map(s=>g({...s,status:"snoozed",snoozeUntil:e,auditAction:"snoozed_batch"})),i=await Promise.all(t),n=i.filter(s=>s?.error);return{data:i.map(s=>s?.data).filter(Boolean),error:n.length?n[0].error:null,failedCount:n.length}}catch(t){return p("Erro ao adiar tarefas em lote",t),{data:[],error:t,failedCount:(r||[]).length}}},re=async(r,e=[],t=[])=>{try{if(!r)return{data:[],error:null};const i=new Map((t||[]).map(a=>[`${a.source_type}:${a.source_id}`,a])),n=(e||[]).filter(a=>a?.sourceType&&a?.sourceId).map(a=>{const d=`${a.sourceType}:${a.sourceId}`,o=i.get(d);let u="open",m=null;return o?.status==="resolved"?u="resolved":o?.status==="snoozed"&&(o.snooze_until?new Date(o.snooze_until).getTime():0)>Date.now()&&(u="snoozed",m=o.snooze_until),{nutritionistId:r,patientId:a.patientId||null,sourceType:a.sourceType,sourceId:a.sourceId,title:a.title||"Item do feed",description:a.description||null,priorityScore:Number(a.priorityScore||0),priorityReason:a.priorityReason||null,status:u,snoozeUntil:m,metadata:{item_type:a.type||null,cta_route:a.ctaRoute||null}}}),s=await Promise.all(n.map(a=>g(a))),l=s.find(a=>a?.error)?.error||null;return{data:s.map(a=>a?.data).filter(Boolean),error:l}}catch(i){return p("Erro ao sincronizar snapshot do feed",i),{data:[],error:i}}},ie=async({nutritionistId:r,sourceType:e,sourceId:t,limit:i=10})=>{try{const n=D({nutritionistId:r,sourceType:e,sourceId:t}),{data:s,error:l}=await c.from("feed_tasks").select("id, status, snooze_until, updated_at, metadata").match(n).maybeSingle();if(l)throw l;return s?{data:(Array.isArray(s?.metadata?.audit_history)?s.metadata.audit_history:[]).slice(0,Math.max(1,Number(i)||10)),error:null}:{data:[],error:null}}catch(n){return p("Erro ao buscar auditoria do item do feed",n),{data:[],error:n}}},ne=async(r,e=20)=>{const t=Date.now();try{const{data:i,error:n}=await c.rpc("get_comprehensive_activity_feed_optimized",{p_nutritionist_id:r,p_limit:e});if(n)throw n;const s=[...new Set(i?.map(o=>o.patient_id)||[])],{data:l}=await c.from("user_profiles").select("id, avatar_url").in("id",s),a=Object.fromEntries((l||[]).map(o=>[o.id,o.avatar_url])),d=(i||[]).map(o=>{const u={id:`${o.activity_type}-${o.activity_id}`,type:o.activity_type,patient_id:o.patient_id,patient_name:o.patient_name,patient_avatar:a[o.patient_id]||null,timestamp:o.activity_date,metadata:o.activity_data};switch(o.activity_type){case"meal":return{...u,title:"RefeiÃ§Ã£o Registrada",description:`${o.activity_data.meal_type} - ${o.activity_data.total_calories||0} kcal`};case"anthropometry":const m=o.activity_data.height&&o.activity_data.weight?(o.activity_data.weight/Math.pow(o.activity_data.height/100,2)).toFixed(1):null;return{...u,title:"Peso Registrado",description:`Peso: ${o.activity_data.weight} kg${m?` - IMC: ${m}`:""}`};case"anamnesis":return{...u,title:"Anamnese Preenchida",description:"Anamnese completa"};case"meal_plan":return{...u,title:"Plano Alimentar Criado",description:o.activity_data.name};case"prescription":return{...u,title:"PrescriÃ§Ã£o Nutricional",description:`${o.activity_data.calories||""} kcal`};case"appointment":return{...u,title:"Consulta Agendada",description:o.activity_data.notes||"Consulta de acompanhamento"};case"chat":return{...u,type:"message",title:"Mensagem Recebida",description:o.activity_data.message_preview||"Mensagem"};case"achievement":return{...u,title:"Conquista Desbloqueada",description:o.activity_data.achievement_name||"Nova conquista"};default:return u}});return await E({module:"feed",operation:"get_comprehensive_activity_feed",eventType:"success",latencyMs:Date.now()-t,nutritionistId:r||null,metadata:{items_count:d.length}}),{data:d,error:null}}catch(i){return p("Erro ao buscar feed de atividades",i),await E({module:"feed",operation:"get_comprehensive_activity_feed",eventType:"error",latencyMs:Date.now()-t,nutritionistId:r||null,errorMessage:i?.message||String(i)}),{data:[],error:i}}},h=(r=[],e,t)=>{const i=r.find(n=>n.rule_key===e&&n.is_active!==!1);return Number(i?.weight??t)},B=(r=[],e)=>{const t=r.find(i=>i.rule_key===e&&i.is_active!==!1);return t?.config&&typeof t.config=="object"?t.config:{}},oe=(r=[],e=[])=>(r||[]).map(t=>{if(t?.type==="pending"){const i=h(e,"pending_data",5),n=String(t?.pendingType||"").toLowerCase(),l=["prescription","anthropometry"].includes(n)?1:0;return{...t,priorityScore:i+l,priorityReason:l>0?"Pendencia de dados essenciais (critica)":"Pendencia de dados essenciais"}}if(t?.type==="low_adherence"){const i=h(e,"low_adherence",4),n=B(e,"low_adherence"),s=Number(n?.days_inactive_threshold??2),l=Number(t?.daysInactive??0);let a=0;return Number.isFinite(l)&&(l>=s+3?a=2:l>=s+1&&(a=1)),{...t,priorityScore:i+a,priorityReason:Number.isFinite(l)&&l>0?`Baixa adesao (${l} dias sem registro)`:"Baixa adesao recente"}}if(t?.type==="appointment_upcoming"||t?.type==="appointment"){const i=h(e,"appointment_upcoming",3),n=t?.timestamp?new Date(t.timestamp):null,s=n&&!Number.isNaN(n.getTime())?(n.getTime()-Date.now())/(1e3*60*60):null;let l=0;return typeof s=="number"&&(s<=2?l=2:s<=12&&(l=1)),{...t,priorityScore:i+l,priorityReason:l>=2?"Consulta muito proxima":"Consulta proxima"}}return t?.type==="lab_high_risk"?{...t,priorityScore:h(e,"lab_high_risk",5),priorityReason:"Risco laboratorial alto"}:{...t,priorityScore:h(e,"recent_activity",1),priorityReason:"Atividade recente"}}),se=async r=>{try{const{data:e,error:t}=await c.from("anamnesis_records").select("id, content, date").eq("patient_id",r).order("date",{ascending:!1}).limit(1).maybeSingle();if(t)throw t;if(!e||!e.content)return{data:null,error:null};const i=e.content;let n=null,s=null;if(typeof i=="object"){const l=["exercise_frequency","exerciseFrequency","frequencia_exercicio","atividade_fisica","physical_activity","nivel_atividade","activity_level"];for(const a of l)if(i[a]){n=i[a];break}if(!n&&i.sections){for(const a of i.sections)if(a.fields){for(const d of a.fields)if(l.includes(d.key||d.id)){n=d.value||d.answer;break}}}}return{data:{exerciseFrequency:n,activityLevel:s,date:e.date},error:null}}catch(e){return p("Erro ao buscar anamnese para energia",e),{data:null,error:e}}},le=async r=>{try{const{data:e,error:t}=await c.from("patient_goals").select("id, goal_type, target_weight, current_weight, description, status").eq("patient_id",r).eq("status","active").order("created_at",{ascending:!1}).limit(1).maybeSingle();if(t)throw t;return{data:e,error:null}}catch(e){return p("Erro ao buscar objetivo para energia",e),{data:null,error:e}}};export{K as a,G as b,Y as c,Q as d,X as e,J as f,ne as g,oe as h,ae as i,Z as j,ee as k,ie as l,W as m,U as n,F as o,se as p,le as q,te as r,re as s,V as t};
