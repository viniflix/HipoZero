import{s as l}from"./index-CjuzupBo.js";const _=7700,M=1e3,T=200,D=500,G=async(a,t)=>{const{goal_type:e,initial_weight:r,target_weight:o,start_date:d,target_date:u}=a,h=o-r,w=h<0,E=h>0,q=new Date(d).getTime(),P=new Date(u).getTime(),g=Math.ceil((P-q)/(1e3*60*60*24));if(g<=0)return{is_realistic:!1,viability_score:1,viability_notes:"Data alvo deve ser posterior √† data de in√≠cio.",warnings:[{type:"invalid_dates",message:"Data alvo inv√°lida"}],required_daily_deficit:0,daily_calorie_goal:null};const n=h/g*_,{data:b}=await l.from("energy_expenditure_calculations").select("*").eq("patient_id",t).order("created_at",{ascending:!1}).limit(1).maybeSingle(),{data:v}=await l.from("meal_plans").select("*").eq("patient_id",t).eq("is_active",!0).maybeSingle(),p=b?.get||null,m=v?.daily_calories||null,i={is_realistic:!0,viability_score:5,viability_notes:"",warnings:[],required_daily_deficit:Math.round(n),daily_calorie_goal:null,energy_expenditure_id:b?.id||null,meal_plan_id:v?.id||null},s=[],c=[];if(w&&Math.abs(n)>M&&(i.is_realistic=!1,i.viability_score=1,c.push({type:"too_aggressive",message:`D√©ficit de ${Math.abs(Math.round(n))} kcal/dia √© muito agressivo e pode ser prejudicial √† sa√∫de.`}),s.push("‚ö†Ô∏è Meta extremamente agressiva. Recomendamos estender o prazo ou reduzir o objetivo de peso.")),w&&Math.abs(n)<T&&(i.viability_score=Math.min(i.viability_score,3),c.push({type:"too_slow",message:`D√©ficit de apenas ${Math.abs(Math.round(n))} kcal/dia resultar√° em perda muito lenta.`}),s.push("üìä Meta pode ser muito conservadora. Considere reduzir o prazo para resultados mais vis√≠veis.")),E&&n>D&&(i.is_realistic=!1,i.viability_score=1,c.push({type:"gain_too_fast",message:`Super√°vit de ${Math.round(n)} kcal/dia √© excessivo.`}),s.push("‚ö†Ô∏è Ganho de peso muito r√°pido. Pode resultar em ac√∫mulo excessivo de gordura.")),p&&m){const y=p-m,f=p-n;i.daily_calorie_goal=Math.round(f),Math.abs(y-n)>300?(i.viability_score=Math.min(i.viability_score,3),y<n?(c.push({type:"plan_too_high_calories",message:`Plano atual fornece ${Math.round(m)} kcal/dia. Para atingir a meta, deveria fornecer aproximadamente ${Math.round(f)} kcal/dia.`}),s.push("üìã Plano alimentar atual fornece mais calorias que o necess√°rio. Considere ajustar o plano.")):(c.push({type:"plan_too_low_calories",message:`Plano atual fornece ${Math.round(m)} kcal/dia. Est√° abaixo do necess√°rio para a meta (${Math.round(f)} kcal/dia).`}),s.push("üìã Plano alimentar atual fornece menos calorias que o necess√°rio. Meta pode ser atingida mais rapidamente."))):s.push("‚úÖ Plano alimentar atual est√° adequado para atingir a meta no prazo estabelecido."),s.push(`
**Dados nutricionais:**`),s.push(`‚Ä¢ Gasto energ√©tico total: ${Math.round(p)} kcal/dia`),s.push(`‚Ä¢ Plano alimentar atual: ${Math.round(m)} kcal/dia`),s.push(`‚Ä¢ D√©ficit atual: ${Math.round(y)} kcal/dia`),s.push(`‚Ä¢ D√©ficit necess√°rio: ${Math.round(n)} kcal/dia`)}else i.viability_score=Math.min(i.viability_score,3),c.push({type:"missing_data",message:"Faltam dados de gasto energ√©tico ou plano alimentar para valida√ß√£o completa."}),p||s.push("‚ö†Ô∏è Gasto energ√©tico n√£o calculado. Recomendamos calcular antes de criar a meta."),m||s.push("‚ö†Ô∏è Nenhum plano alimentar ativo. Crie um plano adequado √† meta.");return g<7&&(i.viability_score=Math.min(i.viability_score,2),c.push({type:"too_short_deadline",message:"Prazo muito curto. Metas saud√°veis requerem mais tempo."})),g>365&&(i.viability_score=Math.min(i.viability_score,4),c.push({type:"long_deadline",message:"Prazo muito longo. Considere criar metas intermedi√°rias."})),i.viability_notes=s.join(`
`),i.warnings=c,i},z=async(a,t,e)=>{try{const r=await G(a,t),o={patient_id:t,nutritionist_id:e,goal_type:a.goal_type,title:a.title,description:a.description||null,initial_weight:a.initial_weight,target_weight:a.target_weight,current_weight:a.initial_weight,start_date:a.start_date,target_date:a.target_date,...r,status:"active"},{data:d,error:u}=await l.from("patient_goals").insert([o]).select().single();if(u)throw u;return{data:d,error:null}}catch(r){return console.error("Erro ao criar meta:",r),{data:null,error:r}}},W=async(a,t={})=>{try{let e=l.from("patient_goals").select("*").eq("patient_id",a);t.status&&(e=e.eq("status",t.status)),e=e.order("created_at",{ascending:!1}),t.limit&&(e=e.limit(t.limit));const{data:r,error:o}=await e;if(o)throw o;return{data:r,error:null}}catch(e){return console.error("Erro ao buscar metas:",e),{data:null,error:e}}},A=async a=>{try{const{data:t,error:e}=await l.from("patient_goals").select("*").eq("patient_id",a).eq("status","active").order("created_at",{ascending:!1}).limit(1).maybeSingle();if(e)throw e;return{data:t,error:null}}catch(t){return console.error("Erro ao buscar meta ativa:",t),{data:null,error:t}}},x=async a=>{try{const{data:t,error:e}=await l.from("patient_goals").select("*").eq("id",a).single();if(e)throw e;return{data:t,error:null}}catch(t){return console.error("Erro ao buscar meta:",t),{data:null,error:t}}},F=async(a,t)=>{try{const{data:e}=await x(a);if(!e)throw new Error("Meta n√£o encontrada");const{data:r,error:o}=await l.rpc("calculate_goal_progress",{goal_id:a});if(o)throw o;const{data:d,error:u}=await l.from("patient_goals").update({current_weight:t,progress_percentage:r}).eq("id",a).select().single();if(u)throw u;return r>=100&&await C(a),{data:d,error:null}}catch(e){return console.error("Erro ao atualizar progresso:",e),{data:null,error:e}}},C=async a=>{try{const{data:t,error:e}=await l.from("patient_goals").update({status:"completed",completion_date:new Date().toISOString().split("T")[0]}).eq("id",a).select().single();if(e)throw e;return{data:t,error:null}}catch(t){return console.error("Erro ao completar meta:",t),{data:null,error:t}}},I=async(a,t="")=>{try{const{data:e,error:r}=await l.from("patient_goals").update({status:"cancelled",description:t?`${t}`:void 0}).eq("id",a).select().single();if(r)throw r;return{data:e,error:null}}catch(e){return console.error("Erro ao cancelar meta:",e),{data:null,error:e}}},R=async a=>{try{const{data:t,error:e}=await l.from("patient_goals").update({status:"paused"}).eq("id",a).select().single();if(e)throw e;return{data:t,error:null}}catch(t){return console.error("Erro ao pausar meta:",t),{data:null,error:t}}},j=a=>{const t=a<0,e=Math.abs(a);return e===0?1:Math.ceil(t?e*_/M:e*_/D)},L=a=>{const t=a<0,e=Math.abs(a);return e===0?1:Math.ceil(t?e*_/500:e*_/300)},N=a=>{const t=new Date,r=new Date(a).getTime()-t.getTime();return Math.ceil(r/(1e3*60*60*24))},O=a=>{if(!a||a.status!=="active")return null;const t=Math.ceil((new Date(a.target_date).getTime()-new Date(a.start_date).getTime())/(1e3*60*60*24)),r=Math.ceil((new Date().getTime()-new Date(a.start_date).getTime())/(1e3*60*60*24))/t*100,d=(a.progress_percentage||0)-r;return d>=10?{status:"ahead",label:"Adiantado",color:"text-green-600"}:d<=-10?{status:"behind",label:"Atrasado",color:"text-red-600"}:{status:"on_track",label:"No prazo",color:"text-blue-600"}};export{N as a,O as b,W as c,L as d,j as e,G as f,A as g,z as h,C as i,I as j,R as p,F as u};
