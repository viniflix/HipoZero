import{q as R,j as e,t as ie,m as B,B as b,X as Y,u as ne,N as oe,as as le,b as ce,a as de,r as s,s as O,O as T,L as V,U as ue,I as J,H as me}from"./index-DGgtqe62.js";import{I as pe}from"./input-C1Ic9mBe.js";import{A as fe}from"./alert-triangle-CDQ896Mi.js";import{A as xe}from"./arrow-left-Dh54ORp5.js";import{S as he}from"./send-T9ZCJ1ia.js";import{i as ge}from"./isYesterday-Dbi-OXVA.js";import{P as ve}from"./pause-W71kYMml.js";import{D as je}from"./download-DMbtZ0RA.js";import{p as L}from"./parseISO-DRK10goE.js";import{i as ye}from"./isToday-Do_qZq4f.js";import"./isSameDay-B9XRUWnT.js";const we=R("Mic",[["path",{d:"M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z",key:"131961"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]]),Ne=R("Paperclip",[["path",{d:"m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48",key:"1u3ebp"}]]),be=R("PlayCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polygon",{points:"10 8 16 12 10 16 10 8",key:"1cimsy"}]]),ke=R("Play",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]]),Me=R("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]),Se=({mediaPath:t,mediaType:a,onClose:d})=>{if(!t)return null;const o=()=>a==="video"?e.jsx("video",{src:t,controls:!0,autoPlay:!0,className:"object-contain w-full h-full max-h-[90vh] rounded-lg",children:"Seu navegador não suporta vídeos."}):a==="image"?e.jsx("img",{src:t,alt:"Visualização ampliada",className:"object-contain w-full h-full max-h-[90vh] rounded-lg"}):e.jsxs("div",{className:"w-full h-[50vh] flex flex-col items-center justify-center text-white",children:[e.jsx(fe,{className:"w-12 h-12 mb-4"}),e.jsx("p",{children:"Tipo de mídia não suportado para visualização."})]});return e.jsx(ie,{children:e.jsx(B.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm",onClick:d,children:e.jsxs(B.div,{initial:{scale:.8,y:50},animate:{scale:1,y:0},exit:{scale:.8,y:50},className:"relative max-w-4xl max-h-[90vh] w-full",onClick:c=>c.stopPropagation(),children:[e.jsxs(b,{variant:"ghost",size:"icon",className:"absolute -top-12 right-2 text-white hover:text-white hover:bg-white/20 rounded-full z-10",onClick:d,children:[e.jsx(Y,{className:"w-6 h-6"}),e.jsx("span",{className:"sr-only",children:"Fechar"})]}),t?o():e.jsx("p",{className:"text-white text-center",children:"Não foi possível carregar a mídia."})]})})})},Re=({date:t})=>{const a=L(t);let d;return ye(a)?d="Hoje":ge(a)?d="Ontem":d=T(a,"d 'de' MMMM 'de' yyyy",{locale:me}),e.jsx("div",{className:"flex items-center justify-center my-4",children:e.jsx("span",{className:"px-3 py-1 text-xs font-semibold text-muted-foreground bg-muted rounded-full",children:d})})},K=({src:t})=>{const a=s.useRef(null),[d,o]=s.useState(!1),[c,h]=s.useState(0),[w,g]=s.useState(0),p=()=>{a.current.src&&(d?a.current.pause():a.current.play(),o(!d))};s.useEffect(()=>{const i=a.current;if(!i)return;const m=()=>{isFinite(i.duration)&&h(i.duration)},j=()=>g(i.currentTime);return i.addEventListener("loadeddata",m),i.addEventListener("timeupdate",j),i.addEventListener("ended",()=>o(!1)),()=>{i&&(i.removeEventListener("loadeddata",m),i.removeEventListener("timeupdate",j),i.removeEventListener("ended",()=>o(!1)))}},[]);const v=i=>{if(!i||!isFinite(i))return"0:00";const m=Math.floor(i/60),j=Math.floor(i%60).toString().padStart(2,"0");return`${m}:${j}`};return e.jsxs("div",{className:"flex items-center gap-2 w-64",children:[e.jsx("audio",{ref:a,src:t,preload:"metadata"}),e.jsx(b,{size:"icon",variant:"ghost",className:"rounded-full",onClick:p,children:d?e.jsx(ve,{className:"w-4 h-4"}):e.jsx(ke,{className:"w-4 h-4"})}),e.jsx("div",{className:"w-full h-1 bg-muted rounded-full cursor-pointer",onClick:i=>{if(!c)return;const m=i.currentTarget.getBoundingClientRect(),I=(i.clientX-m.left)/m.width*c;a.current.currentTime=I},children:e.jsx("div",{className:"h-full bg-primary rounded-full",style:{width:`${w/c*100}%`}})}),e.jsx("span",{className:"text-xs w-12 text-right",children:v(isFinite(c)?c:0)})]})},_e=({mediaPath:t,messageText:a,onImageClick:d})=>{const[o,c]=s.useState(""),[h,w]=s.useState(!0);if(s.useEffect(()=>{(async()=>{if(!t){w(!1);return}const v=t;w(!0);const{data:i,error:m}=await O.storage.from("chat_media").createSignedUrl(v,300);m?(console.error("Error creating signed URL:",m),c("")):c(i.signedUrl),w(!1)})()},[t]),h)return e.jsx("div",{className:"h-24 flex items-center justify-center",children:e.jsx(V,{className:"animate-spin"})});if(!o)return e.jsx("p",{className:"text-xs text-destructive",children:"Erro ao carregar mídia"});const g=t.split(".").pop().toLowerCase();return["jpg","jpeg","png","gif","webp"].includes(g)?e.jsx("img",{src:o,alt:a||"Imagem enviada",className:"rounded-lg max-w-[200px] md:max-w-xs h-auto cursor-pointer",onClick:()=>d(o,"image")}):["mp4","mov","quicktime"].includes(g)?e.jsxs("div",{className:"relative rounded-lg max-w-[200px] md:max-w-xs h-auto cursor-pointer group",onClick:()=>d(o,"video"),children:[e.jsx("video",{src:o,className:"rounded-lg w-full h-full"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/40 group-hover:bg-black/60 transition-all rounded-lg",children:e.jsx(be,{className:"w-12 h-12 text-white/80"})})]}):["mp3","wav","ogg","m4a","aac","webm"].includes(g)?e.jsx(K,{src:o}):g==="pdf"?e.jsxs("a",{href:o,download:a||"document.pdf",target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-3 p-2 bg-background/50 rounded-lg hover:bg-background/80 transition-colors",children:[e.jsx(J,{className:"w-8 h-8 text-primary flex-shrink-0"}),e.jsxs("div",{className:"flex-grow",children:[e.jsx("p",{className:"text-sm font-medium text-foreground truncate",children:a||"Documento PDF"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Clique para baixar"})]}),e.jsx(je,{className:"w-5 h-5 text-muted-foreground"})]}):e.jsx("p",{children:"Tipo de arquivo não suportado."})},Ce=({msg:t,isSender:a,onImageClick:d})=>{const o=t.message_type!=="text"?t.media_url:null,c=t.message_type==="text"?t.message:null,h=o?t.message:null;return e.jsx(B.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},className:`flex ${a?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xs md:max-w-md p-3 rounded-2xl shadow-sm ${a?"bg-primary text-primary-foreground rounded-br-lg":"bg-card text-card-foreground rounded-bl-lg border"}`,children:[o?e.jsx(_e,{mediaPath:o,messageText:h,onImageClick:d}):e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:c}),o&&c&&c!==h&&e.jsx("p",{className:"text-sm mt-2",children:c}),e.jsx("p",{className:`text-xs mt-1 ${a?"text-primary-foreground/70":"text-muted-foreground"} text-right`,children:T(L(t.created_at),"HH:mm")})]})})},qe=()=>{const{user:t}=ne(),{messages:a,sendMessage:d,fetchMessages:o,loading:c,markChatAsRead:h}=oe(),{patientId:w}=le(),g=ce(),{toast:p}=de(),[v,i]=s.useState(""),[m,j]=s.useState(null),[I,A]=s.useState(!0),[y,_]=s.useState(null),[C,E]=s.useState(null),[N,P]=s.useState(null),F=s.useRef(null),z=s.useRef(null),f=s.useRef(null),[k,D]=s.useState(!1),[H,W]=s.useState({path:null,type:null}),[U,X]=s.useState(!1),$=s.useRef(null),q=s.useRef([]),x=t.profile.user_type==="nutritionist"?w:t.profile.nutritionist_id,Z=s.useCallback(async l=>{if(!l){A(!1);return}A(!0);const{data:n,error:r}=await O.rpc("get_chat_recipient_profile",{recipient_id:l}),u=n?n[0]:null;r?(console.error("Erro ao buscar destinatário:",r),p({title:"Erro",description:`Não foi possível carregar os dados do destinatário: ${r.message}`,variant:"destructive"}),j(null)):j(u),A(!1)},[p]);s.useEffect(()=>{Z(x)},[x,Z]),s.useEffect(()=>{t&&x&&o(t.id,x)},[t,x,o]),s.useEffect(()=>{z.current&&a.length>0&&setTimeout(()=>{F.current?.scrollIntoView({behavior:"smooth"})},100)},[a]),s.useEffect(()=>{z.current&&!c&&a.length>0&&setTimeout(()=>{F.current?.scrollIntoView({behavior:"auto"})},200)},[c,a.length]),s.useEffect(()=>{x&&h(x)},[x,h,a]);const Q=l=>{const n=l.target.files[0];if(n){if(n.size>104857600){p({title:"Arquivo muito grande",description:"O tamanho máximo do arquivo é de 100MB.",variant:"destructive"}),f.current&&(f.current.value="");return}let u=null;if(n.type.startsWith("image/"))u="image";else if(n.type.startsWith("audio/"))u="audio";else if(n.type.startsWith("video/"))u="video";else if(n.type==="application/pdf")u="pdf";else{p({title:"Arquivo inválido",description:"Apenas imagens, vídeos, áudios e PDFs são permitidos.",variant:"destructive"}),f.current&&(f.current.value="");return}P(u),_(n),E(URL.createObjectURL(n))}},ee=async l=>{if(l.preventDefault(),v.trim()===""&&!y||!x||k)return;D(!0);let n=null,r="text",u=v.trim();if(y){r=N,u=N==="audio"?"Mensagem de áudio":y.name;const S=y.name.split(".").pop(),M=`${t.id}/${Date.now()}.${S}`,{error:G}=await O.storage.from("chat_media").upload(M,y);if(G){p({title:"Erro no upload",description:G.message,variant:"destructive"}),D(!1);return}n=M,N==="audio"&&(u="")}await d({from_id:t.id,to_id:x,message:u,message_type:r,media_url:n}),i(""),_(null),E(null),P(null),f.current&&(f.current.value=""),D(!1)},te=async()=>{try{const l=await navigator.mediaDevices.getUserMedia({audio:!0}),n="audio/webm";if(!MediaRecorder.isTypeSupported(n)){p({title:"Formato não suportado",description:"Seu navegador não suporta gravação em áudio WebM.",variant:"destructive"});return}const r=new MediaRecorder(l,{mimeType:n});$.current=r,q.current=[],r.ondataavailable=u=>{u.data.size>0&&q.current.push(u.data)},r.onstop=()=>{const u=new Blob(q.current,{type:n}),S=new File([u],`audio_${Date.now()}.webm`,{type:n});_(S),E(URL.createObjectURL(u)),P("audio"),r.stream.getTracks().forEach(M=>M.stop()),X(!1)},r.start(),X(!0)}catch(l){console.error("Erro ao gravar áudio:",l),p({title:"Erro de gravação",description:"Não foi possível acessar o microfone. Verifique as permissões.",variant:"destructive"})}},se=()=>{$.current?.state==="recording"&&$.current.stop()},ae=()=>{t.profile.user_type==="nutritionist"?g("/nutritionist"):g("/patient")},re=a.reduce((l,n)=>{const r=T(L(n.created_at),"yyyy-MM-dd");return l[r]||(l[r]=[]),l[r].push(n),l},{});return c||I?e.jsx("div",{className:"flex items-center justify-center h-screen",children:e.jsx(V,{className:"animate-spin w-8 h-8 text-primary"})}):m?e.jsxs("div",{className:"flex flex-col h-full bg-slate-50",children:[e.jsx(Se,{mediaPath:H.path,mediaType:H.type,onClose:()=>W({path:null,type:null})}),e.jsxs("header",{className:"shrink-0 bg-white border-b p-4 flex items-center shadow-md z-30",children:[e.jsx(b,{variant:"ghost",size:"icon",onClick:ae,className:"mr-2 ",children:e.jsx(xe,{className:"w-5 h-5"})}),e.jsx("div",{className:"w-10 h-10 bg-primary/10 rounded-full mr-3 flex items-center justify-center font-bold overflow-hidden",children:m.avatar_url?e.jsx("img",{src:m.avatar_url,alt:m.name,className:"w-full h-full object-cover"}):e.jsx(ue,{className:"w-6 h-6 text-primary"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-semibold text-foreground",children:m.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:m.user_type==="nutritionist"?"Nutricionista":"Paciente"})]})]}),e.jsxs("main",{ref:z,className:"flex-1 overflow-y-auto p-4 space-y-2",children:[Object.entries(re).map(([l,n])=>e.jsxs(s.Fragment,{children:[e.jsx(Re,{date:l}),e.jsx("div",{className:"space-y-4",children:n.map(r=>r.message&&r.message.includes("Consulta agendada")?e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"inline-block px-4 py-2 bg-blue-100 text-blue-600 rounded-lg text-sm",children:r.message}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:T(L(r.created_at),"HH:mm")})]},r.id):e.jsx(Ce,{msg:r,isSender:r.from_id===t.id,onImageClick:(S,M)=>W({path:S,type:M})},r.id))})]},l)),e.jsx("div",{ref:F})]}),e.jsxs("footer",{className:"shrink-0 bg-white p-4 border-t shadow-lg z-20",children:[C&&e.jsxs("div",{className:"relative p-2 mb-2 border rounded-lg max-w-sm flex items-center gap-2 bg-slate-50",children:[N==="image"&&e.jsx("img",{src:C,alt:"Preview",className:"max-h-24 rounded"}),N==="video"&&e.jsx("video",{src:C,className:"max-h-24 rounded",muted:!0,loop:!0,autoPlay:!0}),N==="audio"&&e.jsx(K,{src:C}),N==="pdf"&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{className:"w-8 h-8 text-destructive"}),e.jsx("span",{className:"text-sm text-muted-foreground truncate",children:y?.name})]}),e.jsx(b,{variant:"ghost",size:"icon",className:"absolute -top-3 -right-3 bg-white rounded-full h-6 w-6 shadow-md",onClick:()=>{_(null),E(null),P(null),f.current&&(f.current.value="")},children:e.jsx(Y,{className:"w-4 h-4"})})]}),e.jsxs("form",{onSubmit:ee,className:"flex items-center space-x-3",children:[e.jsx("input",{type:"file",ref:f,onChange:Q,className:"hidden",accept:"image/*,video/*,audio/*,application/pdf"}),e.jsx(b,{type:"button",variant:"ghost",size:"icon",onClick:()=>f.current.click(),disabled:k,children:e.jsx(Ne,{className:"w-5 h-5"})}),U?e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx("div",{className:"w-2 h-2 bg-destructive rounded-full animate-pulse"}),e.jsx("p",{className:"text-sm text-destructive",children:"Gravando..."})]}):e.jsx(pe,{type:"text",value:v,onChange:l=>i(l.target.value),placeholder:"Digite sua mensagem...",className:"flex-1 bg-slate-50 border-gray-200 focus:border-primary focus:ring-primary",autoComplete:"off",disabled:k}),v.trim()===""&&!y?e.jsx(b,{type:"button",variant:"ghost",size:"icon",onClick:U?se:te,disabled:k,children:U?e.jsx(Me,{className:"w-5 h-5 text-destructive"}):e.jsx(we,{className:"w-5 h-5"})}):e.jsx(b,{type:"submit",size:"icon",disabled:k||v.trim()===""&&!y,className:"",children:k?e.jsx(V,{className:"w-5 h-5 animate-spin"}):e.jsx(he,{className:"w-5 h-5"})})]})]})]}):e.jsxs("div",{className:"flex items-center justify-center h-screen p-4 text-center text-muted-foreground",children:["Você não tem um ",t.profile.user_type==="patient"?"nutricionista":"paciente"," associado."]})};export{qe as default};
